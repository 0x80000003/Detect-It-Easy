init("audio",""),includeScript("chunkparsers"),includeScript("soundchips"),includeScript("bytecodeparsers")
const debug=0
function detect(){if(X.c("'[1tracker module]'0D0A"))sName="Shiru's 1tracker module (.1TM)",bDetected=1,l=X.fStr(1,64,"Engine="),l>=0&&(r=X.fStr(l+7,64,"."),sVersion="for "+X.SA(l+7,r-l-7)),X.isVerbose()&&(l=X.fStr(r,128,"Title="),l>=0&&(r=X.fSig(l+6,64,"0D0A"),sOption(X.SA(l+6,r-l-6))),l=X.fStr(r,128,"Author="),l>=0&&(r=X.fSig(l+7,64,"0D0A"),sOption(X.SA(l+7,r-l-7),"by: ")),l=X.fStr(r,128,"Speed="),l>=0&&(r=X.fSig(l+7,64,"0D0A"),sOption(X.SA(l+7,r-l-7),"spd:")))
else if(X.c("'_A2module_'")&&isWithin(nV=X.U8(14),1,14))bDetected=1,bad=!1,sName="AdLib Tracker II module (.A2M)",sVersion="/┤DLiB TR/┤CK3R ][ v"+nV,ptn=X.U8(15),(!ptn||ptn>64)&&(bad="!badptn"),bad?sVersion+="/malformed"+bad:X.isVerbose()&&sOption("ptn:"+ptn)
else if(X.c("'_A2tiny_module_'")&&isWithin(nV=X.U8(19),1,14))sName="AdLib Tracker II module (.A2T)",bDetected=1,bad=!1,sVersion="/┤DLiB TR/┤CK3R ][ v"+nV+" tiny",ptn=X.U8(20),(!ptn||ptn>64)&&(bad="!badptn"),tmp=X.U8(21),spd=X.U8(22),rows=X.U16(24),trk=X.U8(26),bad?sVersion+="/malformed"+bad:X.isVerbose()&&sOption("tempo:"+tmp+" spd:"+tmp+" trk:"+trk+" ptn:"+ptn)
else if(X.c("'EXITgB'2018201820182F18201024C94AA80004660A558006A80000000200042200D28924C1D0A8000424C0D1DF2018D1D82018D1D82018201812D804800000000166F660B4610000'H|'017E01610000'Z|'027E02610000'R|'037E03610000'JL'DF7FFF'NuH'E7FFFE7E01610000AC7E02610000A67E03610000A04CDF7FFF'Nu`'0A602260000092600000'~A'FA....4BF900DFF000'p0;|'000000AA0440001064F4'NuK'F900DFF0003007C0FC",26))bDetected=1,sName="Art and Magic module (.AAM)",X.isVerbose()&&(t=X.fSig(32768,Math.min(65535,X.Sz()),"'EXIT'"),t>=0?sOption(outSz(t+4),"sz:"):sVersion="malformed!short")
else if(X.c("'ADLIB'01"))sName="Martin Fernandez's Adlib module (.ADLIB)",bDetected=1,X.isVerbose()&&(t=X.SA(6,256),g=X.SA(6+t.length+1,256),sOption(t),sOption(g,"for: "))
else if(X.c("'AERO'00000001")&&202==X.U8(15)&&202==X.U8(31)&&202==X.U8(47))sName="ioNeo's Aero Studio module (.AERO)",bDetected=1,X.isVerbose()&&sOption("sz:"+outSz(X.U32(8)+12))
else if(X.fSig(20,256,'\'<aks:song xmlns:aks="http://www.julien-nevo.com/ArkosTrackerSong"')>0)sName="Julien Névo's Arkos Tracker 2 module (.AKS)",sVersion="unpacked",bDetected=1
else if(X.c("'AM01'000000")&&X.c("'ASD1'",56)&&(amp=X.fSig(64,16777216,"'AMP'.. ........'ASSH'"))>0){for(sName="New Beat's Ace Tracker module (.AM)",bDetected=1,maxsz=Math.min(X.Sz(),16777216),title=by=bad="",ptn=ord=smp=sz=0,ptns=[],p=60;p<amp&&smp<64&&(t=X.U32(p,_BE));)p+=t,smp++
for(p+=4,X.c("'AMP'.. ........'ASSH'",p)||(p=amp,bad=bad.addIfNone("!badsmp"),smp=Math.max(1,smp)),ampv=X.U8(p+3)-48,ampv>3&&(bad=bad.addIfNone("!unkver")),sVersion="v"+ampv,ins=X.U32(p+4,_BE),p+=12,inss=[],E=0;E<ins;E++,p+=1==ampv?205:2==ampv?209:3==ampv?212:0)""!=(t=X.SA(p+4,20).trim())&&"Empty"!=t&&inss.push(t)
if(X.c("'ASG1'",p)||(bad=bad.addIfNone("!badins")),asg1=X.fSig(amp,maxsz,"'ASG1'"),ord=ptn=0,asg1<0)bad=bad.addIfNone("!nosong")
else for(title=X.SC(asg1+4,20,"CP437"),by=X.SC(asg1+24,20,"CP437"),E=asg1+44;E<asg1+300;E++)(t=X.U8(E))&&(ord=E-asg1-43,t>ptn&&(ptn=t))
if(p=asg1+300,apn1=X.fSig(asg1,1024,"'APN1'"),ch=ptn_=-1,apn1>0){for(p!=apn1&&(bad=bad.addIfNone("!badptn")),ptn_=X.U32(apn1+4,_BE),ptn!=ptn_&&(bad=bad.addIfNone("!badptn"+ptn+"/"+ptn_)),E=0,p=apn1+8;E<ptn_;E++)t=X.SC(p+4,12,"CP437").trim(),t.length&&"Empty"!=t&&ptns.push(t),ch_=X.U16(p,_BE),ch_>ch&&(ch=ch_),p+=16+4*ch_*X.U16(p+2,_BE)
sz=p}else bad=bad.addIfNone("!noptns")
ch>16&&(bad=bad.addIfNone("!badchn")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(title),sOptionT(by,"by: "),sOptionT(addEllipsis(inss.join(" ")),'ins/msg:"','"'),sOptionT(addEllipsis(ptns.join(" ")),'ptns:"','"'),sOption((ch>0?"ch:"+ch+" ":"")+"ord:"+ord+" ptn:"+(ptn!=ptn_?ptn+"/":"")+ptn_+" ins:"+ins+" smp:"+smp+" xpos:"+X.I32(52)+(sz?" sz:"+outSz(sz):"")))}else if(X.c("'ASG1'")&&X.c("'APN1'",300)){for(sName="New Beat's Ace Tracker module patterns (.ASG)",bDetected=1,bad="",title=X.SC(4,20,"CP437"),by=X.SC(24,20,"CP437"),ptn=ord=0,p=44;p<300;p++)(t=X.U8(p))&&(ord=p-43,t>ptn&&(ptn=t))
for(ch=-1,ptns=[],E=0,p=308;E<255;E++)ch_=X.U16(p,_BE),ch_>ch&&(ch=ch_),ptnsz=ch_*X.U16(p+2,_BE),p+=4,ptnsz&&(t=X.SC(p,12,"CP437").trim(),t.length&&"Empty"!=t&&ptns.push(t),p+=12+4*ptnsz)
sz=p,ch>16&&(bad=bad.addIfNone("!badchn")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(title),sOptionT(by,"by: "),sOptionT(addEllipsis(ptns.join(" ")),'ptns:"','"'),sOption((ch>0?"ch:"+ch+" ":"")+"ord:"+ord+" ptn:"+ptn+" sz:"+outSz(sz)))}else if(X.c("'AMC V1.2 REPLAY!'")&&X.c("0000003C0002\t",78)){if(sName="Marc Hawlitzeck's A.M. Composer module (.AMC)",bDetected=1,sVersion="v"+X.SA(5,3),X.isVerbose()){for(d0=X.U32(20,_BE),a3=X.U32(24,_BE),d3=c=0,p=72,special="",smp=0;p<X.Sz()&&p<a3;p+=16)d2=X.I32(p,_BE)+2*X.U16(p+4,_BE),smp++,d2>d3&&(d3=d2)
if(p=d3,p<X.Sz()){for(;p+c<X.Sz()&&isWithin(X.U8(p+c),32,126);)c++
X.U8(p+c)||p+c+1!=X.Sz()||c++,special=X.SA(p,c)}sOption(special,'info:"','"'),sOption("smp:"+smp+" sz:"+outSz(p+c))}}else if(X.c("'<o'EF'QU'EE'RoR'",1062)||X.c("'MaDoKaN96'",1062))sName="AMusic Adlib-MOD module (.AMD)",bDetected=1,"<"!=X.SA(1062,1)&&(sVersion="xms rip-off"),17==X.U8(1071)&&(sVersion=sVersion.appendS("packed","/")),X.isVerbose()&&(sOptionT(X.SA(0,24)),sOptionT(X.SA(24,24),"by: "),sOption("ord:"+X.U8(932)+" ptn:"+(X.U8(933)+1)))
else if(X.c("'ASYLUM Music Format V1.0'00000000 00000000")&&X.U8(34)<=64&&X.Sz()>=2662+2048*X.U8(35)){if(sName="ASYLUM Music Format module (.AMF)",bDetected=1,sVersion="v"+X.SA(21,3),X.isVerbose()){for(spd0=X.U8(32),bpm0=X.U8(33),smp=X.U8(34),ptn=X.U8(35),ord=X.U8(36),p=294,ssz=0,smps=[],E=0;E<smp;E++)smpn=X.readBytes(294+37*E,22,!0),smpn=decEncoding(smpn,CP437,!1,Chars0to1F).trim(),""!=smpn&&smps.push(smpn),M=X.U32(294+37*E+25),ssz+=M
sz=2662+2048*ptn+ssz,sOption(addEllipsis(smps.join(" "),256,160),'smp/msg:"','"'),sOption("spd0:"+spd0+" bpm0:"+bpm0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" smpsz:"+Hex(ssz)+" sz:"+outSz(sz))}}else if(X.c("'Extreme0'01")&&X.U8(15)<=32){if(sName="Extreme's Tracker Advanced Module System track (.AMS)",bDetected=1,X.isVerbose()){for(cmd=X.U8(9)>>5,sch=1+(31&X.U8(9)),smp=X.U8(10),ptn=X.U16(11),ord=X.U16(13),vmch=X.U8(15),xtra=X.U16(16),p=xtra+18,S=[],allsmpsz=0,E=0;E<smp;E++,p+=17)ssz=X.U32(p),allsmpsz+=ssz,co=3&X.U8(p+16),b16=128&X.U8(p+16)?2:1,S.push([co,ssz,b16])
for(sOptionT(X.SC(p+1,X.U8(p),"CP437")),p+=1+X.U8(p),smps=[],E=0;E<smp;E++)smps.push(X.SC(p+1,X.U8(p),"CP437")),p+=1+X.U8(p)
for(schs=[],E=0;E<sch;E++)schs.push(X.SC(p+1,X.U8(p),"CP437")),p+=1+X.U8(p)
for(E=0;E<ptn;E++)p+=1+X.U8(p)
msg=X.readBytes(p+2,X.U16(p),!0)
var s=[]
for(p+=2+X.U16(p),E=0;E<msg.length;E++)msg[E]<128?s.push(msg[E]):msg[E]<=160?s.push(32):s.push(10)
for(msg=decEncoding(s,"CP437"),delete s,mptn=-1,E=0;E<ord;E++)t=X.U16(p+2*E),t>mptn&&(mptn=t)
for(mptn++,p+=2*ord,E=0;E<ptn;E++)p+=4+X.U32(p)
for(allsmpcsz=0,E=0;E<smp;E++)S[E][0]?S[E][1]&&(p+=4,scosz=X.U32(p),cc=X.U8(p+4),p+=5+scosz,allsmpcsz+=scosz):p+=8+S[E][1]*S[E][2]
delete S,sOption(addEllipsis(schs.join(" "),160,128),'chns:"','"'),sOption(addEllipsis(msg.trim(),256,128),'msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+(mptn!=ptn?"/"+mptn:"")+" smp:"+smp+" cmd:"+cmd+" strk:"+sch+(vmch?" mtrk:"+vmch:"")+" co.smpsz:"+(100*allsmpcsz/allsmpsz).toFixed(1)+"% sz:"+outSz(p))}}else if(X.c("'AMShdr'1A")&&X.U8(7)<=30&&2==X.U8(9+X.U8(7))&&X.U8(8+X.U8(7))<=2){if(bDetected=1,p=8+X.U8(7),nv=X.U8(p),sName="Velvet Studio Advanced Module System track (.AMS)",sVersion="v"+X.U8(p+1)+"."+nv,bad="",ptn=X.U16(p+3),ptn>1024&&(bad=bad.addIfNone("!badptn")),ord=X.U16(p+5),X.isVerbose()){for(title=X.SC(8,p-8,"CP437"),ins=X.U8(p+2),p+=7,X.Sz()<47+2*ins+2*ord+4*ptn&&(bad=bad.addIfNone("!short")),2==nv?(bpm0=Math.max(8192,X.U16(p)),p+=2,bpm0=(bpm0>>8)+"."+(255&bpm0),spd0=Math.max(1,X.U8(p++)),p+=3,flg=X.U16(p),p+=2):(bpm0=Math.max(32,X.U8(p++)),spd0=Math.max(1,X.U8(p++)),flg=X.U8(p++)),ch=flg>>6&1?"2":"1",linfreqtbl=64&flg?" lnr.freq.tbl.":"",midiused=128&flg?" MIDI used":"",sOptionT(title),inss=[],smps=[],S=[],allsmpsz=allsmpcsz=smp=shd=0,E=0;E<ins;E++)if(t_=X.U8(p++),t_>30&&(bad=bad.addIfNone("!badins")),t=X.SC(p,t_,"CP437").trim(),p+=t_,""!=t&&inss.push(t),inssmp=X.U8(p++),inssmp)for(0==nv?p+=100:p+=124,t=X.U8(p++),t>63&&(bad=bad.addIfNone("!badenv")),p+=3*t+4,t=X.U8(p++),t>63&&(bad=bad.addIfNone("!badpan")),p+=3*t+4,t=X.U8(p++),t>63&&(bad=bad.addIfNone("!badvibenv")),p+=3*t,t=X.U8(p),shdins=t>0,shdins&&shd++,p+=5,i=0;i<inssmp;i++)t_=X.U8(p++),t_>22&&(bad=bad.addIfNone("!badsmp")),t=X.SC(p,t_,"CP437").trim(),p+=t_,ssz=X.U32(p),p+=4,shdins||smp++,ssz&&(shdins||(allsmpsz+=ssz,sfl=X.U8(p+15),co=3&sfl,b16=4&sfl?2:1,S.push([co,ssz,b16])),p+=16)
for(t_=X.U8(p++),sOptionT(X.SC(p,t_,"CP437"),"by:"),p+=t_,schs=[],E=0;E<32;E++)schs.push(X.SC(p+1,X.U8(p),"CP437")),p+=1+X.U8(p)
if(msg=X.readBytes(p+11,X.U32(p)-11),s=[],co=X.U8(p+10),p+=X.U32(p),co){for(E=0;E<msg.length;)if(c=msg[E++],255==c&&msg.length-E>=2)if(c=msg[E++],n=msg[E++],32!=c)for(j=0;j<n;j++)s.push(c)
else n<=32?s.push(32):s.push(10)
else s.push(c)
msg=decEncoding(s,"CP437")}else msg=decEncoding(msg,"CP437")
for(delete s,p+=ord<<1,E=0;E<ptn;E++)p+=4+X.U32(p)
for(p>X.Sz()&&(bad=bad.addIfNone("!short")),E=0;E<smp;E++)S[E][0]?S[E][1]&&(scosz=X.U32(p+4),cc=X.U8(p+9),p+=9+scosz,allsmpcsz+=scosz):p+=S[E][1]*S[E][2]
sz=p,sOption(addEllipsis(schs.join(" "),160,128),'chns:"','"'),sOption(addEllipsis(inss.join(" "),160,128),'insts/msg:"','"'),sOption(addEllipsis(msg.trim(),160),'msg:"','"'),sOption("ch:"+ch+" ins:"+ins+(shd?"+"+shd+"sh":"")+" ord:"+ord+" ptn:"+ptn+" bpm0:"+bpm0+" spd0:"+spd0+linfreqtbl+midiused+" co.smpsz:"+(100*allsmpcsz/allsmpsz).toFixed(1)+"% sz:"+outSz(sz))}bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("'AMX "))sName="Dmitry 'AND' Andreev's XSynth module (.AMX)",bDetected=1
else if(X.c("'AON4'")||X.c("'AON8'")){if(sName="ArtOfNoise/Chorus module (.AON)",bDetected=1,ch=X.U8(3)-48,X.isVerbose()){for(id=X.SA(4,42),p=46,t=a=d=c="",ord=ptn=ins=0;p<X.Sz();){if(63==X.U8(p)){p+=4-p&3
break}if(hkhd=X.readBytes(p,4),charStat(hkhd,1).indexOf("allasc")<0)break
switch(hkhd=decEncoding(hkhd,CP437),hksz=X.U32(p+4,_BE),p+=8,hkhd){case"NAME":t=X.SC(p,hksz,"CP1252")
break
case"AUTH":a=X.SC(p,hksz,"CP1252")
break
case"DATE":d=X.SC(p,hksz,"CP1252")
break
case"RMRK":c=X.SC(p,hksz,"CP1252")
break
case"PLST":for(ord=hksz,E=0;E<ord;E++)(o=X.U8(p+E)+1)>ptn&&(ptn=o)
break
case"WLEN":for(E=0;E<hksz>>2;E+=4)X.U32(p+E,_BE)&&ins++}p+=hksz}sOptionT(t),sOptionT(a,"by: "),sOptionT(d,"on: "),sOption(id,"in: "),sOption(addEllipsis(c.trim(),160)),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" sz:"+outSz(p))}}else if(X.c("'ADRVPACK'"))sName="AProSys module (.APS)",bDetected=1
else if(X.c("'ARP.'"))sName="Major Tom's Player 2 module (.ARP)",bDetected=1
else if(X.c("'ACTIONAMICS SOUND TOOL'",62))sName="Actionamics Sound Tool module (.AST)",bDetected=1,sVersion="v"+X.SA(86,3)
else if(X.c("08'AST '")){if(sName="All Sound Tracker module (.AST)",bDetected=1,sVersion="v"+X.SA(5,4),X.isVerbose()){L=X.U16(10,_BE),ss=X.SC(12,L+1,"CP850").trim()
for(var i="",U=0,E=0;U<2;E+=38)a=ss.slice(E,E+38),""!=a.trim()&&(U++,i+=" "+a.trim())
sOption(i)}}else if(X.c("'AudioSculpture10'00180018"))sName="Synchron Assembly's Audio Sculpture synth file (.AS)",bDetected=1
else if(X.c("'##synth'0D0A"))sName="Athtune module (.ATHTUNE)",bDetected=1
else if(X.c("'FORM'.... ....'AXSFUSER'")&&X.c("'SHDR'",t=X.U32(16,_BE)+20)&&X.c("'SONG'",X.U32(t+4,_BE)+t+8)){if(sName="Resolution's AXS module (.AXS)",bDetected=1,X.isVerbose()){for(ord=ptn=ins=smp=0,sz=X.U32(4,_BE)+8,p=12,maxsz=Math.min(sz,X.Sz());p<maxsz&&(hkhd=X.readBytes(p,4),!(charStat(hkhd,1).indexOf("allasc")<0));){switch(hkhd=decEncoding(hkhd,CP437),hksz=X.U32(p+4,_BE),p+=8,hkhd){case"SONG":ord=hksz>>3
break
case"BLOK":ptn++
break
case"INST":ins++
break
case"SAMP":smp++}p+=hksz}sOption("ord:"+ord+" ptn:"+ptn+(ins?" syn:"+ins:"")+(smp?" smp:"+smp:"")+" sz:"+outSz(sz))}}else if(X.c("'BBSONG'00'0001'00")){sName="Shiru's Beepola module (.BBSONG)",bDetected=1,p=12
var F=!1
for(ord=orn=ptn=svgptn=svgwarp=phains=0,bad=title=auth=engine="";p<X.Sz()&&!(p>=X.Sz());){if(58!=X.U8(p++)){p--
break}switch(t=X.SA(p,254),p+=t.length+1,t){case"INFO":for(;p<X.Sz()&&(t=X.SC(p,TOEOF,"CP1251"),p+=t.length+1,":END"!==t);)switch(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),xx[0]){case"Title":title=xx[1]
break
case"Author":auth=xx[1]
break
case"Engine":engine=xx[1]}break
case"LAYOUT":for(F=!0;p<X.Sz()&&(t=X.SC(p,TOEOF,"CP1251"),p+=t.length+1,":END"!==t);)switch(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),xx[0]){case"LoopStart":lp=+xx[1]
break
case"Length":for(ord=+xx[1],ptn=0,E=0;E<ord;E++)ptn<=(t=X.U8(p++))&&(ptn=t+1)}break
case"PATTERNDATA":for(;p<X.Sz()&&(t=X.SC(p,1024,"CP1251"),p+=t.length+1,":END"!==t);)if(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),"PatternCount"===xx[0])for(ptns=+xx[1],E=0;E<ptns&&p<X.Sz()&&(t=X.SC(p,1280,"CP1251"),p+=t.length+1,":END"!==t);E++)xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),"PatternName"===xx[0]&&(p+=8+5*X.U32(p))
break
case"SVGPATTERNDATA":for(;p<X.Sz()&&(t=X.SC(p,1024,"CP1251"),p+=t.length+1,":END"!==t);)if(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),"PatternCount"===xx[0])for(svgptn=+xx[1],E=0;E<svgptn&&p<X.Sz();E++)p+=4+16*X.U32(p)
break
case"SVGWARPDATA":for(;p<X.Sz()&&(t=X.SC(p,1024,"CP1251"),p+=t.length+1,":END"!==t);)if(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),"PatternCount"===xx[0])for(svgwarp=+xx[1],E=0;E<svgwarp&&p<X.Sz();E++)p+=4+2*X.U32(p)
break
case"P1INSTR":for(;p<X.Sz()&&(t=X.SC(p,1024,"CP1251"),p+=t.length+1,":END"!==t);)if(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),"Length"===xx[0])phains=+xx[1],p+=phains
break
case"SVGORNAMENTS":for(;p<X.Sz()&&(t=X.SC(p,1024,"CP1251"),p+=t.length+1,":END"!==t);)if(xx=t.split("="),xx.length>2&&(xx=[xx[0],xx.slice(1,xx.length).join("=")]),"OrnamentCount"===xx[0])for(orn=+xx[1],E=0;E<orn&&p<X.Sz();E++)p+=4+X.U32(p)
break
default:bad=bad.addIfNone("!badchunk")}}F||(bad=bad.addIfNone("!corrupt")),sVersion="engine:"+engine,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(title),sOptionT(auth,"by: "),sOption("ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+(svgptn?"+svg":"")+(svgwarp?" warp":"")+(orn?" orn":"")+(phains?" phasers":"")+" sz:"+outSz(p)))}else if(X.c("000003F3")&&X.U8(20)&&X.c("70FF4E75'DAGLISH!'",32)&&X.U32(44,_BE)&&X.U32(48,_BE)&&X.U32(52,_BE)&&X.U32(56,_BE))bDetected=1,sName="Ben Daglish's SID (.BDS)",sVersion="v1.1",X.isVerbose()&&(title=X.SA(32+X.U32(60,_BE),256),auth=X.SA(32+X.U32(64,_BE),256),misc=X.SA(32+X.U32(68,_BE),256),sOptionT(title),x=X.U32(56,_BE),x>1&&sOption(x,"×"),sOptionT(auth,"by: "),sOptionT(misc))
else if(/BMF1\.[012]/.test(X.SA(0,6))&&X.Sz()>8&&X.fSig(6,42,"00")>6){if(sName="The Brain's Easy Adlib module (.BMF)",sV=X.SA(5,1),sVersion="v1."+sV,bDetected=1,X.isVerbose()&&sV>"0"){if(p=6,bad=title=author="",f=X.fSig(p,-1,"00"),title=X.SA(p,f-p),p+=title.length+1,f=X.fSig(p,-1,"00"),f>0){if(author=X.SA(p,f-p),p+=author.length+1,spd=X.U8(p++),X.isDeepScan()){for(fl=X.U32(p),p+=4,ins=0,E=0;E<32;E++)1&fl&&(p+=24,p>X.Sz()&&(bad=bad.addIfNone("!short"))),fl>>=1,ins++
fl=X.U32(p),p+=4
const Us=1023
for(trk=0,trkend=!1,E=0;E<32;E++){if(1&fl)for(trk++,trkend=!1,U=0;p<X.Sz()&&!trkend&&U<=Us;U<Us&&U++)switch(t=X.U8(p++),t){case 254:trkend=!0
break
case 252:case 125:break
default:if(evnote=127&t,!(128&t))break
if(t=X.U8(p),128&t&&(evdly=63&t,p++,!(64&t)))break
t=X.U8(p++),64<=t?evvol=t+1-64:32<=t&&t<=63?evins=t+1-32:"2"==sV&&1<=t&&t<=6&&p++}fl>>=1}trkend||(bad=bad.addIfNone("!short"),p=-1)}}else bad=bad.addIfNone("!badtags")
""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),sOptionT(title),sOptionT(author,"by: "),sOption("spd:"+spd+(X.isDeepScan()?" trk:"+trk+" ins:"+ins+" sz:"+outSz(p):""))}}else if(X.Sz()>384&&X.c("'Buzz'")&&isWithin(X.U32(4),1,12)&&X.c("7C010000",12)&&X.fSig(8,64,"'MACH'")>0)sName="Jeskola Buzz module (.BMX)",bDetected=1
else if(X.Sz()>=28252&&X.c("0100'ADLIB'9D02A0021C000000")&&502458809==X.adler32(0,28252))sName="Instrument bank for Adlib Visual Composer (STANDARD.BNK)",bDetected=1,X.isVerbose()&&sOption(outSz(28252),"sz:")
else if(X.c("'BRTF'")){if(sName="BeRoTracker module (.BRT)",bDetected=1,X.isVerbose()){for(p=8,t="",c="",U="",instmsg=[],sainmsg=[],ins=0,smp=0,ord=0,bpm0=0,spd0=0,st0=0,mvol=0,rowsperbeat=0,hltu=0,hltd=0;p<X.Sz();){switch(hkhd=X.SA(p,4),hksz=X.U32(p+4,_LE),p+=8,hkhd){case"NAME":t=X.UCSD(p)
break
case"MESS":c=X.SC(p+2,X.U32(p,_LE),"CP1252")
break
case"BPMI":rpb=X.U8(p)
break
case"INFO":spd0=X.U8(p+4),bpm0=X.U8(p+5),st0=X.U8(p+6),mvol=X.U8(p+10)
break
case"PORD":ord=X.U8(p)
break
case"PAIN":hltu=X.U8(p+1),hltd=X.U8(p+2)
break
case"SAIN":smp++,(U=X.UCSD(p+2)).trim().length&&sainmsg.push(U)
break
case"INST":X.U8(p)&&ins++,(U=X.UCSD(p+1)).trim().length&&instmsg.push(U)
break
case"DONE":p=X.Sz()}p+=hksz}sOption(t),sOption(c),sOption("ord:"+ord+" ins:"+ins+" smp:"+smp+" hlt:"+hltu+"/"+hltd+" RPB:"+rpb+" spd0:"+spd0+" bpm0:"+bpm0+" st.sep0:"+st0+" mixvol:"+mvol),sOption(instmsg.join("\n"),"ins.text:\n"),sOption(sainmsg.join("\n"),"smp.text:\n")}}else if(X.c("FFFFFFFF",52)&&X.c("1027",348)&&X.c("1027",356))sName="BoyScout module (.BSF)",bDetected=1
else if(X.c("'FUCO'")&&X.c("'DIGI'",17412)&&X.c("'DIGP'",18424)){for(sName="Anthony J. 'Slates' Bybell's BSI Future Composer module (.BSI)",bDetected=1,bad="",smp=smpsz=E=0;E<63;E++)(t=X.U32(17420+16*E,_BE))&&smp++,smpsz+=t,t>131072&&(bad=bad.addIfNone("!badsmpsz"))
""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&sOption("smp:"+smp+" sz:"+outSz(18428+smpsz))}else if(X.c("'NuBEATHOVEN'",34))bDetected=1,sName="Beathoven Synthesizer (.BSS)",sVersion="v"+X.SA(45,3),X.isVerbose()&&(title=X.SA(108,256),auth=X.SA(108+title.length+1,256),misc=X.SA(108+title.length+auth.length+2,256),sOptionT(title),sOptionT(auth,"by: "),sOptionT(misc))
else if(X.c("'CBA'F9")&&26==X.U8(36)&&332+X.U16(37)+48*X.U8(41)<=X.Sz()&&isWithin(X.U8(39),1,32)&&X.U8(43)&&X.U8(44)>=32){if(sName="Chuck Biscuits / Black Artist module (.CBA)",bDetected=1,X.isVerbose()){for(msglen=X.U16(37),ch=X.U8(39),ptn=X.U8(40)+1,ord=X.U8(41),smp=X.U8(42),spd0=X.U8(43),tmp0=X.U8(44),E=smpsz=0;E<smp;E++)smpsz+=X.U32(332+48*E+36)
sz=332+48*smp+64*ptn*5*ch+smpsz,msg=X.SC(sz,msglen,"CP437").trim(),sz+=msglen,sOptionT(X.SA(4,32)),sOption(addEllipsis(msg,192,160),'msg:"','"'),sOption("spd:"+spd0+" tempo:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))}}else if(X.c("'<CUD-FM-File>'1ADEE0")&&(!X.U8(19)&&X.c("'CUD-FM-File - SEND A POSTCARD -'",1537)||X.U8(19)&&X.c("'YsComp'07'CUD1997'1A04",32)))sName="BoomTracker 4 module (.CFF)",sVersion="v"+X.U8(16),bDetected=1,X.U8(19)&&(sVersion+="/LZW-packed"),X.isVerbose()&&sOption(outSz(32+X.U16(17)),"sz:")
else if(X.c("'CHIPv1.0'")){for(sName="Dmitry 'Alone Coder' Bystrov's Chip Tracker module (.CHI)",bDetected=1,sVersion="v"+X.SA(5,1),bad="",X.Sz()<=256&&(bad=bad.addIfNone("!badsz")),ptn=smp=0,tempo=X.U8(40),ord=X.U8(41)+1,lp=X.U8(48),E=0;E<ord;E++)p=X.U8(256+E)+1,p>ptn&&(ptn=p),p>31&&(bad=bad.addIfNone("!badord"))
for(sz=512+512*ptn,E=0;E<16;E++)(ssz=X.U16(45+4*E))&&(smp++,sz+=ssz,255&sz&&(sz+=256-(255&sz)))
bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(decAnsi(8,32,CPSpeccy)),sOption("tempo:"+tempo+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))}else if(X.c("000003F3")&&X.c("70FF4E75'S.PHIPPS'",32)&&0<X.I32(64,_BE)<X.Sz()&&0<X.I32(68,_BE)<X.Sz())sName="Core Design module (.CORE)",bDetected=1,X.isVerbose()&&(title=X.SA(104,256),auth=X.SA(104+title.length+1,256),misc=X.SA(104+title.length+auth.length+2,256),sOptionT(title),sOptionT(auth,"by: "),sOptionT(misc))
else if(X.c("'CAT '................'FORM'"))sName="Cybertracker (not C64) module (.CT)",bDetected=1
else if(X.c("0004'NNTRKMZX'")){if(sName="Cybertracker C64 module (.CT)",bDetected=1,sVersion="v"+X.U8(11)+"."+X.U8(10),X.isVerbose()){for(sng=0;sng<X.U16(1209,_LE)&&0!=X.U8(1211+sng-1);sng++);sng?(sng0ord=X.U8(1211),loop0=X.U8(1725),sng>1?sOption("×"+sng+" ord0:"+sng0ord+" loop0:"+loop0):sOption(" ord:"+sng0ord+" loop:"+loop0)):sOption("empty")}}else if(X.c("0004'NNTRKINS'"))sName="Cybertracker C64 instrument (.CI)",bDetected=1,sVersion="v"+X.U8(11)+"."+X.U8(10),X.isVerbose()&&sOptionT(X.SA(26,16))
else if(X.c("000003F3")&&X.fStr(32,256,"NuDELIRIUM")>0)sName="DeliTracker player addon or Amiga Custom Module (.CUST)",bDetected=1,sVersion="CustomPlay",X.isVerbose()&&sOptionT(X.SA(X.fStr(0,256,"NuDELIRIUM")+20,256))
else if(X.c("'JCH'26026601")&&X.c("'Creative Voice File'1A1A000A01291101......C300",64))sName="Edlib Tracker module samples (.S01)",bDetected=1
else if(X.Sz()<65535&&(X.c("'JCH'26 026600")||X.c("'JCH'26 026680"))&&(X.c("FFFF",X.U16(113,_LE)-2)||X.c("FFFF",X.U16(115,_LE)-2))){for(msgp=0,E=0;E<4;)t=X.U16(113+E,_LE),65535!=t&&t>msgp&&(msgp=t),E+=2
sz=X.fSig(msgp,TOEOF,"FFFF")+2,bDetected=1,bad=0,sName="Edlib Tracker module (.D00,.D01)",sVersion="v"+X.U8(7),X.U8(10)>1&&(bad=1),bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(x=X.U8(9),sOptionT(X.SC(11,32,"CP850")),x>1&&sOption(x,"×"),sOptionT(X.SC(43,32,"CP850"),"by: "),sOptionT(X.SC(msgp,sz-msgp-2,"CP850")),sOption(outSz(sz),"sz:"))}else if(X.c("'DBM0'........'NAME'0000002C")&&X.U8(4)<4&&X.c("'INFO'0000000A",60)&&X.c("'SONG'",78)&&X.U16(68,_BE)<=255&&X.U16(70,_BE)<=255&&X.U16(74,_BE)<=1024&&X.U16(76,_BE)>=4&&X.U16(76,_BE)<=254&&!(X.U16(76,_BE)%1)){for(sName="DigiBooster Pro module (.DBM)",bDetected=1,sVersion="v"+X.U8(4)+"."+X.U8(5).padStart(2,"0"),p=8,done=gotinfo=!1,bad="",X.isVerbose()&&(ord=[]),insts=[],titles=[];!done&&p<X.Sz();){switch(hkhd=X.SA(p,4),hksz=X.U32(p+4,_BE),p+=8,hkhd){case"INFO":x=X.U16(p+4,_BE),ins=X.U16(p,_BE),ss="ch:"+X.U16(p+8,_BE)+" ptn:"+X.U16(p+6,_BE)+" ins:"+ins+" smp:"+X.U16(p+2,_BE),gotinfo=!0
break
case"SONG":if(!gotinfo){bad=bad.addIfNone("!badchunkorder")
break}if(!X.isVerbose())break
for(U=0;U+44<hksz;)t=X.SC(p+U,44,"CP1250").trim(),titles.push(t),U+=44,ord.push(X.U16(p+U,_BE)),U+=2+2*ord[ord.length-1]
break
case"INST":if(!gotinfo){bad=bad.addIfNone("!badchunkorder")
break}for(E=0;E<ins;E++)t=X.SA(p+50*E,34).trim(),""!=t&&insts.push(t),c3freq=X.U32(p+50*E+34,_BE),(c3freq<2e3||c3freq>192e3)&&(bad=bad.addIfNone("!badc3freq"))
break
case"SMPL":gotinfo||(bad=bad.addIfNone("!badchunkorder")),done=!0}p+=hksz}(!done||p>X.Sz())&&(bad=bad.addIfNone("!short")),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(title=X.SA(16,44).trim(),sOption(title),sOption(titles.join("; "),title||1!=title.length?"":"songs:"),""!=title||titles.length||sOptionT(X.SA(216,28)),x>1&&sOption(x,"×"),sOptionT(addEllipsis(insts.join(" "),256,160),'smp/msg: "','"'),ss="ord:"+ord.join("+")+" "+ss,sOption(ss+" sz:"+outSz(p)))}else if(X.c("'DFM'1A"))sName="Digital FM module (.DFM)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(7,32))
else if(X.c("'DSNGSEQU'00"))sName="David Hanney's module (.DH)",bDetected=1
else if(X.c("'DIGI Booster module'00")&&X.Sz()>=1572&&X.U8(25)&&X.U8(25)<=8&&X.U8(47)<=127){if(sName="DigiBooster module (.DIGI)",bDetected=1,nV=X.U8(24),sVersion="v"+(nV>>4)+"."+(15&nV),co=X.U8(26),sVersion!=X.SA(20,4).toLowerCase()&&(sVersion+='/"'+X.SA(20,4)+'"'),co&&(sVersion=sVersion.appendS("co.ptn","/")),X.isVerbose()){for(sOptionT(decAnsi(610,32,CPAmiga,!0)),msg=[],ch=X.U8(25),ord=X.U8(47)+1,ptn=X.U8(46)+1,smp=ssz=0,E=0;E<31;E++)(M=X.U32(176+4*E,_BE))&&(smp++,ssz+=M)
for(E=0;E<31;E++)""!=(D=decAnsi(642+30*E,30,CPAmiga,!0).trim())&&msg.push(D)
if(sz=1572,co)for(E=0;E<ptn&&sz<=X.Sz();E++)sz+=2+X.U16(sz,_BE)
else sz+=256*ptn*ch
sz+=ssz,sz>X.Sz()&&(sVersion=sVersion.appendS("malformed!short","/")),sOptionT(addEllipsis(msg.join(" "),256,160),'by/msg: "','"'),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))}}else if(X.c("000003F3")&&X.c("70FF'NuUNCLEART'",32)&&X.U8(20)&&X.U32(44,_BE)&&X.U32(48,_BE)&&X.U32(56,_BE)){if(sName="Dave 'Uncle Tom' Lowe module (.DL)",bDetected=1,X.isVerbose()){if(smpip=32+X.U32(60,_BE),smpiep=32+X.U32(64,_BE),smpiep?smp=Math.floor((smpiep-smpip)/14):smp=0,title=X.SA(32+X.U32(80,_BE),256),auth=X.SA(32+X.U32(84,_BE),256),cmt=X.SA(32+X.U32(88,_BE),256),loadsz=32+X.U32(92,_BE),sz=32+X.U32(96,_BE),sza=Hex(X.Sz()-sz),smpsz=32+X.U32(100,_BE),songsz=32+X.U32(104,_BE),sfx=32+X.U32(108,_BE),x=1,d1=32+X.U32(76,_BE),d1)for(a1=d1;a1+=16,d1=X.U32(a1,_BE),d1&&(d1-=X.U8(a1+3),d1);)x++
sOptionT(title),x>1&&sOption(x,"×"),sOptionT(auth,"by: "),sOptionT(cmt),sOption("smp:"+smp+" sfx:"+sfx)}}else if(X.c("'ALL '00"))sName="Delta Music module (.DM)",sVersion="v1.3",bDetected=1
else if(X.c("4A00670003B40C000001670001EC0C000002670A0C000003671270004E7541FA0B680201003F11",4)&&X.c("0000'.FNL'",3012))sName="Delta Music 2 module (.DM2)",sVersion="v2.0",bDetected=1
else if(X.c("'DMF'0E"))sName="Digital Sound and Music Interface Advanced Music Format hack (.DMF)",sOption("delta samples & no text"),bDetected=1
else if(X.c("'DDMF'")&&X.U8(4)&&X.U8(4)<=10&&X.U16(63)&&X.c("'CMSG'",66)){for(sName="X-Tracker module (.DMF)",bDetected=1,nV=X.U8(4),sVersion="v"+nV,p=66,hkhd=hksz=end=lpst=ch=ord=ptn=smp=sz=ptntotallen=0,lped=65535;"ENDE"!=hkhd&&p<X.Sz();){switch(hkhd=X.SA(p,4),hksz=X.U32(p+4),p+=8,hkhd){case"SEQU":ord=0,3==nV?p+=2:4==nV&&(p+=4),u=p,nV>=3&&(lpst=X.U16(u),u+=2),nV>=4&&(lpst=X.U16(u),u+=2),4===nV&!lped&&(lped=65535),ord=p+hksz-u>>1
break
case"PATT":var _=nV<3?9:8
for(u=p,ptn=X.U16(u),trk=X.U8(u+2),u+=3,ch=trk,ch<1&&(ch=1),ch>32&&(ch=32),E=0;E<ptn;E++){u+=_-4
var O=X.U32(u)
ptntotallen+=O,u+=O}break
case"SMPI":u=p,smp=X.U8(u++)
var B=0
for(E=0;E<smp;E++){var A=nV<2?30:X.U8(u++),D=X.SC(u,A,"CP437").trim()
u+=A
var M=X.U32(u)
B+=M,u+=14
var T=X.U8(u++),I=X.U8(u++)
if(nV>=8){X.SC(u,8,"CP437")
u+=8}u+=nV>1?6:2}break
case"SMPD":if(!X.c("'ENDE'",p+hksz)){if(t=X.fSig(p,Math.min(X.Sz()-p,3*B),"'ENDE'"),t<0){sVersion+="/malformed!noeof",hkhd="ENDE"
break}hksz=t-p}break
case"ENDE":p-=4+hksz}sz=p,p+=hksz}if("ENDE"!=hkhd?sVersion+="/malformed!short":sz=p,X.isVerbose()){sOptionT(X.SC(13,30,"CP437")),sOptionT(X.SC(43,20,"CP437"),"by: "),yy=X.U8(65),yy<80?yyyy="20":yyyy="19",yyyy+=yy.padStart(2,"0"),sOptionT(yyyy+"-"+X.U8(64).padStart(2,"0")+"-"+X.U8(63).padStart(2,"0"),"on: "),sOptionT(X.SA(5,8),"in: "),cmt="",cnt=X.U32(70)-1
for(var C=75;cnt;){var N=Math.min(cnt,40,512),P=X.SC(C,N,"CP437")
""!=P&&(cmt=cmt.appendS(P,"\n")),cnt-=N,C+=N}sOption(addEllipsis(cmt,256,128)),sOption("ch:"+ch+"+1 ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))}}else if(X.c("'.DelekDefleMask.'")){if(sName="DeFleMask module (.DMF)",bDetected=1,sVersion="v"+X.U8(16),X.isVerbose()){switch(X.U8(17)){case 1:sVersion+="#YMU759",ch=17
break
case 2:sVersion+="#Genesis (10ch)",ch=10
break
case 3:sVersion+="#SMS (4ch)",ch=4
break
case 4:sVersion+="#GameBoy (4ch)",ch=4
break
case 5:sVersion+="#PCEngine (6ch)",ch=6
break
case 6:sVersion+="#NES (5ch)",ch=5
break
case 7:case 71:sVersion+="#C64 (3ch)",ch=3
break
case 8:sVersion+="#YM2151 (13ch)",ch=13
break
default:ch=4}sOption(X.UCSD(18)),l=X.U8(18),p=18+l+1,sOption(X.UCSD(p),"by: "),l=X.U8(p),p+=l+1+2,tbase=X.U8(p++),tick1=X.U8(p++),tick2=X.U8(p++),Hz=X.U8(p++)?"60(NTSC)":"50(PAL)",X.U8(p++)?Hz=X.U8(p++)+":"+X.U8(p++)+":"+X.U8(p++):p+=3,sOption("tbase:"+tbase+" tck:"+tick1+":"+tick2+" freq:"+Hz)}}else if(X.c("' M'........'IAN'")&&X.c("0000....0000....0000....0000",28)&&(smp=X.U32(68,_BE))<=255&&(!(smpsz=X.U32(72,_BE))||smp||smp&&smpsz)&&isWithin(ins=X.U32(60,_BE),1,255)){if(sName="Reinier 'Rhino' van Vliet's Digital Mugician module (.DMU,.MUG)","/"==(sv=X.SA(9,1))?sVersion="v1":"2"==sv&&(sVersion="v2"),bDetected=1,X.isVerbose()){for(x=ord=0,ptn=X.U16(26,_BE),wf=X.U32(64,_BE),E=76,p=28,a2=204;E<204&&X.U32(E,_BE);E+=16,p+=4){for((1!=X.U32(p,_BE)||X.U32(a2,_BE)||X.U32(a2+4,_BE))&&x++,a2+=X.U32(p,_BE)<<3,t=X.SA(E+4,12);t[t.length-1]<" ";)t=t.slice(0,t.length-1)
sOptionT(t)}for(E=28;E<60;E+=4)ord+=X.U32(E,_BE)
sz=32*smp+16*ins+smpsz+460+256*ptn+128*wf+8*ord,x>1&&sOption(x,"×"),sOption("ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp/syn:"+smp+"+"+wf+" sz:"+outSz(sz))}}else if(X.c("'DBRAWOPL'")&&(4278255360&(t=X.U32(8))?(sVersion="v0",mV=MV=0):65535&t?(MV=X.U16(8),mV=X.U16(10)):(mV=X.U16(8),MV=X.U16(10)),MV<=3)){switch(sName="DOSBox Raw OPL chiptune (.DRO)",bDetected=1,MV&&(sVersion="v"+MV+"."+mV.padStart(2,"0")),db="",MV){case 0:db="DOSBox 0.62",lenMS=X.U32(8),dtsz=X.U32(12),hw=X.U8(16),dtofs=17
case 1:1==MV&&(db="DOSBox 0.63",lenMS=X.U32(12),dtsz=X.U32(16),hw=(t=X.U32(20))<=255?t:255,dtofs=24),1==hw?hw=2:2==hw&&(hw=1),fmt=0,co=0
break
case 2:if(db="DOSBox 0.73",dtsz=X.U32(12)<<1,lenMS=X.U32(16),hw=X.U8(20),fmt=X.U8(21),co=X.U8(22),ds=X.U8(23),dl=X.U8(24),regcmdcnt=X.U8(25),dtofs=26+regcmdcnt,regcmdcnt>128&&(regcmdcnt=128),regmap=X.readBytes(26,regcmdcnt),1==hw){for(p=dtofs,opl3on=0,reginit=[],E=0;E<512;E++)reginit[E]=!1
for(;p<X.Sz()&&(t=X.U8(p),t!=ds&&t!=dl)&&!((127&t)>=regcmdcnt);)creg=(128&t)<<1|regmap[127&t],reginit[creg]=!0,261==creg&&(opl3en=X.U8(p+1)),p+=2
reginit[261]&&1&opl3en&&(hw=2)}}hw=["YM3812 (OPL2)","YM3812 (Dual OPL2)","YMF262 (OPL3)"].indexOf(hw),-1===hw&&(hw="YMF262(portshift)"),sVersion=sVersion.appendS(hw,"#"),X.isVerbose()&&sOption("len: "+secondsToTimeStr(Util.divu64(lenMS+500,1e3))+" via: "+db+" packed:"+co+" sz:"+outSz(dtofs+dtsz))}if(!bDetected)if(X.c("'DSM'10")&&X.c("1A",36)&&X.U16(178)-X.U16(176)==4&&X.c("'DSI'10",X.U16(176)<<4)&&X.c("'DSI'10",X.U16(176+2*X.U8(39)-2)<<4)){if(sName="Digital Audio Sound Interface Kit module (.DSM)",bDetected=1,X.isVerbose()){for(E=175;E>=48&&255==X.U8(E);E--);for(rord=E-47,mptn=0;E>=48;E--)(t=X.U8(E)+1)>mptn&&(mptn=t)
for(ord=X.U8(38),ptn=X.U8(40),p=X.U16(176)<<4,inss=[],mp=0,E=ins=0;E<X.U8(39);E++,p+=64)X.c("'DSI'10",p)||(bad=bad.addIfNone("!badins")),t=X.SC(p+4,32,"CP437").trim(),t.length&&inss.push(t),(is=X.U16(p+36)<<4)&&ins++,is>mp&&(mp=is+X.U16(p+38))
p=176+2*X.U8(39)+2*ptn-2,p=X.U16(p)<<4,p+=2+X.U16(X.U16(p)),sz=Math.max(mp,p),sOptionT(X.SC(4,32,"CP437")),sOption(addEllipsis(inss.join(" "),160),'ins/msg:"','"'),sOption("ord:"+(rord==ord?"":rord+"/")+ord+" ptn:"+(mptn==ptn?"":mptn+"/")+ptn+" ins:"+ins+" sz:"+outSz(sz))}}else if(X.c("'RIFF'........'DSMFSONG'")&&X.U16(54)<=128&&X.U16(56)<=128&&X.U16(60)<=256&&X.U16(62)<=16){if(sName="Digital Sound Interface Kit module (.DSM)",bDetected=1,sVersion="RIFF",X.isVerbose()){for(sOptionT(X.SC(20,28,"CP437")),sz=X.U32(4)+8,p=12,smp=0;p<sz;)hkhd=X.SA(p,4),hksz=X.U32(p+4),p+=8,"INST"==hkhd&&smp++,p+=hksz
p>X.Sz()&&(sVersion+="/malformed!badchunk"),sOption("ch:"+Math.max(1,X.U16(62))+" spd0:"+X.U8(66)+" bpm0:"+X.U8(67)+" ord:"+X.U16(56)+"("+X.U16(52)+"-"+X.U16(54)+") ptn:"+X.U16(60)+" smp:"+X.U16(58)+"/"+smp+" sz:"+outSz(sz))}}else if(X.c("02011313 1412010B 0.")){if(sName="Digital Symphony module (.DSYM)",bDetected=1,sVersion="v"+X.U8(8),X.isVerbose()){var R=X.U16(14,_LE),W=X.U8(16)
for(infolen=(W<<16)+R,p=17,E=0;E<63;E++)128&X.U8(p)?p++:p+=3
sOption(X.UCSD(p)),sOption("ch:"+X.U8(9)+" ord:"+X.U16(10,_LE)+" trk:"+X.U16(12,_LE))}}else if(X.c("'DSm'1A20"))sName="Dynamic Studio Pro module (.DSM)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(5,20)),sOptionT(X.SA(25,20),"by: "))
else if(X.c("'DSFmt1'0D0A"))sName="DreamStation module (.DSS)",bDetected=1,sVersion="v1.0",X.isVerbose()&&(pt=X.fSig(0,TOEOF,"F0E40001")+4,pt<4&&(pt=X.fSig(0,TOEOF,"F0E40000")+4),pt>=4&&(pa=X.fSig(pt,TOEOF,"0D0A"),t=X.SA(pt,pa-pt),pa+=2,pc=X.fSig(pa,TOEOF,"0D0A"),a=X.SA(pa,pc-pa),pc+=2,c=X.SA(pc,X.Sz()-pc),sOption(t),sOption(a,"by: "),sOption(c)))
else if(X.c("'DS2F0'....'Default'"))sName="DreamStation II module (.DS2)",bDetected=1,sVersion="v2",X.isVerbose()&&(ts=X.U8(98),t=X.SA(99,ts),pa=98+ts+1,as=X.U8(pa),a=X.SA(pa+1,as),pc=pa+as+1,cs=X.U8(pc),c=X.SA(pc+1,cs),sOption(t),sOption(a,"by: "),sOption(c))
else if(X.c("'MMU2'00"))sName="Digital Sound Studio module (.DSS)",bDetected=1,sVersion="v1-3.0",X.isVerbose()&&(sOptionT(X.SA(10,32)),sOption("ord:"+X.I16(1436,_BE)))
else if(X.c("'DTL'00"))sName="Drum Traker module (.DTL)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(4,20))
else if(X.c("'D.T.'00"))sv=["S.Q.","VERS"].indexOf(X.SA(42,4)),sv>=0&&(sName="Digital Tracker module (.DTM)",bDetected=1,X.isVerbose()&&(0==sv?sOptionT(X.SA(22,20)):sOptionT(X.SA(22,24))))
else if(X.c("'DeFy DTM'"))sName="DeFy AdLib Tracker module (.DTM)",bDetected=1,sVersion="v"+X.SA(9,3),X.isVerbose()&&(sOptionT(X.SA(13,20)),sOptionT(X.SA(33,20)))
else if(X.c("'SONG'........'NAME'"))sName="DigiTrekker module (.DTM)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(16,20))
else if(X.c("48E7F1FE610000964CDF7F8F'NuH'E70010610000'$L'DF0800'NuH'E7F1FE610001844CDF7F8F'NuH'E70010610000'NL'DF0800'NuG'FAFFC651EB05',Q'EB05'PQ'EB05'tQ'EB059833FC000F00DFF09633FC00FF00DFF09E33FC000000DFF0A833FC000000DFF0B833FC000000DFF0C833FC000000DFF0D8'NuG'FAFF80177C00010524177C00010548177C0001056C177C00010590'NuG'FAFF'bJ+'00BA670E'S+'00B96608177C000600B9'Nu`'0003180006"))sName="David Whittaker's SFX module (.DW)",bDetected=1
else if(X.c("' PWD'03")&&X.c("'Master'",14))sName="DarkWave Studio module (.DWP)",bDetected=1
else if(X.c("'EASO'"))sName="EarAche module (.EA,.EAS)",bDetected=1
else if(X.c("'FORM'.... ....'EMODEMIC'")&&X.c("'PATT'",pt=20+X.U32(16,_BE))&&X.c("'8SMP'",U=pt+8+X.U32(pt+4,_BE))){for(sName="Bo Lincoln's Quadra Composer module (.EMOD)",bDetected=1,sVersion="v"+X.U16(20,_BE),smp=X.U8(63),smp&&(smps=[]),sz=X.U32(4,_BE)+8,E=ssz=0,p=64;E<smp;E++,p+=34)""!=(t=X.SC(p+4,20,"CP1252").trim())&&smps.push(t),ssz+=X.U16(p+2,_BE)<<1
bad="",ssz!=X.U32(U+4,_BE)&&(bad=bad.addIfNone("!badsmplen:"+X.U32(U+4,_BE)+" vs "+ssz)),ptn=X.U8(++p),p++,p+=26*ptn,X.c("'MDIN'",q1=U+8+X.U32(U+4,_BE))&&(U=q1),Math.abs(sz-(sz1=U+8+X.U32(U+4,_BE)))>1&&(bad=bad.addIfNone("!badlen:"+sz+" vs "+sz1)),sz<sz1&&(sz=sz1),ord=X.U8(p++),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT("<sans titre>"===(t=X.SA(22,20))?"":t),smp&&sOptionT(addEllipsis(smps.join(" "),192,160),'smp/msg: "','"'),delete smps,sOption("bpm:"+X.U8(62)+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))}else if(X.c("'E.M.S. V6.0'..00010000")&&isWithin(X.U8(11),49,54))sName="Sean Connolly's Electronic Music System module (.EMS)",bDetected=1,sVersion="v6."+X.SA(10,2),X.isVerbose()&&(a1=X.U32(14,_BE),a2=X.U32(18,_BE),a3=X.U32(22,_BE),p=lb0=34,p+=a1,lb4=p,p+=a2,lb8=p,p+=a3,insp=p,sz=p+X.U32(30,_BE),sOption("sz:"+outSz(sz)))
else if(X.c("'ENF '....'scor'")){for(sName="Extended Notation Format sheet music (.ENF)",bDetected=1,p=6,staf=brln=0,hkhd="dumm";p<X.Sz()&&(hkhd=X.SA(p,4),/[a-z\[\]\-0-9]{4}/.test(hkhd));)hksz=X.U16(p+4,_BE),"staf"===hkhd?staf++:"brln"===hkhd&&brln++,p+=hksz
sOption("staves:"+staf+" bars:"+brln+" sz:"+outSz(p))}else if(X.Sz()>36&&X.c("'ETracker (C) BY ESI.'",10)||X.Sz()>1236&&(X.c("21B384")||X.c("21B304"))&&X.c("'ETracker (C) BY ESI.'",1213)){for(sName="SAM Coupé E-Tracker file (.ETC,.SAA)",bDetected=1,X.c("21B384")||X.c("21B304")?(sVersion="&player",ofs=1203):ofs=0,p=ofs,x=mp=sz=0,ords=[],ptns=[];p<X.Sz()-36&&X.c("'ETracker (C) BY ESI.'",p+10);){if(x++,ordp=p+X.U16(p),ordp>mp&&(mp=ordp),ptnp=p+X.U16(p+2),ptnp>mp&&(mp=ptnp),smpp=p+X.U16(p+4),smpp>mp&&(mp=smpp),ornp=p+X.U16(p+6),ornp>mp&&(mp=ornp),svd=ofs+X.U16(p+6),svd>mp&&(mp=svd),sz<mp&&(sz=mp),1==x&&sz>X.Sz())return!1
ord=lp=xpos=ptn=0
for(p=ordp;p<X.Sz();p++){if(o=X.U8(p),255==o){p++
break}if(254==o)lp=ord
else if(o>=96)xpos=o-96
else{if(1==x&&o%3)return _log("SAAFault @"+Hex(p)+": trk "+x+" pos not divisible by 3"),!1
if(o=Util.div64(o,3),1==x&&o>31)return _log("SAAFault: trk "+x+" pos over 1Fh"),!1
o>ptn&&(ptn=o),ord++}if(ord>254)return _log("SAAFault: trk "+x+" pos not divisible by 3"),!1}if(!ord)return!1
for(ords.push(++ord),ptns.push(++ptn),sz<p&&(sz=p),p=ptnp+12*ptn,E=ptnp;E<p;E+=2)if((t=X.U16(E))>mp-ofs&&(mp=ofs+t),t<30)return!1
if(1==x&&mp>X.Sz())return!1
if(notes=-1,t>p)for(p=t+64,p=ptnp,notes=0,chncnt=[64,64,64,64,64,64],l=0;l<64;l++)for(c=0;c<6;c++)if(chncnt[c])chncnt[c]--
else for(;p<X.Sz();){if(cmd=X.U8(p++),cmd>=210){chncnt[c]-=cmd-210
break}if(cmd>=114)notes++
else if(cmd>=82);else if(cmd>=81)break}sz<p&&(sz=p),ornp==mp&&sz<mp&&(sz=mp),smpp==mp&&sz<mp&&(sz=mp),svd==mp&&sz<mp&&(sz=mp)}X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("ord:"+ords.join("+")+(lp?" looped":"")+" ptn:"+ptns.join("+")+(xpos?" xpos:"+xpos:"")+(notes>-1?" notes:"+notes:"")+" sz:"+outSz(sz)))}else if(X.Sz()>2060&&X.c("00000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",993)&&X.c("......00 ......00 ......00 ......00 ......00 ......00 ......00",1236))sName="Euphony module (.EUP)",bDetected=1,X.isVerbose()&&sOption(X.SC(0,32,"CP932"))
else if(X.c("'FAR'FE")&&X.c("0D0A1A",44)){if(bDetected=1,nV=X.U8(49),sName="Daniel Potter/Digital Infinity's Farandole Composer module (.FAR)",sVersion="v"+(nV>>4)+"."+(15&nV),X.isVerbose()){sOptionT(X.SC(4,40,"CP850"))
var H=X.U16(96,_LE)
sOption(X.SC(98,H,"CP850").trim().slice(0,256).trim()+"..."),sOption("ord:"+X.U8(H+355)+" ptn:"+X.U8(H+354)+" lp:"+X.U8(H+356))}}else if(X.c("'FPT'FE")&&X.c("0D0A1A",36))sName="Daniel Potter/Digital Infinity's Farandole Composer pattern (.FPT)",bDetected=1,X.isVerbose()&&sOptionT(X.SC(4,32,"CP850"))
else if(X.c("'FSM'FE")&&X.c("0A0D1A",36))sName="Daniel Potter/Digital Infinity's Farandole Composer sample (.FSM)",bDetected=1,X.isVerbose()&&(sOptionT(X.SC(4,32,"CP850")),X.U8(53)?type="16bit":type="8bit",4&X.U8(54)?looped=" looped":looped="",sVersion=type+looped,sOption(outSz(X.U32(39)),"sz:"))
else if(X.c("'SMOD'")&&X.Sz()>112&&isWithin(X.U32(8,_BE),112,X.Sz())&&isWithin(X.U32(16,_BE),112,X.Sz())&&isWithin(X.U32(24,_BE),112,X.Sz())&&isWithin(X.U32(32,_BE),112,X.Sz())){if(sName="Superions' Future Composer module (.FC,.FC13,.SMOD)",sVersion="v1.0~3",bDetected=1,X.isVerbose()){for(ordsz=X.U32(4,_BE),ordsz+=ordsz%2,ord=Util.divu64(ordsz,13),ord||(ord=1),ptnp=X.U32(8,_BE),ptnsz=X.U32(12,_BE),ptn=ptnsz>>6,smpp=X.U32(32,_BE),smpsz=X.U32(36,_BE),smp=wf=0,sszs=[],p=40,E=0;E<10;E++,p+=6)(t=X.U16(p,_BE)<<1)&&smp++,sszs.push(t)
for(E=10;E<90;E++)sszs.push(X.U8(p++)<<1)
for(E=89;E>=10&&!sszs[E];E--);wf=E-9,delete sszs,sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" wf:"+wf+" sz:"+outSz(smpp+smpsz))}}else if(X.c("'FC14'")&&X.Sz()>192&&isWithin(X.U32(8,_BE),192,X.Sz())&&isWithin(X.U32(16,_BE),192,X.Sz())&&isWithin(X.U32(32,_BE),192,X.Sz())&&isWithin(X.U32(36,_BE),192,X.Sz())){if(sName="Superions' Future Composer module (.FC,.FC14)",sVersion="v1.4",bDetected=1,X.isVerbose()){for(ordsz=X.U32(4,_BE),ord=Util.divu64(ordsz,13),ord||(ord=1),ptnp=X.U32(8,_BE),ptnsz=X.U32(12,_BE),ptn=ptnsz>>6,smpp=X.U32(32,_BE),wfp=X.U32(36,_BE),smp=10,rsmp=msmp=wf=0,sszs=[],p=40,E=0;E<10;E++,p+=6)sszs.push(X.U16(p,_BE)<<1)
for(sz=0,E=10;E<90;E++)sz+=t=X.U8(p++)<<1,sszs.push(t)
for(E=89;E>=10&&!sszs[E];E--);for(wf=E-9,sz+=X.U32(36,_BE),p=smpp,E=0;E<10;E++)if(rsmp++,sszs[E]&&X.c("'SSMP'")){for(mszs=[],p+=4,msmp++,smp--,rsmp--,j=0;j<20;j++,p+=20)mszs.push(X.U16(p+4,_BE)<<1)
for(j=0;j<20;j++)mszs[j]&&rsmp++
smp++}delete sszs,delete mszs,sOption("ord:"+ord+" ptn:"+ptn+" smp:"+rsmp+(smp!=rsmp?"("+smp+")":"")+(msmp?" ssmp:"+msmp:"")+" wf:"+wf+" sz:"+outSz(sz))}}else if(X.c("'FMK!'")){if(sName="FM-Kingtracker module (.FMK)",bDetected=1,X.isVerbose()){for(text=!0,E=0;E<56;E++)if(32>X.U8(E+4)){text=!1
break}text&&(sOptionT(X.SA(4,28)),sOptionT(X.SA(32,28),"by: "))}}else if(X.c("'FMTracker'....'The FM Tracker!'"))sName="FM Tracker module (.FMT)",bDetected=1,sVersion="v"+X.U8(9)+"."+X.U8(10),X.isVerbose()&&sOptionT(X.SA(31,32))
else if(X.c("'FMTRK'1A"))sName="FM Tracker (Adlib) module (.FMT)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(16,32))
else if(X.c("000003F3")&&X.U8(20)&&X.c("70FF4E75'F.PLAYER'",32)&&X.I32(64,_BE)){if(sName="Future Player module (.FP)",bDetected=1,X.isVerbose()){sOptionT(X.SA(X.I32(44,_BE)+32,256)),x=1,p=72
do{t=X.U32(p,_BE),t&&x++,p+=8}while(t)
x>1&&sOption(x,"×"),sOptionT(X.SA(X.I32(48,_BE)+32,256),"by:"),sOptionT(outSz(X.I32(56,_BE)+32),"sz:")}}else if(X.c("'Fred Editor '0000")&&X.U16(14,_BE)<=10){for(p=16+1025*(x=X.U16(14,_BE)),spds=[],E=16;E<16+x;E++)spds.indexOf(t=X.U8(E))<0&&spds.push(t)
if(p<X.Sz())for(E=0;E<128&&p<X.Sz();E++)trksz=X.U32(p,_BE),p+=trksz+4
if(p<X.Sz())for(ins=X.U16(p,_BE),p+=2,E=syn=un=0;E<ins&&p<X.Sz();E++){if(255===X.U8(p+83))un++
else syn++
p+=96}for(smp=X.U16(p,_BE),syn-=smp,p+=2,E=0;E<smp&&p<X.Sz();E++)p+=4+X.U16(p+2,_BE)
X.c("12345678",p)&&(bDetected=1,sz=p+4),bDetected&&(sName="Fred & Julien Clermonte's Fred Editor module (.FRED,.MOD)",sVersion="project",X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("tempos:"+spds.sort().join("-")+" ins:"+(ins-un)+(un?"("+ins+")":"")+(smp?" smp:"+smp:"")+(syn?" syn:"+syn:"")+" sz:"+outSz(sz))))}if(!bDetected)if(X.c("'Module: '")&&X.c("';Fast Tracker v1.00'",50))sName="Fast Tracker module (.FTС)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(8,42))
else if(X.c("'FTMN'03")&&X.U8(5)<64&&X.U16(8,_BE)>=4096&&X.U16(8,_BE)<20480&&X.U8(10)<12&&X.U8(12)<64&&!(252&X.U8(13))&&X.U8(14)&&X.U8(14)<=24&&X.U8(15)>=4&&X.U8(15)<=96&&X.U8(15)==Util.div64(96,X.U8(14))&&X.U8(80)<=64&&!X.U8(81)&&X.Sz()>=82+32*X.U8(5)+4*X.U8(80)){if(sName="Face the Music module (.FTM)",sVersion="v"+X.U8(4),bDetected=1,X.isVerbose()){for(smp=X.U8(5),msr=X.U16(6,_BE),bpm0=(1766278.163/X.U16(8,_BE)).toFixed(0),fl=X.U8(13),fx=X.U8(80),gvol0=X.U8(12),p=82+32*smp,realsmp=0,E=0;E<smp;E++)X.U8(82+32*E)&&realsmp++
for(fxln=0,ticksper=X.U8(14),rowsper=X.U8(15),E=0;E<fx;E++)t=X.U16(p,_BE),fxln+=t,p+=4+4*t
if(msr)for(E=0;E<8;E++)p+=6+X.U32(p+2,_BE)
if(1&fl)for(E=0;E<realsmp;E++)p+=4+2*(X.U16(p,_BE)+X.U16(p+2,_BE))
sOptionT(decAnsi(16,32,CPAmiga)),sOptionT(decAnsi(48,32,CPAmiga),"by: "),sOption("bpm0:"+bpm0+" ptn:"+msr+" smp:"+realsmp+"/"+smp+" fx:"+fx+"/"+fxln+" msr:"+ticksper+"/"+rowsper+(1&fl?"":" ext.smps")+" gvol0:"+gvol0+" sz:"+outSz(p))}}else if(X.c("'FMS!'..000000"))sName="FamiStudio module (.FMS)",bDetected=1,sVersion="v"+X.U8(4)
else if(X.c("'FamiTracker Module'"))sName="FamiTracker module (.FTM)",bDetected=1,X.isVerbose()&&(itag=X.fStr(20,256,"INFO\0"),sOptionT(X.SA(itag+24,32)),sOptionT(X.SA(itag+56,32),"by: "),sOptionT(X.SA(itag+88,32)))
else if(X.c("'-Furnace '")){switch(X.SA(9,7)){case"module-":cV="m",bDetected=1,sName="Furnace Tracker module (.FUR)"
break
case"instr.-":cV="i",bDetected=1,sName="Furnace Tracker instrument (.FUI)"
break
case"waveta-":cV="w",bDetected=1,sName="Furnace Tracker wavetable (.FUW)"
break
default:cv="?",bDetected=1,sName="unknown Furnace Tracker file"}if(nV=X.U16(16,_LE),nV<12?sVersion="["+nV+"]":nV<=14?sVersion="v0.2.x":nV<=16?sVersion="v0.3.x":nV<=27?sVersion="v0.4.x":nV<35?sVersion="["+nV+"]":nV<=54?sVersion="v0.5.x":nV<57?sVersion="["+nV+"]":75==nV?sVersion="v.dev75/April Fools' 0.6pre0":nV<=99?sVersion="v.dev"+nV:100==nV?sVersion="v0.6pre1":101==nV?sVersion="v0.6pre1 (dev101)":102==nV?sVersion="v0.6pre1 (dev102)":nV<=115?sVersion="v.dev"+nV:116==nV?sVersion="v.0.6pre1.5":nV<=131?sVersion="v.dev"+nV:132==nV?sVersion="v.0.6pre2":133==nV?sVersion="v.0.6pre3":nV<=140?sVersion="v.dev"+nV:141==nV?sVersion="Tournament Edition":142==nV?sVersion="v.dev"+nV:143==nV?sVersion="v.0.6pre4":nV<=145?sVersion="v.dev"+nV:146==nV?sVersion="v.Pro (joke edition)":nV<=157?sVersion="v.dev"+nV:158==nV?sVersion="v.0.6pre5":nV<=160?sVersion="v.dev"+nV:161==nV?sVersion="v.0.6pre6":162==nV?sVersion="v.0.6pre7":sVersion="["+nV+"]","i"===cV&&(p=X.U32(20,_LE),p>0&&X.c("'INST'",p))){switch(ity=X.U16(16,_LE),ity){case 0:sVersion+="/std"
break
case 1:sVersion+="/FM (OPM/OPN)"
break
case 2:sVersion+="/Game Boy"
break
case 3:sVersion+="/C64"
break
case 4:sVersion+="/Amiga|smp"
break
case 5:sVersion+="/PC Engine"
break
case 6:sVersion+="/AY-3-8910"
break
case 7:sVersion+="/AY8930"
break
case 8:sVersion+="/TIA"
break
case 9:sVersion+="/SAA1099"
break
case 10:sVersion+="/VIC"
break
case 11:sVersion+="/PET"
break
case 12:sVersion+="/VRC6"
break
case 13:sVersion+="/OPLL"
break
case 14:sVersion+="/OPL"
break
case 15:sVersion+="/FDS"
break
case 16:sVersion+="/Vritual Boy"
break
case 17:sVersion+="/Namco 163"
break
case 18:sVersion+="/SCC"
break
case 19:sVersion+="/OPZ"
break
case 20:sVersion+="/POKEY"
break
case 21:sVersion+="/PC Speaker"
break
case 22:sVersion+="/WonderSwan"
break
case 23:sVersion+="/Lynx"
break
case 24:sVersion+="/VERA"
break
case 25:sVersion+="/X1-010"
break
case 26:sVersion+="/VRC6(saw)"
break
case 27:sVersion+="/ESS5506"
break
case 28:sVersion+="/MultiPCM"
break
case 29:sVersion+="/SNES"
break
case 30:sVersion+="/Sound Unit"
break
case 31:sVersion+="/Namco WSG"
break
default:sVersion+="/unk"}X.isVerbose()&&(wvt=X.U16(p+24,_LE),smp=X.U16(p+26,_LE),sOptionT(X.SC(p+12,512,"UTF8")),sOption(" wvt:"+wvt+" smp:"+smp))}if("m"===cV&&X.isVerbose()&&(p=X.U32(20,_LE),p>0&&X.c("'INFO'",p))){for(t=X.SC(p+256,512,"UTF8"),p1=X.fSig(p+256,512,"00")+1,a=X.SC(p1,512,"UTF8"),p1=X.fSig(p1,512,"00")+1,ins=X.U16(p+22,_LE),wvt=X.U16(p+24,_LE),smp=X.U16(p+26,_LE),ptng=X.U32(p+28,_LE),freq=X.F32(p+12,_LE),A4freq=X.F32(p1,_LE),s1spd=X.U8(p+9)+"/"+X.U8(p+10),s1ptn=X.U16(p+16),s1ord=X.U16(p+18),sOptionT(t),sOptionT(a,"by: "),chips=[],el=!1,E=0;!el&&E<32;){switch(X.U8(p+32+E)){case 0:el=!0
break
case 1:chips[E]="YMU759 (17ch)"
break
case 2:chips[E]="Genesis (10ch comp.)"
break
case 3:chips[E]="SMS (SN76489) (4ch)"
break
case 4:chips[E]="Game Boy (4ch)"
break
case 5:chips[E]="PC Engine (6ch)"
break
case 6:chips[E]="NES (5ch)"
break
case 7:chips[E]="C64 (8580) (3ch)"
break
case 8:chips[E]="Arcade (YM2151+SegaPCM) (13ch)"
break
case 9:chips[E]="Neo Geo CD (YM2610) (13ch)"
break
case 66:chips[E]="Genesis extended (13ch)"
break
case 67:chips[E]="SMS (SN76489) + OPLL (YM2413) (13ch comp.)"
break
case 70:chips[E]="NES+VRC7 (11ch)"
break
case 71:chips[E]="C64 (6581) (3ch)"
break
case 73:chips[E]="Neo Geo CD extended (16ch)"
break
case 128:chips[E]="AY-3-8910 (3ch)"
break
case 129:chips[E]="Amiga (4ch)"
break
case 130:chips[E]="YM2151 (8ch)"
break
case 131:chips[E]="YM2612 (6ch)"
break
case 132:chips[E]="TIA (2ch)"
break
case 133:chips[E]="VIC-20 (4ch)"
break
case 134:chips[E]="PET (1ch)"
break
case 135:chips[E]="SNES (8ch)"
break
case 136:chips[E]="VRC6 (3ch)"
break
case 137:chips[E]="OPLL (YM2413) (9ch)"
break
case 138:chips[E]="FDS (1ch)"
break
case 139:chips[E]="MMC5 (3ch)"
break
case 140:chips[E]="Namco 163 (8ch)"
break
case 141:chips[E]="YM2203 (6ch)"
break
case 142:chips[E]="YM2608 (16ch)"
break
case 143:chips[E]="OPL (YM3526) (9ch)"
break
case 144:chips[E]="OPL2 (YM3812) (9ch)"
break
case 145:chips[E]="OPL3 (YMF262) (18ch)"
break
case 146:chips[E]="MultiPCM (28ch)"
break
case 147:chips[E]="Intel 8253 (beeper) (1ch)"
break
case 148:chips[E]="POKEY (4ch)"
break
case 149:chips[E]="RF5C68 (8ch)"
break
case 150:chips[E]="WonderSwan (4ch)"
break
case 151:chips[E]="Philips SAA1099 (6ch)"
break
case 152:chips[E]="OPZ (YM2414) (8ch)"
break
case 153:chips[E]="Pokémon Mini (1ch)"
break
case 154:chips[E]="AY8930 (3ch)"
break
case 155:chips[E]="SegaPCM (16ch)"
break
case 156:chips[E]="Virtual Boy (6ch)"
break
case 157:chips[E]="VRC7 (6ch)"
break
case 158:chips[E]="YM2610B (16ch)"
break
case 159:chips[E]="ZX Spectrum (beeper) (6ch)"
break
case 160:chips[E]="YM2612 extended (9ch)"
break
case 161:chips[E]="Konami SCC (5ch)"
break
case 162:chips[E]="OPL drums (YM3526) (11ch)"
break
case 163:chips[E]="OPL2 drums (YM3812) (11ch)"
break
case 164:chips[E]="OPL3 drums (YMF262) (20ch)"
break
case 165:chips[E]="Neo Geo (YM2610) (14ch)"
break
case 166:chips[E]="Neo Geo extended (YM2610) (17ch)"
break
case 167:chips[E]="OPLL drums (YM2413) (11ch)"
break
case 168:chips[E]="Atari Lynx (4ch)"
break
case 169:chips[E]="SegaPCM (DefleMask compat.) (5ch)"
break
case 170:chips[E]="MSM6295 (4ch)"
break
case 171:chips[E]="MSM6258 (1ch)"
break
case 172:chips[E]="Commander X16 (VERA) (17ch)"
break
case 173:chips[E]="Bubble System WSG (2ch)"
break
case 174:chips[E]="OPL4 (YMF278B) (42ch)"
break
case 175:chips[E]="OPL4 drums (YMF278B) (44ch)"
break
case 176:chips[E]="Seta/Allumer X1-010 (16ch)"
break
case 177:chips[E]="Ensoniq ES5506 (32ch)"
break
case 178:chips[E]="Yamaha Y8950 (10ch)"
break
case 179:chips[E]="Yamaha Y8950 drums (12ch)"
break
case 180:chips[E]="Konami SCC+ (5ch)"
break
case 181:chips[E]="tildearrow Sound Unit (8ch)"
break
case 182:chips[E]="YM2203 extended (9ch)"
break
case 183:chips[E]="YM2608 extended (19ch)"
break
case 184:chips[E]="YMZ280B (8ch)"
break
case 185:chips[E]="Namco WSG (3ch)"
break
case 186:chips[E]="Namco 15xx (8ch)"
break
case 187:chips[E]="Namco CUS30 (8ch)"
break
case 188:chips[E]="MSM5232 (8ch)"
break
case 189:chips[E]="YM2612 extra features extended (11ch)"
break
case 190:chips[E]="YM2612 extra features (7ch)"
break
case 191:chips[E]="T6W28 (4ch)"
break
case 192:chips[E]="PCM DAC (1ch)"
break
case 193:chips[E]="YM2612 CSM (10ch)"
break
case 194:chips[E]="Neo Geo CSM (YM2610) (18ch)"
break
case 195:chips[E]="YM2203 CSM (10ch)"
break
case 196:chips[E]="YM2608 CSM (20ch)"
break
case 197:chips[E]="YM2610B CSM (20ch)"
break
case 198:chips[E]="K007232 (2ch)"
break
case 199:chips[E]="GA20 (4ch)"
break
case 222:chips[E]="YM2610B extended (19ch)"
break
case 224:chips[E]="QSound (19ch)"
break
case 252:chips[E]="Pong (1ch)"
break
case 253:chips[E]="Dummy System (8ch)"
break
case 254:case 255:chips[E]="reserved for development"
break
default:chips[E]="unk."}el||E++}sOption("chips: "+chips.join("+")),sOption("ticks="+freq.toFixed(2)+"Hz, A4="+A4freq+"Hz"),sOption("ins:"+ins+" wvt:"+wvt+" smp:"+smp+" glob.ptn:"+ptng),sOption("1st song's spd:"+s1spd+" ptn:"+s1ptn+" ord:"+s1ord)}}else if(X.c("'FWMP'00"))sName="Forgotten Worlds BGM module (.FW)",bDetected=1
else if(X.c("'FXSM'"))sName="Fuxoft AY Language module (.FXM)",bDetected=1
else if(X.c("'GBRF'"))sName="Gameboy Ripped Format module (.GBR)",bDetected=1,t=X.SA(340,19),""!=t&&/^([a-zA-Z0-9_ -]{4,})/.test(t)&&(sOptions=sOptions.append(t))
else if(X.c("'GBS'01"))bDetected=1,sName="Gameboy Sound System module (.GBS)",X.isVerbose()&&sOptionT(X.SA(16,32)),tc=X.U8(4),tc>1&&sOption(tc,"×"),X.isVerbose()&&(sOptionT(X.SA(48,32),"by: "),sOptionT(X.SA(80,32)))
else if(X.c("'GDM'FE")&&X.c("0D0A1A'GMFS'",68)){if(sName="General Digital Music module (.GDM)",bDetected=1,trkr="",0==X.U16(77,_BE)&&(trkr="2gdm"),sVersion="v"+X.U8(75)+"."+X.U8(76),""!=trkr&&(sVersion+="/"+trkr+" v."+X.U8(79)+"."+X.U8(80)),X.isVerbose()){switch(sOptionT(X.SA(4,32)),sOptionT(X.SA(36,32),"by: "),tof=X.U16(116,_BE),tof){case 1:sOptionT("orig: MOD")
break
case 2:sOptionT("orig: MTM")
break
case 3:sOptionT("orig: S3M")
break
case 4:sOptionT("orig: 669")
break
case 5:sOptionT("orig: FAR")
break
case 6:sOptionT("orig: ULT")
break
case 7:sOptionT("orig: STM")
break
case 8:sOptionT("orig: MED")}sOptionT(X.SA(X.U32(138,_BE),X.U32(141,_BE)))}}else if(X.c("'GLUE'B8B3AABA")){if(sName="GlueMon module (.GLUE)",bDetected=1,X.isVerbose()){for(sOptionT(X.SA(8,8)),ins=X.U8(127),ord=X.U8(158),ptn=0,E=0;E<ord;E++)t=X.U8(159+E),255!=t&&ptn<t&&(ptn=t)
ptn++,sOption("ord:"+ord+" ptn:"+ptn+" ins:"+ins)}}else if(X.c("'NuFREDGRAY'",34))sName="Fred Gray's module (.GRAY)",bDetected=1,X.isVerbose()&&(t=X.SA(80,256),pn=80+t.length+1,a=X.SA(pn,256),pn+=a.length+1,c=X.SA(pn,256),sOptionT(t),sOptionT(a,"by: "),sOptionT(c))
else if(X.c("'+SNT'"))bDetected=1,sName="Beaver Sweeper module (.GTK)"
else if(X.c("'GTK'")&&isWithin(X.U8(3),1,4)&&X.U16(196,_BE)<=255&&isWithin(X.U16(198,_BE),1,256)&&isWithin(X.U16(200,_BE),1,32)&&(ord=X.U16(202,_BE))<=256&&X.U16(204,_BE)<=ord||X.c("'GT2'")&&(X.U8(3)>5&&228==X.U32(4,_BE)||X.U32(4,_BE)==236+2*X.U16(234,_BE))&&isWithin(X.U16(202,_BE),1994,9999)){switch(bDetected=1,sigv=0,bad="",X.U8(2)){case 75:sName="Graoumf Tracker module (.GTK)",sVersion="Amiga ",sigv=1
break
case 50:sName="Graoumf Tracker 2 module (.GT2)",sVersion="PC ",sigv=2}if(v=X.U8(3),sVersion+="v"+v,1==sigv&&v<6)switch(v){case 1:sVersion+="/GT v0.7"
break
case 2:sVersion+="/GT v0.726"
break
case 3:sVersion+="/GT v0.731"}else 9==v&&(sVersion+="/GT r27")
if(tracker=statln="",1==sigv){for(t=X.SC(4,32,"ISO8859-1").trim(),d=xc="",c=X.SC(36,160,"ISO8859-1").trim(),trk=X.U16(200,_BE),ord=X.U16(202,_BE),smp=0,smprecs=X.U16(196,_BE),rows=X.U16(198,_BE),lp=X.U16(204,_BE),smpinfosz=v<=2?48:64,sszofs=1==v?32:28,v>=3&&(sszofs+=16),v>=2&&(sszofs+=4),smp=smpsz=0,p=206,E=0;E<smprecs;E++)(ssz=X.U32(p+sszofs,_BE))&&(smpsz+=ssz,smp++),p+=smpinfosz,ssz%2&&(bad=bad.addIfNone("!oddsmpsz"))
for(ptn=0,E=0;E<ord;E++)(pt=X.U16(p,_BE))>ptn&&(ptn=pt),p+=2
ptn++,nn=4==v?5:4,songsz=718+smprecs*smpinfosz+ptn*rows*trk*nn,sz=songsz+smpsz,statln="trk:"+trk+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+(lp?" lp:"+lp:"")+" sz:"+outSz(sz)}else{for(t=X.SA(8,32).trim(),d=X.U16(202,_BE)+"-"+X.U8(201).padStart(2,"0")+"-"+X.U8(200).padStart(2,"0"),c=X.SA(40,160).trim(),tracker=X.SA(204,24),pn=songhk=spd=bpm=ord=lp=mptn=ptn=ins=smp=trk=0,sz=-1,xc=[],v<6&&(spd=X.U16(228,_BE),bpm=X.U16(230,_BE));pn<X.Sz();){switch(hkhd=X.SA(pn,4),hksz=X.U32(pn+4,_BE),pn+=8,hkhd){case"SONG":for(ord=X.U16(pn,_BE),lp=X.U16(pn+2,_BE),mptn=0,p=pn+4,E=0;E<ord;E++,p+=2)mptn=Math.max(mptn,X.U16(p,_BE))
mptn++,songhk++
break
case"PATD":case"PAIN":case"PAFX":case"PAMI":ptn++,trk=Math.max(trk,X.U16(pn+22,_BE))
break
case"INST":ins++
break
case"SAMP":case"SAM1":case"SAM2":smp++
break
case"XCOM":xcc=X.U16(pn,_BE),xc=xc.push(X.SA(pn+2,xcc).trim())
break
case"TCN2":bpm=X.U16(pn+2,_BE)+(X.U16(pn+4,_BE)?"."+X.U16(pn+4,_BE):"")
case"ENDC":sz=pn+hksz-8}if(pn+=hksz-8>0?hksz-8:0,sz>=0)break
if(charStat(next=X.SA(pn,4)).indexOf("allasc")<0||next.toUpperCase()!=next)break}songhk||(bad=bad.addIfNone("!noSONG")),sz<=0&&(sz=pn,bad=bad.addIfNone("!noendtag")),ptn!=mptn&&(ptn=mptn+"/"+ptn),statln=statln.appendS((bpm?"bpm0:"+bpm+" ":"")+(spd?"spd0:"+spd+" ":"")+"trk:"+trk+" ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(sz)," ")}X.isVerbose()&&(sOption(t),sOption(d,"on:"),sOption(tracker,"in:"),sOption(c),xc.length&&sOption(addEllipsis(xc.join("\n"),256,160),'msg: "','"'),sOption(statln)),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("'NuH.DAVIES'",34))sName="Howie Davies's module (.HD)",bDetected=1,X.isVerbose()&&(t=X.SA(100,256),pn=100+t.length+1,a=X.SA(pn,256),pn+=a.length+1,c=X.SA(pn,256),sOptionT(t),sOptionT(a,"by: "),sOptionT(c))
else if(X.c("'HESM'00")&&isWithin(X.U8(7),125,254)&&X.c("FFF8",8)&&isWithin(X.I8(10),-8,32)&&isWithin(X.I8(11),-8,32)&&isWithin(X.I8(12),-8,32)&&isWithin(X.I8(13),-8,32)&&isWithin(X.I8(14),-8,32)&&X.c("'DATA'",16)&&[0,224].indexOf(X.U8(20))>=0&&X.c("002000000000000000",23)&&X.Sz()>=256){if(sName="Hudson Entertainment System multitrack tune (.HES)",bDetected=1,sVersion="v"+X.U8(4),startsong=X.U8(5),reqaddr=X.U16(6),dtsz=X.U32(20),dtaddr=X.U32(24),X.isVerbose()){function G(){if(X.U8(p)){var s=32
X.U8(p+31)&&!X.U8(p+47)&&(s=48)
var e=X.readBytes(p,s),t=e.indexOf(0)
return t<0||charStat(e.slice(0,t),1).indexOf("asc")<0?"":(p+=s,"<?>"==(e=decEncoding(e,!0,Chars0to1F))?"":e)}return""}t=a=c="",p=64,X.U8(p)>=32&&(sOptionT(G()),sOptionT(G(),"by:"),sOptionT(G())),sOption("from:"+startsong+" sz:"+outSz(dtaddr+dtsz))}}else if(X.c("'GTI5'"))sName="GoatTracker 2 Instrument (.INS)",bDetected=1
else if(X.c("'ISM!V1.2'"))sName="Sound Invasion Music System/In Stereo! module (.IS)",bDetected=1,sVersion="v"+X.SA(5,3),X.isVerbose()&&sOptionT(X.SA(36,25))
else if(X.c("'IS20DF10STBL'"))sName="Sound Invasion Music System/In Stereo! module (.IS20)",bDetected=1,sVersion="v2.0"
else if(X.c("'IXS!'"))sName="Sahara Surfers' iXalance module (.IXS)",bDetected=1,sVersion="compressed",X.isVerbose()&&(sOptionT(X.SA(24,32)),sOption(outSz(56+X.U32(16)),"sz:"))
else if(X.c("'MUSE'DEADBEAF")||X.c("'MUSE'DEADBABE"))sName="Jazz Jackrabbit 2 container (.J2B)/Galaxy Sound System module",sVersion="compressed",bDetected=1
else if(X.c("'NuJ.FLOGEL'",34))sName="Janko Mrsic-Flogel's module (.JMF)",bDetected=1,X.isVerbose()&&(t=X.SA(84,256),pn=84+t.length+1,a=X.SA(pn,256),pn+=a.length+1,c=X.SA(pn,256),sOptionT(t),sOptionT(a,"by: "),sOptionT(c))
else if(X.c("2B7C.... ........ 2B7C.... ........ 2B7C.... ........ 2B7C.... ........ 303C00FF 32004EB9 ........ 4E75")&&X.I32(2,_BE)>=46){if(sName="Steve Turner's module (.JPO)",bDetected=1,X.isVerbose()){for(ofs=X.U32(2,_BE),p1=p=X.U32(18,_BE)-ofs+46,d1=10;p<=Math.min(X.Sz(),1048576)&&(t=X.U16(p,_BE),61695!=t);)p+=2,d0=t,d0>d1&&(d1=d0)
for(sz=X.fSig(p1+d1,TOEOF,"FF"),sz>0&&sz++,p=X.U32(10,_BE)-ofs+46,x=0;p<X.Sz()&&(d0=65520&X.U16(p,_BE),!d0);)p+=12,x++
X.c("2b7c0004449c0faa2b7c000479840fa22b7c00047ab40fa62b7c000458980fae")&&(x=5),d0=20+X.U32(26,_BE)-ofs,smp=(X.U32(d0,_BE)>>2)-1,smpsz=X.U32(d0+4,_BE),x>1&&sOption(x,"×"),sOption("smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz))}}else if(X.c("'KSCC'")&&!X.U8(14)&&!(224&X.U8(15))||X.c("'KSSX'")&&!X.U32(20))sName="KSS chiptune (.KSS)",bDetected=1,X.c("'KSSX'")?(nv=1,sVersion="extended"):nv=0,bnk=127&X.U8(13),bnk16=128&X.U8(13)?1:2,bnk&&(sVersion=sVersion.appendS("banks"+(1==bnk16?"8k":"16k"),",")),chip=X.U8(15),X.isVerbose()&&X.c("'MBM'",32)&&sOptionT(X.SA(36,52)),sz=16+X.U8(14)+X.U16(6)+8192*bnk*bnk16,hnmmode=rammode=!1,scc=!0,ch=1,2&chip?(sVersion+="#SEGA-MkIII(SMS)",4&chip?(sVersion+="/GameGear-Stereo",ch=2):sVersion+="/SMS-SNG(SN76489)",1&chip&&(sVersion+="/FM-UNIT(YM2413)"),136&chip&&(rammode=!0),scc=!1):(16&chip?8&chip?(sVersion+="#MSX-AUDIO-STEREO",ch=2):(sVersion+="#MSX-AUDIO",hnmmode=!0):sVersion+="#MSX-AUDIO",1&chip&&(sVersion+="/MSX-MUSIC"),128&chip?(rammode=!0,scc=!1):(rammode=!!(4&chip),scc=!rammode)),rammode&&(sVersion+="/RAM"),scc&&(sVersion+="/SCC"),hnmmode&&(sVersion+="/牌の魔術師DAC"),nv&&X.U8(14)>=11&&X.isVerbose()&&(x1=X.U16(24),x2=X.U16(26),x2-x1>1&&sOption("subsongs "+x1+"-"+x2)),X.isVerbose()&&sOption("ch:"+ch+(bnk?" ex.bnk:"+bnk:"")+" sz:"+outSz(sz))
else if(X.c("'cyd!song'"))sName="Klystrack module (.KT)",bDetected=1,v=X.U8(8),sVersion="v"+v,X.isVerbose()&&(pn=9,v>=6?trk=X.U8(pn++):v>3?trk=4:trk=3,timesig=X.U8(pn++)+"/"+X.U8(pn++),v>=17&&(pn+=2),instc=X.U8(pn++),patc=X.U16(pn,_LE),pn+=2,pn+=2*trk,songlen=X.U16(pn,_LE),pn+=2,pn+=2,v>=12&&pn++,spd=X.U8(pn++),spd2=X.U8(pn++),rate=X.U8(pn++),v>2&&(pn+=4),v>=9&&pn++,v>=16&&pn++,tlen=17,v>=11&&(tlen=X.U8(pn++)),v>=5&&(tlen=Math.min(tlen,65)),sOptionT(X.SA(pn,tlen)),sOption("trk:"+trk+" tsig:"+timesig+" bpm:"+rate+" ins:"+instc+" len:"+Hex(songlen)+" ptn:"+Hex(patc)+" spd:"+spd+"-"+spd2))
else if(X.c("'cyd!inst'"))sName="Klystrack instrument (.KI)",bDetected=1
else if(X.c("'cyd!efex'"))sName="Klystrack effects (.KF?)",bDetected=1
else if(X.c("'ADL '0000....'MDhd'00000008000080..00000080'MThd'00000006000200..01E0'MTrk'0000....00FF03")||X.U32(0,_LE)==X.Sz()&&X.c("'AD'",4))sName="Lucas Arts Adlib chiptune (.LAA)",bDetected=1,"ADL "===X.SA(0,4)?sVersion="new":sVersion="old"
else if(X.c("'Liquid Module:'")||(X.isHeuristicScan()||X.c("'NO'"))&&extIs("liq")||X.c("21",470)&&X.c("21",2770)&&X.c("21",3046)&&X.c("FF",3796)&&X.c("FF",3816))sName="Liquid Tracker module (.LIQ)",bDetected=1,sVersion=X.SA(65,20).trim(),X.isVerbose()&&("NO"==X.SA(0,2)?sOptionT(X.SA(5,20)):"Liq"==X.SA(0,3)&&(sOptionT(X.SA(14,50)),sOptionT(X.SA(14,15),"by: ")))
else if(X.Sz()>56&&X.c("'LME'00")&&X.fSig(4,32,"00")<0&&!X.U32(36,_BE)){if(sName="Steve 'Leggless' Hasler module (.LME)",bDetected=1,X.isVerbose()){for(ss=decAnsi(4,32,CPAmiga).trim(),songsz=44+X.U32(52,_BE),d3=ins=Util.divu64(X.U32(56,_BE)-(E=X.U32(40,_BE)),58),x=E-16>>4,E+=40,smp=synsmp=smpsz=0,d7=3;d3;d3--,E+=58)(t=X.U32(E,_BE))?t>d7&&(d7=t,smpsz+=X.U16(E+4,_BE)<<1,smp++):synsmp++
steps=X.U32(48,_BE)-X.U32(44,_BE)>>2,sz=songsz+smpsz,x>1&&sOption(x,"×"),sOption(ss,'info:"','"'),sOption("steps:"+steps+" ins:"+ins+" sz:"+outSz(sz))}}else if(X.c("'sa-team 89a'10610A6108610678006000",364)&&X.c("'dynamite89'",564)&&isWithin(X.U16(1290,_BE),0,15)){if(sName="Music Assembler module (.MA)",bDetected=1,X.isVerbose()){for(x=ptn=0,vp=[],ptns=[],ord=[],ch=[],p=1200,E=0;E<40;E++,p+=2)vp[E]=1570+X.U16(p,_BE)
for(E=0;E<40;E+=4){for(ch_=ord_=0,j=E;j<E+4&&j<40;j++)254!=X.U8(vp[j])&&ch_++
if(ch_){for(j=E,p=vp[j];j<E+4&&p<X.Sz()&&254!=(t=X.U8(p));p+=2)255==t?j++:(ord_++,ptns.indexOf(t)<0&&ptns.push(t))
ord_&&(x++,ord.push(ord_)),ch.push(ch_)}}x>1&&sOption(x,"×"),insp=1570+X.U32(1462,_BE),ins=Util.divu64(vp[0]-insp,24),sOption("ch:"+ch.join("/")+" ord:"+ord.join("+")+" ptn:"+ptns.length+" ins:"+ins+" sz:"+outSz(1570+X.U32(1454,_BE)))}}else if(X.c("'MAD+'"))sName="Mlat Adlib Tracker module (.MAD)",bDetected=1
else if(X.c("'MADG'"))sName="B. Birney's PlayerPro module (.MAD)",bDetected=1,X.isVerbose()&&sOption(X.SA(4,18))
else if(X.c("D040D0404EFB"))sName="Mark Cooksey's module (.MC)",sVersion="new",bDetected=1
else if(X.c("'MDC'1A 00080040")){for(sName="かるちゃん/CUL.'s music creative driver module (.MDC)",bDetected=1,ss="",maxsz=Math.max(X.Sz(),65536),sz=X.U32(8,_BE),p=X.U32(20,_BE),midires=X.U16(44,_BE),p&&p<maxsz&&(t=X.fSig(p,maxsz,"0D0A1A"))>0&&(ss=X.SC(p,t-p,"Shift_JIS")),p=trkp=X.U32(16,_BE),x=X.U16(p,_BE),x>32&&(sVersion="!badsongcnt"),E=ch=0,p+=2;E<Math.min(x,32);E++,p+=8)ch<X.U8(p+5)&&(ch=X.U8(p+5))
X.isVerbose()&&(sOptionT(ss),x>1&&sOption(x,"×"),sOption("ch:"+ch+(sz?" sz:"+outSz(sz):"")))}else if(X.c("'DMDL'..'IN'"))sName="Digitrakker module (.MDL)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(11,32)),sOptionT(X.SA(43,20),"by: "))
else if(X.c("'MMDC'"))sName="Tony Crowther's packed MED module (.MMDC)",bDetected=1,X.isVerbose()&&sOption(outSz(X.U32(4,_BE)),"sz:")
else if(X.c("000001001100010014000000'GameBoy Music Module'"))sName="Paragon 5/Beyond Game Boy Tracker module (.MGB)",bDetected=1
else if(X.c("'MGT'11BD'MCS'"))sName="Megatracker module (.MGT)",bDetected=1,sOptionT(X.SA(58,32))
else if(X.c("'MThd'")&&X.c("'MTrk'",8+X.U32(4,_BE))&&X.U16(8,_BE)<=2){switch(sName="Standard MIDI File (.MID)",sVersion="v1.0",nV=X.U16(8,_BE),bad="",bDetected=1,nV){case 0:sVersion+=" t.0:one track"
break
case 1:sVersion+=" t.1:tracks"
break
case 2:sVersion+=" t.2:tracks+tempo"}for(bDetected=1,charset="SJIS",trk=X.U16(10,_BE),trk>1&&sOption(trk,"trk:"),0==nV&&1!=trk&&(bad+="!badvertrk"),sz=p=14,txt=by=title=lyr="",E=0;E<trk;E++){var Y=20
if(!X.c("'MTrk'",p)||E&&!X.c("FF2F00",p-3)){bad+="!badtrk"
break}for(len=X.U32(p+4,_BE),p+=8,sz=p;Y&&p<sz+len&&p<X.Sz();){switch(Y--,dt=readVarUInt(p),p+=dt[0],X.U8(p++)){case 240:case 247:t=readVarUInt(p),p+=t[0]+t[1]
break
case 255:switch(a=X.U8(p++),a){case 0:2!=X.U8(p++)?Y=0:p+=4
break
case 3:t=readVarUInt(p),p+=t[0],title=title.append(X.SC(p,t[1],charset)),p+=t[1]
break
case 2:t=readVarUInt(p),p+=t[0],by=by.append(X.SC(p,t[1],charset)),p+=t[1]
break
case 1:t=readVarUInt(p),p+=t[0],txt=txt.append(X.SC(p,t[1],charset)),p+=t[1]
break
case 5:t=readVarUInt(p),p+=t[0],lyr=lyr.append(X.SC(p,t[1],charset,"-")),p+=t[1]
break
case 4:case 6:case 7:default:t=readVarUInt(p),p+=t[0]+t[1]
break
case 32:t=readVarUInt(p),p+=t[0]+t[1],1!=t[1]&&(Y=0,bad+="!badprefix@"+(p-t[0]-t[1]))
break
case 47:t=readVarUInt(p),p+=t[0]+t[1],t[1]&&(bad+="!badEoTtag@"+(p-t[0]-t[1])),Y=0
break
case 81:t=readVarUInt(p),p+=t[0]+t[1],3!=t[1]&&(Y=0,bad+="!badtempo@"+(p-t[0]-t[1]))
break
case 84:t=readVarUInt(p),p+=t[0]+t[1],5!=t[1]&&(Y=0,bad+="!badSMPTE@"+(p-t[0]-t[1]))
break
case 88:t=readVarUInt(p),p+=t[0]+t[1],(t[1]<2||t[1]>4)&&(Y=0,bad+="!badtime@"+(p-t[0]-t[1]))
break
case 89:t=readVarUInt(p),p+=t[0]+t[1],2!=t[1]&&(Y=0,bad+="!badkey@"+(p-t[0]-t[1]))}}(""!=txt&&""!=by&&""!=title||p-sz>512)&&(Y=0)}if(sz+=len,p=sz,p>X.Sz()){bad+="!short"
break}}bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(sOptionT(title),sOptionT(by,"by: "),sOptionT(txt),sOption(outSz(sz),"sz:"))}else if(X.c("'SMF2CLIP'"))sName="MIDI Clip File (.midi2)",sVersion="v2.0",bDetected=1
else if(X.c("'MKJamz'"))sName="MK-Jamz module (.MKJ)",bDetected=1
else if(X.c("'MLEDMODL'000000")&&X.c("'VERS'",X.U32(8,_BE)+12)){for(sName="Musicline Editor module (.ML)",bDetected=1,p=4,t="",c="",x=0,ch=smp=ins=ptn=0;p<X.Sz()&&(hkhd=X.SA(p,4),hksz=X.U32(p+4,_BE),!(charStat(hkhd).indexOf("allasc")<0));){switch(p+=8,hkhd){case"VERS":v=X.U16(p,_BE),sVersion="v"+(v>>8)+"."+((240&v)>>4)+(15&v)
break
case"TUNE":for(x++,t=t.appendS(X.SC(p,hksz,"CP1252").trim(),"; "),tmp0=X.U16(p+32,_BE),spd0=X.U8(p+34,_BE),groove=X.U8(p+35,_BE),ch=X.U8(p+39),chsz=0,hksz=40,E=0;E<ch;E++)chsz+=X.U32(p+hksz,_BE),hksz+=4
hksz+=chsz
break
case"INFO":for(U=0;U<hksz;)z=X.fSig(p+U,hksz-U,"00"),z>-1?l=z-p-U:l=hksz,c+=X.SC(p+U,l,"CP1252")+"\n",U+=l+1
break
case"PART":ptn++
break
case"INST":ins++
break
case"SMPL":smp++,p+=6}p+=hksz}X.isVerbose()&&(x>1&&sOption(x,"×"),sOptionT(t),sOptionT(addEllipsis(c,160,128),'msg: "','"'),sOption("ch:"+ch+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(p)))}else if(X.c("'FORM'........'MMV8SDAT'................'SE'"))sName="Thomas Winischhofer's Music Maker EXT module (.MM8,.MM4)",bDetected=1,sVersion="v8",X.isVerbose()&&(sOptionT(X.SA(26,20)),sOptionT(X.SA(54,41)),sOption(outSz(X.I32(4,_BE)+8),"sz:"))
else if(X.c("'SEI1XX'00"))sName="Music Maker STD instrument (.IP)",bDetected=1,sVersion="v8 old"
else if(X.c("'MO3'"))sName="MO3 MOD module (.MO3)",bDetected=1
else if(X.c("'RASP'",1080))sName="Generic module (.MOD)",bDetected=1,sVersion=X.SA(1080,4),X.isVerbose()&&(sOptionT(X.SC(0,20,"IBM850")),sOptionT(X.SC(20,22,"IBM850"),"by/inst: "))
else if(X.c("08'MONOTONE'")&&X.Sz()>=351){if(sName="MONOTONE module (.MON)",bDetected=1,sVersion="v"+X.U8(91),X.isVerbose()){sOptionT(X.UCSD(9)),sOptionT(X.UCSD(50)),ptn=X.U8(92),trk=X.U8(93),cellsz=X.U8(94),ord=0,E=95
do{t=X.U8(E++),255!=t&&ord++}while(E<351&&255!=E)
sOption("trk:"+trk+" ord:"+ord+" ptn:"+ptn+" sz:"+outSz(351+64*ptn*trk*cellsz))}}else if(/SONG[0-9.]{4}(COMP|NORM)/.test(X.SA(0,12)))sName="Megastation track (.MS)",bDetected=1,sVersion="v"+X.SA(4,5).toLowerCase()
else if(/SNGM[0-9.]{4}(COMP|NORM)/.test(X.SA(0,12)))sName="Megastation MOD module (.MSM)",bDetected=1,sVersion="v"+X.SA(4,5).toLowerCase()
else if(X.c("'MSOB'00000026")&&X.c("FFFF0000",36)&&(x=X.U16(40,_BE))>0)sName="Medley module (.MSO)",bDetected=1,X.isVerbose()&&x>1&&sOption(x,"×")
else if(X.c("'MTC1'00")&&X.U8(5)<16&&X.Sz()>=(sz=X.U32(4,_BE)+8)){if(sName="Multi-track Container module (.MTC)",bDetected=1,X.isVerbose()){for(name=auth=c="",p=8,x=0;p<sz;){switch(hkhd=X.SA(p,4),hksz=X.U32(p+4,_BE),p+=8,hkhd){case"NAME":name=name.addIfNone(decAnsi(p,hksz,CPSpeccy),"/")
break
case"AUTH":auth=auth.addIfNone(decAnsi(p,hksz,CPSpeccy),"/")
break
case"ANNO":c=c.addIfNone(decAnsi(p,hksz,CPSpeccy),"/")
break
case"TRCK":x++}p+=hksz,p%2&&p++}sOptionT(name),sOptionT(auth,"by:"),sOptionT(addEllipsis(c,160)),sOption("trk:"+x+" sz:"+outSz(sz))}}else if(X.c("'mpu401tr'92'kk'EE'r'"))sName="MPU-401 Trakker Adlib module (.MTK)",bDetected=1,X.isVerbose()&&(t=X.UCSD(24),sOptionT(t),sOptionT(X.SA(24+t.length+2),"by: "))
else if(X.c("'MTM'")){if(sName="Multitracker module (.MTM)",bDetected=1,v=X.U8(3),sVersion="v"+(v>>4)+"."+(15&v),X.isVerbose()){for(sOptionT(X.SA(4,20)),trk=X.U16(24),ptn=X.U8(26),ord=X.U8(27)+1,csz=X.U16(28),nos=X.U8(30),bpt=X.U8(32),smpsz=0,E=88;E<88+37*nos;E+=37)smpsz+=X.U32(E)
pxc=194+37*nos+192*trk+32*(ptn+1)*2,c=X.SA(pxc,csz),sz=pxc+csz+smpsz,c.length<csz&&(c=c.trim()+" <...>"),sOptionT(c),sOption("trk:"+(trk+1)+" ord:"+(ord+1)+" ptn:"+(ptn+1)+" smp:"+nos+" sz:"+outSz(sz))}}else if(X.c("'MT20'")&&X.Sz()>=388&&2==X.U8(9)&&X.U16(112)<64&&X.U16(106)<=256){for(sName="MadTracker 2 module (.MT2)",nV=X.U8(8),bDetected=1,sVersion="v"+X.U8(9)+"."+nV.toString(16).padStart(2,"0"),bad="",ord=X.U16(106),loop=X.U16(108),ptn=X.U16(110),trk=X.U16(112),flags=X.U32(118),ins=X.U16(122),smp=X.U16(124),hasdrums=0!=X.U16(382),hasdrums?dptn=X.U16(384):dptn=0,p=388+(hasdrums?274:0),addp=p+X.U32(p-4),msg="",vst2=0,igskip=0,smpszs=[],insszs=[],inss=[],smps=[],extsmp=[];p<addp;){switch(hkhd=X.SA(p,4),hksz=X.U32(p+4),p+=8,hkhd){case"MSG":showmsg=X.U8(p),msg=X.SC(p+1,hksz-1,"CP1252").replace("\r","\n").replace("\n\n","\n")
break
case"SUM":artist=X.SC(p+6,hksz-6,"CP1252"),"Unregistered"==artist&&artist
break
case"VST2":vst2=X.U32(p)}p+=hksz}if(p>addp)bad=bad.addIfNone("!badaddsz")
else if(p>X.Sz())bad=bad.addIfNone("!short")
else{for(E=0;E<ptn&&p<X.Sz();E++)p+=6+(X.U32(p+2)+1&-2)
if(hasdrums)for(E=0;E<dptn&&p<X.Sz();E++)p+=2+32*X.U16(p)
if(2&flags)for(env=trk+(8&flags)+(nV>=80?vst2:0)+(16&flags?1:0),U=0;U<ptn;U++)for(e=0;e<env&&p+4<=X.Sz();e++)for(nV>=3?(fl=X.U32(p),p+=8):(fl=X.U16(p),p+=4);fl;)1&fl&&(p+=260),fl>>=1,fl<0&&(fl=-fl)}if(p>X.Sz())bad=bad.addIfNone("!short")
else for(E=0;E<255;E++)!msg&&inss.length<3&&(t=X.SC(p,32,"CP1252"),""!=t.trim()&&inss.push(t)),dtlen=X.U32(p+32),32==dtlen&&(dtlen+=396),nV>1&&dtlen&&(dtlen+=4),dtlen&&(igskip+=X.U16(p+36)<<3),p+=36+dtlen
if(p>X.Sz())bad=bad.addIfNone("!short")
else{for(E=0;E<256;E++)msg||(t=X.SA(p,32),E<smp&&""!=t.trim()&&smps.push(t)),dtlen=X.U32(p+32),p+=36,dtlen&&E<smp&&(M=X.U32(p),sfl=X.U8(p+10),5&sfl?smpszs.push({ext:1,slen:0}):M&&smpszs.push({ext:0,slen:M}),p+=dtlen)
if(p+=igskip,p>X.Sz())bad=bad.addIfNone("!short")
else for(E=0;E<smp&&p<X.Sz();E++)smpszs[E].ext?(M=X.U32(p),p+=16,iextsmp.push(X.SA(p,M)),p+=M):p+=smpszs[E].slen}""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(sOptionT(X.SA(42,64)),""!=msg?showmsg?sOption(addEllipsis(msg,128),"msg: "):sOption("("+addEllipsis(msg,128)+")","msg: "):inss.length?sOption('"'+addEllipsis(inss.join(" "),200)+'"',"ins/msg:"):smps.length&&sOption('"'+addEllipsis(smps.join(" "),200)+'"',"smp/msg:"),sOption("ord:"+ord+" loop:"+loop+" ptn:"+ptn+(hasdrums?"+"+dptn:"")+" ins:"+ins+" smp:"+smp+(extsmp.length>0?" ext.smp: ["+extsmp.join(",")+"]":"")+" trk:"+trk+(hasdrums?"+8":"")+(vst2?"vst2:"+vst2:"")+" sz:"+outSz(p)))}else if(X.c("'MTRAC'"))sName="Master Tracker Adlib module (.MTR)",bDetected=1
else if(X.c("3C4F3123 20391E00 1FdF1F9F 0C020C05 04040407 1AF60627"))sName="Packen/ぱっくん Software MUAP98/みゅあっぷ tone data (TONES.DTA)",bDetected=1,X.isVerbose()&&sOption("6400","sz:")
else if(X.c("'MVSM1'"))sName="MVS Tracker module (.MUS)",bDetected=1
else if(X.c("'MUS'1A")&&X.U16(4)>=X.U16(6))sName="DOOM music module (.MUS)",bDetected=1,X.isVerbose()&&sOption(outSz(X.U16(4)),"sz:")
else if(X.c("'MVM'00"))sName="MVX Module (.MVM)",bDetected=1
else if(X.c("'MXM'00"))sName="Cubic Tiny XM module (.MXM)",bDetected=1
else if(X.c("'MXTX'00"))sName="MaxTrax module (.MXTX)",bDetected=1
else if(X.c("'TWNNSNG1'00"))sName="NoiseTrekker module (.NTK)",bDetected=1,sVersion="v1.6b",X.isVerbose()&&sOption(X.SA(9,20))
else if(X.c("'TWNNSNG2'00"))sName="NoiseTrekker module (.NTK)",bDetected=1,sVersion="v2.0",X.isVerbose()&&sOption(X.SA(9,20))
else if(X.c("'TWNNSNG'..00")&&["6","G","I"].indexOf(X.SA(7,1)>=0)||X.c("'PROTREK'"))sName="ProTrekkr module (.PTK)",bDetected=1,sVersion="v"+X.SA(7,1),X.isVerbose()&&"v6"==sVersion&&sOption(X.SA(9,20))
else if(X.c("'NESM'1A")||X.c("'NSFE'")){if(sName="Nintendo Sound Format audio (.",bDetected=1,sig=X.SA(0,4),"NSFE"===sig?filever="NSFe":2==X.U8(5)?filever="NSF2":filever="NSF",sName+=filever+")",INFOready=!1,NEND=!1,hkhd="",pn=4,nsf2jump=palntsc=sz=-1,spd="",vrc7repl=0,playtime=Number(0),g="",t="",a="",c="",taut=[],tlbl=[],xc="","NSFe"===filever){if(X.isVerbose())for(;pn<X.Sz()&&(hksz=X.U32(pn,_BE),hkhd=X.SA(pn+4,4),"INFO"!==hkhd);)pn+=hksz+8
nsf2jump=0}else bDetected=1,sVersion="",X.isVerbose()&&(palntsc=X.U8(122),chip=X.U8(123),tc=X.U8(6),t=X.SA(14,32),a=X.SA(46,32),c=X.SA(78,32)),INFOready=!0,nsf2jump=X.U24(125,_LE),pn+=nsf2jump
if(nsf2jump>=0&&"NSFe"===filever&&X.isVerbose())for(;pn<X.Sz()&&!NEND;){switch(hksz=X.U32(pn,_LE),hkhd=X.SA(pn+4,4),pn+=8,hkhd){case"NEND":NEND=!0
break
case"INFO":if(INFOready)break
palntsc=X.U8(pn+6),chip=X.U8(pn+7),tc=X.U8(pn+7),INFOready=!0
break
case"RATE":spd="rate :: NTSC: "+X.U16(pn,_LE)+" ticks",palspd=X.U16(pn+2,_LE),palspd>0&&(spd+=", PAL: "+palspd+" ticks"),dendyspd=X.U16(pn+4,_LE),dendyspd>0&&(spd+=", Dendy: "+dendyspd+" ticks")
break
case"VRC7":vrc7repl=X.U8(pn)
break
case"time":for(E=0;4*E<hksz;E++)4*E>=hksz?curtime=-1:curtime=X.I32(pn+4*E,_LE),curtime<0&&(curtime=12e4),playtime+=curtime/1e3
break
case"auth":apn=0,g=X.SC(pn,256,"UTF8"),apn+=g.length+1,a=X.SC(pn+apn,256,"UTF8"),apn+=a.length+1,c=X.SC(pn+apn,256,"UTF8"),apn+=c.length+1,c+=", rip: "+X.SC(pn+apn,256,"UTF8")
break
case"taut":if(X.isDeepScan())for(apn=0;apn<hksz;)trkauth=X.SC(pn+apn,hksz-apn,"UTF8"),apn+=trkauth.length+1,taut.push(trkauth)
break
case"tlbl":if(X.isDeepScan())for(apn=0;apn<hksz;)trklbl=X.SC(pn+apn,hksz-apn,"UTF8"),apn+=trklbl.length+1,tlbl.push(trklbl)
break
case"text":X.isDeepScan()&&(xc=X.SC(pn,hksz,"UTF8"))}pn+=hksz,sz=pn}if(X.isVerbose()&&INFOready){switch(palntsc){case 0:sVersion+=" NTSC"
break
case 1:sVersion+=" PAL"
break
case 2:sVersion+=" NTSC/PAL"}if(1&chip&&(sVersion+="#VRC6"),2&chip)if(1===vrc7repl)sVersion+="#YM2413"
else sVersion+="#VRC7"
4&chip&&(sVersion+="#FDS"),8&chip&&(sVersion+="#MMC5"),16&chip&&(sVersion+="#Namco163"),32&chip&&(sVersion+="#Sunsoft5B"),sOptionT(t),tc>1&&sOption(tc,"×"),sOptionT(a,"by: "),sOptionT(c)}if(X.isVerbose()){for(playtime>1&&sOption(new Date(Math.round(1e3*playtime)).toISOString().substr(11,8),"Playtime: "),Math.max(tlbl.length,taut.length)>0&&sOption("[Tracks]"),E=0;E<Math.max(tlbl.length,taut.length);E++)E<tlbl.length?ttlbl=tlbl[E]:ttlbl="#"+(E+1),E<taut.length?ttaut=" by: "+taut[E]:ttaut="",sOption(ttlbl+ttaut)
""!=xc&&sOption(xc,"[Commentary]: "),sz>-1&&sOption(outSz(sz),"sz:")}}else if(X.c("'OKTASONGCMOD'00000008")&&X.c("'SAMP'00000480",24)&&X.c("'SPEE'00000002....'SLEN'00000002....'PLEN'00000002....'PATT'00000080",1184)&&X.c("'PBOD'",1350)){if(sName="Oktalyzer module (.OKTA)",bDetected=1,sVersion="v"+X.U16(20,_BE)+"."+X.U16(22,_BE).padStart(2,"0"),X.isVerbose()){for(p=32,smp=0,smps=[];p<1184;p+=32)""!=(t=decAnsi(p,20,CPAmiga).trim())&&smps.push(t),X.U32(p+20,_BE)&&smp++
for(sOption(addEllipsis(smps.join(" ")),'smp/msg:"','"'),tmp0=X.U16(1192,_BE),ptn=X.U16(1202,_BE),ord=X.U16(1212,_BE),rsmp=0,p=1350;p<X.Sz()&&rsmp<smp&&(hkhd=X.SA(p,4),!(charStat(hkhd,1).indexOf("allasc")<0));)hksz=X.U32(p+4,_BE),"SBOD"===hkhd&&rsmp++,p+=8+hksz
sOption("tmp0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" sz:"+outSz(p))}}else if(X.c("'Onyx Music File'1A0001")&&X.c("80808080",274)){if(sName="Onyx Music File (.OMF)",bDetected=1,X.isVerbose()){for(ch=X.U8(402)+1,ptn=X.U8(403)+1,ord=X.U8(404)/2+1,title=X.SA(405,31).trim(),sn=[],smp=smpsz=0,E=0;E<31;E++)t=X.SA(436+28*E,21).trim(),t.length&&sn.push(t),t=X.U16(460+28*E),t&&(smpsz+=t,smp++)
for(E=0,p=1306;E<ptn;E++)p+=3+256*X.U8(p+2)
for(sz=p+smpsz+3*smp,E=0;E<smp;E++)p+=3+X.U16(p+1)
p!=sz&&(sVersion="malformed!badsmpcnk"),sOptionT(title),sOptionT(addEllipsis(sn.join(" ")),'smp/msg:"','"'),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))}}else if((X.c("'Org-02'")||X.c("'Org-03'"))&&X.Sz()>=114){if(sName="Organya module (.ORG)",bDetected=1,50===X.U8(5)?sVersion:sVersion="v2",X.isVerbose()){for(c=ins=0,E=0;E<16;E++)t=X.U16(22+6*E),t&&(ins++,c+=t)
sOption("ins:"+ins+" tempo:"+X.U16(6)+" rhythm:"+X.U8(8)+"/"+X.U8(9)+" notes:"+c+" sz:"+outSz(114+(c<<3)))}}else if(X.c("'OBISYNTHPACK'")&&X.Sz()>1296&&(X.c("0100",1292)||!X.U32(1292,_BE))){if(sName="Karsten 'Obi' Obarski's Synth Pack module (.OSP+SMP.set)",bDetected=1,X.isVerbose()){for(p=a2=12,x=ord=0,d1=64;p<X.Sz()&&d1--&&(d2=X.U32(p,_BE),p+=4,d2);)ord++,d2&=65535,240==d2&&x++
for(d3=d6=0;a2<X.Sz()&&d6<64&&(d4=X.U32(a2,_BE),a2+=4,d4?(d4&=65280,65024!=d4&&64512!=d4||d3++,d6++):X.U32(a2,_BE)&&d6++,!(d6>=64)););for(d3>x&&(x=d3,ord=d6),(X.c("2000",12)||X.c("FE",14))&&(x=7),d1=256,p<X.Sz()&&(p=268),ptn=0;p<X.Sz()&&d1--;)(t=X.U8(p))>ptn&&(ptn=t),p+=4
if(p<X.Sz()&&(p=1292),X.U32(1292,_BE)){for(;p<X.Sz()&&X.U16(p,_BE);p+=2);for(p+=X.U16(p-2,_BE);p<X.Sz()&&!X.c("FFFFFFFF5FFF",p);p+=2);p+=6}else p+=384*(ptn+1)
x>1&&sOption(x,"×"),sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(p))}}else if(X.c("'OBISYNTHPACK'")){for(p=12,E=smp=0;p<X.Sz()&&E<64;E++)t=X.U32(p+4,_BE)-X.U32(p,_BE),p+=4,t&&smp++
p-=4,sz=X.U32(p,_BE),sz<=X.Sz()&&(sName="Synth Pack's sample set (SMP.SET)",bDetected=1,X.isVerbose()&&sOption("smp:"+smp+" sz:"+outSz(sz)))}else if(X.c("00800404 1214191C 1FCE26D6 328E35EA 3CF23CF2")&&X.c("0C000384000000000000",128)){for(p=0,E=smp=0;p<X.Sz()&&E<64;E++)t=X.U16(p+2,_BE)-X.U16(p,_BE),p+=2,t&&smp++
p-=2,sz=X.U16(p,_BE),sz<=X.Sz()&&(sName="Synth Pack's sample set (SMP.SET)",sVersion="headerless",bDetected=1,X.isVerbose()&&sOption("smp:"+smp+" sz:"+outSz(sz)))}else if(X.c("'PACG'........'PAIN'")&&(t=X.fSig(12,256,"'SOIN'")+8)>16&&X.U16(t+2)&&X.U8(t+4)&&X.c("4005",t+5)&&X.U32(4)+8<=X.Sz()){for(sName="SBStudio module (.PAC)",bDetected=1,p=8,sz=p+X.U32(4),title=tracker="",end=trk=ord=ptn=spd0=bpm0=smp=0;p<X.Sz()&&(hkhd=X.SA(p,4),!(charStat(hkhd).indexOf("allasc")<0));){switch(hksz=X.U32(p+4),p+=8,hkhd){case"SND ":smp++
break
case"SOIN":spd0=X.U8(p),bpm0=X.U8(p+1),ptn=X.U16(p+2),trk=X.U8(p+4)
break
case"SONA":title=X.SC(p,hksz,"CP850")
break
case"SOOR":ord=hksz>>1
break
case"PAOR":tracker=X.SC(p,hksz,"CP850")
break
case"END ":end=1}if(p+=hksz,end)break}""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(title),sOption(tracker,"in: "),sOption("trk:"+trk+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(X.U32(4)+8)))}else if(X.c("'PLM'1A..10")&&isWithin(ch=X.U8(54),1,32)&&X.Sz()>=4*((smp=X.U8(92))+(ptn=X.U8(93))+(ord=X.U16(94,_LE)))&&firstNotOf(60,32,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])<0){for(sName="Disorder Tracker 2 module (.PLM)",bDetected=1,p=X.U8(4),ofs=rsmp=0,rptn=[],ptns=[],smps=[],mp=[0,"unk"],bad="",E=0;E<ord;E++,p+=4)rptn.indexOf(t=X.U8(p+3))<0&&rptn.push(t)
for(E=0;E<ptn;E++,p+=4)(t=X.U32(p))>mp[0]&&(mp=[t,"ptn"]),t=X.SC(t+7,25,"CP437").trim(),t.length&&ptns.push(t)
for(E=0;E<smp;E++,p+=4)(t=X.U32(p))>mp[0]&&(mp=[t,"smp"]),t&&(X.c("'PLS'1A",t)||(bad=bad.addIfNone("!badsmpsig:"+X.SA(t,4))),isWithin(X.I8(t+50),-1,15)||(bad=bad.addIfNone("!badsmppan")),X.U8(t+51)>64&&(bad=bad.addIfNone("!badsmpvol")),t=X.SC(t+6,32,"CP437").trim(),t.length&&smps.push(t),X.U32(t+67)&&rsmp++)
switch(rptn=rptn.length,p>X.Sz()&&(bad=bad.addIfNone("!short")),sz=Math.max(mp[0],p),mp[1]){case"ptn":sz=mp[0]+X.U32(mp[0],_LE)
break
case"smp":sz=mp[0]+X.U8(mp[0]+4)+X.U32(mp[0]+67,_LE)}bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SC(6,48,"CP437")),sOption(addEllipsis(smps.join(" "),224),'smp/msg:"','"'),sOption("ch:"+X.U8(54)+" bpm0:"+X.U8(58)+" spd0:"+X.U8(59)+" ord:"+ord+" ptn:"+(rptn!=ptn?rptn+"/":"")+ptn+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" sz:"+outSz(sz)))}else if(X.c("'PLX'00"))sName="Palladix Adlib module (.PLX)",bDetected=1
else if(X.c("FFFFE002E102"))sName="POKEYNoise chiptune (.PN)",bDetected=1
else if(X.c("01080B08 E1079E32 30363100 000078D8 A2FF9A20 1B082000"))sName="Polyanna module (.PRG)",sVersion="v1.0&player",bDetected=1,X.isVerbose()&&sOption("sz:"+outSz(22529))
else if(X.c("'PRT'"))sName="PreTracker module (.PRT)",bDetected=1,nV=X.U8(3),nV<25?sVersion="v<0.3":25==nV?sVersion="v0.3~0.866":26==nV?sVersion="v0.87~0.92":27<=nV&&nV<30?sVersion="v.[0.93~1.5)":30==nV?sVersion="v1.5+":sVersion="v.TODO",X.isVerbose()&&(sOptionT(X.SA(20,20)),sOptionT(X.SA(40,20),"by: "),trks=X.U8(90),trks>31&&(sVersion+="/malformed"),sOption("trks:"+X.U8(90)+" ord:"+X.U8(95)+" ptn:"+X.U8(93)+"("+X.U8(94)+") restart:"+X.U8(92)))
else if(X.c("'PSA'00")&&52<X.U32(40,_BE)<X.Sz()&&52<X.U32(44,_BE)<X.Sz()&&52<X.U32(48,_BE)<X.Sz()){if(sName="Professional Sound Artists module (.PSA)",bDetected=1,X.isVerbose()){for(sOptionT(X.SA(4,20)),d2=X.U32(40,_BE),x=d2-56>>3,x>1&&sOption(x,"×"),d3=X.U32(44,_BE),d0=X.U32(48,_BE),ins=d3-d2>>6,d3=ins,synsmp=0,smp=0,allsmpsz=0,d7=3;d3;)ts=X.U32(d2,_BE),ts?ts<d7&&(d7=ts,smpsz=X.U16(d2,_BE)+4<<1,allsmpsz+=smpsz,smp++):synsmp++,d2+=64,d3--
sz=X.U32(36,_BE),songsz=sz-allsmpsz,ptn=songsz-d0>>10,sOption("ptn:"+ptn+" ins:"+ins+" smp:"+smp+" syn.smp:"+synsmp+" songsz:"+songsz+" sz:"+outSz(sz))}}else if(X.c("'PSC V'........' COMPILATION OF '"))sName="Pro Sound Creator module (.PSC)",sVersion="v"+X.SA(5,4),bDetected=1,X.isVerbose()&&(sOptionT(X.SA(25,20)),sOptionT(X.SA(49,20),"by: "))
else if(X.c("'PSF'")){if(nV=X.U8(3),nV>0){switch(bDetected=1,sName="Portable Sound Format module (.",nV){case 1:sName+="PSF,.PSF1,.MINIPSF,.MINIPSF1)",sVersion="Playstation"
break
case 2:case 3:sName+="PSF2,.MINIPSF2)",sVersion="Playstation 2"
break
case 17:sName+="SSF,.MINISSF)",sVersion="Saturn"
break
case 18:sName+="DSF,.MINIDSF)",sVersion="Dreamcast"
break
case 33:sName+="USF,.MINIUSF)",sVersion="Ultra64"
break
case 34:sName+="GSF,.MINIGSF)",sVersion="Gameboy"
break
case 35:sName+="SNSF,.MINISNSF)",sVersion="Super Nintendo"
break
case 36:sName+="2SF,.MINI2SF)",sVersion="Nintendo DS"
break
case 37:sName+="NCSF,.MININCSF)",sVersion="Nintendo DS Nitro Sound"
break
case 65:sName+="QSF,.MINIQSF)",sVersion="Capcom Q-Sound"
break
default:sName+="*SF,.MINI*SF)",sVersion="unk.console"}if(sVersion="v"+Hex(nV)+" "+sVersion,X.isVerbose())if(ptags=X.U32(8,_LE)+21,sig2=!1,21<ptags&&ptags<X.Sz()&&(sig2="[TAG]"===X.SA(ptags-5,5)),sig2||(ptags=X.U32(4,_LE)+21,21<ptags&&ptags<X.Sz()&&(sig2="[TAG]"===X.SA(ptags-5,5))),sig2){for(tags=X.SC(ptags,X.Sz()-ptags,"UTF8").trim(),a="",g="",t="",y="",l="",tagl=tags.split("\n"),E=0;E<tagl.length;E++)switch(tag=tagl[E].split("="),tag[0]){case"length":l=tag[1]
break
case"title":t=tag[1]
break
case"game":g=tag[1]
break
case"artist":a=tag[1]
break
case"copyright":case"ssfby":""==a&&(a=tag[1])
break
case"year":y=tag[1]}sOption(t),sOption(a,"by: "),sOption(y,"'"),sOption(g,"for: "),sOption(l,"len ")}else sVersion+=" library"
X.Sz()<768&&(sVersion+=" header")}}else if(X.c("'PSG'1A"))sName="fMSX/x128 PSG chiptune (.PSG)",bDetected=1
else if(X.c("'EPSG'1A")){if(sName="Z80 Stealth Extended PSG chiptune (.EPSG)",bDetected=1,hw=X.U8(5),0===hw)sVersion="ZX Spectrum 128k"
hw<2&&!X.c("00000000 000000000000",6)&&(sVersion+="/malformed")}else if(X.c("'PSG2'"))sName="PSG2 chiptune (.PSG2)",bDetected=1
else if((X.c("'PSM '")||X.c("'PSM'FE"))&&X.fStr(8,10,"FILE")>=0&&X.fStr(16,50,"MAINSONG")>=0)sName="Epic Megagames MASI module (.PSM)",bDetected=1,X.isVerbose()&&(pt=X.fStr(16,50,"MAINSONGTITL"),pt>0&&(ts=X.U32(pt+12),sOptionT(X.SA(pt+16,ts))),sOption(outSz(X.U32(4)+12),"sz:"))
else if(X.c("'PSY'..'SONG")){if(sName="Psycle module (.PSY)",bDetected=1,sV=X.SA(3,1),sVersion="v"+sV,X.isVerbose())switch(sV){case"0":case"1":sOptionT(X.SC(8,32,"CP1252")),sOptionT(X.SC(40,32,"CP1252"),"by: "),sOptionT(X.SC(72,128,"CP1252"))
break
case"2":if(sOptionT(X.SC(8,32,"CP1252")),sOptionT(X.SC(40,32,"CP1252"),"by: "),sOptionT(X.SC(72,128,"CP1252")),bpm=X.I32(200),ord=X.I32(401),trk=X.I32(405),ptn=X.I32(409),p=413,X.isDeepScan()){for(inss=[],vsts=[],macs=[],waves=mach=0,bad="",E=0;E<ptn;E++)rows=X.I32(p),p+=36+160*rows
for(p+=4,inss=[],E=0;E<255;E++)t=X.SC(p,32,"CP1252").trim(),""!=t&&"empty"!=t&&inss.push(t),p+=32
if(p+=14284,p>X.Sz())bad=bad.addIfNone("!short")
else for(E=0;E<255&&p<X.Sz();E++)for(w=0;w<16&&p<X.Sz();w++)if(t=X.U32(p),p+=4,t){w||waves++,p+=45
var K=X.U8(p++)+1
p+=t<<K}if(p>X.Sz())bad=bad.addIfNone("!short")
else for(E=0;E<256;E++)t=X.U8(p++),t&&(t=X.SC(p,128,"CP1252").trim(),""!=t&&vsts.push(t),p+=128,t=X.I32(p),p+=4+4*t)
for(m=[],E=0;E<128;E++)t=X.U8(p++),t&&mach++,m[E]=t
t=oldt=0
const zs=8,hs=9,Es=10
for(E=0;E<128;E++)if(m[E]){for(t=X.I32(p+8),p+=12,tn=X.SA(t===zs?p+256:p,16),tpn=t===zs?X.SA(p,256):"",ts=tn+tpn,nonascii=!1,U=0;U<ts.length;U++)if(ts[U]<" "||ts[U]>"~"||/[\"\+\?\*]/.test(ts[U])){nonascii=!0
break}if((15<t&&t<255||ts.length<2||nonascii)&&oldt===zs){bad=bad.addIfNone("!pluginDefinedDataSize")
break}if(15<t&&t<255){bad=bad.addIfNone("!badMachineType")
break}switch(oldt=t,t){case zs:macs.push(tn),t=X.I32(p+272),p+=276+4*t,p+=385
break
case hs:case Es:vsts.push(tn),p+=407
break
default:macs.push(X.SA(p,16)),p+=401}}p>X.Sz()&&(bad=bad.addIfNone("!short")),p+=1275,p>X.Sz()&&(bad=bad.addIfNone("!noP0")),p+=64,p>X.Sz()&&(bad=bad.addIfNone("!noP1")),p<X.Sz()&&X.U8(p++)&&(p+=4+X.U32(p)),""!=bad&&(sVersion+="/malformed"+bad),inss.length&&sOption("inss: ["+inss.join(",")+"]"),vsts.length&&sOption("vsts: ["+vsts.join(",")+"]"),macs.length&&sOption("mcn: ["+macs.join(",")+"]"),sOption("ord:"+ord+" ptn:"+ptn+" trk:"+trk+" bpm:"+bpm+" mach:"+mach+" smp:"+waves+" sz:"+outSz(p))}else sOption("ord:"+ord+" ptn:"+ptn+" trk:"+trk+" bpm:"+bpm)
break
case"3":for(nV=X.I32(8),sVersion+="/"+nV,p=16+X.U32(12),hkn=X.U32(16,_LE),t="",a="",c="",trk=0,bpm=0,ptnlns=0,ptn=0,mac=0,ins=0,eins=0;hkn>0;){switch(hkhd=X.SA(p,4),hkn--,cV=X.U32(p+4,_LE),hksz=X.U32(p+8,_LE),p+=12,hkhd){case"INFO":p1=p,65280&cV||(t=X.SC(p1,128,"CP1252"),p1+=t.length+1,a=X.SC(p1,64,"CP1252"),p1+=a.length+1,c=X.SC(p1,65535,"CP1252"),p1+=c.length+1,0==cV&&(hksz=t.length+a.length+c.length+3))
break
case"SNGI":65280&cV||(trk=X.I32(p,_LE),0==cV&&(hksz=44+2*trk),bpm=X.I16(p+4,_LE)+X.I16(p+6,_LE)/100)
break
case"SEQD":65280&cV||(seqlen=X.I32(p+4,_LE))
break
case"PATD":65280&cV||(_idx=X.I32(p,_LE),ptnlns=X.I32(p+4,_LE),ptnn=X.SA(p+12,32),p1=p+12+ptnn.length+1,ptnsz=X.I32(p1,_LE),ptn++,p1+=4,0==cV&&p1+ptnsz==p+hksz+4&&(hksz+=4))
break
case"MACD":mac++
break
case"INSD":ins++
break
case"EINS":65536==(4294901760&cV)&&(eins=X.U32(p,_LE))}p+=hksz}sOptionT(t),sOptionT(a,"by: "),sOptionT(c),sOption("bpm:"+bpm+" trk:"+trk+" ptnlns:"+ptnlns+" mac:"+mac+" ptn:"+ptn+"/idx:"+_idx+" ins:"+ins+" eins:"+eins+" sz:"+outSz(p))
break
case"4":sVersion+="/future"}}else if(X.c("'PSMP'")&&[0,16].indexOf(X.U8(4))>=0)sName="Sega MegaDrive Pre-SMP chiptune (.PSZ)",bDetected=1,sVersion=X.U8(4)?"BE":"LE",X.isVerbose()&&sOption("tempo:"+X.U8(5))
else if(X.c("'PTCOLLAGE-'")||X.c("'PTTUNE--20'")){if(bDetected=1,v1=X.SA(2,1),"T"===v1){var J=10
sName="pxtone tune (.PTTUNE)"}else{J=1
sName="pxtone project (.PTCOP)"}if(dt=X.SA(10,6),dt<="050227"?(sV="v.x1x",nV=1):dt<="050608"?(sV="v.x2x",nV=2):dt<="060115"?(sV="v.x3x",nV=3):dt<="060930"?(sV="v.x4x",nV=4):dt<="071119"&&(sV="v5",nV=5),d=dt.substr(0,2)+"-"+dt.substr(2,2)+"-"+dt.substr(4,2),sVersion=sV+"/20"+d,X.isVerbose()){switch(nV){case 1:case 2:p=16
break
default:p=20}for(t="",c="",bclock=0,bnum=0,btempo=0,bps=0,bEnd=!1;!bEnd&&p<X.Sz();){switch(hkhd=X.SA(p,8),hksz=X.U32(p+8,_LE),hkhd){case"PROJECT=":t=X.SC(p+12,16,"Shift_JIS"),btempo=X.F32(p+28,_LE).toFixed(0),bclock=X.I16(p+32,_LE),bnum=X.I16(p+34,_LE)
break
case"evenMAST":if(3!=X.U16(p+12,_LE))sVersion+="/unk"
else{var q=X.fSig(p+3,256,"'textNAME'")-12;(q>-12||(q=X.fSig(p+3,256,"'textCOMM'")-12)>-12)&&(p=q-hksz)}break
case"MasterV5":bclock=X.I16(p+12,_LE)*J,bnum=X.I8(p+14),btempo=X.F32(p+15,_LE).toFixed(0)
break
case"Event V5":var Z=X.U32(p+12,_LE)
for(hksz=4,e=0;e<Z;e++){for(E=0;E<5&&(hksz++,!(X.U8(p+11+hksz)<128));E++);for(hksz+=2,E=0;E<5&&(hksz++,!(X.U8(p+11+hksz)<128));E++);}break
case"textNAME":t=X.SC(p+12,hksz,"Shift_JIS")
break
case"textCOMM":c=addEllipsis(X.SC(p+12,hksz,"Shift_JIS"),160)
break
case"END=====":case"pxtoneND":bEnd=!0}p+=12+hksz}"no name"!=t&&sOption(t),sOptionT(c),bclock+btempo+bnum>0&&sOption("btempo:"+btempo+" bclock:"+bclock+" bnum:"+bnum),sOption(outSz(p),"sz:")}}else if(X.c("'PTNOISE-'"))sName="pxtone Noise instrument (.PTNOISE)",bDetected=1
else if(X.c("'PTVOICE-'"))sName="pxtone Voice instrument (.PTVOICE)",bDetected=1,X.isVerbose()&&sOption(outSz(X.U32(12)+16),"sz:")
else if(X.c("'PTMF'",44)&&26==X.U8(28)&&X.U8(30)<=2&&isWithin(ch=X.U16(38),1,32)&&(ord=X.U16(32))<256&&isWithin(ins=X.U16(34),1,255)&&isWithin(ptn=X.U16(36),1,128)){for(sName="Poly Tracker module (.PTM)",bDetected=1,sV=Hex(X.U16(29)),sVersion="v"+sV.substr(0,1)+"."+sV.substr(1,2),bad="",sn=[],E=mp=rsmp=0,p=608;E<ins;E++,p+=80)3&X.U8(p)&&(rsmp++,t=X.U32(p+18),mp<t&&(mp=t,sz=t+X.U32(p+22))),t=X.SC(p+48,28,"CP437").trim(),t.length&&sn.push(t)
sz=Math.max(sz,p),rsmp||(bad=bad.addIfNone("!badsmpavl")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SC(0,28,"CP437")),sOption(addEllipsis(sn.join(" ")),'ins/msg:"','"'),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+rsmp+" sz:"+outSz(sz)))}else if(X.c("'RAD by REALiTY!!'")){if(sName="Reality Adlib Tracker module (.RAD)",bDetected=1,sV=X.U8(16).toString(16),sVersion="v"+sV[0]+"."+sV[1],bad="",X.isVerbose()){if(al=X.U8(17),fbpm=sV>"20"&&32&al,"10"==sV&&128&al||sV>="20"){for(l=18,fbpm&&(l+=2),desc="",maxdesc=250,cutoff=!1,r=X.fSig(l,X.Sz()-32-l,"00"),p=r+1,r<0?(maxdesc=0,bad=bad.addIfNone("!baddesc")):r>l+maxdesc&&(r=l+maxdesc,cutoff=!0),tmp=X.readBytes(l,r-l),E=0;desc.length<maxdesc;E++)switch(tmp[E]){case 0:E=r-l
break
case 1:desc+="\n"
break
default:if(tmp[E]<32)for(j=0;j<tmp[E]&&desc.length<=maxdesc;j++)desc+=" "
else desc+=String.fromCharCode(tmp[E])}cutoff&&(desc+="..."),sOption(desc)}else p=18
for(spd0=31&al,fbpm?bpm=X.U16(18,_LE):bpm=125,ins=0;insn=X.U8(p++),insn&&!(p>X.Sz());)ins++,"10"==sV?p+=11:"21"==sV?(nmlen=X.U8(p),p+=nmlen+1,rm=X.U8(p),riff=128&rm,midi=!(7&~rm),midi?p+=7:p+=24,riff&&(p+=X.U16(p,_LE)+2)):bad=bad.addIfNone("!badver")
for(ord=X.U8(p++),p+=ord,ptn=0,E=0;E<32;E++)X.U16(p+2*E,_LE)&&ptn++
if(p+=64,(!ord||ord>128)&&(bad=bad.addIfNone("!badord")),ptn||(bad=5),ins||(bad=bad.addIfNone("!badptn")),sV>"20"){for(riffs=0;riffn=X.U8(p++),!(255==riffn||p>X.Sz());)riffs++,p+=X.U16(p)
sOption("spd0:"+spd0+" bpm:"+bpm+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" riffs:"+riffs)}else sOption("spd0:"+spd0+" bpm:"+bpm+" ord:"+ord+" ptn:"+ptn+" ins:"+ins)
bad&&(sVersion+="/malformed"+bad)}}else if(X.c("'RAWADATA'")&&X.Sz()>10){if(sName="Raw OPL Capture chiptune (.RAW)",bDetected=1,X.isVerbose()&&(X.isDeepScan()||X.Sz()<65535)){for(p=10,len=X.Sz()-10>>1,tagdata=!1,t=a=d="",next=0,E=0;E<len&&p<X.Sz();E++)x=tagdata?65535:X.U16(p),p+=2,tagdata||65535!=x||(tagcode=X.U8(p++),26==tagcode?tagdata=!0:tagcode?p--:(d=X.SA(p,1023),p+=1023,tagdata=!0))
tagdata&&(t=X.SA(p,40),p+=40,27!=X.U8(p++)&&(p--,X.U8(p)>=32?(a=X.SA(p,60),p+=60,d=X.SA(p,1023),p+=1023,next=2):p--,next=1),next||(a=X.SA(p,40),p+=40),1==next&&(next=0,28!=X.U8(p++)&&(next=2),next||(d=X.SA(p,1023),p+=1023))),sOption(t),sOption(a,"by: "),sOption(d)}X.isVerbose()&&sOption(X.U16(8),"clkspd:")}else if(X.c("'RNS0'")&&X.c("'>>> Chunk Start <<<'00",9)){if(sName="Renoise module (.RNS)",bDetected=1,sV=X.SA(3,4),sVersion="v"+sV,sV<"05"?sVersion+="/RN<1.1.1":"05"===sV?sVersion+="/RN1.1.1":sV<"015"?sVersion+="/RN<1.2.7":"015"===sV?sVersion+="/RN1.2.7":sV<"018"?sVersion+="/RN<1.5.2":"018"===sV?sVersion+="/RN1.5.2":sVersion+="/RN>1.5.2",X.isVerbose())for(p=9;p<X.Sz()&&X.c("'>>> Chunk Start <<<'00",p);){if(p+=20,X.c("'Header V00         '00",p)){sOptionT(X.SC(p+20,20,"CP1252")),sOptionT(X.SC(p+40,20,"CP1252"),"by: "),sOptionT(X.SC(p+60,20,"CP1252"),"style: ")
break}if(X.c("'Header V01         '00",p)){p+=20,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252")),p+=sz+4,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252"),"by: "),p+=sz+4,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252"),"style: ")
break}if(X.c("Header V02         '00",p)){p+=20,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252")),p+=sz+4,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252"),"by: "),p+=sz+4,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252"),"style: "),p+=sz+4+5,sz=X.U32(p),sOptionT(X.SC(p+4,sz,"CP1252"))
break}if(p=X.fSig(p+1,TOEOF,"''>>>  Chunk End  <<<'00"),-1==p)break
p+=20}}else if(extIs("xrns")&&X.c("'PK'0304"))sName="Renoise module (.XRNS)",sVersion="xml",bDetected=1
else if(extIs("xrdp")&&X.fStr(0,256,"<FilterDevicePreset")>=0)sName="Renoise filter device preset (.XRDP)",bDetected=1,p=X.fStr(20,256,"doc_version="),p<0?sVersion="malformed":(sVp=X.SA(p,16),sVersion="v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(extIs("xrni")&&X.c("'PK'0304"))sName="Renoise instrument (.XRNI)",sVersion="xml",bDetected=1
else if(extIs("xrno")&&X.fStr(0,256,"<SampleModulationSet")>=0)sName="Renoise sample modulation set (.XRNO)",bDetected=1,p=X.fStr(15,256,"doc_version="),p<0?sVersion="malformed":(sVp=X.SA(p,16),sVersion="v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(extIs("xrnt")&&X.fStr(0,256,"<RenoiseDeviceChain")>=0)sName="Renoise effect chain (.XRNT)",bDetected=1,p=X.fStr(15,256,"doc_version="),p<0?sVersion="malformed":(sVp=X.SA(p,16),sVersion="v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(extIs("xrnt")&&X.c("'PK'0304"))sName="Renoise effect chain (.XRNT)",sVersion="v<3.0",bDetected=1
else if(extIs("xrnz")&&X.fStr(0,256,"<InstrumentPhrase")>=0)sName="Renoise instrument phrase (.XRNZ)",bDetected=1,p=X.fStr(15,256,"doc_version="),p<0?sVersion="malformed":(sVp=X.SA(p,16),sVersion="v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(X.c("'NuRIFFRAFF'",34))sName="Riff Raff module (.RIFF)",bDetected=1,X.isVerbose()&&(t=X.SC(100,256,"CP1252"),a=X.SC(100+t.length+1,256,"CP1252"),c=X.SC(100+t.length+a.length+2,256,"CP1252"),sOptionT(t),sOptionT(a,"by: "),sOptionT(c))
else if(X.c("'RON_KLAREN_SOUNDMODULE!'00",40))sName="Ron Klaren module (.RK)",bDetected=1
else if(X.c("'RTMM '"))sName="Real Tracker module (.RTM)",bDetected=1,sVersion="v"+X.SA(55,7),X.isVerbose()&&(sOptionT(X.SC(5,32,"CP1252")),sOptionT(X.SC(62,32,"CP1252"),"by: "),sOptionT(X.SC(140,32,"CP1252"),"orig.: "))
else if(X.c("01FF..3EFF32018079FEFF2846320280B7201301FF013E1CED79053E02ED79AF320180C9")&&X.c("21A9843D280E232347237E2BB67820F6232318EF5E23567AB328D22B2224803EFE320E823E08325280C35C80",38))sName="František Fuka/Fuxoft Samadeus module (.samadeus)",bDetected=1
else if(X.c("00000000 00000200",12)&&X.c("00")&&X.U16(24,_LE)===X.U16(64,_LE)&&X.c("00'ST-Module.'",1207)){for(sName="Amstrad CPC Soundtrakker module (.STK)",bDetected=1,datasz=X.U16(24,_LE),sz=datasz+128,sz<X.Sz()&&(sVersion="malformed"),crc=0,E=0;E<67;E++)crc+=X.U8(E)
crc&=65535,crc!=X.U16(67)&&(sVersion+=""!=sVersion?"!badCRC":"/malformed!badCRC"),X.isVerbose()&&sOptionT(X.SA(1,8)),sOption(outSz(sz),"sz:")}else if(X.c("00000000 00000200",12)&&X.c("00")&&X.U16(24,_LE)===X.U16(64,_LE)&&X.SA(1,8)===X.SA(2832,8)){for(sName="Amstrad CPC Soundtrakker 128K module (.128)",bDetected=1,datasz=X.U16(24,_LE),sz=datasz+128,sz<X.Sz()&&(sVersion="malformed"),crc=0,E=0;E<67;E++)crc+=X.U8(E)
for(crc&=65535,crc!=X.U16(67)&&(sVersion+=""!=sVersion?"!badCRC":"/malformed!badCRC"),X.isVerbose()&&sOptionT(X.SA(1,8)),inst=[],ins=0,E=0;E<16;E++)[0,32].indexOf(X.U8(2840+8*E))||(ins++,inst.push(X.SA(2840+8*E,8).trim()))
sOption(inst),sOption("ins:"+ins+" sz:"+outSz(sz))}else if(X.c("00'ST-Module.'",1079))sName="Amstrad CPC Soundtrakker module (.STK)",bDetected=1,sVersion="headerless"
else if(X.Sz()>32&&/S98[0-3]/.test(X.SA(0,4))&&X.U32(4)<=32&&!X.U32(12)&&(!X.U32(16)||isWithin(X.U32(16),32,8388608))&&X.U32(20)<131072&&(!X.U32(24)||isWithin(X.U32(24),X.U32(20),8388608))&&X.U32(28)<=64){if(sName="Ru³'s S98 chiptune (.S98)",bDetected=1,nv=X.U8(3)-48,sVersion="v"+nv,dev=X.U32(28),!dev||nv>=2&&!X.U32(32))sVersion+="#OPNA(YM2608)@7.6MHz"
else for(E=0,p=32;E<dev&&X.U32(p);E++,p+=16)clk=(X.U32(p+4)/1048576).toFixed(1)+"MHz",(dt=X.U32(p))>16?sVersion+="#unk@"+clk:sVersion+="#"+["","PSG(YM2149)","OPN(YM2203)","OPN2(YM2612)","OPNA(YM2608)","OPM(Y2151)","OPLL(YM2413)","OPL(YM3526)","OPL2(YM3812)","OPL3(YMF262)","unk0A","unk0B","unk0C","unk0D","unk0E","PSG(AY-3-8910)","DCSG(SN76489)"][dt]+"@"+clk
if(bad="",(X.U32(20)>X.Sz()||X.U32(24)>X.Sz())&&(bad+="!short"),X.U32(16)>X.Sz()-7&&(bad+="!badmetadata"),bad.length&&(sVersion+="/malformed"+bad),X.isVerbose())switch(a=c=i=g=ti=y="",nv){case 0:case 1:case 2:p=X.U32(16),p>0&&sOptionT(X.SC(p,64,"Shift_JIS").replace("\\","￥")),pk=X.U32(12),pk&&(sVersion+=" compressed",sOption("Please send this file over Telegram to @kaens, the detection author! It's unique and needs research"))
break
case 3:if(ptags=X.U32(16),ptags>6&&X.c("'[S98]'",ptags)){for(ptags+=5,bUTF8=X.c("EFBBBF",ptags),bUTF8?tags=X.SC(ptags,512,"UTF8"):tags=X.SC(ptags,512,"Shift_JIS"),tagl=tags.split("\n"),E=0;E<tagl.length;E++)switch(tag=tagl[E].split("="),tag[0]){case"title":case"ｔｉｔｌｅ":ti=tag[1]
break
case"game":case"ｇａｍｅ":g=tag[1]
break
case"system":case"ｓｙｓｔｅｍ":i=tag[1]
break
case"artist":case"ａｒｔｉｓｔ":a=tag[1]
break
case"year":case"ｙｅａｒ":y=tag[1]
break
case"copyright":case"ｃｏｐｙｒｉｇｈｔ":case"s98by":case"ｓ９８ｂｙ":""==a&&(a=tag[1])
break
case"comment":case"ｃｏｍｍｅｎｔ":c=tag[1]}sOption(ti),sOption(a,"by: "),sOption(y,y.length<4?"y'":"y"),sOption(g,"for: "),sOption(i,"on: "),sOption(c),ptags>6&&X.c("'[S98]'",ptags-5)&&(t=X.fSig(ptags,768,"00"))>-1&&sOption(outSz(t+1),"sz:")
break}ptags>6&&(t=X.SC(ptags,64,"Shift_JIS").replace("\\","￥"))}}else if(X.c("'SAP'0D0A")&&(p=X.fSig(3,TOEOF,"0D0AFFFF"))>=3&&X.U16(p+4)<X.U16(p+6)){if(sName="Slight Atari Player chiptune (.SAP)",bDetected=1,X.isVerbose()){if(bad=!1,t="",a="",dt="",tp="",tm="",taghunk=X.SA(5,p),taghunk.length>5)for(tags=taghunk.split("\r\n"),E=0;E<tags.length;E++)switch(tagdiv=tags[E].indexOf(" "),tagl=tags[E].substr(0,tagdiv),tagr=tags[E].substr(tagdiv+1,tags[E].length),tagl){case"NAME":'"<?>"'!=tagr&&(t=tagr.substr(1,tagr.length-2))
break
case"AUTHOR":'"<?>"'!=tagr&&(a=tagr.substr(1,tagr.length-2))
break
case"DATE":'"<?>"'!=tagr&&(dt=tagr.substr(1,tagr.length-2))
break
case"TYPE":sVersion="t."+tagr
break
case"TIME":tm=tagr}bad&&(sVersion+="/malformed"),sOption(t),sOption(a,"by: "),sOption(dt,"'"),sOption(tm,"len: "),t=parseAtariBinary(p+2),sOption(t[1].length,"binblks:"),sOption(outSz(t[0]),"sz:")}}else if(X.c("'SC68 Music-file / (c) (BeN)jamin Gerard / SasHipA-Dev  '00'SC68'........'SCFN'")){if(sName="SC 68000 programmatic chiptune (.SC68)",bDetected=1,X.isVerbose()){for(hdrl=X.SA(0,256).length+1,p=hdrl,t="",a="",cp="",K="",df=-1,x=0,ef=!1,mn=[];p<X.Sz();){switch(hkhd=X.SA(p,4),hksz=X.U32(p+4,_LE),p+=8,hkhd){case"SC68":hksz+hdrl!=X.Sz()&&(sVersion="malformed"),hksz=0
break
case"SCFN":t=X.SC(p,hksz,"CP1252")
break
case"SCDF":df=X.U32(p,_LE)+1
break
case"SCMN":mn.push(X.SC("CP1252",p,hksz)),""!=K&&df!=mn.length||(K=mn[mn.length-1])
break
case"SCAN":a=X.SC(p,hksz,"CP1252")
break
case"SCCN":cp=X.SC(p,hksz,"CP1252")
break
case"SCEF":ef=!0,p=X.Sz()}p+=hksz}sOptionT(t),mn.length>1&&sOption(mn.length,"×"),sOptionT(mn.join(";")),sOptionT(a,"by: "),sOptionT(cp,"(c)"),sOption(outSz(p),"sz:"),ef||(sVersion="malformed!short")}}else if(X.c("'shro'020000"))sName="Mario Paint's Shroom module (.SHO)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(7,32)),sOptionT(X.SA(39,32),"by: "))
else if(X.c("'PSID'")||X.c("'RSID'")){switch(v1=X.SA(0,1),bDetected=1,"P"==v1?sName="PlaySID programmatic chiptune (.SID, .PSID)":sName="RealSID programmatic chiptune (.SID, .RSID)",v2=X.U16(4,_BE),sVersion="v"+Hex(v2),bad=0,x=X.U16(14,_BE),x<1||x>256?bad=1:x>1&&sOption(x,"×"),startSong=X.U16(16,_BE),startSong>x&&(bad=2),dataOfs=X.U16(6,_BE),(1==v2&&118!=dataOfs||2==v2&&124!=dataOfs)&&(bad=3),loadAddr=X.U16(8,_BE),"R"==v1&&loadAddr>0&&loadAddr<2024&&(bad=4),initAddr=X.U16(10,_BE),"R"==v1&&(initAddr<2024||40960<=initAddr&&initAddr<49152||53248<=initAddr)&&(bad=5),flags=X.U16(118,_BE),"R"==v1&&(2&flags)>>1&&initAddr>0&&(bad=6),(48&flags)>>4){case 1:sVersion+="/6581"
break
case 2:sVersion+="/8580"
break
case 3:sVersion+="/6581&8580"
break
default:sVersion+="/unk.chip"}switch((12&flags)>>2){case 1:sVersion+="/PAL"
break
case 2:sVersion+="/NTSC"
break
case 3:sVersion+="/PAL&NTSC"}sidn=(dataOfs-124)/2+1,sidn>1&&(sVersion+="/"+sidn+"SID"),bad>0&&(sVersion+="/malformed"+bad),X.isVerbose()&&(t=X.SC(22,32,"CP1252"),"<?>"==t&&(t=""),sOptionT(t),a=X.SC(54,32,"CP1252"),"<?>"==a&&(a=""),sOptionT(a,"by: "),c=X.SC(86,32,"CP1252"),"<?>"==c&&(c=""),sOptionT(c))}else if(X.c("00 FF00FF00 9100FF00 FF008000 92..00967F 01",7)&&X.c("9908",5442))sName="Sound Images Generation 2 module (.SIG)",bDetected=1
else if(X.c("0100FEFF09000000'ALIM3'"))sName="Skale Tracker module (.SKM)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(25))
else if(X.c("'<track'")&&X.fStr(6,256,"rowhighliohtingminor=")>0)sName="Picatune module v1 (.SMUFI) or v2 (.PT2)",bDetected=1,X.isVerbose()&&(i=X.SC(0,256,"UTF8"),t=/.*name="([^"]*)".*/.exec(i),null!=t&&sOptionT(t[1]),a=/.*author="([^"]*)".*/.exec(i),null!=a&&sOptionT(a[1],"by: "),spd=/.*speed="([^"]*)".*/.exec(i),bpm=/.*bpm="([^"]*)".*/.exec(i),null!=spd&&(sVersion+=" spd: "+spd[1]),null!=bpm&&(sVersion+=" bpm: "+bpm[1]))
else if(X.c("'SNGs'")&&X.Sz()>16&&X.U8(10)<=X.U8(7)&&X.U8(11)<=30&&isWithin(X.U8(12),0,120)&&isWithin(X.U8(13),1,30)&&isWithin(X.U8(14),1,30))sName="BlueMoon's Sound Club for DOS module (.SN)",bDetected=1,(ord=X.U8(7))||(sVersion="malformed!0ord"),X.isVerbose()&&(sOptionT(X.SA(15,26)),lp=X.U8(10),gvol=5*X.U8(11),tx=X.U8(12),tpb=X.U8(13),bpms=X.U8(14),sOption("rhythm:"+tpb+"/"+bpms+" ord:"+X.U8(7)+" ins:"+X.U8(4)+" gvol:"+gvol+"%"))
else if(X.c("'SN2'")&&isWithin(X.U32(19),0,120)&&isWithin(X.U32(23),1,30)&&isWithin(X.U32(27),1,30)&&X.c("'NAM'",31)&&X.c("'SEQ'",38+X.U32(34))){if(sName="Bluemoon's Sound Club for Windows module (.SN2)",bDetected=1,X.isVerbose()){for(sOptionT(addEllipsis(X.SA(38,X.U32(34)))),sz=X.U32(3)+7,lp=X.U32(15),tx=X.U32(19),tpb=X.U32(23),bpms=X.U32(27),tempop=Math.round(200-tx*(4.27246-tx*(.0603477+tx*(1.33871*tx/1e6-453202e-9)))),p=38+X.U32(34),ord=ptn=ins=0,end=!1;!end&&p<X.Sz();){switch(hkhd=X.SA(p,3),hksz=X.U32(p+3),p+=7,hkhd){case"PAT":ptn++
break
case"SEQ":ord=Util.divu64(hksz,4)
break
case"INS":ins++}p+=hksz}sOption("rhythm:"+tpb+"/"+bpms+" tempo: "+tempop+"% ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" ins:"+ins+" sz:"+outSz(sz))}}else if(X.c("'SNDH'",12)&&(X.isHeuristicScan()||X.c("6000............6000"))){if(sName="Atari ST Sound Header module (.SND,.SNDH)",sVersion="uncompressed",bDetected=1,X.isVerbose()){for(p=16,title=artist=yr="",totaltime=E=0,x=1;E<10&&p<X.Sz();){if(t=X.SA(p,4),"TIME"===t){for(j=0;j<x;j++)totaltime+=X.U16(p+4+2*j,_BE)
tlen=4+2*x-1,(p+tlen+1)%2&&tlen++}else t=X.SA(p,Math.min(X.Sz()-p),256),tlen=t.length
if(tlen>=4)switch(hd=t.substr(0,4),tag=t.substr(4,tlen),hd){case"TITL":"Unknown"!=tag.substr(0,7)&&(title=tag)
break
case"COMM":"Unknown"!=tag.substr(0,7)&&(artist=tag)
break
case"YEAR":yr=tag
break
case"HDNS":E=8
break
default:/##\d\d/.test(hd)?x=hd.slice(2,4):/#!\d\d/.test(hd)&&(p+tlen+1)%1&&tlen++}p+=tlen+1,E++}sOptionT(title),x>"01"&&sOption(x,"×"),sOptionT(artist,"by: "),sOptionT(yr,"'"),totaltime&&sOption(secondsToTimeStr(totaltime,"time:"))}}else if(X.c("'FMC!'"))sName="Faust Music Creator module (.SNG)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(4,20))
else if(/GTS[25!]/.test(X.SA(0,4))&&X.U8(100)<=32){for(sName="Lasse Öörni's GoatTracker module (.SNG)",bDetected=1,nV=X.U8(3)-48,nV<0&&(nV=1),nV>=2?sVersion="v2."+nV:sVersion="v1.x",x=X.U8(100),p=101,ords=[],ptn=mptn=0,bad="",ordc=0;p<X.Sz()&&(U=X.U8(p),X.c("FF",p+U));){for(E=0,p++;E<U;E++)(t=X.U8(p++))<=207&&t+1>mptn&&(mptn=t+1)
ordc++,ords.push(U),p++}for(ch=3,ordc==6*x?(sVersion+=" stereo",ch=6):ordc!=3*x&&(bad=bad.addIfNone("!badordcnt")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),ins=nV>=2?X.U8(p++):31,inss=[],E=0;E<ins;E++)t=X.SC(p+(nV>1?9:8),16,"CP1250").trim(),t.length&&inss.push(t),nV>1?p+=25:p+=24+2*(X.U8(p+7)>>1)
for(E=0;E<(1==nV?0:2==nV?3:4);E++)p+=1+2*X.U8(p)
for(ptn=X.U8(p++),E=0;E<ptn;E++)p+=1+(1==nV?1:4)*X.U8(p)
if(1==nV&&X.Sz()!=p&&(p+=256),X.isVerbose()){for(sOptionT(X.SC(4,32,"CP1250")),x>1&&sOption(x,"×"),sOptionT(X.SC(36,32,"CP1250"),"by: "),sOptionT(X.SC(68,32,"CP1250")),sOptionT(addEllipsis(inss.join(", "),160),'ins/msg:"','"'),E=0,ordc=[];E<ords.length/ch;E++){for(c=j=0;j<ch;j++)c+=ords[E*ch+j]
ordc.push(c)}sOption("ch:"+ch+" ord:"+ordc.join("+")+" ptn:"+(ptn==mptn?mptn:"/"+ptn)+" ins:"+ins+" sz:"+outSz(p))}}else if(X.c("'ObsM'"))sName="Jonne Valtonen's SNG Player module (.SNG)",bDetected=1,X.U8(11)&&(sVersion+="compressed"),len=X.U16(4,_LE),len>X.Sz()&&(sVersion+="malformed"),X.isVerbose()&&(start=X.U16(6,_LE),loop=X.U16(8,_LE),delay=X.U16(10,_LE),sOption("len:"+Hex(len)+" start:"+Hex(start)+" loop:"+Hex(loop)+" delay:"+delay))
else if(X.c("'RJP'3.'SMOD'"))sName="Richard Joseph's module (.SNG)",bDetected=1,sVersion="v"+X.SA(3,1)
else if(X.c("'SYNC'")||X.c("'SYNB'"))sName="Synder SNG-player module (.SNG)",bDetected=1,sVersion="ver."+X.SA(3,1),X.isVerbose()&&sOption(X.SA(16,512))
else if(X.c("'SYND'....'S0'"))sName="Synder Tracker module (.SNG)",bDetected=1,sVersion="ver."+X.SA(3,1)
else if(X.c("'SYND'")||X.c("'SYNF'")||X.c("'SYNH'"))sName="Synder SNG-player Stereo module (.SNG)",bDetected=1,sVersion="ver."+X.SA(3,1),X.isVerbose()&&sOption(X.SA(16,512))
else if(isWithin(t=(X.U8(0)+1<<4)+(X.U8(1)+1<<7)+869,870,X.Sz())&&(/df\d:/.test(X.SA(t,4))||/[sS]amples/.test(X.SA(t,7)))){if(sName="AJ [Activas]'s ZoundMonitor module (.SNG + Samples/)",bDetected=1,X.isVerbose()){for(ptn=X.U8(1)+1,ord=X.U8(3)+1,spd=X.U8(4),p=5,smp=0;p<815;p+=54)X.U8(p+4)&&smp++
sOption("spd:"+spd+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" len "+secondsToTimeStr(1+Util.divu64(spd*ord*32,50))+" sz:"+outSz(t+101))}}else if(X.c("'RJP'3. 0000 0000"))sName="Richard Joseph's module instruments (.INS)",bDetected=1,sVersion="v"+X.SA(3,1)
else if(X.c("'SNES-SPC700 Sound File Data'")){if(sName="Nintendo SNES SPC chiptune (.SPC)",bDetected=1,sVersion="v0."+X.U8(36),X.isVerbose()){if(id666inhdr=26==X.U8(35),t="",a="",c="",g="",dumper="",emu="",preferBin=!1,id666inhdr){switch(t=X.SA(46,32),g=X.SA(78,32),dumper=X.SA(110,16),dumpdate=X.SA(158,11),emu=X.U8(210),emu>=48&&emu<=57&&(emu-=48),emu){case 1:emu="ZSNES"
break
case 2:emu="Snes9x"
break
case 3:emu="ZST2SPC"
break
case 4:emu="ETC"
break
case 5:emu="SNEShout"
break
case 6:emu="ZSNESW"
break
default:emu=""}c=X.SA(126,32),M=X.SA(169,3),lp=X.SA(172,4),(M+lp+dumpdate).length<5?(chnDis=X.U8(209),1==chnDis&&""==emu?bin=!0:bin=preferBin):/[0-9/]*/.test(M+lp+dumpdate)?(songlen=Number(M),a=X.SA(177,32)):(bin=!0,songlen=X.U8(169)<<16+X.U8(170)<<8+X.U8(171),a=X.SA(176,32))}else t=X.SA(48,20)
sOption(t),sOption(g,"for: "),sOption(a,"by: "),sOption(c),""!=emu&&(sVersion+=" "+emu)}}else if(X.c("'STK1.0SONG'")&&[1,2,3].indexOf(X.U8(52))>=0&&X.U8(53)<=X.U8(58)&&X.U8(54)<=X.U8(53)&&X.U8(56)<=63&&X.U8(57)<=5){switch(sName="STarKos module (.SKS)",bDetected=1,bad="",X.U8(57)){case 0:hz=13
break
case 1:hz=25
break
case 2:hz=50
break
case 3:hz=100
break
case 4:hz=150
break
case 5:hz=300
break
default:hz=0,bad=bad.addIfNone("!badRepFreq")}for(xpos=X.I8(55).toString(),"-"!=xpos[0]&&(xpos="+"+xpos),spd0=X.U8(56),ord=1+X.U16(58),ptn=-1,rows=ptnxpos=0,p=60,E=0;E<4*ord;E++)E%4==3?rows+=X.U8(p)+1:(t=X.U8(p),ptn<t&&(ptn=t),X.I8(p+1)>>1&&ptnxpos++),p+=2
ptn++,insns=[]
const ks=128,Fs=64,_s=32,Os=16
for(ins=0;p<X.Sz()&&ins<256&&(insn=X.U16(p),p+=2,65535!=insn);ins++)if(ip=p,isz=X.U16(ip),p+=4,iend=1+X.U8(p+2),p+=5,iname=X.SA(p,8).trim(),p+=8,""!=iname&&insns.push(iname),X.isDeepScan()){for(l=0;l<iend;l++)if(x=X.U8(p++),x)if(x&ks)y=X.U8(p++),8&x&&p++,64&y&&p++,2&x&&p++,4&x&&(p+=2),16&x&&(p+=2),32&x&&(p+=2)
else{if(x&Os&&(y=X.U8(p++),64&y&&(p+=2,x&(_s|Fs)))){bad=bad.addIfNone("!badinsflags"),ins=l=65534
break}x&_s&&p++,x&Fs&&(p+=2)}}else p=ip+isz
for(sptn=0;p<X.Sz()&&(curptn=X.U16(p),p+=2,65535!=curptn);sptn++)p+=X.U8(p)
if(X.isDeepScan()&&(notecnt=0),p<X.Sz()&&ins<65534)for(E=0;E<=ptn;E++){if(curptn=X.U16(p),p+=2,255!=curptn&&65535!=curptn&&curptn>512){bad=bad.addIfNone("!badnptn")
break}if(65535==curptn)break
if(pp=p,psz=X.U16(pp),X.isDeepScan()){p+=2
pins=-1
for(var Q=0;p<Math.min(X.Sz(),pp+psz);){p
var $=pfvol=pfpitch=!1
if(x=X.U8(p++),255==x)break
if(128&x)Q+=127&x
else if(x>=96)switch(15&x){case 0:if(pfvol=!0,pfpitch=!1,15-X.U8(p++)<0){bad=bad.addIfNone("!badptnvol0"),E=ptn,p=pp+psz
break}case 1:pfvol=!1,pfpitch=!0,-X.U8(p++)
break
case 2:pfvol=pfpitch=!0,15-X.U8(p++)<0&&(bad=bad.addIfNone("!badptnvol2"),E=ptn,p=pp+psz),-X.U8(p++)
break
case 3:$=!0,pnote="rst"
break
case 4:$=!0,pnote="spl",pins=X.U8(p++)}else $=!0,y=X.U8(p++),pfvol=!(64&y),pfvol&&15-(15&y),!(pins<0)&&32&y||(pins=X.U8(p++)),pfpitch=16&y,pfpitch&&-X.I8(p++)
$&&notecnt++,Q++}}else p=pp+psz}p>X.Sz()&&(bad=bad.addIfNone("!short")),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SA(20,32)),sOptionT(X.SA(10,10),"by: "),sOption("spd0:"+spd0+("+0"!=xpos?" xpos:"+xpos:"")+" ord:"+ord+" ptn:"+ptn+"+"+sptn+" ins:"+ins+(ptnxpos?" ptn.xpos:"+ptnxpos:"")+" smp.ch:"+X.U8(52)+" rep.freq:"+hz+"Hz loop:"+(X.U8(54)?Hex(X.U8(54))+"-":"")+Hex(X.U8(53))+(X.isDeepScan()?" notes:"+notecnt:" rows:"+rows)+" sz:"+p))}else if(!X.U8(0)&&X.c("'SK10'",128)&&[1,2,3].indexOf(X.U8(134))>=0&&[13,25,50,100,150,300].indexOf(X.U16(135))>=0&&X.U16(24)==X.U16(64)){for(sName="STarKos module (.BIN)",sVersion="compiled/ofs:80h",bDetected=1,crc=0,E=0;E<67;E++)crc+=X.U8(E)
crc&=65535,crc!=X.U16(67)&&(sVersion+="/malformed!badCRC"),X.isVerbose()&&(sOption(X.SA(1,8).trim()+"."+X.SA(9,3).trim()),sOption(X.U16(135)+"Hz"),sOption(Hex(X.U16(132)),"base:"),sOption(outSz(X.U24(64)+188),"sz:"))}else X.c("'Nu!SOPROL!'",34)&&(sName="Holger Gehrmann's Sound Programming Language/SOPROL module (.SPL)",bDetected=1,X.isVerbose()&&(t=X.SA(88,256),a=X.SA(88+t.length+1,256),c=X.SA(88+t.length+a.length+2,256),sOptionT(t),sOptionT(a,"by: "),sOptionT(c)))
if(/SPM[\x01-\x02]/.test(X.SA(0,4))&&(sName="Emmanuel Marty & Michael Lavaire's Stonetracker module (.SPM)",sVersion="v"+X.U8(3),bDetected=1,X.isVerbose()&&sOptionT(decAnsi(4,32,CPAmiga))),/SPS[\x01-\x02]{2}/.test(X.SA(0,5))&&X.c("'psn'",6+32*(smp=X.U8(5)))){if(sName="Emmanuel Marty & Michael Lavaire's Stonetracker sample bank (.SPS)",sVersion="v"+X.U8(3),bDetected=1,X.isVerbose()){for(E=smpsz=0,smps=[];E<smp;E++)(t=decAnsi(32*E+6,8,CPAmiga).trim()).length&&smps.push(t)
sOption(addEllipsis(smps.join(" ")),'smp/msg:"','"'),sOption("smp:"+smp)}}else if(X.c("'SPU'00")||X.c("'SPU1'")||X.fSig(X.Sz()-6,TOEOF,"1D80FF")>-1)bDetected=1,sName="Eternal SPU chiptune (.SPU)",X.c("'SPU'")?X.U8(3)?sVersion="v1":sVersion="v0":sVersion="headerless",X.isVerbose()&&"headerless"!=sVersion&&(game=X.SC(4,64,"Shift_JIS"),title=X.SC(68,64,"Shift_JIS"),sOptionT(title),sOptionT(game,"game: "),artist=X.SC(132,32,"Shift_JIS"),sOptionT(artist,"by: "),cmt=X.SC(164,3840,"Shift_JIS"),sOptionT(cmt))
else if(X.c("'SPEEDY-SYSTEM'"))bDetected=1,sName="Speedy System module (.SS)",sVersion="v1"
else if(X.c("'ZXAYST11'"))sName="Sound Tracker module (.ST1, .ST11)",bDetected=1,sVersion="v1.1/uncompiled",X.isVerbose()&&(t_=X.U8(23),t=X.SA(24,t_-1).trim(),"Some SoundTracker Song"!=t&&sOption(t))
else if(X.c("'STP3'"))sName="Soundtracker Pro II module (.STP)",bDetected=1
else if(X.c("48E7FFFE 4DFA.... 4A2E")&&isWithin(X.I8(6),-1,6)&&[97,102].indexOf(X.U8(12))>=0)sName="SUNtronic module (.SUN)",bDetected=1
else if(X.c("'SVOX'00000000")){if(sName="SunVox module (.SUNVOX)",bDetected=1,X.isVerbose()){for(p=8,t="",bpm=0,spd=0,tme=0,ptn=0,blk=0;p<X.Sz()&&(hkhd=X.SA(p,4),!(charStat(hkhd).indexOf("allasc")<0));){switch(hksz=X.U32(p+4,_LE),p+=8,hkhd){case"VERS":for(nV=X.U32(p,_LE),aV=[],E=0;E<4;E++)aV[3-E]=nV>>8*E&255
sVersion+="v"+aV.join(".")
break
case"BVER":if(nB=X.U32(p,_LE),nB!=nV){for(aV=[],E=0;E<4;E++)aV[3-E]=nB>>8*E&255
sVersion+="/v"+aV.join(".")}break
case"NAME":t=X.SA(p,hksz)
break
case"BPM ":bpm=X.U32(p,_LE)
break
case"SPED":spd=X.U32(p,_LE)
break
case"TIME":tme=X.U32(p,_LE)
break
case"SNAM":blk++
break
case"PDTA":ptn++}p+=hksz}sOptionT(t),bpm>0&&sOption(bpm,"bpm:"),spd>0&&sOption(spd,"spd:"),tme>0&&sOption(tme,"time:"),ptn>0&&sOption(ptn,"ptn:"),blk>0&&sOption(blk,"blk:"),sOption(outSz(p),"sz:")}}else if(X.c("'SymM'")){if(sName="Symphonie module (.SYMMOD)",bDetected=1,sVersion="v"+X.U32(4,_BE),X.isVerbose()){for(p=8,t="",done=!1,ch=0,len=0,extsmp=!1,pro=!1;p<X.Sz()&&!(done||charStat(hkhd).indexOf("allasc")<0);){switch(hkhd=X.I32(p,_BE),hkhx=Hex(X.U32(p,_BE)),hksz=4,p+=4,hkhd){case-16:if(pklen=X.U32(p,_BE),hksz+=pklen,o=4,pklen>=10&&X.c(p+o,"'PACK'FFFF")){if(!X.isDeepScan()){p=0
break}for(o+=6,unplen=X.U32(p+o,_BE),o+=4,maxlen=pklen-10,25264513.5>=maxlen?maxlen*=170:maxlen=4294967295,unplen>maxlen&&(unplen=maxlen),done=!1,ofs=0,left=unplen;!done&&o<hksz;)switch(tp=X.I8(p+o),o++,tp){case 0:l=X.U8(p+o),o++,left>=l?(t+=X.SA(p+o,l),o+=l,left-=l):done=!0
break
case 1:if(l=X.U8(p+o),o++,dw=X.SA(p+o,4),o+=4,left>=4*l&&o<pklen)for(left-=4*l;l--;)t+=dw
else done=!0
break
case 2:dw=X.SA(p+o,4),o+=4,left>=4*l&&o<pklen?(unp+=dw+dw,left-=8):done=!0
break
case 3:l=X.U8(p+o),o++,left>=l?left-=l:done=!0
break
case-1:done=!0
break
default:sVersion+="/malformed",done=!0}}else t=X.SC(p+o,hksz,"CP1252")
break
case-1:ch=X.I32(p,_BE)
break
case-2:len=X.I32(p,_BE),len>1024&&(len="malformed")
break
case-3:case-4:case-5:break
case-7:extsmp=!0
break
case 10:case 11:case 12:pro=!0
break
case-6:tmp=Math.round(1.24*Math.min(X.I32(p,_BE),800))
break
case-12:hksz=0
break
case-10:case-11:case-13:case-14:case-15:case-17:case-18:case-19:case-20:case-21:hksz+=X.I32(p,_BE)
break
default:_log("symmod @"+Hex(p,8)+": "+hkhd+"/"+hkhx+" ("+Hex(hksz,8)+"): ?!?!?!?!?!")}p+=hksz}sOption(t),sOption(ch,"ch:"),sOption(len,"len:"),sOption(tmp,"bpm:"),done&&sOption(outSz(p),"sz:"),extsmp&&sOption("extsmp"),pro&&(sVersion+="/Pro")}}else if(X.c("'Synth'")&&!X.c("'esi'",5))sName="Synthesis module (.SYN)",bDetected=1,X.c("'Synth'",7950)?(sVersion="v"+X.SA(7955,3),X.isVerbose()&&(sOptionT(X.SA(7986,27)),sOptionT(X.SA(8014,256)))):(sVersion="v"+X.SA(5,3),X.isVerbose()&&(sOptionT(X.SA(36,27)),sOptionT(X.SA(64,256))))
else if(X.c("'SYNTRACKER-SONG:'00"))sName="SynTracker module (.SYNMOD)",bDetected=1,X.isVerbose()&&(t1=X.SC(20,32,"CP1252"),sOptionT(t1,"title/inst: "),t2=X.SC(52,32,"CP1252"),sOptionT(t2),t3=X.SC(84,32,"CP1252"),sOptionT(t3))
else if(X.c("'T0AST'")){function ss(){if(1==nV)p=474
else{if(2!=nV)return
p=842}if(drummode=X.U8(p++),chipmode=X.U8(p++),chs=X.U8(p++),ch=0,chs>16)sVersion+="/malformed"
else{for(E=0;E<16;E++)X.U8(p++)&&(ch++,p+=3)
for(ins=0,E=0;E<16;E++)X.U8(p++)&&(ins++,p+=25)
for(ord=X.U16(p,_LE),p+=2+ord,ptn=0,notes=0,k=0;k<=255;k++)if(X.U8(p++))for(ptn++,E=0;E<chs;E++)for(j=0;j<64;)if(b=X.U8(p++),128&b)if(c=127&b,c)for(p++;c&&j<64;)notes++,j++,c--
else j++
else if(1&b&&p++,2&b&&p++,4&b&&p++,8&b&&p++,16&b&&p++,32&b&&p++,64&b)for(c=X.U8(p++);c&&j<64;)notes++,j++,c--
else notes++,j++
loop=X.U8(p++),t_=X.U32(p,_LE),p+=4,t=X.SC(p,t_,"CP1252"),p+=t_,a_=X.U32(p,_LE),p+=4,a=X.SC(p,a_,"CP1252"),p+=a_,c_=X.U32(p,_LE),p+=4,c=X.SC(p,c_,"CP1252"),p+=c_,sOption(t),sOption(addEllipsis(a,128),"by: "),sOption(addEllipsis(c,256),'msg:"','"'),sOption("ch:"+ch+" ins:"+ins+" ord:"+ord+" ptn:"+ptn+" notes:"+notes+" loop:"+loop+" sz:"+outSz(p))}}sName="The 0ok Amazing Synth Tracker module (.T0AST)",bDetected=1,X.c("'0OK'",5)?(nV=1,sVersion="v1"):X.c("010001",5)?(nV=2,sVersion="v2"):(nV=-1,sVersion="v.unk"),X.isVerbose()&&-1!=nV&&ss()}else if(X.c("'T0ASTINS'"))sName="The 0ok Amazing Synth Tracker instrument file",bDetected=1,X.isVerbose()&&sOption(outSz(33),"sz:")
else if(X.c("4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900")&&X.U32(44,_BE)-X.U32(2,_BE)==160||X.c("601A")&&(X.c("1010",28)||X.c("1012",28))&&(t=X.I32(34,_BE))>0&&t==X.I32(38,_BE)&&t==X.I32(42,_BE)&&t==X.I32(46,_BE))sName="Tim Follin & Mike D.'s Follin Player II module (.TF)",sVersion="f."+(78==X.U8(0)?"0":"1"),bDetected=1
else if(X.c("'TFMD'"))sName="TFM Music Maker tune (.TFD)",bDetected=1,X.isVerbose()&&(p=4,t=X.SA(p,512),p=X.fSig(p,512,"00")+1,a=X.SA(p,512),p=X.fSig(p,512,"00")+1,c=X.SA(p,512),sOptionT(t),sOptionT(a,"by: "),sOptionT(c))
else if(X.c("'TFMfmtV2'")){if(sName="Shiru's TFM Music Maker module (.TFE)",bDetected=1,X.isVerbose()){for(p=0,x=[],tobuf=!0,p=0,b=63,n=0,c=X.U8(p++);n<2244057&&p<X.Sz();)if(tobuf&&n>786&&(tobuf=!1),128!=c)b=c,n++,c=X.U8(p++),tobuf&&x.push(b)
else{for(c=X.U8(p++),next=!0,reps=shl=0;next&&shl<57&&p<X.Sz();)next=!(128&c),c&=127,reps|=Util.shlu64(c,shl),shl+=7,c=X.U8(p++)
if(reps){if(reps-=1,n+=reps,shl=0,tobuf)for(j=0;j<reps;j++)x.push(b)}else tobuf&&x.push(128),n++}for(p--,spd1=x[8],spd2=x[9],intlv=x[10],ord=x[11],ord||(ord=256),lp=x[12],d1=x[13]+(x[14]<<8),d2=x[15]+(x[16]<<8),saves=x[17]+(x[18]<<8),d1="20"+(127&d1).padStart(2,"0")+"-"+(1+(d1>>7&15)).padStart(2,"0")+"-"+(d1>>11&31).padStart(2,"0"),d2="20"+(127&d2).padStart(2,"0")+"-"+(1+(d2>>7&15)).padStart(2,"0")+"-"+(d2>>11&31).padStart(2,"0"),auth=decEncoding(x.slice(19,82),CP1251),title=decEncoding(x.slice(83,148),CP1251),cmt=decEncoding(x.slice(147,532),CP1251),E=ptn=0;E<ord;E++)x[E+531]+1>ptn&&(ptn=x[E+531]+1)
sz=2244057==n?p:-1,sz<0&&(sVersion=sVersion.appendS("malformed:"+Hex(n),"/")),sOptionT(title),sOptionT(auth,"by: "),sOptionT(cmt),sOption("on: "+d1+(d1!=d2?" to "+d2:"")),sOption("spd:"+spd1+"/"+spd2+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" intlv:"+intlv+" saves:"+saves+(X.isDeepScan()?" sz:"+outSz(sz):""))}}else if(X.Sz()>=902&&isWithin(X.U8(37),1,4)&&(bin=parseAtariBinary())[0]>0&&X.c("0E158D",6)&&X.c("8D150E",26)&&X.U16(29)==bin[1][0][1]&&(X.c("'TMC SONG FILE 2.0'",9)||X.c("D4CDC3A0 D3CFCEC7A0 C6C9CCC5A0 B2AEB0",9))){for(sName="Marcin 'Jaskier' Lewandowski's Theta Music Composer (.TM2)",sVersion="v2.0",bDetected=1,bad="",ins=0,p0=65536,p=134;p<262&&(t=(X.U8(p+640)<<8|X.U8(p))-X.U16(2)+6,!(t<0));p++)t>0&&(isWithin(t,896,bin[1][0][1]+6)?(p0>t&&(p0=t),255!=X.U8(t)&&ins++):bad=bad.addIfNone("!badinsp"))
for(ptn=0,p=262;p<518&&(t=(X.U8(p+256)<<8|X.U8(p))-X.U16(2)+6,!(t<0));p++)t>0&&(isWithin(t,896,bin[1][0][1])?(p0>t&&(p0=t),255!=X.U8(t)&&ptn++):bad=bad.addIfNone("!badptnp"))
for(ord=(p0-902)/17,p=902,pt=-1;p<p0;p+=17){for(U=p+1;U<p+17;U+=2)X.U8(U)>=pt&&(pt=X.U8(U)+1)
if(isWithin(X.U8(p+16),65,127)&&(bad=bad.addIfNone("!badord")),X.I8(p+16)<=0)break}if(bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()){for(p=38,t="";p<134;p+=32)t=t.appendS(decAnsi(p,32,CPATASCII,0,Chars0to1FATASCII).trim()," | ")
sOption(t),(t=X.U8(31))?isWithin(t,1,63)?t="stereo":isWithin(t,64,127)?t="RMT stereo":t="quadro":t="mono",sOption("ch:"+t+" spd0:"+X.U8(36)+" ticks:"+X.U8(37)+" ord:"+ord+" ptn:"+ptn+(pt!=ptn?"/"+pt:"")+" ins:"+ins+" sz:"+outSz(bin[0]))}}else if(X.c("0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F",20)&&X.c("FFFF001000000030000000",385))sName="The Musical Enlightenment module (.TME)",bDetected=1
else if(X.Sz()>=12288&&X.c("'TRK01/TV.ES.'")){if(sName="RamTracker module (.TRK)",bDetected=1,X.isVerbose()){for(sOptionT(X.SC(15,32,"CP850")),sOptionT(X.SC(47,32,"CP850"),"by: "),p=1107,ptn=-1,ord=0;t=X.U8(p++),!(t>=254||p>X.Sz());)ord++,ptn<t&&(ptn=t)
ptn++,sOption("ord:"+ord+" ptn:"+ptn)}}else if(X.c("'S'8F'NG.'")&&/[BW][48]/.test(X.SA(5,2))&&(pp=X.fSig(8,128*(ch=X.U8(6)-48),"DD48"))>0&&!(pp%2)){if(sName="Unique Development/BladePacker module (UDS.+SMP.)",bDetected=1,X.isVerbose()){for(ptn=mptn=0,maxp=Math.min(X.Sz(),65536),bw="B"==X.SA(5,1)?1:2,ord=pp-8>>bw+1,p=8;p<pp;p++)(t=X.U8(p)+1)>mptn&&(mptn=t)
if(p+=2,t=0,1==bw)for(;55537!=X.U16(p,_BE)&&p<maxp;)(U=X.U8(p++))>t&&(t=U),(U=X.U8(p++))>t&&(t=U)
else for(;55537!=(U=X.U16(p,_BE))&&p<maxp;p+=2)U>t&&(t=U)
ptnp=p,ptn=p-pp-2>>bw+5,p+=2+(t+1<<2),sz=p,p=o=x=0,a2=pp+2
s:for(;p<maxp&&(p=8+o*ch,p!=pp);){a0ch=a0=p+ch,o++
e:for(;p<maxp;)for(a0=pp+2+(X.U8(p++)<<bw+5),d6=64;d6&&p<maxp;){if(1==bw?d1=X.U8(a0++):(d1=X.U16(a0,_BE),a0+=2),d1<<=2,[44,32].indexOf(X.U8(ptnp+4+d1))>=0){x++
continue s}if(! --d6){if(p!=a0ch)continue e
continue s}}}x||(x=1),x>1&&sOption(x,"×"),sOption("ch:"+ch+" ord:"+ord+" ptn:"+(mptn==ptn?"":mptn+"/")+ptn+" sz:"+outSz(sz))}}else if(X.Sz()>307&&X.c("'MAS_UTrack_V00'")&&isWithin(X.U8(14),49,52)&&X.Sz()>32*X.U8(47)+80){for(sName="UltraTracker module (.ULT)",bDetected=1,nV=X.U8(14)-48,sVersion="v"+["<1.4","1.4","1.5","1.6"][nV-1],bad="",msgn=X.U8(47),p=48+32*msgn,smp=X.U8(p++),smpsz=0,smps=[],E=0;E<smp;E++)t=X.SC(p,32,"CP437").trim(),""!=t&&smps.push(t),ssz=X.U32(p+56)-X.U32(p+52),ssz<0?bad=bad.addIfNone("!badsmpsz"):smpsz+=(4&X.U8(p+61)?2:1)*ssz,nV>=4?p+=66:p+=64
for(E=ord=mp=0;E<256;E++)(o=X.U8(p++))<254&&(ord++,mp<o&&(mp=o))
for(ch=X.U8(p++)+1,ptn=X.U8(p++)+1,mp++,p+=ch,c=notes=0;c<ch;c++)for(t=0;t<ptn&&p<X.Sz();t++)for(row=0;row<64&&(rp=1,b=X.U8(p++),252==b&&(rp=X.U8(p++),b=X.U8(p++)),note=isWithin(b,1,96),p+=4,rp+row>64&&(rp=64-row),rp);)row+=rp,note&&(notes+=rp)
if(p>X.Sz()&&(bad=bad.addIfNone("!short")),sz=p+smpsz,""!=bad&&(sVersion=sVersion.appendS("/malformed"+bad,"/")),X.isVerbose()){for(sOptionT(X.SC(15,32,"CP437")),specialmsg=23==msgn&&297221==sz&&7==ch&&20==ord&&29==ptn&&17==smp&&1572==notes,p=48,E=0,msg=[];E<msgn;E++)t=decAnsi(p,32,CP437,Chars0to1F),specialmsg||(t=t.trim()),""!=t&&msg.push(t),p+=32
msg=addEllipsis(msg.join(specialmsg?"\n":" "),specialmsg?8192:192,specialmsg?8192:160),sOption(msg,"msg:"+(specialmsg?"\n":'"'),specialmsg?"\n":'"'),msg.length||sOption(addEllipsis(smps.join(","),128,96),'smp/msg:"','"'),sOption("ch:"+ch+" ord:"+ord+" ptn:"+mp+(ptn!=mp?"/"+ptn:"")+" smp:"+smp+" notes:"+notes+" sz:"+outSz(sz))}}else if(/(UN0[4-6].*|APUN\x01[1-6])/.test(X.SA(0,6)))sName="UNIMOD module (.UNI)",bDetected=1,"N"!=X.SA(3,1)?(v=+X.SA(3,1),v>6&&(v=X.U16(4,_LE)),sVersion="v"+v):(sVersion="v.APlayer",v=256),X.isVerbose()&&(p=4,v>=6?(6==v&&p++,flg=X.U16(p,_LE),p+=2,ch=X.U8(p++),voc=X.U8(p++),pos=X.U16(p,_LE),p+=2,ptn=X.U16(p),p+=2,trk=X.U16(p),p+=2,ins=X.U16(p),p+=2,smp=X.U16(p),p+=2,reppos=X.U16(p),p+=2,spd0=X.U8(p++),tmp0=X.U8(p++),vol0=X.U8(p++),v>=262?(bpmlimit=X.U16(p,_LE),p+=2):bpmlimit=32):(ch=X.U8(p++),pos=X.U16(p,_LE),p+=2,5==v?(reppos=X.U16(p,_LE),p+=2):reppos=0,ptn=X.U16(p,_LE),p+=2,trk=X.U16(p,_LE),p+=2,ins=X.U16(p,_LE),p+=2,smp=0,spd0=X.U8(p++),tmp0=X.U8(p++),p+=288,flg=X.U8(p++)),ts=X.U16(p,_LE),sOptionT(X.SA(p+2,ts)),v<258&&(porig=p+2+ts,origs=X.U16(porig,_LE),origs>0&&sOptionT(X.SA(porig+2,origs),"orig: "),p=porig+2+origs,sOptionT(X.SA(p+2,X.U16(p,_LE)))),sOption("ch:"+ch+" trk:"+trk+" ord:"+pos+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" spd0:"+spd0+" tmp0:"+tmp0))
else if(X.c("'VGEfmtV'")&&isWithin(nV=X.U8(7)-48,1,3)){if(sName="Shiru's VGM Music Maker module (.VGE)",bDetected=1,sVersion="v"+nV,X.isVerbose()){if(p=0,ptn=1,n=next=0,tobuf=!0,x=[],nV>1)for(c=X.U8(p++);n<7231953&&p<X.Sz();)if(tobuf&&n>807&&(tobuf=!1),128!=c)b=c,n++,c=X.U8(p++),tobuf&&x.push(b)
else{if(c=X.U8(p++),1==nV&&!c){x.push(128),n++,c=X.U8(p++)
continue}for(next=!0,reps=shl=0;next&&shl<57&&p<=X.Sz();)next=!(128&c),c&=127,reps|=Util.shlu64(c,shl),shl+=7,c=X.U8(p++)
if(reps){if(reps--,n+=reps,shl=0,tobuf)for(E=0;E<reps;E++)x.push(b)}else tobuf&&x.push(128),n++}else p=1
switch(p--,nV){case 2:spd1=x[16],spd2=x[17],intlv=x[18],d1=x[20]+(x[21]<<8),d2=x[22]+(x[23]<<8),saves=x[24]+(x[25]<<8),ord=x[27],lp=x[28]
break
case 3:spd1=x[26],spd2=x[27],intlv=x[28],ord=x[37],lp=x[38],d1=x[31]+(x[32]<<8),d2=x[33]+(x[34]<<8),saves=x[35]+(x[36]<<8)}if(ord>1)for(E=0;E<255;E++)(t=x[551+E])+1>ptn&&(ptn=t+1)
d1="20"+(127&d1).padStart(2,"0")+"-"+(1+(d1>>7&15)).padStart(2,"0")+"-"+(d1>>11&31).padStart(2,"0"),d2="20"+(127&d2).padStart(2,"0")+"-"+(1+(d2>>7&15)).padStart(2,"0")+"-"+(d2>>11&31).padStart(2,"0"),auth=decEncoding(x.slice(39,103),CP1251),title=decEncoding(x.slice(103,167),CP1251),cmt=decEncoding(x.slice(167,551),CP1251),sz=7231953==n?p:-1,sOptionT(title),sOptionT(auth,"by: "),sOptionT(cmt),sOption("on: "+d1+(d1!=d2?" to "+d2:"")),sOption("spd:"+spd1+"/"+spd2+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" intlv:"+intlv+" saves:"+saves+" sz:"+outSz(sz))}}else if(X.c("'Vgm '")&&X.Sz()>=(eof=X.U32(4)+4)&&(nV=X.U32(8))&&nV<768&&(!X.U32(20)||X.c("'Gd3 '",X.U32(20)+20))){if(bDetected=1,bad="",nV=1e3*(nV>>12)+100*(nV>>8&15)+10*(nV>>4&15)+(15&nV),sName="Video Game Music chiptune stream (.VGM)",eoh=X.U32(52)+52,(nV<150||52==eoh)&&(eoh=64),nV>=150&&eoh<64&&(bad="!dataofs"),sVersion="v"+(nV/100).toFixed(2),X.isVerbose()){if(tags=[],gd3p=X.U32(20,_LE)+20,gd3p>20&&"Gd3 "===X.SA(gd3p,4)){for(sVersion+="/Gd3 v"+X.readBytes(gd3p+4,4).join("")/100,taglen=X.U32(gd3p+8,_LE),gd3p+=12,gd3p+taglen>X.Sz()&&(bad=bad.addIfNone("!tagsz")),E=0;E<11&&gd3p<=X.Sz();)tpos=X.fSig(gd3p,TOEOF,"0000"),tpos>=0?(tags[E]=X.SU16(gd3p,taglen),gd3p+=2*tags[E].length+2):(tags[E]="",gd3p+=2),E++
E<11?bad=bad.addIfNone("!tagnum"):tagn=Math.max(0,E-1),sOption(slashTag(tags[0],tags[1])),sOption(slashTag(tags[6],tags[7]),"by: "),sOption(slashTag(tags[2],tags[3]),"for: "),sOption(slashTag(tags[4],tags[5]),"on: "),sOption(tags[8],"date: "),sOption(tags[9],"ripper: "),sOption(tags[10],"notes: ")}for(smp=X.U32(24),smp||(bad=bad.addIfNone("!badlen")),lp=X.U32(28)+28,lpsmp=X.U32(32),(lp>=eof||lpsmp>smp)&&(lp=0,bad=bad.addIfNone("!badloop")),rate=X.U32(36),nV>100&&(rate?50==rate?rate+="Hz(PAL)":60==rate?rate+="Hz(NTSC)":rate+="Hz":rate="n/a"),chips=[[12,"SN76489",0],[16,"YM2413",0],[44,"YM2612",110],[48,"YM2151",110],[56,"SegaPCM",151],[64,"RF5C68",151],[68,"YM2203",151],[72,"YM2608",151],[76,"YM2610/B",151],[80,"YM3812",151],[84,"YM3526",151],[88,"Y8950",151],[92,"YMF262",151],[96,"YM278B",151],[100,"YMF271",151],[104,"YMZ280B",151],[108,"RF5C164",151],[112,"PWM",151],[116,"AY8910",151],[128,"GameBoyDMG",161],[132,"NES_APU",161],[136,"MultiPCM",161],[140,"uPD7759",161],[144,"OKIM6258",161],[152,"OKIM6295",161],[156,"K051649/K052539",161],[160,"K054539",161],[164,"HuC6280",161],[168,"C140",161],[172,"K053260",161],[176,"Pokey",161],[180,"QSound",161],[184,"SCSP",171],[192,"WonderSwan",171],[196,"VSU",171],[200,"SAA_1099",171],[204,"ES5503",171],[208,"ES5505/ES5506",171],[216,"X1-010",171],[220,"C352",171],[224,"GA20",171],[228,"Mikey/Atari_Lynx",172]],chipn=0,xhdr=0,nV>=170&&(t=X.U32(188),t&&(xhdr=t+188),xhdr&&(xhdsz=X.U32(xhdr),xhdsz||(xhdr=0,bad=bad.addIfNone("!badxhdr")))),E=0;E<chips.length&&!(chips[E][0]>=eoh||xhdr&&chips[E][0]>xhdr);E++)if(clk=X.U32(chips[E][0]),b30=Util.shru64(clk,30),b31=b30>>1,b30&=1,clk&=1073741823,!(nV<chips[E][2])&&clk){switch(chipn++,chip=chips[E][1],chips[E][0]){case 12:b30&&b31&&(chip="T6W28"),nV<=151&&!(4&X.U8(43))&&(chip+="/GGStereo")
break
case 16:nV<=101&&clk>5e6&&(chip="YM2612")
break
case 44:nV>=151&&b31&&(chip="YM3438"),nV<=101&&(clk1=1073741823&X.U32(16),clk1>5e6&&(clk=clk1))
break
case 48:nV>=151&&b31&&(chip="YM2164"),nV<=101&&(clk1=1073741823&X.U32(16),clk1<5e6&&(clk=clk1))
break
case 76:b31?chip="YM2610B":chip="YM2610"
break
case 116:switch(X.U8(120)){case 0:break
case 1:chip="AY8912"
break
case 2:chip="AY8913"
break
case 3:chip="AY8930"
break
case 4:chip="AY8914"
break
case 16:chip="YM2149"
break
case 17:chip="YM3439"
break
case 18:chip="YMZ284"
break
case 19:chip="YMZ294"
break
default:chip+="-ish"}break
case 132:b31&&(chip+="/FDS")
break
case 144:8&X.U8(148)?chip+="12bit":chip+="10bit"
break
case 156:b31?chip="K052539":chip="K051649"
break
case 168:switch(X.U8(150)){case 0:chip="C140+NamcoSystem2"
break
case 1:chip="C140+NamcoSystem21"
break
case 2:chip="219_ASIC+NamcoNA-1/2"
break
default:chip+="-ish"}break
case 204:chip+=":"+X.U8(212)+"ch"
break
case 208:b31?chip="ES5506":chip="ES5505",chip+=":"+X.U8(213)+"ch"}sVersion=sVersion.appendS(chip,"#")}volmod=-1,eoh>124&&(volmod=X.U8(124),volmod>192&&(volmod-=256),-63==volmod&&(volmod=-64),volmod=100*(2^volmod/32),volmod=Math.round(volmod)+"%"),chipn>2&&(bad=bad.addIfNone("!toomanychips")),eof<X.Sz()&&("Vgm "==X.SA(eof,4)?sOption("multisong"):sOption("+extra data")),sOption("rate: "+rate+" len: "+secondsToTimeStr(Util.divu64(smp+22e3,44100))+(lp?" looped":"")+(-1!==volmod&&" 100%"!==volmod?" vol: "+volmod:"")+(xhdr?" xhdr":"")+" sz:"+outSz(eof))}""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("00'3T1'"))sName="VicTracker module (.VT)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(414,16)),sOptionT(X.SA(430,16),"by: "),sOptionT(X.SA(446,16),"'"))
else if(X.fSig(X.Sz()-32,TOEOF,"'VSS0'00")>-1)sName="Voodoo Supreme Synthesizer audio (.VSS)",bDetected=1
else if(X.c("6000")&&X.c("48E7FFFE610000",4)&&X.c("4CDF7FFF'Nu'",12))sName="Wally Beben's module (.WB)",bDetected=1
else if(X.c("'WSRF'",X.Sz()-32)&&X.c("EA",X.Sz()-16)){if(sName="WonderSwan R programmatic chiptune (.WSR)",bDetected=1,p=X.Sz()-32,sVersion="v"+X.U8(p+4),X.isVerbose()){switch(sOption(Hex(X.U8(p+24)),"CartID:"),pub=X.U8(p+22),pub){case 0:sOption("(invalid publisher)")
break
case 1:sOption("Bandai")
break
case 2:sOption("Taito")
break
case 3:sOption("Tomy")
break
case 4:sOption("Koei")
break
case 5:sOption("Data East")
break
case 6:sOption("Asmik Ace")
break
case 7:sOption("Media Entertainment")
break
case 8:sOption("Nichibutsu")
break
case 10:sOption("Coconuts Japan")
break
case 11:sOption("Sammy")
break
case 12:sOption("Sunsoft")
break
case 13:sOption("Mebius")
break
case 14:sOption("Banpresto")
break
case 16:sOption("Jaleco")
break
case 17:sOption("Imagineer")
break
case 18:sOption("Konami")
break
case 22:sOption("Kobunsha")
break
case 23:sOption("Bottom Up")
break
case 24:sOption("Kaga Tech")
break
case 25:sOption("Sunrise")
break
case 26:sOption("Cyber Front")
break
case 27:sOption("Mega House")
break
case 29:sOption("Interbec")
break
case 30:sOption("Nihon Application")
break
case 31:sOption("Bandai Visual")
break
case 32:sOption("Athena")
break
case 33:sOption("KID")
break
case 34:sOption("HAL Corporation")
break
case 35:sOption("Yuki Enterprise")
break
case 36:sOption("Omega Micott")
break
case 37:sOption("Layup")
break
case 38:sOption("Kadokawa Shoten")
break
case 39:sOption("Shall Luck")
break
case 40:sOption("Squaresoft")
break
case 43:sOption("Tom Create")
break
case 45:sOption("Namco")
break
case 46:sOption("Movic(?)")
break
case 47:sOption("E3 Staff(?)")
break
case 49:sOption("Vanguard")
break
case 50:sOption("Megatron")
break
case 51:sOption("Wiz")
break
case 52:sOption("Capcom")
break
default:sOption("(unknown publisher)")}sOption(X.U8(p+5),"1sttrk: ")}}else if(X.c("3026b2758e66cf11a6d900aa0062ce6c"))sName="Windows Media (.WMV/WMA)",bDetected=1
else if(X.c("'XAD!'"))sName="Exotic AdLib module (.XAD)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(4,36)),sOptionT(X.SA(40,36),"by: "))
else if(X.c("'Extended Module: '")&&X.c("1A",37)&&isWithin(X.U16(72),1,256)){V=X.U16(58),charset="CP437",sName="Fast Tracker 2 Extended module (.XM)",bDetected=1,text=tracker=mVlsw=bad="",insns=[],smpns=[],hdrp=60,hdrsz=X.U32(hdrp),restartp=X.U16(hdrp+6),flags=X.U16(hdrp+14),linearSlides=1&flags,xFilter=4096&flags,ord=X.U16(hdrp+4),chn=X.U16(hdrp+8),ptn=X.U16(hdrp+10),ins=X.U16(hdrp+12),tmp0=X.U16(hdrp+16),bpm0=X.U16(hdrp+18)
p=hdrp+hdrsz
if(V>=260)for(E=0;E<ptn;E++)p+=X.U32(p)+X.U16(p+7)
const Bs=0,Vs=1,xs=2,gs=4,vs=8,As=16,Ds=32,Ms=128,Ts=256,Is=512,Cs=2048
var es=isOMPTMade=isOXM=mixlevCompatFT2=!1
for(madewith=Bs,X.c("'FastTracker v2.00   '",38)&&276===hdrsz?V<260?madewith=Ds|As:(t=X.fSig(17,20,"00"))>=0?restartp?madewith=Ms|xs|Cs:36==t?madewith=Ms|xs|Ts|Cs:firstNotOf(t+1,36-t,32)<0?madewith=Ts|As:madewith=Ms|xs|Cs:restartp?madewith=Ds|xs:madewith=Ds|xs|Ts:X.c("'FastTracker v 2.00  '",38)?madewith=Vs:(madewith=Bs|As,tracker=X.SC(38,20,charset).trim(),X.c("'OpenMPT '",38)?madewith=vs|As|Cs:X.c("'MilkyTracker '",38)?X.c("'       '",50)||(mixlevCompatFT2=!0):X.c("'Fasttracker II clone'",38)?madewith=Ds|As:X.c("'MadTracker 2.0'00",38)?(es=!0,X.c("00000000",53)?tracker="MadTracker 2":tracker="MadTracker 2 (registered)"):X.c("'*Converted '",38)&&X.c("'-File*'",52)&&(madewith=Is|As,tracker="Digitrakker")),xFilter&&madewith&xs&&(madewith=Ms|xs|As|Cs),smp=smpReserved=0,insp=p,anyADPCM=anyInsSmp=!1,sflags=[],smpsz=lastsmphdsz=lastinstp=lastsmpreserved=-1,ord||Cs||(ord=1),E=0;E<ins;E++){if(p+4>X.Sz()){bad=bad.addIfNone("!short")
break}if(ihdsz=X.U32(p),ihdsz||(ihdsz=263),instp=X.U8(p+26),inst=X.SC(p+4,22,"CP437").trim(),inst.length&&insns.push(inst),smpn=X.U16(p+27),smphdsz=X.U32(p+29),madewith==Vs?(madewith|=As,245==ihdsz?(mVlsw="1.00.00.A5",tracker="ModPlug Tracker 1.0 alpha"):263==ihdsz?(mVlsw="1.00.00.B3",tracker="ModPlug Tracker 1.0 beta"):madewith=Bs|As):smpn||(263==ihdsz&&!smphdsz&&madewith&xs?madewith|=As:29!=ihdsz&&madewith&Is?madewith&=~Is:madewith&(Ms|Ds)&&33!=ihdsz&&(madewith=Bs),33!=ihdsz?madewith&=~Ts:smphdsz>40&&madewith&Ts&&((anyInsSmp||-1!=lastsmphdsz&&smphdsz!=lastsmphdsz)&&(madewith=Ts|As),lastsmphdsz=smphdsz)),-1==lastinstp?lastinstp=instp:lastinstp!=instp&&madewith&Ds&&(madewith&=~Ds,madewith|=Ms),vls=X.U8(p+40+195),vle=X.U8(p+40+196),vef=X.U8(p+40+200),pls=X.U8(p+40+198),ple=X.U8(p+40+199),pef=X.U8(p+40+201),midichecks=X.U8(p+40+208)|X.U8(p+40+209)|X.U16(p+40+210)|X.U8(p+40+214),p+=ihdsz,smp+=smpn,p>X.Sz()){bad=bad.addIfNone("!short")
break}V>=260&&(sflags=[])
var ps=[],rs=0
if(smpn){for(anyInsSmp=!0,midichecks&&(madewith&=~(Vs|xs|Ts)),(263!=ihdsz||instp)&&(madewith&=~Ts),!(madewith&As)&&madewith&Ts&&((4&vef||255!=vls||255!=vle)&&(4&pef||255!=pls||255!=ple)||(madewith&=~xs,madewith|=As)),j=0;j<smpn;j++){M=ps[j]=X.U32(p)
var ns=X.I8(p+13),is=(I=X.U8(p+14),X.U8(p+15)),os=X.U8(p+17),Xs=(D=X.SC(p+18,22,"CP437")).trim()
smpReserved|=os,isADPCM=173===os&&!I&!(48&I),os&&173!=os&&(madewith&=~(Vs|xs|vs)),-1==lastsmpreserved?lastsmpreserved=os:lastsmpreserved!=os&&(madewith&=~Ts),128!=is&&(madewith&=~Ts),15&ns&&127!=ns&&(madewith&=~Ts),Xs.length&&funSampleName(Xs)&&smpns.push(Xs),sflags.push([I,isADPCM]),isADPCM&&(anyADPCM=!0),rs+=isADPCM?16+(M+1>>1):M,p+=40,madewith&(Ds|Ms)&&madewith&(xs|Ts)&&!(madewith&As)&&(os>22||D.slice(os).indexOf(" ")<0)&&(madewith&=~Ds,madewith|=Ms|As),!(3&~I)&&madewith&xs&&(madewith|=gs)}smpsz+=rs,V>=260&&(X.c("'OggS'",p)&&(isOXM=!0),p+=rs)}}if(!smpReserved&&madewith&xs&&X.fSig(17,20,"00")>-1&&(madewith|=As),V<260){for(E=0;E<ptn;E++)p+=X.U32(p)+X.U16(p+(258==V?6:7))
X.c("'OggS'",p)&&(isOXM=!0),p+=smpsz}for(basesz=p,""==tracker&&(madewith&Is&&!smpReserved&&-1==(lastinstp||-1)?tracker="Digitrakker":madewith&Ds?tracker="FastTracker 2 or compatible":tracker="Unknown"),fx=0,xt="";p+6<X.Sz()&&(t=X.SA(p,4),it=X.U32(p),!it||!X.U16(p+4)||!("228"===t||2155905152&it)&&1616928864&it);)if("text"===t)t=X.U32(p+4),p+=8,xt=xt.append("t"),text=X.SC(p,t,"CP437").trim(),p+=t,madewith&=~Ts,madewith|=As
else if(/F[0-9X]\d\d/.test(t))t=X.U32(p+4),p+8+t<=X.Sz()&&(p+=8+t,fx++),madewith|=As
else if("MIDI"===t)t=X.U32(p+4),madewith&=~Ts,madewith|=As,p+8+t<=X.Sz()&&(p+=8+t,xt=xt.append("m"))
else if("CHFX"===t||"CNAM"===t||"PNAM"===t)t=X.U32(p+4),p+8+t<=X.Sz()&&(p+=8+t),madewith&=~Ts,madewith|=As
else if("XTPM"===t)for(p+=4,xt=xt.append("x"),madewith&=~Ts,madewith|=As,isOMPTMade=!0,t=X.SA(p,4);p+7<X.Sz();){if(!X.U8(p)){p++
break}if(code=X.SA(p,4),icode=X.U32(p),"STPM"===code||"228"===code||2155905152&icode||!(1616928864&icode))break
for(prsz=X.U16(p+4),p+=6,E=0;E<ins;E++)p+=prsz}else{if("STPM"!==t)break
for(p+=4,xt=xt.append("s"),madewith&=~Ts,madewith|=As;p+6<X.Sz();){if(!X.U8(p)){p++
break}if(X.c("'VWSL'",p)){function ms(s){return s.slice(0,1)+"."+s.slice(1,3)+"."+s.slice(3,5)+"."+s.slice(5,7)}switch(v=0,X.U16(p+4)){case 1:v=X.U8(p+6)
break
case 2:v=X.U16(p+6)
break
case 3:v=X.U24(p+6)
break
case 8:v=X.U64(p+6)
break
default:v=X.U32(p+6)}v&&(mVlsw=ms(v.toString(16).toUpperCase().padStart(7,"0")))
break}p+=6+X.U16(p+4)}}if(madewith&As&&(madewith&gs?(mVlsw="1.11",tracker="ModPlug Tracker 1.0-11"):madewith&xs&&!(madewith&Ts)?(mVlsw="1.16",tracker="ModPlug Tracker 1.0-16"):madewith&xs&&madewith&Ts?(mVlsw="1.16",tracker="ModPlug Tracker 1.0-16 / PlayerPRO"):!(madewith&xs)&&madewith&Ts&&(tracker="PlayerPRO")),X.c("'OpenMPT '",38)&&(mVlsw=X.SA(46,12).trim(),madewith=vs|As),isOMPTMade&&mVlsw<"1.17"&&(mVlsw="1.17"),mVlsw>="1.17"&&(tracker="OpenMPT v"+mVlsw),sz=p,charset=""!=mVlsw||es?"CP1252":"CP437",X.isVerbose()){sOptionT(X.SC(17,20,charset)),sOptionT(tracker,"in:"),isOXM&&sOption("OggMod FastTracker 2 (.OXM)","via:"),text.length&&sOption(addEllipsis(text,256)),insns.length&&sOption(addEllipsis(insns.join(" "),256),'ins/msg:"','"'),smpns.length&&sOption(addEllipsis(smpns.join(" "),256),'smp/msg:"','"')
var ss="chn:"+chn+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp
fx&&(ss+=" fx:"+fx),xt.length&&(ss+=" xt:"+xt),sz!=basesz&&(ss+=" base_sz:"+basesz),ss+=" sz:"+outSz(sz),sOption(ss)}sVersion="v"+(V>>8)+"."+(255&V)+bad+(anyADPCM?"/ADPCMpacked":"")}else if(X.c("'FORM' 0000000E 'XDIRINFO'  00000002 .... 'CAT ' ........ 'XMIDFORM' ........ 'XMID'"))bDetected=1,sName="Extended MIDI chiptune (.XMI)",X.isVerbose()&&((x=X.U8(20))>1&&sOption(x,"×"),sOption(outSz(30+X.U32(26,_BE)),"sz:"))
else if(X.c("'ofTAZ!'"))sName="Extra Simple Music module (.XSM)",bDetected=1
else if(/YM\d!/.test(X.SA(0,4))||X.c("'YM3b!'")||/YMT\dLeOnArD!/.test(X.SA(0,12))||X.c("'MIX1LeOnArD!'")){switch(bDetected=1,bad="",frm=smp=voc=loop=ddn=0,sName="ST-Sound chiptune stream (.YM)",sV=X.SA(0,4).replace(/!/g,""),sV){case"YM1":sVersion="YM1"
break
case"YM2":sVersion="MADMAX specific"
break
case"YM3":sVersion="YM-Atari"
break
case"YM3b":sVersion="YM-Atari+loopinfo",loop=X.U32(X.Sz()-4,_LE)
break
case"YM4":sVersion="YM-Atari extended"
break
case"YM5":case"YM6":sVersion="Generic YM2149 extended"
break
case"MIX1":sVersion="Atari Remix digital"
break
case"YMT1":case"YMT2":sVersion="YM-Tracker"}if(["YM2","YM3","YM3b"].indexOf(sV)>=0&&(frm=Util.divu64(X.Sz()-4,14)),["YM5","YM6","YMT1","YMT2","MIX1"].indexOf(sV)>=0){if("LeOnArD!"!=X.SA(4,8)&&(bad=bad.addIfNone("!badsig")),["YM6!","YMT1","YMT2"].indexOf(sV)>=0&&"End!"!=X.SA(X.Sz()-4)&&(bad=bad.addIfNone("!badfilesz")),["YM5","YM6"].indexOf(sV)>=0){for(ddn=X.U16(20,_BE),loop=X.U32(28,_BE),p=X.U16(32,_BE)+34,E=0;E<ddn;E++)if(ds=X.U16(p,_BE),p+=2+ds,p>=X.Sz()){bad=bad.addIfNone("!tooshort")
break}}else if("MIX1"===sV)for(p=24,smp=X.U32(16,_BE),mixblk=X.U32(20,_BE),E=0;E<mixblk;E++)p+=12
else["YMT1","YMT2"].indexOf(sV)>=0&&(ddn=X.U16(24,_BE),voc=X.U16(13,_BE),frm=X.U32(16,_BE),p=30)
p>=X.Sz()?bad=bad.addIfNone("!nodata"):(t=p,t_=X.fSig(p,TOEOF,"00")-p,t_>=0&&(p+=t_+1,a=p,a_=X.fSig(p,TOEOF,"00")-p,p+=a_+1,c=p,c_=X.fSig(p,TOEOF,"00")-p,p+=c_+1,["YM5","YM6"].indexOf(sV)>=0&&(X.c("'End!'",p+((frm=X.U32(12,_BE))<<4))||(bad=bad.addIfNone("!badframes"),sOption("frm/frames: "+(frm<<4)+"/"+(X.Sz()-p-4)))))),X.isVerbose()&&(sOptionT(X.SA(t,t_)),sOptionT(X.SA(a,a_),"by: "),sOptionT(X.SA(c,c_)))}X.isVerbose()&&(voc&&sOption(voc,"voc:"),smp&&sOption(outSz(p+smp),"sz:"),ddn&&sOption(ddn,"digidrums:"),frm&&sOption("len:"+frm+" sz:"+outSz(p+(frm<<4)+4))),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("'YMST'")&&(sName="MYST ST-YM module (.YMST,.YM)",bDetected=1,X.isVerbose())){for(E=0,p=4;E<48&&(p+=8,X.U16(p-8,_BE));E++);t=p,t_=X.fSig(p,TOEOF,"00")-p,t_>=0&&(p+=t_+1,a=p,a_=X.fSig(p,TOEOF,"00")-p,p+=a_+1,c=p,c_=X.fSig(p,TOEOF,"00")-p,X.isVerbose()&&(sOptionT(X.SA(t,t_)),sOptionT(X.SA(a,a_),"by: "),sOptionT(X.SA(c,c_))))}if(!bDetected&&function(){if(!X.c("'ZXAYAMAD'")||X.U8(9)>3)return!1
if(authp=12+X.I16(12,_BE),!(authp<X.Sz()))return!1
if(auth=authp?X.SA(authp,256):"",miscp=14+X.I16(14,_BE),!(miscp<X.Sz()))return!1
if(misc=miscp?X.SA(miscp,256):"",x=X.U8(16)+1,p=18+X.I16(18,_BE),p>X.Sz())return!1
for(titles=[],E=0;E<x;E++,p+=4)if(t=p+X.I16(p,_BE)){if(!(t<X.Sz()))return!1
titles.push(X.SA(t,256).trim())}return!0}()&&(sName="Fuxoft's AY Amadeus module (.AMAD)",sVersion=[X.U8(8)?"Rel "+X.U8(8):"",X.U8(9)?"Plr "+X.U8(9):""].join(" ").trim(),X.isVerbose()&&(sOptionT(titles.join(",")),x>1&&sOption(x,"×"),authp&&sOptionT(auth,"by: "),miscp&&sOptionT(misc))),!bDetected&&function(){if(!X.c("'ZXAYEMUL'")||X.U8(9)>3)return!1
if(authp=12+X.I16(12,_BE),!(authp<X.Sz()))return!1
if(auth=authp?X.SC(authp,256,"CP1250"):"",miscp=14+X.I16(14,_BE),!(miscp<X.Sz()))return!1
if(misc=miscp?X.SC(miscp,256,"CP1250"):"",x=X.U8(16)+1,p=18+X.I16(18,_BE),p>X.Sz())return!1
for(titles=[],E=0;E<x;E++,p+=4)if(t=p+X.I16(p,_BE)){if(!(t<X.Sz()))return!1
titles.push(X.SC(t,256,"CP1250").trim())}return!0}()&&(sName="AY Emul chiptune (.EMUL)",bDetected=1,sVersion=[X.U8(8)?"Rel "+X.U8(8):"",X.U8(9)?"Plr "+X.U8(9):""].join(" ").trim(),X.isVerbose()&&(sOptionT(titles.join(",")),x>1&&sOption(x,"×"),authp&&sOptionT(auth,"by: "),miscp&&sOptionT(misc))),!bDetected&&function(){if(!X.c("'CBMF'"))return!1
p=4,notes=ins=0
var s=!1,e=Math.min(X.Sz(),65536),t=[]
for(E=0;E<16;E++)t[E]=!1
for(;!s&&p<e;)for(;!s&&(b=X.U8(p++))<128&&p<e;){if(isWithin(b,1,15)||isWithin(b,64,79)||isWithin(b,113,126))return!1
switch(b>>4){case 0:X.isHeuristicScan()||(s=!0)
break
case 1:if(!t[b-16])return!1
p++,notes++
break
case 2:case 5:case 7:default:break
case 3:t[b-48]=!0,p+=11
break
case 6:p++}}if(!X.isHeuristicScan()){if(!s&&e<X.Sz()||notes<16)return!1
for(E=0;E<16;E++)t[E]&&ins++
if(!ins)return!1}return!0}()&&(sName="Bob's Adlib Music module (.BAM)",bDetected=1,sOption("ch:"+ins+" notes:"+notes+" sz:"+outSz(p))),!bDetected&&function(){if(!X.c("'CTMF'"))return!1
if(!isWithin(X.U16(4),256,257)||!isWithin(X.U16(8),37,X.Sz()-1))return!1
for(nV=X.U16(4,_LE),ic=0,bad="",pins=X.U16(6,_LE),pmus=X.U16(8,_LE),pmus<=pins&&(ic++,bad=bad.addIfNone("!badptr")),nV>=257?(p=40,ins=X.U16(36)):(p=37,ins=X.U8(36)),(t=Util.divu64(pmus-pins,16))!=ins&&(ic++,bad=bad.addIfNone("!inconsistentinscnt"+t)),tp=X.U16(14,_LE),tp&&!isWithin(tp,p,pins-1)&&(tp=0,ic++,bad=bad.addIfNone("!badptr")),ap=X.U16(16,_LE),ap&&!isWithin(ap,p,pins-1)&&(ap=0,ic++,bad=bad.addIfNone("!badptr")),cp=X.U16(18,_LE),cp&&!isWithin(cp,p,pins-1)&&(cp=0,ic++,bad=bad.addIfNone("!badptr")),ch=0,E=20;E<36;E++)1==(t=X.U8(E))?ch++:t>1&&ic++
return ch||ic++,sz=X.fSig(pmus,Math.min(65536,X.Sz()),"FF2F00"),sz<0&&(sz=X.fSig(pmus,Math.min(65536,X.Sz()),"FF2FFE"),bad=bad.addIfNone("!badeof")),sz>0&&(sz+=3),ic<5}()&&(sName="Creative Labs' Creative Music Format chiptune (.CMF)",bDetected=1,sVersion="v"+(nV>>8)+"."+(255&nV),""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(tp&&sOptionT(addEllipsis(X.SC(tp,256,"CP437"))),ap&&sOptionT(addEllipsis(X.SC(ap,256,"CP437")),"by: "),cp&&sOptionT(addEllipsis(X.SC(cp,256,"CP437"))),nV>=257&&255==X.U8(sz)&&sz++,sOption("ch:"+ch+" ins:"+ins+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<2303||!X.c("'Funk'"))return!1
if(sz=X.U32(8),!isWithin(sz,2303,1048576))return!1
switch(t=X.U32(4),sV=X.SA(12,4),bad="",sus=0,/F2\d\d/.test(sV)?sversion="R2 GOLD "+(1980+(t>>9&127))+"-"+(t>>5&15).padStart(2,"0")+"-"+(31&t).padStart(2,"0")+" ":sversion="R1",/F[2vk]\d\d/.test(sV)?ch=X.SA(14,2):(sversion+="b",ch=8,sus++),t>>20&15){case 1:case 2:t="IBM"
break
case 3:t="Intel 386"
break
case 4:t="Intel 486"
break
case 5:t="Pentium"
break
case 6:t="Linux"
break
case 7:t="FreeBSD"
break
case 8:t="N/A"
break
default:t="unk.system"}switch(sversion+="#"+t,t>>16&15){case 0:t="SB 2.0"
break
case 1:t="SB Pro"
break
case 2:t="GUS+ch.pan"
break
case 3:t="SB compatible"
break
case 4:t="SB 16"
break
case 5:t="GUS"
break
case 6:t="conversion"
break
case 7:t="Pro Audio Spectrum"
break
case 8:t="Voxware /dev/dsp 8 bit"
break
case 9:t="Voxware /dev/dsp 16 bit"
break
case 15:t="unk.soundcard"
break
default:t="soundcard N/A"}for(sversion+=":"+t,!X.isVerbose()&&X.Sz()<sz&&(bad=bad.addIfNone("!short")),ord=0,ptn=-1,E=0;E<256&&(t=X.U8(17+E),255!=t);E++)if(ord++,t>121){if(!X.isHeuristicScan())return!1
bad=bad.addIfNone("!badord")}else t>ptn&&(ptn=t)
for(ptn++,lp=X.U8(16),255!=lp&&lp>ord&&(bad+="!badloop"),smp=sus=0,smps=[],E=400;E<2239;E+=32){if(!isWithin(X.U8(E),1,79))return!1
if(X.U32(E+24)&&smp++,charStat(X.readBytes(E+1,19),1).indexOf("allasc")<0&&sus++,sus>3)return!1
sn=X.SC(E+1,19,"CP437"),sn=sn.trim(),funSampleName(sn)&&smps.push(sn)}return!0}()&&(sName="Funktracker module (.FNK,.Funk)",sVersion=sversion,bDetected=1,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())){bpm=X.U8(4),bits=1&bpm?16:8,bpm>>=1
var fs=bpm>>6
bpm&=63,bpm=fs?125-bpm:125+bpm,sOptionT(addEllipsis(smps.join(" ")),'smp/msg:"','"'),sOption("ch:"+ch+" bpm0:"+bpm+" ord:"+(255!=lp?lp+"~":"")+ord+" ptn:"+ptn+" smp:"+smp+" "+bits+"bit sz:"+outSz(sz))}if(!bDetected&&X.c("'psm1'00",8)&&(sus=0,bad="",posp=X.U16(0),(posp<13||posp>X.Sz())&&(sus++,bad+="!badpos"),smpp=X.U16(2),(smpp<13||smpp>X.Sz())&&(sus++,bad+="!badsmp"),ornp=X.U16(0),(ornp<13||ornp>X.Sz())&&(sus++,bad+="!badorn"),ptnp=X.U16(0),(ptnp<13||ptnp>X.Sz())&&(sus++,bad+="!badptn"),sus<2)&&(sName="Pro Sound Maker module (.PSM)",sVersion="compiled",bDetected=1,sus&&(sVersion+="/malformed"+bad+"/sus"+sus),X.isVerbose())){for(t=posp,smpp<t&&(t=smpp),ornp<t&&(t=ornp),ptnp<t&&(t=ptnp),t-13&&sOptionT(X.SA(13,Math.min(t-13,128)),'msg: "','"'),ord=0,t=posp,t=posp;X.U8(t)<255&&t<X.Sz();t+=2)ord++
loop=255,255==X.U8(t)?loop=X.U8(t+1):bad=5,255==loop&&(loop="none"),sOption("ord:"+ord+" loop:"+loop)}if(!bDetected&&function(){if(!(X.c("'FORM'........ 'MODLVERS'00000016")&&X.c("'INFO'00000048",30)&&X.c("'CMNT'000001A4",102)&&X.c("'PTDT'",522)))return!1
for(ss=cmt=dt=pt=sv="",smp=ord=ptn=tmp0=0,sz=X.U32(4,_BE)+8,maxsz=Math.min(sz,X.Sz()),p=30;!bDetected&&p<maxsz&&(hkhd=X.SA(p,4),hksz=X.U32(p+4,_BE),!(charStat(hkhd,1).indexOf("allasc")<0));){switch(hkhd){case"INFO":ss=decAnsi(p+8,32,CPAmiga).trim(),smp=X.U16(p+40,_BE),ord=X.U16(p+42,_BE),ptn=X.U16(p+44,_BE),bpm0=X.U16(p+48,_BE)
var s=X.U16(p+52,_BE)
if(!isWithin(s,1,31))return!1
var e=X.U16(p+54,_BE)
if(!isWithin(e,0,12))return!1
var t=X.U16(p+56,_BE)
if(isWithin(t,30,88))return!1
dt=1900+t+"-"+e.padStart(2,"0")+"-"+s.padStart(2,"0")+" "+X.U16(p+58,_BE).padStart(2,"0")+":"+X.U16(p+60,_BE).padStart(2,"0")+":"+X.U16(p+62,_BE).padStart(2,"0"),pt=secondsToTimeStr(3600*X.U16(p+64,_BE)+60*X.U16(p+66,_BE)+X.U16(p+68,_BE))
break
case"CMNT":auth=decAnsi(p+8,32,CPAmiga).trim(),"UNNAMED AUTHOR"===auth&&(auth=""),cmt=decAnsi(p+40,hksz-32,CPAmiga).trim()
break
case"PTDT":return!0}p+=hksz}}()&&(sName="ProTracker IFF-wrapped module (.PTM)",bDetected=1,sv=X.SA(24,6).trim(),sv.length||(sv="v3.6"),sVersion=sv,X.isVerbose()&&(sOption(ss),sOption(auth,"by: "),sOption(cmt),sOption(dt,"on "),sOption(pt,"len "),sOption("bpm0:"+bpm0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp),sOption(outSz(sz),"sz:"))),!bDetected&&function(){if(!X.c("'SCRM'",44)||!X.c("10",29)||[1,2].indexOf(X.U8(42))<0||X.Sz()<96)return!1
for(keepmidims=fmttrkstr=trknc=us=isSchism=!1,tracker=lswv=bad="",sus=0,X.c("1A",28)||(sus++,bad=bad.addIfNone("!badsig1a")),z1=X.U16(30),z1&&(sus++,bad=bad.addIfNone("!badsig0")),ord=X.U16(32),1&ord&&(sus++,bad=bad.addIfNone("!oddord")),smp=X.U16(34),ptn=X.U16(36),fl=X.U16(38),cwtv=X.U16(40),tv=cwtv>>12,wtv=4095&cwtv,fmtv=X.U16(42),gvol=X.U8(48),spd=X.U8(49),tmp=X.U8(50),mvol=X.U8(51),uc=X.U8(52),usept=(X.U8(53)&&252)>0,r2=X.U16(54),special=X.U16(62),ch=4,E=0;E<32;E++)255!=X.U8(64+E)&&(ch=E+1)
switch(t=Hex(cwtv),sv=t.substr(1,1)+"."+t.substr(2,2).padStart(2,"0"),tv){case 520&tv:tracker="Akord"
break
case 1:X.c("'SCLUB2.0'",54)?tracker="Sound Club 2":4896!=cwtv||special||15&ord||uc||-81&fl||!usept?4896!=cwtv||special||uc||fl||usept?4896!=cwtv||special||uc||8!=fl||usept?(us=!0,4896==cwtv?tracker="Sami 'Psi' Tammilehto's Scream Tracker 3.20-21":(tracker="Sami 'Psi' Tammilehto's Scream Tracker",fmttrkstr=!0)):tracker="Impulse Tracker < 1.03":64==gvol&&48==mvol?tracker="PlayerPRO":tracker="Velvet Studio":(mvol?(lswv="1.16",tracker="ModPlug Tracker/OpenMPT 1.17"):(lswv="1.00.00.A0",tracker="ModPlug Tracker 1.0 alpha"),keepmidims=trknc=!0)
break
case 2:fmttrkstr=8211!=cwtv,fmttrkstr?tracker="Imago Orpheus":tracker="PlayerPRO",trknc=!0
break
case 3:13088==cwtv?tracker="Impulse Tracker 1.03":r2>532?tracker="Impulse Tracker 2.15":isWithin(wtv,533,535)?tracker="Impulse Tracker 2.14p"+(533==wtv?"1-2":534==wtv?"3":"4-5"):tracker="Impulse Tracker "+((3840&wtv)>>8)+"."+(255&wtv).toString(16).padStart(2,"0"),trknc=!0
break
case 4:if(16640==cwtv)tracker="BeRoTracker"
else{isSchism=!0
var s=734016+(wtv<4095?wtv-80:r2),e=Util.div64(1e4*s+14780,3652425),r=s-(365*e+Util.div64(e,4)-Util.div64(e,100)+Util.div64(e,400))
r<0&&(r=s-(365*--e+Util.div64(e,4)-Util.div64(e,100)+Util.div64(e,400)))
var n=Util.div64(100*r+52,3060)
tracker="Schism Tracker "+(e+Util.div64(n+2,12)).padStart(4,"0")+"-"+((n+2)%12+1).padStart(2,"0")+"-"+(r-Util.div64(306*n+5,10)+1).padStart(2,"0")}trknc=!0
break
case 5:if(cwtv>>8==87)tracker="NESMusa",fmttrkstr=!0
else if(r2||16!=uc||1==X.U8(65))if(21575!=cwtv){v=wtv<<16,v>=19464192&&(v|=r2),lswv=function(s){return s.slice(0,1)+"."+s.slice(1,3)+"."+s.slice(3,5)+"."+s.slice(5,7)}(v.toString(16).toUpperCase().padStart(7,"0")),tracker="OpenMPT "+lswv}else tracker="Dumbo's Graoumf Tracker"
else tracker="Liquid Tracker",fmttrkstr=!0
break
case 6:tracker="BeRoTracker"
break
case 7:tracker="BeRo's CreamTracker"
break
default:51712==cwtv&&(tracker="Camoto")}if(sus>=2)return!1
for(fmttrkstr&&(tracker+=" "+sv),charset=""!=lswv?"CP1252":"CP437",p=96+ord+2*smp,max=sz=0,E=0;E<ptn;E++){var i=X.U16(p+2*E)<<4
i&&(i>max&&(max=i,sz=max+X.U16(i)))}if(sz%16&&(sz+=16-sz%16),usept){var a=!1
for(p+=2*ptn,E=0;E<ch;E++)us&&isWithin(X.U8(64+(255&E)),16,29)&&X.U8(p+E)<16&&(a=!0)
ch<32&&lswv.indexOf("1.16")>=0&&(tracker=a?"ModPlug Tracker 1.16/OpenMPT 1.17":"ModPlug Tracker")}for(p=96+ord,anysmp=anyADPCM=!1,gus=0,smps=[],E=0;E<smp;E++)si=X.U16(p+2*E)<<4,si&&(si>X.Sz()?bad=bad.addIfNone("!short"):(K=X.U8(si),ssz=X.U32(si+16),t=X.SC(si+48,28,charset).trim(),""!=t&&smps.push(t),K<2&&(ssz&&(anysmp=!0,I=X.U8(31),anyADPCM||4!=X.U8(si+20)||6&I||(anyADPCM=!0)),gus|=X.U16(si+40)),1===X.U8(si)&&(sofs=X.U16(si+14)<<4,sofs>max&&(4&I&&(ssz*=2),max=sofs,sz<max+ssz&&(sz=max+ssz)))))
return usegus=gus>1,us&&anysmp&&!gus&&4864!=cwtv?(us=!1,tracker="Unknown",4865!=cwtv||uc||(!(-81&fl)&&128&mvol&&usept?tracker="Laurent Clévy's UNMO3":fl||48!=gvol||176!=mvol||150!=tmp||usept?fl||64!=gvol||48!=(127&mvol)||6!=spd||125!=tmp||usept||(tracker="Zab/Kosmic's To-S3M"):tracker="Slixter's deMODifier")):us&&(tracker+=usegus?" (GUS)":" (SB)"),anyADPCM&&(tracker+=" (ADPCM packed)"),!0}()&&(sName="ScreamTracker 3 module (.S3M)",bDetected=1,sus&&(sVersion=sVersion.appendS("malformed"+bad+" sus"+sus,"/")),X.isVerbose()&&(sOptionT(X.SC(0,28,charset)),sOption(tracker,"in:"),sOption(addEllipsis(smps.join(" "),160),'smp/msg:"','"'),sOption("ch:"+ch+" tempo0:"+tmp+" spd0:"+spd+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" gvol:"+gvol+" smpvol:"+(127&mvol)+(128&mvol?"/mono":"/stereo")+" sz:"+outSz(sz)))),!bDetected&&X.c("'SONG'")&&(secsz=X.U32(4,_BE),v=X.U8(8),trk=X.U8(9),p=10,fxc=0,v>=17&&(fxc=X.U8(p),p++),title=X.SA(p,256),X.c("'SEQU'",p+title.length+1+2))&&(sName="ProtoTracker module (.SONG)",bDetected=1,sVersion=sVersion="v"+v,X.isVerbose()&&(sOption(title),sOption("trk:"+trk+" fx:"+fxc))),bDetected||!X.c("'mpl'")||(p=X.U32(4,_BE),p>X.Sz()||1&p||(songp=p+8,!X.c("'mdt'",p)||(p+=X.I32(p+4,_BE),p>X.Sz()||1&p||!X.c("'msm'",p)||(p+=X.I32(p+4,_BE),p<X.Sz()||(sz=p,smpp=songp+X.I32(songp-4,_BE),smpsz=X.I32(smpp-4,_BE),smp=X.I16(songp+20,_BE)-X.I16(songp+18,_BE)>>2,songsz=songp-8,x=X.I16(songp+4,_BE)-X.I16(songp+2,_BE)>>2,p=X.I16(songp,_BE),ord=X.I16(songp+6,_BE)-p-X.I32(songp+p+12,_BE),0)))))||(sName="Anders 'Zonix' 0land's Music & Player module (.HOT)",bDetected=1,sVersion="v"+X.SA(3,1),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("ord:"+ord+" smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)),sOption(outSz(sz),"sz:"))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<40||X.Sz()>=65535)return!1
if(X.c("0001.... 000D00")&&X.c("FFFF",11))nV=0
else{if(!X.c("01..01.. 000F00")||!X.c("FFFF",13))return!1
nV=1}if(seqp=X.U16(3,_LE),seqp<13||seqp>X.Sz())return!1
for(x=1,seqtest=X.fSig(seqp+18+9,TOEOF,"0000000000 FFFF")-seqp;seqtest>32;)if(x++,seqtest-=32,!X.c("0000000000",seqp+seqtest))return!1
if(trkp=t=X.U16(5,_LE),!X.c("FFFF",trkp-2)||trkp<13)return!1
if(insp=X.U16(7,_LE),!X.c("FFFF",insp-2)||insp<13)return!1
if(sz=X.U16(9,_LE),!X.c("FFFF",sz-2)||sz<13)return!1
if(1==nV&&(sfxp=X.U16(11,_LE),!X.c("FFFF",sfxp+8)))return!1
if(Math.abs(trkp-seqp)<20||Math.abs(trkp-insp)<20||Math.abs(seqp-insp)<20)return!1
for(oldp=trkp,p=X.U16(trkp,_LE),ip=0,once=0;t<trkp+18&&trkp<X.Sz();){if(t===trkp&&(p=oldp=t),p&&(oldp=p),p=X.U16(t,_LE),!p||p<trkp||p>X.Sz())return!1
if(!X.c("FFFF",p-2)&&(once++,once>1))return!1
if(p<oldp&&(ip++,ip>2))return!1
for(U=p;!X.c("FFFF",U)&&U<X.Sz();)U+=2
if(!X.c("FFFF",U))return _log("D00nohdr: boh. t="+Hex(t)+" p="+Hex(p)+" q="+Hex(U)),!1
t+=2}return msg="",t=X.fSig(sz,512,"FFFF"),t>0?(msg=X.SC(sz,t-sz,"CP437").trim(),sz=t+2):(msg=X.readBytes(sz,Math.min(sz+256,X.Sz())-sz),c=charStat(msg,1),c.indexOf("allxsc")>=0?(msg=decEncoding(msg,CP437),sz+=msg.length,msg=msg.trim()):msg=""),!0}()&&(sName="Edlib Tracker module (.D00)?",sVersion="old v"+X.U8(0),bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOptionT(addEllipsis(msg,256,128),'msg:"','"'),sOption("sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<1084)return!1
var s=X.readBytes(1080,4),e=X.SA(1080,4),r=1084,n=952,i=isGenericMCh=isMdKd=maybeWOW=isHMNT=isInconexia=isNoiseTracker=setMODVBlankTiming=hasLongSmp=hasEmptySmpwVol=hasRepLen0=!1,a=0,o=40
if(/(M\.K\.|M!K!|PATT|NSMS|LARD)/.test(e))chn=4,tracker="generic Protracker-compatible","M.K."===e&&(isMdKd=!0,maybeWOW=!0)
else if(/(M&K!|FEST|N\.T\.)/.test(e))chn=4,"N.T."===e?tracker="NoiseTracker":(tracker="His Master's NoiseTracker",isHMNT=!0),isNoiseTracker=!0
else if(/O[KC]TA/.test(e))chn=8,tracker="Oktalyzer"
else if(/CD[68]1/.test(e))chn=s[2]-48,tracker="Oktalyser (Atari)"
else if(s===[77,0,0,0]||s===[56,0,0,0])56===s[0]?chn=8:chn=4,o=1,tracker="Inconexia demo",isInconexia=!0
else if(/FA0[4-8]/.test(e))chn=s[3]-48,tracker="Digital Tracker",r=1088
else if(/(FLT|EXO)[48]/.test(e))chn=s[3]-48,4==chn&&a++,i=setMODVBlankTiming=!0,tracker="Startrekker"
else if(/[1-9]CHN/.test(e))chn=s[0]-48,isGenericMCh=!0,tracker="generic MOD-compatible"
else if(/[1-9][0-9]C[HN]/.test(e))chn=10*s[0]+s[1]-528,isGenericMCh=!0,tracker="generic MOD-compatible"
else if(/TDZ[1-3]/.test(e))chn=s[3]-48,tracker="Twaddler and Dr. Zon's TakeTracker"
else{if(!/WARD/.test(e))return!1
chn=8,isGenericMCh=!0,tracker="generic MOD-compatible"}if(!chn)return!1
for(restartpos=X.U8(951),p=20,wowsmpsz=ib=0;p<950;p+=30){var d=X.U16(p+22,_BE)<<1
wowsmpsz+=d,!isHMNT&&!hasLongSmp&&d>=131072&&(hasLongSmp=!0)
var c=X.U8(p+24),m=X.U8(p+25),f=X.U16(p+26,_BE)<<1,l=X.U16(p+28,_BE)<<1
if((c||d&&64!=m)&&(maybeWOW=!1),c>15&&ib++,m>64&&ib++,d||64!=m||(hasEmptySmpwVol=!0,a&&!f&&l<=2&&a++),f>d&&ib++,hasRepLen0||!d||l||(hasRepLen0=!0),ib>o)return!1}function u(s){var e=0
for(E=0;E<64*chn;E++)224&X.U8(s+(E<<2))&&e++
return e}if(isFLT8=i&&8==chn,wowsmpsz,restartpos&&(maybeWOW=!1),maybeWOW||(wowsmpsz=0),a>=2&&(tracker+="/Audio Sculpture"),ord=X.U8(950),!ord)return!1
if(ol=X.readBytes(n,128),ord>128)ord=128
else if(!ord)for(ord=128;ord>1&&!ol[ord-1];)ord--
for(ptn=iptn=optn=0,E=n,E=0;E<128;E++){isFLT8&&(ol[E]/=2)
var b=ol[E]
b<128&&b>=ptn&&(ptn=b+1,E<ord&&(optn=ptn)),ptn>=iptn&&(iptn=ptn+1)}var S=-2&X.Sz()
wowsmpsz&&wowsmpsz+r+8*ptn*256==S?u(r+4*ptn*256)<16&&(chn=8):ptn!=optn&&u(r+optn*chn*256)>64&&(ptn=optn),iptn>ptn&&r+d+iptn*chn*256==S&&(ptn=iptn),maybeWOW&&8===chn&&(tracker="Mod's Grave",isGenericMCh=!0),(restartpos>=ord||120==restartpos&&4===chn)&&(restartpos=0)
var U=!0
if(leftPan=extPan=maxPan=0,!isNoiseTracker){for(isNoiseTracker=isMdKd&&!hasEmptySmpwVol&&!hasLongSmp,p=r,b=0;b<ptn;b++)for(var z=0;p<b*chn*256;p+=4){var h=X.readBytes(p,4),k=(15&h[0])<<8|h[1]
k&&4095!=k&&U&&(k<113||k>856)&&(U=isNoiseTracker=!1)
var F=15&h[2],_=h[3];(F>6&&F<10||14==F&&_>1||15==F&&_>31||13==F&&++z>1)&&(isNoiseTracker=!1),8==F&&(_>maxPan&&(maxPan=_),_<128?leftPan=!0:_>143&&164!=_&&(extPan=!0))}leftPan&&!extPan&&maxPan>=48}if(U&&!hasRepLen0&&["M.K.","M!K!","PATT"].indexOf(e)>=0||!U&&127==restartpos&&isMdKd&&restartpos+2>=ord&&(tracker="Sami 'Psi/Future Crew' Tammilehto's Scream Tracker"),sz=r+ptn*chn*256,sz>X.Sz())return!1
p=20,smp=0,songsz=sz,ib=0,smps=[]
for(var O=0;p<950;p+=30){isHMNT||(t=X.readBytes(p,22,!0),t=decEncoding(t,CPAmiga).trim(),t.length&&smps.push(t)),(d=2*X.U16(p+22,_BE))&&smp++,X.c("'ADPCM'",sz)&&(O++,d=5+(d+1>>1)+16),sz+=d}if(X.c("8BBEB4BA 8BADBEBC B4BAAD",sz)){for(var B,V=[];sz<X.Sz()&&isWithin(223^X.U8(sz),10,127);)V.push(223^X.U8(sz++))
B=decEncoding(V,CP437),tracker="Twaddler and Dr. Zon's TakeTracker",/\ version\ \d+\./.test(B)&&(tracker+=" v"+/\ version\ (\d[^!]+)/.exec(B)[1])}else isMdKd&&X.c("001155332211",sz)&&(tracker="Tetra Music Editor:"+X.U24(sz+6,_BE).padStart(6,"0"),sz+=9)
return O&&!isInconexia&&(tracker+=" (ADPCM packed: "+O+")"),!0}()&&(sName="Amiga Freelancers' Protracker module (.MOD)",bDetected=1,sVersion=X.SA(1080,4),X.isVerbose()&&(sOptionT(decAnsi(0,20,CPAmiga)),sOption(tracker,"in: "),sOptionT(addEllipsis(smps.join(" "),200),'smp/msg:"','"'),sOption("chn:"+chn+" ord:"+ord+" ptn:"+(optn!=ptn?optn+"/":"")+ptn+(iptn!=ptn?"("+iptn+")":"")+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<2240||!X.c("'KRIS'",952))return!1
if(ord=X.U8(956),ord>128)return!1
if(loop=X.U8(957),loop>127||loop<127&&loop>=ord)return!1
p=22
var s=ib=0
smp=synwf=0,smps=[]
for(var e=0;e<31;p+=30,++e)if(X.U8(p)){t=X.SC(p,20,"IBM850").trim(),""!=t&&""!=t&&smps.push(t)
var r=2*X.U16(p+22,_BE)
if(s+=r,240&X.U8(p+24)&&ib++,X.U8(p+25)>64&&ib++,2*X.U16(p+26,_BE)>r&&ib++,ib>40)return!1
smp++}else{var n=Math.max(X.U8(p+1),X.U8(p+5),X.U8(p+10),X.U8(p+19))
n&&n>=synwf&&(synwf=n+1)}for(ptn=0,p=958,ord=X.U8(956),e=0;e<ord<<2;e++,p+=2)ptn<X.U8(p)&&(ptn=X.U8(p))
return ptn++,sz=1984+(synwf<<6)+(ptn<<8)+s,!0}()&&(sName="Krister Wombell's ChipTracker module (.KRIS,.MOD)",bDetected=1,X.isVerbose()&&(sOption(X.SA(0,16)),sOptionT(addEllipsis(smps.join(" "),200),'smp/msg:"','"'),sOption("ord:"+(loop&&loop<127?loop+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+(synwf?" synwf:"+synwf:"")+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.c("'MTN'000000",1464))tracker="MnemoTroN ST"
else{if(!X.c("'IT10'00",1464))return!1
tracker="Ice Tracker 1.0~1"}for(smp=smpsz=0,smps=[],p=20;p<950;p+=30)t=decAnsi(p,22,CPAmiga).trim(),""!=t&&smps.push(t),ssz=X.U16(p+22,_BE),ssz&&smp++,smpsz+=ssz
if(ord=X.U8(p++),ptn=X.U8(p++),ord>128)return!1
for(E=0;E<512;E++)if(X.U8(p++)>ptn)return!1
return sz=1468+64*ptn*4+smpsz,!0}()&&(sName="SoundTracker module (.ST26,.ICE)",sVersion="v2.6",bDetected=1,X.isVerbose()&&(sOptionT(decAnsi(0,20,CPAmiga)),sOptionT(addEllipsis(smps.join(" "),128),'smps/msg:"','"'),sOption("in: "+tracker),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+sz))),!bDetected&&function(){if(!/MED[\x02-\x04]/.test(X.SA(0,4)))return!1
switch(nV=X.U8(3),nV){case 2:sVersion="v1.12"
break
case 3:sVersion="v2.00"
break
case 4:sVersion="v2.10+"}if(x=1,p=sz=ptn=ord=trk=midi=syhy=smp=realsmp=0,smps=[],cs=bad="",nV<3);else{var s=X.U8(4)
for(p=5;s;){if(1&s)for(var e=X.U8(p++);e;)smp+=1&e,e>>=1
s>>=1}for(E=0;E<smp;E++){if(fl=X.U8(p++),smpnl=X.U8(p++),smps.push(X.SA(p,smpnl)),p+=smpnl,1&fl||(p+=2),2&fl||(p+=2),4&fl||p++,8&fl||p++,48&fl||(T=X.U8(p++)),T>64)return!1
64&fl||p++}for(E=62;E>=0;E--)if(smps[E]&&smps[E].length){realsmp=E+1
break}if(ptn=X.U16(p,_BE),ord=X.U16(p+2,_BE),!ord||ord>256)return!1
for(p+=4,E=0;E<ord;E++)if(X.U8(p++)>ptn)return!1
for(extsmp=!(8&X.U8(p+3)),tmp0=X.U16(p,_BE)+"//"+X.U16(p+4,_BE),p+=26,E=0;E<16;E++)if(X.U8(p++)>64)return!1
if(mvol=X.U8(p++),mvol>64)return!1
if(p>X.Sz())return!1
function t(){var s=X.U32(p,_BE)
p+=4
for(var e=0;e<32;e++)s<0&&(s=-s),2147483648&s&&(midi++,p++),s<<=1}for(3===nV&&(t(),t()),E=0;E<ptn;E++){var r=X.U8(p++),n=X.U8(p)
trk<n&&(trk=n)
X.U8(p+1)
var i=X.U16(p+2,_BE)
p+=r+i}if(!extsmp){var a=new BitReader(p,_BE),o=0
for(a.read(1),E=0;E<realsmp;E++)o+=a.read(1)
for(delete a,p+=8,E=0;E<o;E++)i=X.U32(p,_BE),hktp=X.U16(p+4,_BE),p+=6,65535!=hktp&&65534!=hktp||syhy++,p+=i}if(X.c("'MEDV'",p))for(;p+8<=X.Sz()&&/[A-Z]{4}/.test(X.SA(p,4));){switch(hkhd=X.SA(p,4),i=X.U32(p+4,_BE),p+=8,hkhd){case"MEDV":sVersion="v"+X.U8(p+2)+"."+X.U8(p+3).padStart(2,"0")
break
case"ANNO":cs=X.SC(p,i,"CP1252")
break
case"HLDC":break
default:_log("Unknown MED header: "+hkhd)}p+=i}}return sz=p,sz>X.Sz()&&(bad="!short"),!0}()&&(sName="OctaMED module (.MED)",bDetected=1,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())){for(sOptionT(cs);""==smps[smps.length];)delete smps[smps.length]
smps.length&&sOption("["+smps.join(",")+"]","smps:"),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+(realsmp!=smp?"("+realsmp+")":"")+(extsmp?"(ext.)":"")+(syhy?" synth+hybrid:"+syhy:"")+(midi?" midi:"+midi:"")+" trk:"+trk+" tmp0:"+tmp0+" mvol:"+mvol+" sz:"+outSz(sz))}if(!bDetected&&function(){if(!X.c("'MMD'"))return!1
if(nV=X.U8(3)-48,nV<0||nV>3)return!1
switch(nV){case 0:D="MED module (.MED,.MMD0)",sversion="v2.1 Med MoDule 0"
break
case 1:D="OctaMED Professional module (.MED,.MMD1)",sversion="v.3.00-4.x"
break
case 2:D="OctaMED Professional module (.MED,.MMD2)",sversion="v5.x"
break
case 3:D="OctaMED Professional module (.MED,.MMD3)",sversion="v6.x?"}if(ptnsp=X.U32(16,_BE),ptnsp<52)return!1
if(smpsp=X.U32(24,_BE),smpsp&&smpsp<52)return!1
if(expp=X.U32(32,_BE),expp>X.Sz())return!1
if(sec=p=0,sngp=X.U32(p+8,_BE),sngp<52||sngp>4294966535)return!1
if(X.Sz()<Math.max(sngp+504+256,ptnsp,smpsp||52,expp+52))return!1
songname=anno=iinfo="",ch=4,xsngs=X.U8(51),x=expp?xsngs+1:1,expp&&(psongname=X.U32(expp+44,_BE),psongname&&(songnamelen=X.U32(expp+48,_BE),songnamelen&&(songname=X.SC(psongname,songnamelen,"CP1252"))),pannotxt=X.U32(expp+12,_BE),pannotxt>0&&(annolen=X.U32(expp+16,_BE),anno=X.SC(pannotxt,annolen,"CP1252")),pMMDInstrInfo=X.U32(expp+20,_BE),pMMDInstrInfo>0&&(iinfo=X.SC(expp,40,"CP1252"))),ptn=0,ord=[]
var s=X.U32(16,_BE)
for(E=0;E<x;E++){for(p=sngp+504,ptn1=X.U16(p,_BE),ptn1>32767&&(ch=4),ptn+=ptn1,j=0;j<ptn1;j++)pj=4*j+s,pj>X.Sz()||(pj=X.U32(pj,_BE),pj>X.Sz()||(pj=nV<1?X.U8(pj+4):X.U16(pj+4,_BE),pj>ch&&(ch=pj)))
if(nV<2){if(ord[0]=X.U16(p+2,_BE),ord[0]>256)return!1}else{if(sec=X.U16(p+2,_BE),trk=X.U16(p+16,_BE),!trk||trk>64)return!1
if(sectp=X.U32(p+8,_BE),sectp+2*sec>X.Sz())continue
for(playseqtp=X.U32(p+4,_BE),nplayseq=X.U16(p+18,_BE),secs=[],j=0;j<sec;j++)secs.push(X.U16(sectp+2*j,_BE))
for(j=0;j<secs.length;j++)j<=nplayseq&&ord.push(X.U16(X.U32(playseqtp,_BE)+40,_BE))}if(expp=X.U32(sngp+32,_BE),expp&&(X.U32(expp,_BE)<sngp||expp>X.Sz())){x=E+1
break}sngp=X.U32(expp,_BE)}return smp=X.U8(p+283),!(smp>63)}()&&(sName=D,sVersion=sversion,bDetected=1,X.isVerbose()&&("<unnamed>"!=songname&&"<ohne Namen>"!=songname&&sOption(songname),sOptionT(anno),sOptionT(iinfo,"ins0:"),x>1&&sOption(x,"×"),sOption((X.isDeepScan()?"ch:"+ch+" ":"")+"ord:"+ord.join("+")+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(X.U32(4,_BE))))),!bDetected&&function(){if(X.Sz()<30)return!1
if(X.c("'THX'0."))fmt="ahx"
else{if(!X.c("'HVL'0."))return!1
fmt="hvl"}bad=0
var s=X.U8(6)
switch(trk0saved=s>>7,s>>4&7){case 0:spd="50Hz"
break
case 1:spd="100Hz"
break
case 2:spd="150Hz"
break
case 3:spd="200Hz"
break
default:bad++}if(ord=4095&X.U16(6,_BE),ord>999&&bad++,(!ord||ord>1024)&&bad++,"ahx"===fmt?(lp=X.U16(8,_BE),lp>=ord&&bad++):chn=4+(X.U8(8)>>2),bad>1)return!1
if(trl=X.U8(10),!trl||trl>64)return!1
if(trk=X.U8(11),ins=X.U8(12),ins>63)return!1
if(sub=X.U8(13),"ahx"===fmt)for(sz=14+2*sub+8*ord+trk*trl*3,trk0saved||(sz+=3*trl),E=0;E<ins;E++){var e=X.U8(sz+21)
sz+=22+4*e}else{for(sz=16+2*sub+ord*chn*2,E=trk0saved?1:0;E<=trk;E++)for(j=0;j<trl;j++)63!=X.U8(sz)?sz+=5:sz++
for(E=0;E<ins;E++){e=X.U8(sz+21)
sz+=22+5*e}}for(title="",E=0;E<=ins;E++){for(var t=sz;X.U8(sz)&&sz<X.Sz();)sz++
E||(title=X.SA(t,sz-t)),sz++}return sz>X.Sz()&&bad++,!0}()&&("ahx"===fmt?(sName="Abyss' Highest eXperience module (.AHX)",X.U8(3)?sVersion="v2.0+":sVersion="v1.00~1.27"):sName="Hively Tracker module (.HVL)",bDetected=1,bad&&(sVersion+="/malformed"+bad),X.isVerbose())){for(""!=title&&sOption(title),sub&&sOption(sub,"×"),n=0,p=14+2*sub+8*ord,c=trk*trl,trk0saved||(c+=trl),hp=!1,E=0;E<c;E++)note=X.U8(p+3*E)>>2,note&&n++,note>60&&"ahx"==fmt&&(hp=!0)
hp&&(sVersion+="/hi-pitch!"),"ahx"===fmt?sOption("spd:"+spd+" ord:"+ord+" lp:"+lp+" trk:"+trk+" ins:"+ins+" notes:"+n+" sz:"+outSz(sz)):sOption("ch:"+chn+" spd:"+spd+" ord:"+ord+" trk:"+trk+" ins:"+ins+" notes:"+n+" sz:"+outSz(sz))}if(!bDetected&&function(){for(t=X.readBytes(20,8),E=0;E<8;E++)if(t[E]<32||t[E]>=127)return!1
if(isstm=!([26,2].indexOf(X.U8(28))<0||[1,2].indexOf(X.U8(29))<0||!X.c("02",30)||[0,10,20,21].indexOf(X.U8(31))<0||X.U8(33)>64||(gvol=X.U8(34),gvol>64&&88!=gvol||(nVm=X.U8(31),ptn=X.U8(33),nVm?maxord=128:maxord=64,minsz=1040+maxord+256*ptn,X.Sz()<minsz||(smp=0,ord=-1,tracker="Sami 'Psi/Future Crew' Tammilehto's Scream Tracker 2 module",ext="STM",0)))),!isstm&&(isstx=function(){if(!X.c("'SCRM'",60))return!1
if(ptnsz=X.U16(28),ptnsz<64&&26!=ptnsz||ptnsz>2112)return!1
if(t=X.U8(42),t>64&&88!=t)return!1
if(ptn=X.U16(48),ptn>64)return!1
if(smp=X.U16(50),smp>96)return!1
if(ord=X.U16(52),ord>129&&257!=ord)return!1
if(X.U16(30)||X.U32(38)||1!=X.U32(44))return!1
if(ptntp=X.U16(32)<<4,smptp=X.U16(34)<<4,chtp=X.U16(36)<<4,minsz=64+Math.max(ptntp+2*ptn,smptp+2*smp,chtp+32+5*ord),X.Sz()<minsz)return!1
for(p=chtp+32,E=0;E<ord;E++)if(t=X.U8(p+5*E),t>63&&99!=t&&255!=t)return!1
return tracker="Scream Tracker Music Interface Kit module",ext="STX",!0}(),!isstx))return!1
if(sz=sz1=minsz,smp0="",max=0,isstm){for(E=0;E<31;E++){if(zero=X.U8(48+32*E+12),zero&&46!=zero)return!1
t=X.SC(48+32*E,12,"CP437").trim(),E<3&&X.isVerbose()&&t.length&&(smp0=smp0.append(t))
var s=X.U16(48+32*E+14,_LE)<<4,e=X.U16(48+32*E+16,_LE)
e&&s>48&&s<X.Sz()&&(e&&(sz1=s+e),sz1>sz&&(sz=sz1),e>1&&smp++)}for(E=0;E<maxord;E++)if(t=X.U8(1040+E),99===t||255===t)t=255
else{if(t>63)return!1
ord++}ord++}else{if(!isstx)return!1
for(p=smptp,E=0;E<smp;E++)si=X.U16(p+2*E)<<4,t=X.SC(si+48,28,"CP437").trim(),E<3&&X.isVerbose()&&t.length&&(smp0=smp0.append(t)),si&&1===X.U8(si)&&(s=X.U16(si+14)<<4)>max&&(e=X.U32(si+16),4&X.U8(si+31)&&(e*=2),max=s,sz<max+e&&(sz=max+e))
if(fmt=1,ptn&&26!=ptnsz){if(p=X.U16(ptntp)<<4,p>X.Sz())return!!X.isHeuristicScan()&&(bad=bad.addIfNone("!badptnp"),!0)
X.U16(p)===ptnsz&&(fmt=0)}}return!0}()&&(sName=tracker+" (."+ext+")",bDetected=1,X.isVerbose()&&(sOptionT(X.SC(0,20,"CP437")),smp0.length&&sOption(smp0,"by/smp: "),"STM"===ext?sVersion="v"+X.U8(30)+"."+nVm:sVersion="v1."+fmt,tmp0=X.U8(32),gvol=X.U8(34),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" gvol:"+gvol+" sz:"+outSz(sz)))),!bDetected&&function(){var s=0
if(X.c("'IMPM'"))type="it"
else{if(!X.c("'tpm.'"))return!1
type="mpt"}if(ord=X.U16(32,_LE),ord||s++,ins=X.U16(34,_LE),ins>99&&s++,smp=X.U16(36,_LE),smp>255&&s++,ptn=X.U16(38,_LE),ptn||X.isHeuristicScan()||s++,X.Sz()<192+4*(ins+smp+ptn))return!1
if(cwtv=X.U16(40,_LE),cmwt=X.U16(42,_LE),flags=X.U16(44,_LE),special=X.U16(46,_LE),gvol=X.U8(48),gvol>128&&s++,mvol=X.U8(49),mvol>128&&s++,spd0=X.U8(50),spd0||s++,tmp0=X.U8(51),tmp0<31&&s++,sep=X.U8(52),sep>128&&s++,msglen=X.U16(54,_LE),msgofs=X.U32(56,_LE),msgofs+msglen>X.Sz()&&s++,s>2)return!1
bad="",s&&(bad=bad.addIfNone("!badinitinfo")),pwd=X.U8(53),nreserved=X.U32(60,_LE),sreserved=X.SA(60,4),tracker=auth="",mVlsw=mVcw=sV="?",ch=1,cord=0,sz=-1
var e=k=0
if(type="it",chnm=[],insnlst=[],smpnlst=[],X.isDeepScan()){const $=80,ss=4096,es=1,ts=2,ps=4,rs=8,ns=128
var t=X.fSig(64,64,"FF")>=0,r=0
function n(s){return s.slice(0,1)+"."+s.slice(1,3)+"."+s.slice(3,5)+"."+s.slice(5,7)}if(X.c("'tpm.'"))type="mpt",p=X.Sz()-4,e=X.U32(p,_LE),X.c("'228'04'mptm'",e)?sz=X.Sz():e=0
else{if(2184<cwtv<=4095&&(p=X.Sz()-4,256<=(e=X.U32(p,_LE))<X.Sz()-4))if(X.c("'228'04'mptm'",e)){if(type="mpt",sz=X.Sz(),cwtv>=ss)return sV="future",charset="UTF8",extsmp=0,!0}else e=0
"it"===type&&(20480==(61440&cwtv)?(r=(4095&cwtv)<<16,X.c("'OMPT'",60)?!0:r>=19464192&&(r|=65535&nreserved),mVlsw=n(r.toString(16).toUpperCase().padStart(7,"0"))):2184===cwtv||2184===cmwt?mVlsw="1.17.00.00":532!==cwtv||514!==cmwt||nreserved?768!==cwtv||768!==cmwt||nreserved||256!==ord||128!==sep||pwd||(mVlsw="1.17.02.20",!0):(mVlsw="1.09.00.00",tracker="ModPlug Tracker b3.2 - 1.09",!0))}var i=-1,a=0
if("mpt"===type&&2186<cwtv&&cwtv<=2189){if(p=192,X.U16(p,_LE))return!1
if(p+=2,i=X.U32(p,_LE),p+=4,i>256||X.Sz()<p+4*i)return!1}else p=192
for(i>=0&&(ord=i),E=0;E<ord;E++)i<0?(o=X.U8(p++),254===o?a=65534:(cord++,255===o&&(a=65535))):(o=X.U32(p,_LE),p+=4,a=o,cord++)
minp=4294967295
var d=[]
for(E=0;E<ins;E++){if(s=X.U32(p,_LE),p+=4,s<=p||s>X.Sz())return!1
U=X.readBytes(s+32,26,!0),""!=(U=decEncoding(U,CP437,!1).trim())&&insnlst.push(U),sz<s&&(sz=s),s&&s<minp&&(minp=s),d.push(s)}var c=[]
for(E=0;E<smp;E++)s=X.U32(p,_LE),p+=4,s>X.Sz()&&(bad=bad.addIfNone("!short")),U=X.readBytes(s+20,26,!0),""!=(U=decEncoding(U,CP437,!1).trim())&&smpnlst.push(U),sz<s&&(sz=s),s&&s<minp&&(minp=s),c.push(s)
var m=[]
for(E=0;E<ptn;E++){if(s=X.U32(p,_LE),p+=4,s>30&&s<=p||s>X.Sz())return!1
sz<s&&(sz=s),s&&s<minp&&(minp=s),m.push(s)}special&es&&(minp=Math.min(minp,msgofs),sz<msgofs+msglen&&(sz=msgofs+msglen))
var f=!(532!==cmwt||cwtv&&532!==cwtv||X.U16(30)||pwd||nreserved||192&flags)
if(f&&!ins&&smp&&p+4*c.length+2<=minp){var u=!0
for(E=0;E<smp;E++){if(X.U32(p)){u=!1,p-=4*E
break}p+=4}u&&(tracker="UNMO3 <= v2.4")}if(f&&!cwtv&&(tracker="UNMO3 v0/1"),special&ts){var b=X.U16(p)
X.Sz()>p+8*b&&p+8*b<=minp&&(p+=2+8*b,f&&!b&&(special&ps?tracker="UNMO3 <= 2.4.0.1":tracker="UNMO3"))}else f&&special<=1&&!X.U16(p)&&(tracker="UNMO3 <= 2.4",p+=2)
if((flags&ns||special&rs)&&(p+=4896),p>X.Sz())return!1
for(var z=hasPluginChunks=hasMPTM=!1;p+9<X.Sz();){if(hkhd=X.SA(p,4),hksz=X.U32(p+4,_LE),"MODU"===hkhd)z=!0
else if("CNAM"===hkhd)for(ch=hksz/20,M=p+8,hasMPTM=!0,E=0;E<ch;E++)s=X.SA(M,20).trim(),M+=20,""!=s&&chnm.push(s)
else"PNAM"===hkhd?hasMPTM=!0:("CHFX"===hkhd||/F[X0-9]\d\d/.test(hkhd))&&(hasPluginChunks=!0)
if(["IMPI","IMPS","XTPM","STPM"].indexOf(hkhd)>=0||p+8+hksz>X.Sz()||p>=msgofs)break
p+=8+hksz}535!==cwtv||512!==cmwt||nreserved||z||(hasMPTM||ord>0&&65535==a||t?(mVlsw="1.16.00.00",tracker="ModPlug Tracker 1.09-16"):(mVlsw="1.17.00.00",tracker="OpenMPT 1.17 (compat.export)"),!0)
var k=smp>0?c[smp-1]+$:p,F=!1
const is=2,as=4,os=8,ds=1,Xs=2,cs=4,ms=8,fs=64,ls=128,us=255
extsmp=[]
var _=!1
for(Ss=[],maxsmpofs=-1,E=0;E<smp;E++)if(c[E])if(c[E]>X.Sz())bad=bad.addIfNone("!short")
else{X.c("'IMPS'",c[E])||(bad=bad.addIfNone("!badsmp"))
var O=X.U8(c[E]+18),B=X.U8(c[E]+46),V=X.U32(c[E]+48),x=X.U32(c[E]+72)
if(S={ofs:0,slen:0,bits:O&is?16:8,chn:1,en:"LE",codec:"sPCM",bps:0,length:0},p=x,S.ofs=x,S.slen=V,B===fs)p+=12
else if(B===ls)s=readVarUInt(p),extsmp.push(X.SA(p+1,s[1])),p+=s[0]+s[1]
else if(X.c("'fLaC'",x))S.codec="FLAC"
else if(X.c("'OggS'",x))S.codec="Ogg"
else{switch(S.codec=B&ds?"sPCM":"uPCM",O&as&&cwtv>=532&&(S.chn=2),O&os?S.codec=B&cs?"IT215":"IT214":O&is||B!=us?(B&Xs&&(S.en="BE"),B&cs&&(S.codec="dPCM"),B&ms&&(S.codec="8d16")):S.codec="ADPCM",S.codec){case"sPCM":case"uPCM":case"dPCM":case"fPCM":case"MT2":case"fPCM15":case"fPCM23":case"fPCMn":case"sPCMn":S.bps=S.bits
break
case"8d16":S.bps=16
break
case"ADPCM":S.bps=4
break
case"uLaw":case"aLaw":S.bps=8
break
default:S.bps=0}S.bps?(S.length=V*S.chn*(S.bps>>3),p+=S.length):F=!0,Ss[E]=S}k<p&&(k=p),sz<k&&(sz=k),"uPCM"===S.codec&&V&&(_=!0)}if(_&&516===cwtv&&512===cmwt&&!special&&!nreserved&&21==(-9&flags)&&128===gvol&&48===mvol&&128===sep&&!pwd&&!msglen){for(E=0;E<64;E++)if([32,64].indexOf(X.U8(64+E))<0){_=!1
break}if(_)for(E=0;E<64;E++)if(64!=X.U8(128+E)){_=!1
break}if(_)for(E=20;E<26;E++)if(X.U8(4+E)){_=!1
break}_&&(tracker="XM Conversion")}for(E=0;E<ptn;E++)if((s=m[E])&&!(s>X.Sz())){X.U16(s,_LE)
var g=X.U16(s+2,_LE)
if(s+=4,!(!g||g>1024||s+4>X.Sz())){p=s+4
for(var v=[],A=0;A<g&&p<X.Sz();){if(K=X.U8(p++)){var D=127&K
D&&D--,128&K&&(v[D]=X.U8(p++)),15&v[D]&&ch<=D&&D<127&&(ch=D+1),1&v[D]&&p++,2&v[D]&&p++,4&v[D]&&p++,8&v[D]&&(p+=2)}else A++}k<p&&(k=p),sz<k&&(sz=k)}}if(ch||(ch=1),k&&(p=k,F)){if(S=Ss[Ss.length-1],S.bps)S.bps%8?S.length=("ADPCM"==S.codec?16:0)+Math.ceil((V+1)/2*S.ch):S.length=("ADPCM"==S.codec?16:0)+S.slen*S.bps/8*S.chn
else if(4==S.bps&&1==S.chn&&"LE"==S.en&&"ADPCM"==S.codec)S.length=16+(S.slen+1)/2,p+=S.length
else if(S.slen>1&&("IT214"===S.codec||"IT215"===S.codec)){for(var M=p,T=0,I=0;M<X.Sz()&&T<S.slen;){if(X.c("'XTPM'",M)||X.c("'STPM'",M)||X.c("'228'04'mptm'",M)){I=1,p=M
break}ucsz=X.U16(M,_LE),T+=ucsz,M+=2+ucsz}if(I)p=M
else{var C=bit_buf=cend=readdef=0
function N(s){for(;C<s;)bit_buf|=Util.shlu64(X.U8(p++),C),C+=8
var e=bit_buf&Util.shlu64(1,s)-1
return bit_buf=Util.shru64(bit_buf,s),C-=s,e}if(16==S.bits){}else{}for(D=0;D<S.chn;D++){var P=S.slen,y=csz=clen=topbit=0
for(cend=p;P&&p<X.Sz();)if(csz=X.U16(p,_LE),p+=2,cend=p+csz,csz){if(cend>X.Sz()){D=3599,bad=bad.addIfNone("!short")
break}clen=Math.min(P,32768>>(S.bits>>4))
var w=defW
for(bit_buf=C=0;clen&&p<X.Sz();){if(w>defW){bad=bad.addIfNone("!badITsmp"),P=0
break}if(y=N(w),topbit=1<<w-1,w<7){if(y==topbit){(y=N(fetchA)+1)>=w&&y++,w=y
continue}}else if(w<defW){if(y>=topbit+lowerB&&y<=topbit+upperB){(y-=topbit-1+lowerB)>=w&&y++,w=y
continue}}else if(y&topbit){w=1+(255&y)
continue}clen--,P--}}else readdef=10,_log("IT @"+Hex(p)+" malformed sample?")
p>X.Sz()&&(bad=bad.addIfNone("!short"))}}}else if("FLAC"===S.codec);else if("Ogg"===S.codec);else if("AMS"===S.codec&&1==S.chn){sOption("\n!!! Please send this file to the detector dev!!! Poor fella hasn't any to test on")
var L=X.U32(p+4,_LE)
X.U8(p+8)
S.length=L+9}else if("8d16"===S.codec&&1==S.chn&&16==S.bps)sOption("\n!!! Please send this file to the detector dev!!! Poor fella hasn't any to test on")
else if("MDL"===S.codec&&1==S.chn&&S.bps<=16){L=X.U32(p)
S.length=4+L}else"DMF"===S.codec&&1==S.chn&&S.bps<=16?sOption("\n!!! Please send this file to the detector dev!!! Poor fella hasn't any to test on"):"uLaw"!==S.codec&&"aLaw"!==S.codec||16!=S.bps||(S.length=S.slen*S.chn)
sz<p&&(sz=p)}if(X.c("'XTPM'",p)){for(p+=4;p+6<X.Sz()&&(s=X.SA(p,4),it=X.U32(p),!("STPM"===s||"228"===s||2155905152&it)&&1616928864&it);){var j=X.U16(p+4,_LE)
for(p+=6,E=0;E<ins;E++)p+=j}sz<p&&(sz=p)}if(X.c("'STPM'",p)){for(p+=4;p+7<X.Sz();){if(s=X.SA(p,4),it=X.U32(p),j=X.U16(p+4,_LE),"228"===s||"228"==s){e=p
break}if(2155905152&it||!(1616928864&it)||p+6+j>X.Sz())break
switch(p+=6,s){case"...C":var R=0
switch(j){case 2:R=X.U16(p,_LE)
break
case 3:R=X.U24(p,_LE)
break
case 4:R=X.U32(p,_LE)
break
default:R=X.U8(p)}R>ch&&(ch=R)
break
case".VWC":y=0
switch(j){case 1:y=X.U8(p)
break
case 2:y=X.U16(p,_LE)
break
case 3:y=X.U24(p,_LE)
break
case 8:y=X.U64(p,_LE)
break
default:y=X.U32(p,_LE)}y&&(mVcw=n(y.toString(16).toUpperCase().padStart(7,"0")))
break
case"VWSL":y=0
switch(j){case 1:y=X.U8(p)
break
case 2:y=X.U16(p,_LE)
break
case 3:y=X.U24(p,_LE)
break
case 8:y=X.U64(p,_LE)
break
default:y=X.U32(p,_LE)}y&&(mVlsw=n(y.toString(16).toUpperCase().padStart(7,"0")))
break
case"AUTH":auth=X.SC(p,j,"UTF8")}p+=j}sz<p&&(sz=p)}if(tunings=0,X.c("'HSCT'",p)){var W=!1
y=X.I32(p+4,_LE)
p+=8,1==y?(sOption("Please send this file to the detection author!!! This is ultra-rare, how did you make it?!"),p+=X.U32(p),p+=4+Math.min(256,l)):2==y?p+=1+X.U8(p):(W=!0,bad=bad.addIfNone("!badtuningver")),W||(tunings=X.U32(p+2),p+=6,(s=X.fSig(p,4096,"'FSCT'"))>=p&&(p=s+4)),sz<p&&(sz=p)}else if(X.c("'228'04'mptm'",p)){function H(s){var e=0,t=0,r=0
p
if(!(p+1<X.Sz()))return 0
if(e=X.U8(p++),16==s)t=1&e
else if(32==s)t=3&e
else{if(64!=s)return 0
t=(1<<(3&e))-1}r=16==s?e>>1:e>>2
for(var n=0;n<t;n++){if(e=0,!(p+1<X.Sz()))return 0
r|=(e=X.U8(p++))<<8*(n+1)-2}return r}if(e||(e=p),function(){if(!X.c("'228'",p))return!1
posstart=p,p+=3
var e=X.U8(p++)
h=X.SA(p,e),p+=e,flagbyte=0,hd=X.U8(p++),idbytes=3&~hd?3&hd:4,twochar=64&hd,hsz=H(32),hsz>1&&((s=X.U8(p++))||(flagbyte=X.U8(p)),p+=hsz-1),16&hd&&(s=H(64))
var t=n(s.toString(16).toUpperCase().padStart(7,"0"))
return"?"===mVlsw&&(mVlsw=t+"[mptinfo]"),32&hd&&(p+=X.U8(p++)),1&flagbyte&&(s=X.U8(p++),idbytes=1&s?65535:s>>1),fes=0,2&flagbyte&&(fes=H(32)),hasstartpos=4&hd,hassz=8&hd,hasid=idbytes,hasdesc=128&hd,hasmap=hasid||hasstartpos||hassz||hasdesc,4&flagbyte&&(s=H(16),p+=s*(twochar?2:1)),8&flagbyte&&(p+=5),entries=H(64),hasmap&&(s=H(64)),!(p>X.Sz())&&(rposMapBegin=hasmap?s:p-posstart,!0)}()&&(hasmap||fes))for(p=posstart+rposMapBegin,E=0;E<entries&&p<X.Sz();E++){var G=idbytes
65535==G&&(G=H(16)),p+=G,hasstartpos&&H(64),fes||hassz&&H(64),hasdesc&&(s=H(16),p+=s*(twochar?2:1))}sz<p+4&&(sz=p+4),X.U32(p,_LE)!=e&&(bad=bad.addIfNone("!badmptptr"))}if("?"===mVlsw&&2184===cwtv&&(mVlsw="1.17.00.00"),"?"!=mVlsw&&""===tracker)tracker="OpenMPT",isCompatX=20480==(61440&cwtv),"1.17.00.00"===mVlsw&&"OMPT"!=sreserved&&(isCompatX=!1),isCompatX?tracker+=" (compat. export)":(mVlsw>"1.17.02.54"&&mVlsw<"1.18.02.00"&&"1.18.00.00"!=mVlsw||mVlsw>"1.18.02.00"&&"00"!=mVlsw.slice(mVlsw.length-2,mVlsw.length))&&(tracker+=" (test build)")
else{8191===cwtv?nreserved:cwtv
switch(cwtv>>12){case 0:z?tracker="BeRoTracker":532!==cwtv||512!==cmwt||9!==flags||special||X.U16(62)||ins||ptn+1!==ord||128!==gvol||100!==mvol||1!==spd||128!==sep||pwd||msglen||msgofs||nreserved?532!==cwtv||512!==cmwt||X.U16(62)||nreserved?532===cwtv&&532===cmwt&&"CHBI"===sreserved?tracker="ChibiTracker":532===cwtv&&532===cmwt&&special<=1&&!pwd&&!nreserved&&4==(4262&flags)&&smp>1&&X.c("'XXXXXXXX.YYY'",c[1]+4)?tracker="CheeseTracker":cwtv||""!==tracker?cmwt<768&&""===tracker&&(cmwt>532?tracker="Impulse Tracker 2.15":isWithin(cwtv,533,535)?tracker="Impulse Tracker 2.14p"+(533==cwtv?"1-2":534==cwtv?"3":"4-5"):tracker="Impulse Tracker "+((3840&cwtv)>>8)+"."+(255&cwtv).toString(16).padStart(2)):tracker="Unknown":(mVlsw="1.00.00.A5",tracker="ModPlug Tracker 1.00a5",!0):tracker="OpenSPC conversion"
break
case 1:var Y=4095&cwtv
if(Y<=80)tracker="Schism Tracker 0."+Y.toString(16)
else{var K,J=734016+(Y<4095?Y-80:nreserved),q=J-(365*(K=Util.div64(1e4*J+14780,3652425))+Util.div64(K,4)-Util.div64(K,100)+Util.div64(K,400))
q<0&&(q=J-(365*--K+Util.div64(K,4)-Util.div64(K,100)+Util.div64(K,400)))
var Z=Util.div64(100*q+52,3060)
tracker="Schism Tracker "+(K+Util.div64(Z+2,12)).padStart(4,"0")+"-"+((Z+2)%12+1).padStart(2,"0")+"-"+(q-Util.div64(306*Z+5,10)+1).padStart(2,"0")}break
case 4:tracker="pyIT "+((3840&cwtv)>>8)+"."+(255&cwtv).toString(16)
break
case 6:tracker="BeRoTracker"
break
case 7:32767===cwtv&&533===cmwt?tracker="munch.py":tracker="ITMCK "+(cwtv>>8&15)+"."+(cwtv>>4&15)+"."+(15&cwtv)
break
case 13:56043==cwtv?tracker="spc2it":53710==cwtv?tracker="itwriter":tracker="unknown"}}}"?"!=mVlsw?(charset="CP1252","?"==mVcw?sV=mVlsw:mVcw!=mVlsw?sV="cw:"+mVcw+"/lsw:"+mVlsw:sV=mVcw):(charset="CP437","?"!=mVcw&&(sV=mVcw))
var Q=0
for(E=0;E<bad.length;E++)"!"==bad[E]&&Q++
return Q<3||void 0}()&&("it"===type?sName="Impulse Tracker module (.IT)":sName="OpenMPT module (.MPTM)",bDetected=1,"?"!=sV&&(sVersion="v."+sV),""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(sOptionT(decAnsi(4,26,charset)),X.isDeepScan()&&(sOption(tracker,"in: "),sOptionT(auth,"by: "),sOption(addEllipsis(extsmp.join(", "),64,48),'ext.smp: "','"'),sOption(addEllipsis(chnm.join(", "),80,48),'ch.names: "','"')),1&special&&sOptionT(addEllipsis(X.SC(msgofs,Math.min(msglen,256),"CP437"),192),'msg: "','"'),sOption(addEllipsis(insnlst.join(" "),128,48),'ins/msg: "','"'),sOption(addEllipsis(smpnlst.join(" "),128,48),'smp/msg: "','"'),X.isDeepScan()?sOption("bpm0:"+tmp0+" spd0:"+spd0+" ch:"+ch+" ord:"+ord+(ord!=cord?"("+cord+")":"")+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+(tunings?"tunings:"+tunings:"")+" sz:"+outSz(sz)):sOption("bpm0:"+tmp0+" spd0:"+spd0+" ch:"+ch+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp))),!bDetected&&function(){if(X.c("'RIFF'........'AM  '"))align=1
else{if(!X.c("'RIFF'........'AMFF'"))return!1
align=0}if(!X.c("C5",88))return!1
for(sz=X.U32(4,_LE)+8,p=12,ok=ord=ptn=smp=ins=0,mptn=-1,insts=[],t="";p<sz&&p<X.Sz();){switch(hkhd=decAnsi(p,4,"CP437",!1),hksz=X.U32(p+4,_LE),p+=8,hkhd){case"INIT":case"MAIN":ok=1
break
case"ORDR":for(ord=hksz,loop=X.U8(p),E=p+1;E<p+hksz;E++)mptn<X.U8(E)&&(mptn=X.U8(E))
mptn++
break
case"PATT":ptn++
break
case"RIFF":smp++
break
case"INST":for(ins++,t=X.readBytes(p+2,25,!0),t=decEncoding(t,"CP437").trim(),""!=t&&insts.push(t.trim()),insn=X.U8(p+1,_LE),subsmp=X.U16(p+30,_LE),U=p+225;U<p+hksz;)hhd=decAnsi(U,4,"CP437"),hsz=X.U32(U+4),U+=8,"SAMP"==hhd&&smp++,t_=decAnsi(U,256,"CP437"),(U+=hsz)<p+hksz&&["SAMP","INST"].indexOf(decAnsi(U,4,"CP437"))<0&&_log(" | ^WTF J2B @"+Hex(U-hsz)+"->"+Hex(U))}p+=hksz+align*(1&hksz)}return!(p>sz||!ok||!ord||!ptn||!smp&&!ins)}()&&(sName="Jazz Jackrabbit 2/Galaxy Sound System module (.J2B)",sVersion="v."+(align?"__":"FF"),bDetected=1,X.isVerbose()&&(sOptionT(X.SA(20,64)),sOptionT(addEllipsis(insts.join("\n"),256,160),'msg:"','"'),sOption("ord:"+ord+" loop:"+loop+" ptn:"+mptn+(mptn!=ptn?"/"+ptn:"")+(ins?" ins:"+ins:"")+(smp?" smp:"+smp:"")+" sz:"+outSz(sz)))),!bDetected&&function(){if(!X.c("00407F40 00C081C0")||!X.c("41FAFFEE",56))return!1
p=180
const s=Math.min(65536,X.Sz())
do{t=X.U16(p,_BE),p+=2}while(p<s&&20085!=t)
if(p>s)return!1
playp=p
do{t=X.U16(p,_BE),p+=2}while(p<s&&57340!=t)
if(p>s)return!1
p+=4,endp=p
do{t=X.U16(p,_BE),p+=2}while(p<s&&20085!=t)
if(p>s)return!1
do{t=X.U16(p,_BE),p+=2}while(p<s&&32258!=t)
if(p>s)return!1
for(songp=p+X.U16(p+2,_BE)+2,d0=X.U32(songp,_BE)>>2,x=d0/3,a1=p=songp,d5=0;d0--;)for(p=songp+X.U32(a1,_BE),a1+=4;p<s&&(t=X.U32(p,_BE),p+=4,t);)t>d5&&(d5=t)
sz=songp+d5
do{t=X.U8(sz++)}while(135!=t)
return!0}()&&(sName="Rob Hubbard ST module (.RHO)",sVersion="v1.1",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption(outSz(sz),"sz:"))),!bDetected&&function(){if(X.Sz()<9)return!1
if(ptntp=X.U16(2,_LE),ord=X.U8(8),ptntp-ord!=9&&ptntp-ord!=72)return!1
if(smptp=X.U16(4,_LE),smptp>X.Sz())return!1
if(orntp=X.U16(6,_LE),orntp>X.Sz())return!1
if(64!=X.U16(smptp,_LE)||64!=X.U16(orntp,_LE))return!1
for(ptn=0,E=0;E<ord;E++)p=X.U8(9+E),ptn<p&&(ptn=p)
if(ptn++,X.U16(ptntp,_LE)!=6*ptn)return!1
for(j=X.U16(orntp+64-2,_LE)+orntp;j<X.Sz()&&j<65535&&!(64&X.U8(j));)j+=2
if(bad="",j>65534||j>=X.Sz()){if(!X.isHeuristicScan())return!1
bad="/malformed!short"}return sz=j+2,delay=X.U8(0),loop=X.U8(1),!0}()&&(sName="ASC Sound Master module (.ASC)",sVersion="v1.x-2.x"+bad,bDetected=1,X.isVerbose()&&(pt=X.fSig(8,128,"'ASM COMPILATION OF '")+19,pt>8&&(pa=X.fSig(pt+19,32,"' BY '"),sOptionT(X.SA(pt,pa-pt)),sOptionT(X.SA(pa+4,20),"by: ")),sOption("ord:"+ord+" ptn:"+ptn+" delay:"+delay+" loop:"+loop+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<8)return!1
if(ptntp=X.U16(1,_LE),ord=X.U8(7),ptntp-ord!=8&&ptntp-ord!=71)return!1
if(smptp=X.U16(3,_LE),smptp>X.Sz())return!1
if(orntp=X.U16(5,_LE),orntp>X.Sz())return!1
if(64!=X.U16(smptp,_LE)||64!=X.U16(orntp,_LE))return!1
for(ptn=0,E=0;E<ord;E++)p=X.U8(8+E),ptn<p&&(ptn=p)
if(ptn++,X.U16(ptntp,_LE)!=6*ptn)return!1
for(j=X.U16(orntp+64-2,_LE)+orntp;j<X.Sz()&&j<65535&&!(64&X.U8(j));)j+=2
if(bad="",j>65534||j>=X.Sz()){if(!X.isHeuristicScan())return!1
bad="/malformed!short"}return sz=j+2,delay=X.U8(0),!0}()&&(bDetected=1,sVersion="v0.x"+bad,sName="ASC Sound Master module (.AS0)",X.isVerbose()&&(pt=X.fSig(7,128,"'ASM COMPILATION OF '")+19,pt>7&&(pa=X.fSig(pt+19,32,"' BY '"),sOptionT(X.SA(pt,pa-pt)),sOptionT(X.SA(pa+4,18),"by: ")),sOption("ord:"+ord+" ptn:"+ptn+" delay:"+delay+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<296)return!1
for(adr=X.U16(5),p=39,mp=0,E=0,old=X.U16(p)-adr,p+=2;E<14;E++,old=t){if(t=X.U16(p)-adr,t-old<6||(t-old-2)%4||t>X.Sz())return!1
p+=2}for(E=0,old=X.U16(p)-adr,p+=2;E<15;E++,old=t){if(t=X.U16(p)-adr,t-old<3||t>X.Sz()||t-old!=2+X.U8(old+1))return!1
p+=2}for(sz=t+2+X.U8(t+1),E=1,old=X.U16(p)-adr,p+=2;E<96;E++,old=t){if(t=X.U16(p)-adr,t-old<3||t>X.Sz())return!1
p+=2}return!0}()&&(sName="Global Tracker module (.GTR)",bDetected=1,sVersion="v"+(X.U8(4)>>4)+"."+(15&X.U8(4)),X.isVerbose()&&(dly=X.U8(0),ptn=X.U8(293),lp=X.U8(294),sOptionT(X.SA(7,32)),sOption(" ptn:"+ptn+" delay:"+dly+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<512)return!1
if(old=!1,bad="",!/V\.\d/.test(X.SA(26,3))){if(!X.c("'BPSM'",26))return!1
old=!0}if(ord=X.U16(30,_BE),525+16*ord>X.Sz())return!1
for(allsmpsz=smp=0,E=0;E<15;E++)if(255!=X.U8(32+32*E)){if(sn=X.readBytes(32+32*E,24),charStat(sn,CS_ALL).indexOf("xsc")<0)return!1
if(M=X.U16(56+32*E,_BE)<<1,lp=X.U16(58+32*E,_BE),lpl=X.U16(58+32*E,_BE),T=X.U16(62+32*E,_BE),lpl>M||lp-1>M||lpl-1>M)return!1
if(T>96)return!1
T>64&&(bad=bad.addIfNone("!badvol")),allsmpsz+=M,M&&smp++}for(sz=512+allsmpsz+16*ord,old||(sz+=64*X.U8(29)),ptn=0,E=0;E<16*ord;E+=4)p=X.U16(512+E,_BE),p>ptn&&(ptn=p)
return sz+=48*ptn,!0}()&&(bDetected=1,sName="Brian Postma's SoundMon module (.BP)",old?sVersion="old":sVersion="v"+X.SA(28,1),X.Sz()<sz&&(bad=bad.addIfNone("!short")),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SA(0,26)),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<192||!X.c("'SONG'",192)||!X.c("'INST'",200+X.U32(196,_BE)))return!1
if(allsmpsz=X.U32(10,_BE),allsmpsz<=2||allsmpsz>=1048560)return!1
for(smpdescs=0,smp=0,E=0;E<16;E++){if(ssz=X.U16(14+2*E,_BE),ssz&&smp++,lpst=X.U16(78+2*E,_BE),ssz<lpst)return!1
if(X.U8(46+2*E)>64)return!1
smpdescs+=ssz}if(smpdescs<=2||smpdescs>allsmpsz)return!1
if(ord=X.U8(111),!ord||ord>40)return!1
for(ptn=0,E=0;E<40;E++){if(pt=X.U8(113+2*E),pt>40)return!1
pt>ptn&&(ptn=pt)}return ptn++,k=1024*ptn,!(k+204>X.Sz())&&(sz=smpdescs+k+204,!0)}()&&(sName="FuchsTracker module (.FUCHS)",bDetected=1,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<444||!X.c("000000",240))return!1
for(allsmpsz=0,j=0,smps=[],k=0;k<15;k++){if(o=X.U32(16*k,_BE),o>8388607||1&o)return!1
if(l=X.U16(4+16*k,_BE)<<1,l>65535)return!1
if(X.U8(6+16*k,_BE))return!1
if(X.U8(7+16*k)>64)return!1
if(a=X.U32(8+16*k,_BE),a>8388607||1&a)return!1
if(n=X.U16(12+16*k,_BE),n>2&&n>l)return!1
if(1&X.U16(14+16*k,_BE))return!1
allsmpsz+=l,l&&smps.push([o,l])}if(allsmpsz<=4)return!1
for(smps.sort((function(s,e){return s[0]-e[0]})),k=0;k<smps.length-1;k++)if(smps[k][0]+smps[k][1]>smps[k+1][0])return!1
if(ord=X.U8(243),ord>100||!ord)return!1
for(ptn=0,ords=[],E=0;E<100;E++){if(p=X.U16(244+2*E,_BE),1023&p)return!1
E<ord&&(p>>=10,p>ptn&&63!=p&&(ptn=p))}if(ptn++,ptn>64)return!1
for(m=notes=0,p=444,nps=[],E=0;E<ptn;E++){for(badnotes=badled=0,j=0;j<256;j++){if(d=X.readBytes(p,4),np=(d[0]<<8)+d[1],np&&65534!=np&&(np<113||np>856?badnotes++:(nps.indexOf(np)<0&&nps.push(np),notes++)),d[2]&=15,3==d[2]&&d[3]>64&&badnotes++,4==d[2]&&d[3]>99)return!1
if(5==d[2]&&d[3]>ord+1)return!1
if(p+=4,p>65532||p>X.Sz())return!1}if(badnotes>16)return _log("GMCFault: over 16 bad notes"),!1}return!(!notes&&!X.isHeuristicScan())&&(nps.sort((function(s,e){return s-e})),sz=allsmpsz+1024*ptn+444,!0)}()&&(bDetected=1,sName="Game Music Creator module (.GMC)",X.isVerbose()&&(sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smps.length+" notes:"+notes+"("+nps.length+" diff.) sz:"+outSz(sz)),X.Sz()<sz&&(sVersion="malformed!short"))),!bDetected&&function(){if(ord=X.U8(0),ofs=unpsz=0,ord>220&&ord<255)return!1
for(255==ord?(ofs=1,ord=200):ord++,E=0;E<32;E++)if(X.U8(163+ofs+E)>22)return!1
if(tmp0=X.U8(ofs+205),!tmp0)return!1
for(p=ofs+376+ord,ptn=0,E=ofs+376;E<p;E++)t=X.U8(E),t>ptn&&(ptn=t)
if(ptnp=p+ofs,ptn1=oldp=X.U16(ptnp),ptn1>X.Sz())return!1
for(E=0;p<X.Sz()&&E<ptn;E++){if(p=X.U16(ptnp+2*E),E||(unpsz=p),p<ptnp+2*E||p>X.Sz())return!1
if(E&&p-oldp>256)return!1
oldp=p}if(ofs)p=ptn1
else if(p=ptnp+2*E,unpsz!=p||p>X.Sz())return!1
for(;p<X.Sz()&&(c=X.U8(p++),c);)c<=242?unpsz++:unpsz+=c-242
return!(p>15808)&&(sz=p,!0)}()&&(sName="MSX MoonBlaster for MoonSound module (.MBM)",bDetected=1,ofs&&(sVersion="200-pos.ver."),drumkit=X.SA(ofs+320,8).trim(),"NONE"!=drumkit&&(sVersion=sVersion.appendS("+"+drumkit+".MBK","/")),X.isVerbose()&&(sOption(X.SA(ofs+207,40)),sOption("tempo0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" unpsz:"+unpsz+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<102)return!1
if(tempo=X.U8(0),tempo<2||tempo>15)return!1
if(ptntp=X.U16(67,_LE),ptntp>=X.Sz())return!1
for(numofpos=X.U8(1),loop=X.U8(2),j=0,j1=65535,E=0;E<16;E++){if((is=X.U16(3+2*E,_LE))>X.Sz())return!1
if(j<is&&(j=is),op=X.U16(35+2*E,_LE),op>X.Sz())return!1
0!=op&&j1>op&&(j1=op)}if(j1<103||j<103||j>65534||j>X.Sz()||j+3*X.U8(j)+2!=j1)return!1
for(j=0,E=0;E<16;E++){if(op=X.U16(35+2*E,_LE),op>X.Sz())return!1
j<op&&(j=op)}if(j<103)return!1
if(len=j+64,len>65536)return!1
if(len>X.Sz()+1)return!1
for(j=99;j<=ptntp&&X.U8(j)<255;)j++
return j+1==ptntp&&(ord=j-99,!(loop>ord))}()&&(sName="ProTracker module (.PT1)",sVersion="v1.x",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(69,30)),sOption("tempo:"+tempo+" ord:"+ord+" len:"+len))),!bDetected&&function(){if(X.Sz()<132)return!1
if(tmp=X.U8(0),!isWithin(tmp,2,15))return!1
const s=X.Sz()+512*X.isHeuristicScan()
if(ord=X.U8(1),lp=X.U8(2),!ord||lp>ord||131+ord>s-2)return!1
if(smp0=X.U16(3),orn0=X.U16(67),orn0-smp0>s+2||orn0<smp0)return!1
if(ptnp=X.U16(99),!isWithin(ptnp,101,orn0))return!1
for(smp=orn=0,E=mps=0,p=3;E<32;E++,p+=2){if(t=X.U16(p),t&&(smp++,!isWithin(t,101,s-2)))return!1
t>mps&&(mps=t)}for(mp=0;E<48;E++,p+=2)if(t=X.U16(p),t>mp&&(mp=t),t&&(orn++,orn<=2&&!isWithin(t,Math.max(mps,orn0),s)))return!1
for(p=131,ptn=E=0;E<=255;E++,p++){if(p>X.Sz()-2)return!1
if(255==(o=X.U8(p)))break
o>ptn&&(ptn=o)}if(ptn++,p++,ord!=E||ptnp!=p)return!1
for(rptn=0;p<X.Sz()&&(t=X.U16(p));rptn++,p+=2)if(!isWithin(t,ptnp+6*ptn,X.Sz()))return!1
return rptn==3*ptn&&(sz=mp+2+X.U8(mp),!0)}()&&(sName="ProTracker module (.PT2)",sVersion="v2.x",bDetected=1,X.isVerbose()&&(nc=charStat(t=X.readBytes(101,30),1),nc.indexOf("allxsc")>=0?sOptionT(decEncoding(t,CPSpeccy)):sOption("<broken title>"),sOption("tmp:"+tmp+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+" orn:"+orn+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<202)return!1
p=0
var s=Math.min(65535,X.Sz()+512*X.isHeuristicScan())
if(ttn=X.U8(99),ttn>4){if(!X.isHeuristicScan())return!1
bad=bad.addIfNone("!badtuning")}if(tmp=X.U8(100),!tmp)return!1
if(ord=X.U8(101),ptnp=202+ord,ptnp!=X.U16(103)||ptnp>X.Sz()-2)return!1
if(lp=X.U8(102),lp>ord-1)return!1
orn=smp=mp=0
var e=[],r=[],n=[],i=[]
for(bad="",p=105;p<169;p+=2)X.U16(p)&&smp++
for(;p<201;p+=2)X.U16(p)&&orn++
for(ptn=E=0,p=201;E<=255&&255!=(o=X.U8(p++));E++){if(o%3)return!1
i.indexOf(o/3)<0&&i.push(o/3),o/3>ptn&&(ptn=o/3)}if(ptn++,!E||E!=ord)return ord,!1
function a(s,e){for(var t=0;t<s.length;t++)if(s[t][0]==e[0])return!0
return!1}for(t=X.readBytes(0,10),tracker="",charStat(t,1).indexOf("allasc")>=0?(t=decEncoding(t,CPSpeccy),"ProTracker"==t?(tracker="Pro Tracker",sv="v"+X.SA(11,4).trim(),nv=X.U8(13)-48):"Vortex Tra"==t?(tracker="Vortex Tracker ][",sv="v"+X.SA(18,4).trim(),nv=7):(tracker='"'+X.SA(0,14)+'"',sv="v3.x",nv=7)):(tracker="hacked Pro Tracker",sv="v3.x",nv=7),E=notes=0;E<3*ptn&&p<s;E++,p+=2){if(!isWithin(t=X.U16(p),p,s))return Hex(t),!1
if(!(i.indexOf(Util.divu64(E,3))<0)&&(trk=[t,0],!a(n,trk))){for(var d=0,c=!1;!c&&d<256&&t<s;){for(eol=!1,z=0;!eol&&t<X.Sz();)0==(x=X.U8(t++))?eol=c=!0:1==x||8==x?z+=3:2==x?z+=5:[3,4,6,9].indexOf(x)>=0?z++:5==x?z+=2:7==x?bad=bad.addIfNone("badcmd07h"):16==x?(x=X.U8(t++),y=X.U16(105+x),e.indexOf(x)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(x))):x<32?(t+=2,x=X.U8(t++),y=X.U16(105+x),e.indexOf(x)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(x))):x<64||(x<80?(x&=15,r.indexOf(x)<0&&(r.push(x),mp<(y=X.U16(169+2*x))&&(mp=y))):x<176?(notes++,eol=!0):176==x||(177==x?d+=X.U8(t++):x<192?t+=2:192==x?eol=!0:x<208||(208==x?eol=!0:x<240?(x=(31&x)<<1,y=X.U16(105+x),e.indexOf(x)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(x))):(x&=15,r.indexOf(x)<0&&(r.push(x),mp<(y=X.U16(169+2*x))&&(mp=y)),x=X.U8(t++),y=X.U16(105+x),e.indexOf(x)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(x))))))
if(d++,t+=z,z=0,d>256){if(!X.isHeuristicScan())return!1
bad=bad.addIfNone("!badlns")}}trk[1]=t-trk[0],a(n,trk)||n.push(trk),mp<t&&(mp=t)}}if(t=findIntersections(n,!0).length){if(!X.isHeuristicScan()||t>5)return!1
bad=bad.addIfNone("!trkxsec")}if(t=findGaps(n,0).length){if(!X.isHeuristicScan()||t>5)return!1
bad=bad.addIfNone("!trkgap")}return rsmp=e.length,rorn=r.length,rptn=i.length,!(!rptn||!isWithin(rsmp,1,32))&&(sz=mp+2+X.U8(mp+1),!0)}()&&(sName="Pro Tracker module (.PT3)",sVersion=sv,bDetected=1,tsmode=nv>=7&&(32!=X.U8(98)||X.c("'Vortex Tra'",sz)||X.c("'ProTracker v'",sz)),tsmode&&(sVersion+=" TurboSound"),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())){switch(X.c("'by ",63)&&(sOptionT(decAnsi(30,32,CPSpeccy)),sOptionT(decAnsi(66,32,CPSpeccy),"by: ")),sOptionT(tracker,"in: "),ttn){case 0:sOption("tuning 0: 1625000Hz PT3.3")
break
case 1:sOption("tuning 1: Sound Tracker")
break
case 2:sOption("tuning 2: ASM/PSC 1.75MHz")
break
case 3:sOption("tuning 3: RS 1625000Hz")
break
case 4:sOption("tuning 4: Ivan Roshchin's Natural Cmaj/Am")
break
default:sOption("tuning "+ttn+"/custom")}sOption((tsmode?"1st chip info: ":"")+"tmp0:"+tmp+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+(rptn!=ptn?rptn+"/":"")+ptn+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" orn:"+(rorn!=orn?rorn+"/":"")+orn+" notes:"+notes+" sz:"+outSz(sz))}function ls(){if(X.Sz()<6)return!1
if(tempo=X.U8(0),0==tempo||tempo>32)return!1
if(postp=X.U16(1,_LE),postp<126||postp>X.Sz())return!1
if(orntp=X.U16(3,_LE),orntp<126||orntp>X.Sz())return!1
if(ptntp=X.U16(5,_LE),ptntp<126||ptntp>X.Sz())return!1
if(ord=X.U8(postp)+1,j2=ptntp-orntp,0==j2)return!1
if(fID=!1,j2>0){if(j2%33>0)return!1}else if(j2%33>0){if(j1<55||(j1-55)%33>0)return!1
fID=!0}if(j=2*X.U8(postp)+3,j2<0){if(j+j2!=0)return!1}else if(j+postp-orntp!=0){if(ptntp<82||j+postp-ptntp+55!=0)return!1
fID=!0}if(j=orntp+33,j>65535||j>X.Sz())return!1
for(;j;){if(j--,X.U8(j)>0)return!1
if(j==orntp)break}for(j=ptntp,j1=0,j2=0,ptn=0;j+6<=X.Sz()&&j+6<65536&&X.U8(j)<255;)j++,j2=X.U16(j,_LE),j1<j2&&(j1=j2),j+=2,j2=X.U16(j,_LE),j1<j2&&(j1=j2),j+=2,j2=X.U16(j,_LE),j1<j2&&(j1=j2),j+=2,ptn++
if(X.U8(j)<255)return!1
if(j1>X.Sz())return!1
if(X.U8(j1-1)<255)return!1
for(bad=0;;){if(131<=X.U8(j1)<=142&&j1++,j1++,j1>65535)return!1
if(j1>X.Sz()){if(X.isHeuristicScan()){bad=1
break}return!1}if(255==X.U8(j1)||j1==X.Sz())break}return 255==X.U8(j1)&&(len=j1+1),!fID||"SOUND TRACKER COMPILATION OF "==X.SA(ptntp-55,29)||"KSA SOFTWARE COMPILATION OF "==X.SA(ptntp-55,28)}function us(){if(X.Sz()<8)return!1
if(orntp=X.U16(5,_LE),orntp>X.Sz()-6)return!1
if(ptntp=X.U16(7,_LE),j1=ptntp-orntp,j1<=0)return!1
if(smptp=X.U16(3,_LE),j2=orntp-smptp,j2<=0)return!1
if(postp=X.U16(1,_LE),j3=smptp-postp,j3>X.Sz())return!1
if(j4=postp-9,j4<=0)return!1
if(fID=!1,j4%130){if(j4<55||(j4-55)%130)return!1
fID=!0}if(smp=X.U8(smptp),!smp||smp>16)return!1
if(j=130*smp+9,fID&&(j+=55),posptr!=j)return!1
if(ord=X.U8(j),!ord)return!1
if(j+=2*ord+1,smptp!=j&&smptp!=j+2)return!1
if(orn=X.U8(orntp),!orn||orn>16)return!1
if(j=smptp+2*smp+1+32*orn,orntp!=j)return!1
if(j+=2*orn+1,X.U16(ptntp,_LE)!=j)return!1
if(base=X.U16(smptp+1,_LE)-9,fID&&(base-=55),base<0)return!1
if(j=X.U16(X.U8(orntp+1),_LE)-base,j!=smptp+2*j5+1)return!1
for(E=j;E<j+32;E++)if(X.U8(E))return!1
for(j8=-1,j=postp+2,E=0;E<ord;E++){if(b=X.U8(j),b%6)return!1
j8<b&&(j8=b),j+=2}return len=ptntp+j8+6,!(len-1<X.Sz())&&(!(base+j>65536)&&(!(fID&&!X.c("''KSA SOFTWARE COMPILATION OF ''",9))&&(delay=X.U8(0),!0)))}if(!bDetected&&function(){if(X.Sz()<3585)return!1
for(p=smp=0;smp<15;smp++){for(E=0;E<32;E++)if(X.U8(p++)>15)return!1
for(E=0;E<32;E++)if(32&X.U8(p++))return!1
for(E=0;E<32;E++)if(p++,X.U8(p++)>31)return!1
for(E=0;E<2;E++)if(X.U8(p++)>31)return!1}for(E=0;E<256;E++){if(!isWithin(X.U8(p),1,32))return!1
p+=2}return!(128&X.U8(p++))&&(p+=544,dly=X.U8(p++),!!isWithin(dly,1,15)&&(pts=X.U8(p),!!isWithin(pts,1,64)))}()&&(sName="Stanislav 'KSA' Kuzin's Sound Tracker Pro module (.STF,.F)",sVersion="uncompiled/packed",bDetected=1,X.isVerbose()&&sOption("dly:"+dly+" pts:"+pts)),!bDetected&&function(){if(tmp=X.U8(0),!isWithin(tmp,1,50))return!1
const s=X.Sz()-2
var e=X.U16(1,_LE)
if(ord=X.U8(e),lp=X.U8(e+1),!isWithin(e,10,s)||lp>ord)return!1
var p=X.U16(3,_LE)
if(!isWithin(p,e+2+2*ord,s))return!1
var r=X.U16(5,_LE)
if(!isWithin(r,10,s))return!1
var n=X.U16(7,_LE)
if(!isWithin(n,10,s))return!1
if(sz=n+30,sz>X.Sz())return!1
var i=[],a=[]
for(E=0;E<ord;E++){if(X.U8(e+2+2*E)%6||!isWithin(t=X.U16(p+2*E,_LE),10,s))return!1
i.indexOf(t)<0&&i.push(t)}for(E=0;E<15;E++){if(!isWithin(t=X.U16(n+2*E),10,s))return!1
a.indexOf(t)<0&&a.push(t)}return ptn=i.length,smp=a.length,!0}()&&(sName="Stanislav 'KSA' Kuzin's Sound Tracker Pro module (.STP)",sVersion="compiled",bDetected=1,X.isVerbose()&&(X.c("'KSA SOFTWARE COMPILATION OF '",10)&&sOptionT(X.SC(38,25,"CP1251")),sOption("tmp:"+tmp+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<17)return!1
if(sz=X.U16(0),X.Sz()<sz)return!1
if(smptp=X.U16(2),smptp<10)return!1
if(orntp=X.U16(4),ptntp=X.U16(6),postp=X.U16(8),lpp=X.U16(10),orntp<=smptp+1)return!1
if(ptntp<orntp)return!1
if(postp<=ptntp)return!1
if(lpp<postp)return!1
if(membase=smptp-10,lpp-membase>=sz)return!1
if(E=postp-membase,b=X.U8(E),!b)return!1
for(ord=0,ptn=0;b;){if(E+7>=sz)return!1
ord++,ptn<(t=127&b)&&(ptn=t),E+=2,b=X.U8(E),ptn<(t=127&b)&&(ptn=t),E+=2,b=X.U8(E),ptn<(t=127&b)&&(ptn=t),E+=3,b=X.U8(E)}if(ptn++,p=X.U16(smptp-membase+2),p-ptntp!=2*ptn)return!1
if(p=12,len=E+7,len!=sz)return!1
for(t=X.U16(12),E=1;E<=orntp-smptp>>1;E++){if(p+=2,j3=X.U16(p),j3-t!=98&&(1337!=sz||10!=ord||11!=ptn))return!1
t=j3}for(E=1;E<=ptntp-orntp>>1;E++){if(p+=2,j3=X.U16(p),j3-t!=34)return!1
t=j3}return!0}()&&(sName="Scalex Qjeta Tracker module (.SQT)",sVersion="compiled",bDetected=1,sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(sz))),!bDetected&&X.isDeepScan()&&ls()&&(sName="Sound Tracker module (.STC,.ZXS)",sVersion="v1.x",bDetected=1,bad&&(sVersion+="/malformed"+bad),sz=X.U16(25,_LE),i_d=X.SA(7,18),["SONG BY ST COMPILE","SONG BY MB COMPILE","SONG BY ST-COMPILE","SOUND TRACKER v1.1","S.T.FULL EDITION  ","SOUND TRACKER v1.3"].indexOf(i_d)>=0?msg="":msg=i_d,sz!=X.Sz()&&(sz=len,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn),32<=(255&sz)<=127&&(msg+=String.fromCharCode(255&sz),32<=sz>>8<=127&&(msg+=String.fromCharCode(sz>>8)))),X.isVerbose()&&(sOptionT(msg,"msg: "),sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&ls()&&(sName="Sound Tracker module (.ST3)",sVersion="v3.0",bDetected=1,bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(sOptionT(X.SA(9,55)),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" delay:"+delay+" @"+Hex(base)+" sz:"+outSz(len)))),!bDetected&&X.isDeepScan()&&function(){if(a0=X.fSig(0,65535,"41FA.... ....FFD4 43FA.... 228841FA ....D1E8 FFD843FA"),a0<0||1&a0||a0>X.Sz())return!1
if(bad="",p=X.U16(a0+2,_BE),msgp=a0+p+2,msgp<a0+16||msgp>X.Sz())return!1
if(playp=X.fSig(a0+16,a0+msgp-6,"4E7548E7FFFE"),playp<0||1&playp)return!1
if(smpd=X.U16(a0+2+p-2,_BE),ordp=X.U16(a0+2+p-6,_BE),ptnp=X.U16(a0+2+p-10,_BE),!smpd||!ordp||!ptnp)return!1
if(a0+2+p+smpd>X.Sz()||a0+2+p+ordp>X.Sz())return!1
if(smpd<=ordp&&1!=smpd)return!1
if(ptn=ordp-ptnp>>6,ord=0,smps=[],1==smpd){if(ord++,pt=a0+2+p+ordp,pt+4>X.Sz())return sz=pt,!0
for(pt+=4,t=1,sz=ordp-ptnp;t<sz;){if(t=X.U32(sz,_BE),sz+4>X.Sz()||!t)return!0
sz+=4}sz-=4,ord--}else{if(ord=smpd-ordp>>2,smpd+=a0+2+p,sdsz=X.U16(smpd+2,_BE),smp=sdsz>>5,smpd+sdsz>X.Sz()||sdsz%32)return!1
if(!sdsz)for(;;sdsz+=32){if(sdsz+36>X.Sz())return!1
if(stp=X.U32(smpd+sdsz+4,_BE),k=X.U32(smpd+sdsz+8,_BE),endp=X.U32(smpd+sdsz+12,_BE),stp>k||k>=endp)break
smp++,t=decAnsi(smpd+sdsz+16,16,CPAmiga).trim(),""!=t&&smps.push(t)}for(mendp=0,E=0;E<smp;E++)endp=X.U32(smpd+32*E+12,_BE),endp>mendp&&(mendp=endp),t=decAnsi(smpd+32*E+16,16,CPAmiga),""!=t&&smps.push()
sz=smpd+sdsz+4+mendp,sz>X.Sz()&&(bad=bad.addIfNone("!short"))}return!0}()&&(sName="SIDMon module (.SID1,.SMN,.SID)",sVersion="v1",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(t=decAnsi(msgp,256,CPAmiga).trim(),"SID-MON BY R.v.VLIET  (c) 1988"!=t&&sOptionT(t),sOptionT(addEllipsis(smps.join(","),200),"smps:"),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<90)return!1
if(!X.c("'SIDMON II - THE MIDI VERSION'",58))return!1
if(ord=X.U8(2)+1,spd0=X.U8(3),smp=X.U16(4,_BE),ofs=58+X.U32(6,_BE),songlenlen=X.U32(10,_BE),ofs+=songlenlen,90!=ofs)return!1
for(p=14,E=0;E<10;E++){if(t=X.U32(p,_BE),t>1048575||!t)return!1
switch(E){case 0:var s=[ofs,t]
break
case 1:if(t!=s[1])return!1
var e=[ofs,t]
break
case 2:if(t!=e[1])return!1
break
case 3:if(t%32)return!1
break
case 7:if(t!=smp)return!1
var r=[ofs,t]
break
case 8:trk=t>>1
break
case 9:var n=[ofs,t]}if(p+=4,ofs+=t,ofs>X.Sz())return!1}for(ofs=n[0]+n[1],1&ofs&&ofs++,smpsz=0,smps=[],p=r[0];p<r[0]+r[1];p+=64)smpsz+=X.U16(p+4,_BE)<<1,t=decAnsi(p+32,32,CPAmiga).trim(),""!=t&&smps.push(t)
return sz=ofs+smpsz,smp>>=6,!0}()&&(sName="SIDMon II module (.SID2)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(7,32)),sOptionT(X.SA(39,32),"in: "),sOptionT(addEllipsis(smps.join(","),256),'smp/msg:"','"'),sOption("trk:"+trk+" ord:"+ord+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<17)return!1
if(smp=X.U16(0,_BE),smp>31)return!1
if(ordp=X.U32(2,_BE),ordp<8*smp+2)return!1
if(ptndp=X.U32(6,_BE),ptndp-ordp>128||255!=X.U8(ptndp-1))return!1
if(smpdp=X.U32(10,_BE),smpdp>65535)return!1
if(ptndp<=ordp+1||smpdp<=ordp)return!1
if(ordp>X.Sz()||ptndp>X.Sz())return!1
for(allsmpsz=0,j=0;j<smp;j++){if(ssz=X.U16(8*j+14,_BE)<<1,ssz>65535)return!1
if(lst=X.U16(8*j+18,_BE)<<1,lst>ssz)return!1
if(lsz=X.U16(8*j+20,_BE)<<1,lsz>ssz+2||lst+lsz>ssz+2||lst&&lsz<=2)return!1
if((lst||lsz>2)&&!ssz)return!1
if(X.U8(16+8*j)>15||X.U8(17+8*j)>64)return!1
allsmpsz+=ssz}if(allsmpsz<=2)return!1
for(E=ordp,ptn=0;E<ptndp-1;E++){if((t=X.U8(E))>128)return!1
t>=ptn&&(ptn=t+1)}return sz=allsmpsz+smpdp,!0}()&&(sName="Digital Illusions Creative Entertainment packed module (.DI)",bDetected=1,sz>X.Sz()&&!X.isVerbose()&&(sVersion="malformed!short"),X.isVerbose()&&sOption("ord:"+(ptndp-ordp-1)+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&function(){if(!X.c("'IM10'",60))return!1
if(X.U16(32)>256||X.U16(34)>256||X.U16(36)>255||!X.U8(48)||X.U8(49)<32||X.U8(50)>64||X.I8(51)<4)return!1
var s,e,t,r,n,i
for(ord=X.U16(32),ptn=X.U16(34),ins=X.U16(36),spd=X.U8(48),bpm=X.U8(49),ch=chon=0,chns=[],p=64;p<576;E++,p+=16)X.isVerbose()&&(s=X.SC(p,12,"CP437").trim()).length&&chns.push(s),X.U8(p+15)<=1&&ch++,X.U8(p+15)||chon++
if(!ch)return!1
for(notes=E=0,p=832;E<ptn&&p<X.Sz();E++){if(r=X.U16(p)-4,(e=X.U16(p+2))>256)return!1
if(p+=4,X.isDeepScan()){for(;--r>=0&&p<X.Sz();)if(0!=(n=X.U8(p++)))32&n&&([160,255].indexOf(X.U8(p++))<0&&notes++,p++,r-=2),128&n&&(p+=2,r-=2),64&n&&(p+=2,r-=2)
else if(++t>=e)return!1}else p+=r}if(p>X.Sz())return!1
for(inss=[],smps=[],smp=E=0;E<ins;E++){if(X.isVerbose()&&(s=X.SC(p,32,"CP437").trim()).length&&inss.push(s),p+=384,(i=X.U16(p-6))>255)return!1
if(!X.c("'II10'",p-4)&&X.U32(p-4))return!1
for(j=0;j<i;j++,smp++){X.isVerbose()&&(s=X.SC(p,13,"CP437").trim(),funSampleName(s)&&smps.push(s))
var a=X.U32(p+16),o=X.U32(p+20),d=X.U32(p+24)
X.U8(48)
if(a>1048576||o>1048576||d>1048576)return!1
if(X.U8(p+36)>64)return!1
if(p+=64,!X.c("'IS10'",p-4)&&!X.c("'IW10'",p-4))return!1
p+=a}}return!0}()&&(sName="Imago Orpheus module (.IMF)",bDetected=1,X.isVerbose()&&(sOptionT(X.SC(0,32,"CP437")),sOptionT(addEllipsis(inss.join(" ")),'insts/msg:"','"'),sOptionT(addEllipsis(smps.join(" ")),'smps/msg:"','"'),sOption("spd0:"+spd+" bpm0:"+bpm+" ch:"+chon+(ch==chon?"":ch)+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+(notes?" notes:"+notes:"")+" sz:"+outSz(p)))),!bDetected&&function(){if(X.Sz()<37||!isWithin(nV=X.I8(0),-1,2))return!1
if(26==X.U16(1))var s=13
else{if(24!=X.U16(1))return!1
s=12}function e(s){return s<0?"??":s<6?"FM "+(s+1):s<9?"SSG "+(s-5):9===s?"OPNA ADPCM B":10===s?"OPNA Rhythm":11===s?"Rhythm Subs":12===s?"FM insts":"??"}var r=[]
for(E=0,oldchn=X.U16(1);E<s;E++){if(p=X.U16(1+2*E),!isWithin(p,26,X.Sz()-1))return p,!1
if(r.push(Hex(p+1)+": "+e(E)),isWithin(E,1,11)&&128!=X.U8(p))return p,X.U8(p),!1
if(isWithin(E,1,10)&&p<=oldchn)return p,!1
if(!E&&198==X.U8(p))for(j=p+1;j<p+9;j+=2)if((t=X.U16(j))&&!isWithin(t,p,X.Sz()-1))return p,!1
oldchn=p}rhosz=X.U16(23)-X.U16(21)-1,rhysz=X.U16(25)-X.U16(23)-2>>1,rho=rhy=0
var n=oldrhy=0,i=16777215
if(rhosz>0)for(U=X.U16(21)+1;U<X.U16(23)+1&&(t=X.U8(U),128!=t);U++)t>=rhy&&t<128&&(rhy=t+1),rho++
if(rhysz>0&&rhosz>0)for(U=X.U16(23)+1;U<i&&U<X.U16(25)-1&&n<rhy&&(t=X.U16(U)+1,isWithin(t,U,X.Sz()))&&(n||(i=t),!(t>=65024||X.U16(25)-U<2));U+=2)n++,oldrhy=t
if(bad="",ttype="",extra=-1,sV="",rhysz>=4)if(extrap=p-3,extra_type=X.U8(extrap+2),isWithin(extra_type,64,79)||(bad=bad.addIfNone("!badxtype"+Hex(extra_type))),extra_type<66?ttype="PCP/P86":extra_type<72?ttype="PPS":-1==nV?ttype="FM Towns":ttype="PPZ",extra=X.U16(extrap,_LE)+1,isWithin(extra,1,X.Sz()))for(E=0;E<4;E++)p=X.U16(extra+2*E,_LE),(p<27||p+1>X.Sz())&&(bad=bad.addIfNone("!extrapOOB"+Hex(extra)))
else bad=bad.addIfNone("!"+Hex(extra)+" out of "+Hex(extrap-1))
return!0}()&&(bDetected=1,sName="Masahiro 'Kajapon' Kajihara's Professional Music Driver module (.M,.M2)",sVersion=nV>=0?"v"+nV+"/"+["OPN/OPNA","OPM","OPL2",,,,,,,,,,,,,,][nV]:"",sVersion=sVersion.appendS(ttype," "),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(fnames=[],extra>0&&(extra_type>=72&&(n=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),extra+=2,""!=n&&fnames.push("PPZ:"+n)),extra_type>=66&&(n=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),extra+=2,""!=n&&fnames.push("PPS:"+n)),n=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),extra+=2,""!=n&&fnames.push("PPC/P86:"+n),title=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),""==title&&(title=""),artist=X.SC(X.U16(extra+2,_LE)+1,256,"Shift_JIS"),""==artist&&(artist=""),arenji=X.SC(X.U16(extra+4,_LE)+1,256,"Shift_JIS"),""==arenji&&(arenji=""),rem=X.SC(X.U16(extra+6,_LE)+1,256,"Shift_JIS"),""==rem&&(rem=""),sOption(title),sOption(artist,"by: "),sOption(arenji,"mixed by: "),sOption(rem),sOption(fnames.join(", "),"fn: ")),t=X.U8(X.U16(21)+1),sOption("rhyord:"+rho+(rho?(t?"×"+t:"")+" rhy:"+rhy:"")))),!bDetected&&function(){if(X.Sz()<Math.max(X.U16(32),38))return!1
var s
for(ch=notes=sz=0,msg="",E=oldp=0;E<17;E++){if(s=X.U16(2*E),!isWithin(s,Math.max(24,oldp),X.Sz()))return outArray([s,oldp,X.Sz()],16),!1
if(E&&252!=X.U8(s-1))return!1
if(252!=X.U8(s)){var e=parseMUAP98(s,X.isDeepScan()?BCParseToEoF:BCParseToReasonable,E)
if(e[0]==BCInvalidFormat)return!1
notes+=e[0],msg=msg.appendS(e[3],"\n"),ch++,sz<e[4]&&(sz=e[4])}else sz<s+1&&(sz=s+1)
oldp=s}return!0}()&&(sName="Packen/ぱっくん Software MUAP98/みゅあっぷ Object chiptune (.O,.OX+TONES.DTA)",bDetected=1,X.isVerbose()&&(sOptionT(msg),sOption("ch:"+ch+(X.isDeepScan()?" notes:"+notes+" sz:"+outSz(sz):"")))),!bDetected&&X.isDeepScan()&&function(){if(!X.c("6000.... 6000.... 6000.... 6000.... 6000....  41FA.... ........ 4E7541FA"))return!1
a2=64,d4=8
do{if(9240==X.U16(a2,_BE))break
a2+=2,d4--}while(d4)
if(!d4)return!1
smp=d3=X.U8(a2-1)+1,a2=54,d4=5
do{if(16890==X.U16(a2,_BE))break
a2+=2,d4--}while(d4)
if(!d4)return!1
a2+=2,a4=a2,d4=a2+X.U16(a2,_BE)+2,53756==X.U16(a4+2,_BE)&&(d4+=64),a3=d4-2,d5=0,a2=a3
do{if(d1=X.U32(a3,_BE),d1>65536)return!1
d1+=6,d5+=d1,a3+=d1,d3--}while(d3)
if(20081!=X.U16(a3,_BE))return!1
a3=0,a0=130+a3,d0=10
do{if(16875==X.U16(a0,_BE)){a0+=2
break}a0+=2,d0--}while(d0)
if(!d0)return!1
d1=0,d2=X.U16(a0,_BE),a3+=d2
do{a3+=18,d1++}while(X.U16(a3,_BE))
d2=a2-a3
do{if(b=X.U8(a3,_BE),132==b||133==b)d0++,a3++,d2--
else if(a3++,d2--,d2<0)break}while(d2>=0)
return songsz=d4,sz=d4+d5,steps=d0,x=d1,!0}()&&(sName="Rob Hubbard's module (.RH)",sVersion="v1.4",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" steps:"+steps+" songsz:"+songsz+" sz:"+outSz(sz)))),!bDetected&&function(){if(ord=X.U16(12,_BE)+1,ord>256)return!1
if(ptn=X.U16(14,_BE),!ptn||ptn>128)return!1
if(synsmp=X.U16(16,_BE),!isWithin(synsmp,1,32))return!1
if(loop=X.U16(18,_BE),bad="",loop>=ord&&(bad=bad.addIfNone("!badloop")),charStat(X.readBytes(0,12),1).indexOf("allxsc")<0)return!1
for(p=80,E=mp=0;E<ord&&p<X.Sz();p+=14,E++)for(c=0;c<4;c++){if((pt=X.U8(p+3*c))>=128||!isWithin(X.I8(p+3*c+2),-48,48))return!1
pt>mp&&(mp=pt)}if(E<ord)return!1
if(mp++,minsz=p+8*ptn+4+16*synsmp+4,minsz>=X.Sz())return!1
for(E=0;E<ptn;E++){if(!X.c("'patt'",p))return!1
for(p+=4,row=0;row<32;p+=4){var s=X.readBytes(p,4)
if(s[0]%2||!isWithin(s[3],1,32-row))return!1
row+=s[3]}}if(!X.c("'patt'",p))return!1
for(p+=4,smp=msmpp=mssz=evc=0,plim=Math.min(X.Sz(),1048576),E=0;E<10;E++)if(smpp=X.U32(20+4*E,_BE),smpp){if(ssz=X.U16(60+2*E,_BE),1&ssz&&ssz--,ssz<<=1,smpp<minsz||smpp>1048576)return!1
smpp>msmpp&&(msmpp=smpp,mssz=ssz),smp++}function e(s){for(var e=!0;p+4<X.Sz();){var t=X.readBytes(p,4)
if(p+=4,e&&s&&192!=t[0])return!1
switch(t[0]){case 160:evc++
break
case 176:return evc++,!(3&t[1])
case 192:if(!s)return!1
evc++
break
case 208:if(s)return!1
evc++,1&t[1]&&(bad=bad.addIfNone("!oddpitch"))
break
case 224:return evc++,!0
default:return!s&&"inst"===decEncoding(t,CPAmiga)&&(p-=4,evc>0)}e=!1}return evc>0}for(E=0;E<synsmp&&p<X.Sz();E++){if(!X.c("'inst'",p))return!1
if(p+=4,!e(!0))return!1
if(!X.c("'insf'",p))return!1
if(p+=4,!e(!1))return!1}return!!X.c("'inst'",p)&&(p+=4,p>X.Sz()?(sz=-1,bad=bad.addIfNone("!short"),!0):(sz=Math.max(msmpp+mssz,p),!0))}()&&(sName="PumaTracker module (.PUMA)",sVersion="v1.1",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("/malformed"+bad,"/")),X.isVerbose()&&(sOption(decAnsi(0,12,CPAmiga).trim()),sOption("ord:"+ord+" ptn:"+mp+(mp!=ptn?"/"+ptn:"")+(smp?" wf.smp:"+smp:"")+" syn.smp:"+synsmp+(loop?" lp:"+loop:"")+" events:"+evc+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.c("0FFF0FE2")||X.c("10000FE2")){if(!X.c("0FC40FA7 0F8B0F6E",4))return!1
p=292,a0=8}else{if(!X.c("0F1C0F0E 0F000EF2 0EE40ED6"))return!1
p=452,a0=168}do{if(t=X.U32(p,_BE),!t)return!1
if(p+=2,p>X.Sz())return!1}while([17914,17401,16889].indexOf(t>>16)<0)
for(initp=p-2,a0+=284,d1=0;d1<128;d1++){if(X.c("7F7F7F7F",a0)||X.c("FFFF",a0))return!1
a0+=2}x=IntAddress=0,Twin=!1
do{if(t=X.U16(p,_BE),p+=2,p>X.Sz())return!1}while([28672,29184].indexOf(t)<0)
if(28672===t)x=1
else{for(;!x&&p<X.Sz();){if(X.c("00000000",p))return!1
X.c("21C80070",p)?(p+=2,X.c("00003B76",588)&&(Twin=!0)):X.c("43FA",p)?(t=p+2+X.I16(p+2,_BE),x=X.I16(t,_BE)-t>>3):X.c("43EA",p)?(t=X.I16(p+2,_BE),x=X.I16(t,_BE)-t>>3):p+=2}if(!x||p>=X.Sz())return!1}return!0}()&&(sName="Sean Conran module (.SCR)",sVersion="v1.2",bDetected=1,Twin&&(sVersion+="/Megatwins"),X.isVerbose()&&x>1&&sOption(x,"×")),!bDetected&&X.isDeepScan()&&function(){if(!X.c("6000....6000.... ....6000"))return!1
if(d1=X.I16(2,_BE),d1<=0||1&d1||d1>X.Sz())return!1
if(a0=a1=a3=d1+2,d1=X.I16(6,_BE),d1<=0||1&d1||d1>X.Sz())return!1
if(d1=X.I16(12,_BE),d1<=0||1&d1||d1>X.Sz())return!1
if(!X.c("3F006100",a1)||!X.c("3D7C",a1+6)||!X.c("41FA",a1+12))return!1
for(d0=127;d0;){if(X.c("D040D040 D04041FA",a0)){a0+=8,a1=a0+X.I16(a0,_BE)
break}if(a0+=2,d0--,!d0||a0>X.Sz())return!1}x=0
s:for(;;){for(d2=4;d2;){if(d0=64512&X.U16(a1,_BE),a1+=2,a1>X.Sz())return!1
if(d0){x--,x<0&&x
break s}d2--}x++}for(x++,d5=d6=0,d0=128;d0;){if(t=X.U16(a0,_BE),a0+=2,a0>X.Sz())return!1
if(16890===t)break
d0--}if(!d0)return!1
for(smpi1=a0+X.U16(a0,_BE),a0=12+X.I16(12,_BE),d0=128;d0&&(d0--,!X.c("D040D040 41FA",a0));)if(a0+=2,a0>X.Sz())return!1
for(d0?(a0+=6,d0=X.I16(a0,_BE),1&d0?a0=0:(a0+=d0,X.I16(a0,_BE)&&(a0=0))):a0=0,smpi2=a0,a0=smpi1;;){if(d0=X.U32(a0,_BE),a0+=4,a0>X.Sz())return!1
if(!d0)break
if(d0>>16){a0-=4
break}}if(a0-=8,smp1=a0-smpi1>>2,d0=smpi2,d0){for(a0=d0;;){if(d0=X.U32(a0,_BE),a0+=4,a0>X.Sz())return!1
if(!d0)break
if(d0>>16){a0+=4
break}}a0-=8,smp2=a0-smpi2>>2}else smp2=0
d3=smp1,a2=smpi1+X.I32(smpi1,_BE),d1=X.I32(a2,_BE),d2=X.U16(a2+8,_BE),E=d4=0
do{if(++E===smp1)break
if(a2=smpi1+X.I32(smpi1+(E<<2),_BE),a2<20||a2>X.Sz())return!1
if(d4=X.I32(a2,_BE),!(d1>d4)){if(d1!=d4)d4!=X.I32(a2+4,_BE)?d6=X.U16(a2+10,_BE):d6=0,d5=X.U16(a2+8,_BE)
else if(d5=X.U16(a2+8,_BE),d2>d5)continue
d1=d4,d2=d5}}while(E<smp1)
if(d2+=d6,sz=smpi1+d1+(d2<<1),smpi2){d3=smp2<<2,a2=smpi2+X.I32(smpi2,_BE),d1=X.I32(a2,_BE),d2=X.U16(a2+8,_BE),E=d6=0
do{if((E+=4)===d3)break
if(a2=smpi2+X.I32(smpi2+E,_BE),a2<20||a2>X.Sz())return!1
if(d4=X.I32(a2,_BE),!(d1>d4)){if(d1!=d4)d4!=X.I32(a2+4,_BE)?d6=X.U16(a2+10,_BE):d6=0,d5=X.U16(a2+8,_BE)
else if(d5=X.U16(a2+8,_BE),d2>d5)continue
d1=d4,d2=d5}}while(E<d3)
d2+=d6,a1=smpi1+d1+(d2<<1),sz<a1&&(sz=a1)}return!0}()&&(sName="Ben Daglish's module (.BD)",sVersion="v1.2",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp1+"+"+smp2+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(!X.c("'BANK'"))return!1
for(E=0;E<20;E++)if(X.U32(4+(E<<2),_BE)>=2097152)return!1
for(E=0;E<40;E++)if(X.U32(84+(E<<2),_BE)>=65536)return!1
for(p=84,U=4,smp=0,smpt=[],i=484,E=0;E<20;E++)t=X.U32(U,_BE),U+=4,t&&(smpt.push(X.SA(i,16).trim()),smp++,i+=16+X.U32(p,_BE)),p+=4
for(smpsz=i,bad=!1;i<X.Sz()&&(t=X.U8(i),i+=1,255!==t););if(i>X.Sz()){if(!X.isHeuristicScan())return!1
bad=!0}return 47===X.U8(i)?(sz=i+1,songsz=sz-smpsz):(sz=i,bad=!0),!0}()&&(sName="Andrew Parton's module (.BYE)",sVersion="v1.2",bDetected=1,bad&&(sVersion+="/malformed"),X.isVerbose()&&sOption("smp:"+smp+" songsz:"+songsz+" smpsz:"+smpsz+" sz:"+outSz(sz))),!bDetected&&X.isDeepScan()&&function(){for(p=0,E=0;E<4;E++){if(!X.c("6000",p))return!1
if(p+=2,d2=X.I16(p,_BE),d2<=0||1&d2)return!1
p+=2}if(X.c("6000",p)){if(p+=2,d2=X.I16(p,_BE),d2<=0||1&d2)return!1
if(p+=2,!X.c("6000",p))return!1
if(p+=2,d2=X.I16(p,_BE),d2<=0||1&d2)return!1
if(p+=d2,!X.c("48E7FFFE 6100",p))return!1
if(p+=6,p+=X.I16(p,_BE),!X.c("4DF9 00DFF000",p))return!1
sV="new"}else{if(!X.c("303C0000 662233C0",p))return!1
sV="old"}if("new"===sV){a2=special=28,a0=X.I16(2,_BE),title=X.SA(special,X.fStr(special,a0-a2,"  ")-a2).trim()
do{t=X.U16(a0,_BE),a0+=2}while(17914!=t||a0>X.Sz())
if(a2=a0,a0+=X.I16(a0,_BE),a0>X.Sz()-2){if(!X.isHeuristicScan())return!1
bad=!0}d0=X.I16(a0,_BE),x=d0>>2,a0+=d0+X.I16(a0-2,_BE)
do{if(a0>X.Sz()-2){if(!X.isHeuristicScan())return!1
bad=!0}t=X.I16(a0,_BE),a0+=2}while(1010!=t)
sz=a0,ss='title: "'+title+'" sz:'+outSz(sz)}else{special=0,a2=16,a0=2,a0+=X.U16(a0,_BE)
do{t=X.I16(a0,_BE),a0+=2}while(6512!=t||a0>X.Sz())
a1=a0-4,a1+=X.I16(a1,_BE)
do{t=X.I16(a0,_BE),a0+=2}while(16890!=t||a0>X.Sz())
a0+=X.I16(a0,_BE),x=a1-a0>>4
do{t=X.U16(a2,_BE),a2+=2}while(49916!=t||a0>X.Sz())
a2+=4,smpip=a2+X.U16(a2,_BE)
do{t=X.U16(a2,_BE),a2+=2}while(18426!=t||a0>X.Sz())
a0=a2,a2+=X.U16(a2,_BE),songsz=a2
do{t=X.U16(a0,_BE),a0+=2}while(18938!=t||a0>X.Sz())
do{t=X.U16(a0,_BE),a0+=2}while(18938!=t||a0>X.Sz())
a0+=X.U16(a0,_BE),smp=(a0-smpip)/44,d1=0,a1=smpip,a3=21747
do{d2=X.I32(a1+32,_BE),d2>=0&&d1<=d2&&(d1=d2,a3=a1),a1+=44}while(a0>a1)
d0=X.U16(a3+40,_BE),d1+=d0+d0,smpsz=d1,sz=songsz+smpsz,ss="smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz)}return!0}()&&(sName="Ashley Hogg's module (.ASH)",sVersion=sV,bDetected=1,bad&&(sVersion+="/malformed"),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption(ss))),!bDetected&&X.isDeepScan()&&function(){if(!X.c("'IBLK'"))return!1
if(d2=X.U8(4),!d2||d2>128)return!1
if(a1=22+138*d2,aseq=X.fSig(a1,260,"'ASEQ'"),aseq<0||1&aseq)return!1
p=aseq+4,sz=0,bad=!1
do{if(sz+=5,sz+p>X.Sz()){if(X.isHeuristicScan()){bad=!0
break}return!1}}while(!X.c("102F00",sz+p-3))
return sz+=p,ord=Math.floor((sz-p)/100),!0}()&&(sName="Cinemaware module (.CIN)",bDetected=1,bad&&(sVersion="malformed"),X.isVerbose()&&sOption("ord:"+ord+" sz:"+outSz(sz)+" (sans ext.samples)")),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<3e3)return!1
if(X.c("6000.... 6000")||X.c("4EF9.... ....4EF9")||X.c("4EB9.... ....4EF9")){a1=8
var s=!1
do{X.c("42280030 42280031 42280032",a1)&&(s=!0),a1+=2}while(!s&&a1<408)}if(!s)return!1
if(!X.isVerbose())return!0
for(a0=d5=0,d7=2048,org=0,smpi=0,songst=0,bad=!1,L="lp";d7;)switch(L){case"lp":if(!X.c("D04149FA",a0)){L="2"
break}d0=X.I16(a0+4,_BE),a1=a0+d0+4,Table=a1,L="lp_c"
break
case"2":if(X.c("48E7F8FC",a0)){L="2.0"
break}if(!X.c("48E7FFFE",a0)){L="3"
break}case"2.0":for(d6=a3,!d6||org?d6=20:(a1=a0-a3,d5-=a1,org=d5);d6>=0;){if(t=X.U16(a0,_BE),a0+=2,16890===t){d0=X.I16(a0,_BE),songst=a1=a0+d0
break}d6--}L="lp_c"
break
case"3":if(!X.c("E94847F0",a0)){L="4"
break}d1=X.I16(a0+4,_BE),L="lp_c"
break
case"4":if(!X.c("00BFD500",a0)){L="6"
break}if(tmrval=(X.U8(a0-1)<<8)+X.U8(a0+7),X.c("4E71",a0+20)){L="lp_c"
break}X.c("21FC",a0+28)?a3=X.U32(a0+30,_BE):X.c("C000",a0+32)?a3=X.U32(a0+32,_BE):a3=X.U32(a0+22,_BE),L="lp_c"
break
case"6":if(!X.c("42A8001C",a0)){L="7"
break}d0=X.I16(a0+6,_BE),smpi=a1=a0+d0+6,L="lp_c"
break
case"7":if(X.c("E44843FA",a0)){L="7.1"
break}if(!X.c("E448207B",a0)){L="8"
break}case"7.1":if(d6=a4,!d6){L="lp_c"
break}d0=X.I16(a0+4,_BE),a4-=X.I32(a0+d0+4,_BE),org||(d5-=a4,org=d5),L="lp_c"
break
case"8":X.c("48E700F0",a0)&&(d0=X.I16(a0+6,_BE),a4=a0+d0+6)
case"lp_c":if(a0+=2,X.c("1AC01940",a0))break
d7--,L="lp"}for(songst+=d1,a1=songst,x=0;!X.c("DFF0A0",a1+1);){if(a1>X.Sz())return bad=!0,!0
x++,a1+=16}for(a1=smpi,smp=synsmp=0;!X.U32(a1+28,_BE);)a2=X.U32(a1,_BE)-org,a24=X.U16(a2+4,_BE),2===a24||16===a24?smp++:synsmp++,a1+=32
return!0}()&&(sName="Ivo Zoer & Ron Klaren's CustomMade module (.CM)",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp+syn:"+smp+"+"+synsmp+" timer:"+tmrval))),!bDetected&&X.isDeepScan()&&function(){if(a1=0,bad="",d1=X.I16(0,_BE),4===d1)X.U32(24,_BE)||(a1+=4)
else{if(8!==d1)return!1
a1+=4}for(a1+=4,a2=a1,d2=0;d2<4;d2++){if(X.I16(a1,_BE))return!1
if(a1+=2,d1=X.I16(a1,_BE),a1+=2,d1<=0||1&d1)return!1}for(d0=0;d0<4;d0++){if(a1=d1=X.I32(a2,_BE),a2+=4,d2=X.I32(a1,_BE),X.I16(a1,_BE))return!1
if(a1+=2,d1=X.I16(a1,_BE),a1+=2,d1<=0||1&d1)return!1
if(a1=d2,t=X.I16(a1,_BE),48===t&&(a1+=2,t=X.I16(a1,_BE)),12===t&&(a1+=6,t=X.I16(a1,_BE),a1+=2,4===t))break}if(d2=X.I32(a1,_BE),1!=X.I16(d2,_BE))return!1
if(a1=a2=d2>>16,a1)return!1
if(fmt=1,X.U32(24,_BE)){for(x=0,p=X.U16(0,_BE);p<X.Sz()&&(t=X.I16(p,_BE),p+=2,!t)&&(t=X.I16(p,_BE),p+=2,t&&!(1&t));)x++
x>>=2}else fmt=0,x=X.I16(2,_BE)-8>>5
for(bad=0,sz=0,a1=d2;a1<X.Sz()&&(a2=a1,a1-=14,1==X.I16(a1,_BE)););for(t=X.I16(a2-2,_BE),8!=t&&0!=t&&(a2+=14),sz=0,smp=0;a2<X.Sz()&&(t=X.I16(a2,_BE),1==t);)smp++,a2+=2,d2=X.I32(a2,_BE),a2+=6,t=X.I32(a2,_BE),t>d2&&(d2=t),d2>sz&&(sz=d2),a2+=6
return sz>X.Sz()&&(bad=bad.addIfNone("!short")),a2>=X.Sz()?(bad=bad.addIfNone("!badsmpinfo"),!0):(sz+=254,!0)}()&&(sName='Dave "Uncle Art" Lowe New module (.DLN)',bDetected=1,sVersion="f."+fmt,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<=2500)return!1
for(a2=0,a0=8,d1=0;d1<4;d1++){if(!X.c("00010101",a0))return!1
a0+=16}a1=400+a0
do{if(a0===a1)return!1
t=X.I16(a0,_BE),a0+=2}while(18938!=t)
if(a0+=2,!X.c("45F900DF F000357C 00FF009E 41FA",a0))return!1
if(a0+=14,a0+=X.I16(a0,_BE),a0!=a2)return!1
a1=240
do{t=X.U16(a1,_BE),a1+=2}while(18938!=t&&a1<X.Sz())
a1-=2
do{t=X.U16(a1,_BE),a1+=2}while(18426!=t&&a1<X.Sz())
a2=a1+20,a1+=X.I16(a1,_BE),x=0,a1++
do{if(d1=X.U8(a1),a1++,!d1)break
x++}while(d1!=X.U8(a1)&&a1<X.Sz())
do{t=X.U16(a2,_BE),a2+=2}while(58177!=t&&a2<X.Sz())
do{t=X.U16(a2,_BE),a2+=2}while(18426!=t&&a2<X.Sz())
smptsz=a1=a2+X.I16(a2,_BE)
do{t=X.U16(a2,_BE),a2+=2}while(18426!=t&&a2<X.Sz())
a3=a2,a2+=X.I16(a2,_BE),smpp=a2,a0=a2,d4=a1-a2,a2=a1+d4,smp=0
do{t=X.I16(a1,_BE),a1+=2,t&&smp++}while(a1<a2)
do{t=X.U16(a3,_BE),a3+=2}while(18426!=t&&a3<X.Sz())
a3+=2,d6=3584&X.U16(a3,_BE),d6?d6>>=9:d6=8,ruch=d6,d1=X.I16(a0,_BE),songsz=d2=d1<<d6,t=d1,d1=d2,d2=t,d5=0
do{d0=X.I16(a0,_BE),a0+=2,d0>d2&&(d2=d0,d5=X.U16(a0+d4-2,_BE))}while(a0<smptsz)
return d2<<=d6,d5<<=1,d2+=d5,sz=d2,smpsz=sz-songsz,!0}()&&(sName="Desire player module (.DSR)",bDetected=1,sVersion="v1.0",X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz)),sz<X.Sz()&&(sVersion+="/malformed!short"))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<2048)return!1
const s=Math.min(X.Sz(),16384)
for(sz=x=ch=smp=sqwfsmp=0,E=0;E<s&&(!X.c("47FA",E)||240&~X.U8(E+2));E+=2);if(E>=s-6)return!1
for(sofs=E+2+X.I16(E+2,_BE);E<s&&!X.c("6100",E);E+=2);if(E>=s-6)return!1
for(sinit=E,ssmpsinit=E,X.c("6100",E+4)&&(ssmpsinit=E+6+X.I16(E+6,_BE)),E=ssmpsinit;E<s&&!X.c("4A2B",E);E+=2);if(E>=s-36)return!1
if(X.c("66",E+4)){if(old=!1,X.U8(E+5)||(E+=2),!X.c("41FA",E+6))return!1
if(smpdp=X.I16(E+8,_BE)+E+8,E+=10,X.c("2748....D0FC",E)){if(smpdp+=X.U16(E+6,_BE),E+=12,!X.c("D0FC",E))return!1
smpdp+=X.U16(E+2,_BE),E+=4}if(!X.c("4BFA....72",E))return!1
for(smpip=X.I16(E+2,_BE)+E+2,smp=X.U8(E+5)+1,E=sinit;E<s-4&&(!X.c("41FA",E)||X.c("4B",E+4));E+=2);if(E>=s-4)return!1
if(!X.c("1230",E+4)&&!X.c("3770",E+4))return!1
for(sstp=E+2+X.I16(E+2,_BE),E+=4;E<s-8&&(!X.c("41FA",E)||X.c("23",E+4));E+=2);if(E>=s-8)return!1
if(X.c("2070",E+4))is32bp=!0
else{if(!X.c("3070",E+4))return!1
is32bp=!1}}else{for(E=sinit;E<s&&!X.c("41EB",E);E+=2);if(E>=s-36)return!1
if(smpdp=sofs+X.I16(E+2,_BE),E+=4,114!=X.U8(E+4))return!1
for(smp=X.U8(E+5)+1;E<s-4&&!X.c("41EB....E34F",E);E+=2);if(E>=s-4)return!1
for(chvolp=sofs+X.I16(E+2,_BE),E=sinit;E<s&&!X.c("41EB....17",E);E+=2);if(E>=s-4)return!1
sstp=sofs+X.I16(E+2,_BE),is32bp=!0,old=!0}for(p=smpdp,E=0;E<smp;E++){if(ssz=X.U32(p,_BE),p+=6,p+ssz>X.Sz())return bad=bad.addIfNone("!short"),!0
p+=ssz,sz=p}for(E=0;E<s;E+=2)if(X.c("47FA",E)){if(E>=s-10)return!1
if(X.c("4A2B....67",E+4)){if(X.c("33FC",E+10)||X.c("177C",E+10)||X.c("08B9",E+10))continue
break}}for(splay=E,ch=0,E=splay;E<splay+200;E+=2)if(126==X.U8(E)){if(ch=X.U8(E+1),ch)ch++
else for(;E<splay+500;E+=2)if(X.c("BE7C",E)||X.c("BE3C",E)){ch=X.U8(E+3)
break}break}if(!ch)return!1
for(E=splay;E<splay+100;E+=2)if(X.c("207A.... 303A",E)){if(sqwfsmp=(X.I16(E+2,_BE)+E+2-smpip)/12,!X.c("31BC",E+14)&&!X.c("11BC",E+14))return!1
if(80!=(240&X.U8(E+20))||107!=X.U8(E+21))return!1
if(!X.c("0C6B",E+24))return!1
if(!X.c("31BC",E+38)&&!X.c("11BC",E+38))return!1
if(!X.c("0C6B",E+48))return!1}if(old){for(E=splay;E<s&&!X.c("7000",E);E+=2);if(16!=X.U8(E+2))return!1
var e=E}else{for(E=splay;E<s&&!X.c("5368",E);E+=2);if(E>=s-16)return!1
if(103!=X.U8(E+4))return!1
e=X.U8(E+5)+E+6
if(102!=X.U8(E+12))return!1
for(E=e;E<s&&!X.c("45FA.... 322D",E);E+=2);if(E>=s-6)return!1
if((E=X.U16(E+2,_BE)+E+2)>=s-144)return!1
if(!X.c("1000",E)&&!X.c("2000",E))return!1}for(E=e;E<s&&!X.c("6B00",E);E+=2);if(E>=s-6)return!1
var r=endlym=!1
for(E=splay;E<splay+100;E+=2)if(X.c("103A",E)){r=!0,X.c("C0FC",E+6)&&(endlym=!0)
break}for(x=0,p=sstp,minpp=4294967295,sngspd=dlyspd=0,bad="";p+8<minpp&&(r?(sngspd=X.U8(p++),dlyspd=X.U8(p++)):(sngspd=X.U16(p,_BE),p+=2,dlyspd=0),!(sngspd>255));){for(E=0;E<ch;E++)is32bp?(t=X.U32(p,_BE),p+=4):(t=X.U16(p,_BE),p+=2),minpp>sofs+t&&(minpp=sofs+t)
if(p>X.Sz()){bad=bad.addIfNone("!short")
break}x++}return!0}()&&(sName="David Whittaker's module (.DW)",old?sVersion="old":sVersion="new",bDetected=1,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("ch:"+ch+" smp:"+smp+(sqwfsmp?" sqwf.smp:"+sqwfsmp:"")+" spd:"+sngspd+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(!X.c("13FC0040 ........ 4E710439 0001")||!X.c("66F44E75 48E7FFFE",18))return!1
for(a2=0,bad="";!X.c("2379",a2)&&a2<=1e3;)a2+=2
if(a2>1e3){if(!X.isHeuristicScan())return!1
bad="!badorigin"}org=X.U32(a2-4,_BE),a2=0,d1=1
do{X.c("23D1",a2)?(smplen=X.I32(a2+8,_BE)-org,smpp=X.I32(a2-6,_BE)-org,smplp=X.I32(a2+24,_BE)-org,smpnvol=X.I32(a2-30,_BE)-org,d1-=6):X.c("C0FC0400",a2)?(ptn=X.I32(a2+6,_BE)-org,d1+=3):X.c("0C790400",a2)&&(songpos=X.I32(a2+12,_BE)-org,len=X.I32(a2+34,_BE),d1+=2),a2+=2}while(a2<1e3)
if(d1){if(!X.isHeuristicScan())return!1
bad=bad.addIfNone("!badval")}a1=smpp,songsz=X.I32(smpp,_BE)-org,d0=X.I32(a1-4,_BE)<<1,a2=smplen,d1=a1-a2,a1+=d1,d1>>=2,smp=d1,d1=X.I32(a1-4,_BE)-org,sz=d0+d1,smpsz=sz-songsz,a1=songpos,a2=a1+len,ptn=0
do{t=X.U8(a1),ptn<t&&(ptn=t),a1++}while(a1<a2)
return ptn++,d1=6*(d0-1),d0=d1,d1*=14187,dur=Math.floor(64*d1/709376),!0}()&&(sName="Fashion Tracker module (.EX)",bDetected=1,sVersion="v1.0",bad&&(sVersion+="/malformed."+bad),X.isVerbose()&&sOption("ord:"+len+" ptn:"+ptn+" smp:"+smp+" songsz:"+songsz+" sz:"+outSz(sz))),!bDetected&&function(){if(a0=a1=0,title="",format="Aegis Sonix Music Driver",X.c("'FORM'")){if(!X.c("'SMUSSHDR'",8)||!X.U8(23)||!X.c("'NAME'",24))return!1
if(d1=X.U32(28,_BE),d1>>31)return!1
if(t_=d1,d1=d1+1&4294967294,a1=32+d1,X.c("'SNX1'",a1)){if(a1+=4,d1=X.U32(a1,_BE),d1>>31)return!1
a1+=4,d1=d1+1&4294967294,a1+=d1}else format="Electronic Arts' Simple Musical Score"
insinfp=a1,realsmp=[],ins=0
do{if(!X.c("'INS1'",a1))return!1
if(a1+=4,d1=X.U32(a1,_BE),d1>>31)return!1
if(a1+=4,d1=d1+1&4294967294,d1>>24>63)return!1
if(X.U8(a1+1))return!1
realsmp.push(X.U8(a1)),a1+=d1,ins++}while(!X.c("'TRAK'",a1))
for(sz=a1,trk=0;sz<X.Sz()&&(hkhd=X.SA(sz,4),hksz=X.U32(sz+4,_BE),"TRAK"==hkhd);)trk++,sz+=8+hksz
title=X.SA(32,t_),fmt=2,ext="smus"}else if(240&X.U16(0,_BE)){if(X.Sz()<333)return!1
if(a1=48,320!=X.I32(a1,_BE))return!1
for(a1+=4,d1=3;d1;){if(d2=X.I32(a1,_BE),a1+=4,d2<=0||1&d2||d2>X.Sz())return!1
if(-1!=X.I16(d2,_BE)){if(X.I32(d2,_BE)||X.I16(d2+4,_BE))return!1
if(t=X.U8(d2+6,_BE),!isWithin(t,128,130))return!1}d1--}sz=X.fSig(d2,512,"FFFF"),sz>0&&(sz+=2),fmt=1,ext="tiny"}else{for(d3=20,d1=4;d1;){if(d2=X.I32(a0,_BE),d2<=0||1&d2)return!1
a0+=4,d3+=d2,d1--}if(d3>=X.Sz())return!1
for(a0+=4,d1=4;d1;){if(t=X.U16(a0,_BE),!(8e3&t))return!1
if(65535!=t&&t>>16>132)return!1
a0+=X.I32(a1,_BE),a1+=4,d1--}if(!X.U8(a0))return!1
sz=X.fSig(a0,512,"0000"),sz>0&&(sz+=2),fmt=0,ext="snx"}return!0}()&&(sName=format+" module (."+ext+")",sVersion="f."+fmt,bDetected=1,X.isVerbose()&&(""!=title&&sOption(title),sOption("sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(X.c("'AmBk'"))a0=p=4
else{if(!X.c("C0"))return!1
a0=p=0}if(!X.c("'Music   '",p+8))return!1
if(p+=20,p+=X.I32(p,_BE),6!=X.I16(p,_BE))return!1
if(p+=2,r=p,p+=X.I16(p+2,_BE)-2,p=X.I16(p,_BE),-2!=p&&p)return!1
title=X.SA(r+12,32),p=r+30+X.I16(r+30,_BE),ord=-1
do{ord++,d1=X.I16(p,_BE),p+=2}while(p<X.Sz()&&d1>=0)
for(a0?d3=4+(16777215&X.I32(a0+4,_BE)):d3=16777215&X.I32(a0,_BE),sz=d3+8,bad="",sz>X.Sz()&&(bad=bad.addIfNone("!short")),p=r+X.I16(r+6,_BE),ptn=0;p<X.Sz()&&(d1=X.I16(p,_BE),p+=2,!(d1<0));)d1>ptn&&(ptn=d1)
for(ptn++,X.I16(p,_BE)||(p+=2),X.I16(p,_BE)!=ptn&&(bad=bad.addIfNone("!badptn")),U=a0+32,smp=d1=X.I16(U,_BE),U+=16,d7=0;d1&&U<X.Sz();)d2=X.I16(U,_BE),d2||(d2=X.I16(U-6,_BE)),d7+=d2<<1,U+=32,d1--
return smpsz=d7,songsz=sz-d7,!0}()&&(sName=" AMOS Music Bank module (.ABK)",bDetected=1,""!=bad&&(sVersion="malformed"+bad),X.isVerbose()&&(sOption(title),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(ins=X.I16(0,_LE),ins>32)return!1
if(!X.c("'INST'",4+2*ins))return!1
if(t=8+114*ins,!X.c("'SONG'",t))return!1
for(t+=4,songsz=0,E=0;E<ins;E++)songsz+=X.U16(4+2*E,_LE)
return!!X.c("'ENDS'",t+4*songsz)&&(sz=t+4*songsz+4,!0)}()&&(sName="TuneFish module (.TF4)",sVersion="v4",bDetected=1,X.isVerbose()&&sOption("ins:"+ins+" tempo:"+X.U16(2,_LE)+" songsz:"+Hex(songsz)+" sz:"+outSz(sz))),!bDetected&&X.isDeepScan()&&function(){if(a0=0,tfmx=0,X.c("'MCMD'"))fmt=-1,tfmx=a0
else if(X.c("48E7FFFE")){if(fmt=-1,a0+=4,d1=0,!X.c("61",a0))return!1
if(d1=X.U8(a0+1),!d1||1&d1)return!1
if(a0+=d1+2,!X.c("2F006100",a0))return!1
if(a0+=4+X.I16(a0+4,_BE),!X.c("41FA",a0))return!1
if(!X.c("41FA",a0+18))return!1
if(a0+=20,a0+=X.I16(a0,_BE),!X.c("'MCMD'",a0))return!1
tfmx=a0}else{if(fmt=0,!X.c("60",a0++))return!1
if(d1=X.U8(a0++),d1){if(1&d1)return!1
if(a0+=d1,!X.c("48E7FFFE",a0))return!1
if(a0+=4,!X.c("6100",a0))return!1
if(a0+=2,a0+=X.I16(a0,_BE),!X.c("2F006100",a0))return!1
if(a0+=4,a0+=X.I16(a0,_BE),!X.c("41FA",a0))return!1
a0+=20}else{if(fmt=1,d1=X.I16(a0,_BE),d1<0||1&d1)return!1
if(!X.c("6000",a0+2))return!1
if(a0+=d1,!X.c("48E7FFFE",a0))return!1
a0+=4}if(t=X.c("41FA",a0),a0+=2,!t&&(t=X.c("41FA",a0),a0+=2,!t))return!1
if(a0+=X.I16(a0,_BE),tfmx=a0,!X.c("'TFMX'00",a0))return!1
if(a0+=4,!X.I16(a0+12,_BE))return fmt="sfx",sz=0,x=1,!0
if(d1=2+X.I16(a0,_BE)+X.I16(a0+2,_BE)<<6,d2=(1+X.I16(a0+4,_BE))*X.I16(a0+8,_BE),d3=12*(1+X.I16(a0+6,_BE)),d1+=d2+d3+6*(1+X.I16(a0+12,_BE))+32,a0+=d1+14,X.I32(a0,_BE))return!1
if(a0+=4,d2=X.I16(a0,_BE),!d2)return!1
if(d2*=2,d2!=X.I32(a0+26,_BE))return!1}return sz=a0=0,x=1,a1=a0+tfmx,fmt<0?(d0=0,d1=18):(d0=2,d1=32),d0+=X.I16(a1+4,_BE)+X.I16(a1+6,_BE),d0<<=6,d0+=d1,fmt<0?d1=0:d1=1,d1+=X.I16(a1+8,_BE),ptn=d1,d1*=X.I16(a1+12,_BE),d0+=d1,fmt<0?d1=0:d1=1,d1+=X.I16(a1+10,_BE),d1*=12,d0+=d1,a2=subp=a1+d0,d1=1,fmt<0?(d2=X.I16(a1+14,_BE),d1=d2<<3):(d2=X.I16(a1+16,_BE),d1=6*(d1+d2)),x=d2,d0+=d1,a2=smpinfop=a1+d0,fmt<0?(d1=X.I16(a1+16,_BE),d2=28):(d1=X.I16(a1+18,_BE),d2=30),smp=d1,d1*=d2,d0+=d1,smpp=a2=a1+d0,a1=smpp,fmt<0&&(a1+=2),smpsz=2*X.I16(a1-8,_BE)+X.I32(a1-12,_BE),songsz=a2-a0,sz=songsz+smpsz,!0}()&&(fmt<0?ext=".MCMD":ext=".SOG",sName="Jochen 'Mad Max' Hippel's module ("+ext+",.HIP)",sVersion="f."+fmt,bDetected=1,X.Sz()<sz&&(sVersion+="!short"),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(p=0,X.c("6000")){if(p=2,d1=X.I16(p,_BE),d1<=0||1&d1)return!1
if(p=d1+2,p=4+X.fSig(p,20,"308141FA"),p<4)return!1
if(d1=X.I16(p,_BE),d1<=0||1&d1)return!1
p+=d1}if(!X.c("'TFMX'00",p))return!1
if(d0=d1=2+X.I16(p+4,_BE)+X.I16(p+6,_BE)<<6,d0+=32,ptn=d2=X.I16(p+8,_BE)+1,d3=28*(X.I16(p+10,_BE)+1),d2*=X.I16(p+12,_BE),d0+=d2,d1+=d2+d3,X.U8(p+4+d0)?txt=X.SA(p+4+d0,24):txt="",x=X.I16(p+16,_BE),d2=x+1<<3,ins=X.I16(p+18,_BE),insip=p+d1+d2+32,X.I32(insip+18,_BE))return!1
if(d2=2*X.I16(insip+22,_BE),!d2)return!1
if(d2!=X.I32(insip+22+30-4,_BE))return!1
var s=0,e=0
for(E=0;E<ins;E++){var t=X.I32(insip+30*E+18,_BE),r=X.U16(insip+30*E+22,_BE)
t>=s&&(s=t,e=r)}return smpp=insip+30*ins,sz=smpp+s+2*e,!0}()&&(sName="Jochen 'Mad Max' Hippel's module (.HIP7,.S7G)",sVersion="7V",bDetected=1,X.c("'TFMX'")||(sVersion+="+replayer"),X.Sz()<sz&&(sVersion+="!short"),X.isVerbose()&&(""!=txt&&sOptionT(txt),x>1&&sOption(x,"×"),sOption("ptn:"+ptn+" ins:"+ins+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(!X.c("'COSO'"))return!1
if(!X.c("'TFMX'",32))return!1
if(!X.I16(48,_BE)||!X.I16(64,_BE))return!1
var s=X.I32(28,_BE)
if(s>X.Sz())return!1
a2=X.I32(4,_BE),d6=d7=0,d0=X.I16(36,_BE)
do{if(a1>X.Sz())return!1
a1=X.I16(a2,_BE),a2+=2,226===X.U8(a1)&&(128&X.U8(a1+1)?d7++:d6++),d0--}while(d0>=0)
return!(d7>=d6)&&(ptn=X.I16(40,_BE)+1,smp=X.I16(50,_BE),a0=X.I32(24,_BE)+10*smp,smpsz=X.I32(a0-10,_BE)+2*X.I16(a0-6,_BE),sz=s+smpsz,x=X.I16(48,_BE),!0)}()&&(sName="Jochen 'Mad Max' Hippel's module (.HIPC)",sVersion="packed",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){for(a0=a1=a4=d4=0,d1=128,d0=X.Sz(),bad=msg="";d1;){if(a0>X.Sz()||a1>X.Sz())return!1
if(128!=d1&&(t=X.I16(a1,_BE),a1+=2,16890===t&&(d2=X.I16(a1,_BE),d2>=0&&!(1&d2)&&(a0=a1+d2))),X.c("'MMME'",a0)){d0=2
break}if(X.c("'TFMX'",a0)){if(X.I16(a0+4,_BE)>=512)d0=0
else if(X.I16(a0+16,_BE)){d0=X.I16(a0+4,_BE),a1=a0+32,d6=d7=0
do{226===X.U8(a1)&&(128&X.U8(a1+1)?d6++:d7++),a1+=64,d0--}while(d0>=0)
d6>d7?d0=2:d0=5}else d0=0
break}if(X.c("'COSO'",a0)){if(!X.I16(a0+48))return!1
if(!X.I32(a0+24))return!1
if(X.c("'TFMX'",a0+32)){a2=a0+X.I32(a0+4,_BE),d6=d7=0,d0=X.I16(a0+36,_BE)
do{if(X.I16(a0+64,_BE)?(a1=a0+X.I16(a2,_BE),a2+=2):(a1=a0+X.I32(a2,_BE),a2+=4),a1>X.Sz())return!1
226===X.U8(a1)&&(128&X.U8(a1+1)?d7++:d6++),d0--}while(d0>=0)
d7<d6?d0=4:d0=2}else X.c("'MMME'",a0+32)?d0=2:d0=0
break}d0-=2,d1--}if(2!=d0)return!1
if(X.c("'LSMP'",a0+28)?lsmp=1:lsmp=0,d0=X.Sz()-a0,d4=a0,songsz=smpsz=0,sz=sz1=-1,X.c("'COSO'",a0)||X.c("'MMME'",a0+32)){if(sV="packed",a1=a0,d3=0,d3=6*(1+X.I16(a0+50,_BE)),d2=d3+X.I32(a0+24,_BE),d3=0,d0-=d2,d0<0&&(d0=28),d0>0)if(a1+=d2,t=X.I16(a1,_BE),128==t&&256==t){do{d3=X.I16(a1,_BE),a1+=8}while(X.I16(a1,_BE)&&a1<X.Sz())
d0-=d2,d0<0&&(d0=28)}else{for(t>>=8,p=a1+1,msg=[];t&&p<X.Sz();)msg.push(t),t=X.U8(p++)
msg=decEncoding(msg,CPAmiga,1,Chars0to1FLF)}if(songsz=d2,smpsz=d3,sz=a0+d3+d2,msg.length<3&&(msg=""),sz1=msg.length?sz+msg.length+1:sz,x=X.U16(a0+48,_BE),x>100)return!1}else{if(sV="unpacked",d6=a0,d1=2,a2=a0,d1=2+X.I16(a0+4,_BE)+X.I16(a0+6,_BE)<<6,d2=(1+X.I16(a0+8,_BE))*X.I16(a0+12,_BE),d3=12*(1+X.I16(a0+10,_BE)),d1+=d2+d3,d2=2+X.I16(a0+16,_BE),d1+=6*(d2+X.I16(a0+18,_BE))+32,d2=32,d3=d7=0,d0-=d1,d0<0)d0=28,bad=bad.addIfNone("!short")
else if(d0>0)if(a1=d1+a2,t=X.I16(a1,_BE),128===t||256===t){d7=a1
do{d3=X.I16(a1,_BE),a1+=8}while(X.I16(a1,_BE)&&a1<X.Sz())
d0-=d3,d0<0&&(d0=28)}else{for(t>>=8,p=a1+1,msg=[];t&&p<X.Sz();)msg.push(t),t=X.U8(p++)
msg=decEncoding(msg,CPAmiga,1,Chars0to1FLF)}if(d0=d1,smpsz=d3,songsz=d1,sz=a0+songsz+smpsz,sz1=""!=msg?sz+msg.length+1:sz,x=X.U16(a0+16,_BE),x>100)return!1}return!0}()&&(sName="Jochen 'Mad Max' Hippel's Atari ST module (.HST,.SOC,.SOG)",bDetected=1,sVersion=sV,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(msg,'msg:"','"'),ss="",lsmp&&(ss=ss.appendS("ext.samples"," ")),sz>0&&(ss=ss.appendS("sz:"+outSz(sz,sz1)," ")),smpsz&&(ss=("smpsz:"+Hex(smpsz)).appendS(ss," ")),x>1&&(ss=("×"+x).appendS(ss," ")),sOption(ss))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<=1338)return!1
if(1!=X.U8(0))return!1
if(X.U8(1)>37)return!1
if(t=X.I16(2,_BE),!t||t>128)return!1
if(d1=X.U16(4,_BE),d1>63)return!1
for(d=255&d1,p=6;p<134;)if(t=X.U8(p),p++,d<t)return!1
for(c=0,p=314;p<1338;p+=4){if(t=X.I16(p,_BE),t<0)return!1
if(t){if([1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,151,127,120,113].indexOf(t)<0)return!1
c++}}return!!c}()&&(sName="Editeur Musical Sequentiel module (.EMS)",bDetected=1),!bDetected&&function(){if(X.Sz()<1280||!X.c("48E7..F0 41FA.... 4CD80600"))return!1
if(X.c("78",2)&&X.c("0C0000FF",12))sversion="strange"
else if(!X.c("00",2)||!X.fSig(12,576,"700033FC 000F00DF F09641FA"))return!1
return soptions="",X.c("4A44",12)?(sversion="type 1",X.isVerbose()&&(p=X.fSig(0,128,"0C04.... 66..41FA"),p>=0&&(bs="×"+(X.U16(p+2,_BE)+3)))):X.c("4A00",12)?sversion="type 2":X.c("0C00",12)&&(sversion="type 3"),!0}()&&(sName='Darius "Mark II" Zendeh module (.DZ)',sVersion=sversion,sOptions=soptions,bDetected=1),function(){if(!X.c("41FA",4)||X.Sz()<1280)return!1
p=8,E=288
do{if(t=X.c("E742",p),p+=2,t)break
E--}while(E)
if(!E)return!1
do{if(t=X.c("41FA",p),p+=2,t)break
E--}while(E)
if(!E)return!1
a3=p,p+=X.I16(p,_BE),d5=X.I16(a3+2,_BE),E=24
do{if(t=X.c("D1FA",a3),a3+=2,t)break
E--}while(E)
if(E)a5=a3,a3+=X.I16(a3,_BE)
else{if(14192==d5)return!1
d5=0,a5=a3-28,E=16}do{if(t=X.c("41FA",a5),a5-=2,t)break
E--}while(E)
return E}()&&(_setResult("audio","Darius Zendeh's Mark II Sound System module (.MK2)","","",""),bDetected=1),!bDetected&&function(){if(!X.isHeuristicScan()&&!X.c("'BeEp'"))return!1
if(smp=X.U8(5),!smp||smp>31)return!1
if(X.U8(6+40*smp)>0)return!1
for(allsmpsz=0,k=0;k<smp;k++){if(l=X.U32(38+40*k,_BE),!l||l>X.Sz())return!1
allsmpsz+=l}return ord=X.U16(6+40*smp,_BE),!(ord>255)&&(ptns=6+40*smp+2,ptn=X.U16(ptns+6*ord,_BE),!(ptn>255)&&(ptn0=X.U32(ptns+2,_BE),ptns+=6*ord,trkdtsz=X.U32(ptns-4,_BE)-ptn0,addlns=4*X.U8(ptns-5)*8,sz=ptns+2+2*ptn+allsmpsz+trkdtsz+addlns,!0))}()&&(sName="JamCracker/Pro module (.JAM,.JC)",bDetected=1,bad="",X.isHeuristicScan()&&(sz+19==X.Sz()&&(sVersion="v1.0a (Xag)",X.isVerbose()&&sOptionT(X.SA(sz,19)),sz+=19),X.c("'BeEp'")||(bad=bad.addIfNone("!badsig"))),sz>X.Sz()&&(bad=bad.addIfNone("!short")),""!=bad&&(sVersion=appendS("malformed"+bad,"/")),X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&X.isHeuristicScan()&&function(){if(2!=X.U16(0,_LE))return!1
if(!X.c("00FF01FF02FF03FF04FF05FF06FF07FF08FF09FF0AFFFD00",54))return!1
if(seqt=X.U16(4,_LE),!seqt||seqt<30||seqt>=X.Sz())return!1
if(inst=X.U16(6,_LE),!inst||inst<=seqt||inst>=X.Sz())return!1
for(ins=X.Sz()-inst>>4,mptn=65535,ch=0,trk=[],E=0;E<11;E++)if(p=X.U16(10+2*E,_LE),trk[E]=p,p){if(ch++,p<=seqt||p>=inst)return!1
p<mptn&&(mptn=p)}for(ptn=mptn-seqt>>1,E=0;E<5;E++)if(trk[E]){if(p=X.U16(seqt+2*E,_LE),65023!=X.U16(p-1,_LE))return!1
if(p<=seqt||p>=inst)return!1}return E=X.U16(2,_LE),tmr=(1193810/(E||65535)).toFixed(2),!0}()&&(sName="Johannes Bjerregaard Adlib module (.JBM)",bDetected=1,X.isVerbose()&&sOption("tmr:"+tmr+" ch:"+ch+" ptn:"+ptn+" ins:"+ins)),!bDetected&&function(){if(X.c("'SONG'",60)&&X.Sz()>660)msmp=15
else{if(!(X.c("'SO31'",124)&&X.Sz()>1204))return!1
msmp=31}if(hdrp=4*msmp,smptp=hdrp+20,ordp=smptp+30*msmp,ord=X.U8(ordp,_BE),ord>128)return!1
if(t=X.U16(hdrp+4,_BE),t<178)return!1
for(tmp0=(1776930/t).toFixed(0),spd0=6,smp=smpsz=ic=0,smps=[],E=0;E<msmp;E++){if(ssz=X.U32(4*E,_BE),ssz>131072)return!1
for(smpsz+=ssz,ssz&&smp++,t=X.readBytes(smptp+30*E,20),c=0;c<20;c++)t[c]&&t[c]<32&&ic++
if(ic>=128)return!1
t=decEncoding(t,CPAmiga),""!=t.trim()&&smps.push(t.trim()),smth=X.U16(smptp+30*E+2,_BE)}return!0}()&&(sName=15==msmp?"SoundFX module (.SFX)":"SoundFX 2 / MultiMedia Sound module (.MMS)",15==msmp&&(sVersion="v1.0-8"),bDetected=1,X.isVerbose())){for(p+=2,ptn=0,E=ordp+2;E<ordp+2+ord;E++)t=X.U8(E),t>ptn&&(ptn=t)
ptn++,sz=ordp+130+1024*ptn+smpsz,31==msmp&&(sz+=6),lp=X.U8(ordp+1),lp>ord&&(sVersion=sVersion.appendS("malformed!badloop","/")),sOption("tmp0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+(lp?" loop:"+lp:"")+" sz:"+outSz(sz))}if(!bDetected&&function(){if(fmt="",smp=smpp=0,sz=-1,x=1,X.c("6000")){p=0,d1=3
do{if(!X.c("6000",p))return!1
if((t=X.I16(p+2,_BE))<=0||t%2)return!1
p+=4}while(d1--)
if(p=p0=6+X.I16(6,_BE),X.c("4A406B00",p)){if(!X.c("000641FA",p+4))return!1
if(p+=8,p+=X.I16(p,_BE)+4,!X.c("00017FFF",p))return!1
fmt="second",p=p0+8+X.I16(p0+8,_BE)
var s=p
for(p+=8,x=0,d2=X.I32(p+10,_BE);p<X.Sz()&&d2==X.I32(p+10,_BE);)x++,p+=26
for(p=smpp=s+X.I32(s,_BE);p<X.Sz()&&(X.c("'FORM' 00?????? '8SVXVHDR'",p)&&(smp++,p+=4+X.I32(p+4,_BE)+2),p+=2,!(p>=X.Sz())););if(p>X.Sz())return!1
if(sz=p,p=s,d1=X.U32(p,_BE),d2=X.U32(p+18,_BE),d2<=d1)p+=d1
else if(d3=d2-X.I32(p+22,_BE),sz=d2+d3+p,35944==sz&&(x-=1),sz>X.Sz())return!1}else{if(p-=4,X.c("C0FC",p))p+=2
else for(E=0;E<16&&p<X.Sz();E++,p+=2)if(X.c("02800000",p)){if(!X.c("00FFC0FC",p+4))return!1
p+=8
break}if(p>X.Sz())return!1
for(mulu=X.I16(p,_BE),p+=800,U=p+900;p<X.Sz()&&!X.c("6AE064E0",p);)if(p+=2,p===U)return!1
if(p>X.Sz())return!1
for(fmt="old",p=p0;p<X.Sz()&&(t=X.I16(p,_BE),p+=2,!(t>=0&&!(16634&~t)&&(t=X.I16(p,_BE),p+=2,t>=0))););p+=t-2
p
for(x=X.I16(p,_BE)-p,x<mulu?x=1:x=Util.divu64(x,mulu);p<X.Sz()&&(X.c("'FORM' 0000???? '8SVXVHDR'",p)&&(smpp||(smpp=p),smp++,p+=4+X.I32(p+4,_BE)+2),p+=2,!(p>=X.Sz())););if(p>X.Sz())return!1
for(sz=p,p=10+X.I16(10,_BE);p<X.Sz()&&(t=X.c("43FA",p),p+=2,!t););p,p,X.I16(p,_BE)
for(p+=2,d1=X.c("6000",12)?"7FFE":"7FFF";p<X.Sz()&&(t=X.c(d1,p),p+=2,!t););for(;p<X.Sz()&&(t=X.c("336C",p),p+=2,!t););X.I16(p+2,_BE)}}else if(X.c("0000 ???? 00017FFF")){var e=0
for(p=8;p<16;p+=2)if(t=X.I16(p,_BE),t){if(t<0||t%2||!X.c("7FFF",t-2)&&!X.c("7FFE",t-4))return!1}else e++
if(e>1)return!1
if(p=2+X.I16(2,_BE),p>X.Sz()||!X.c("'FORM' 00?????? '8SVXVHDR'",p))return!1
for(;p<X.Sz()&&(X.c("'FORM' 00?????? '8SVXVHDR'",p)&&(smp++,p+=4+X.I32(p+4,_BE)+2),p+=2,!(p>=X.Sz())););if(p>X.Sz())return!1
sz=p,fmt="harald"}else{if((p=X.U16(0,_BE))>512||p<4||p%2)return!1
for(p+=2,E=2;E<p;E+=2)if((t=X.I16(E,_BE))<=0||t%2||!X.c("7FFF",t-2))return!1
fmt="latest",x=X.U16(0,_BE),p=smptp=X.U16(x+2,_BE),d3=X.U16(x,_BE),x>>=1,x--,1!=x&&(!X.c("0000",d3-6)&&X.c("7F00",d3-4)||x--),smp0p=X.U16(p,_BE)
var r=hi=X.U24(smp0p+15,_BE)
for(smp=ssz=0;p<smp0p&&smp<128;){if(p>X.Sz())return!1
if(smp++,pp=X.U16(p,_BE),sofs=X.U24(pp+15,_BE),r>sofs&&(r=sofs),hi<=sofs&&(hi=sofs,ssz=X.I16(pp+18,_BE),X.c("'BODY'",sofs-8)||(sofs=X.U32(pp+20,_BE),sofs>hi&&(hi=sofs,ssz=2*X.U16(pp+24,_BE)))),hi>X.Sz())return!1
pp<smp0p&&(smp0p=pp),p+=2}X.c("'BODY'00'",r-8)&&(r=X.fSig("'FORM'00??????",r-150,r-20)),songsz=r,X.c("'BODY'00'",hi-8)?hi+=X.U32(hi-4,_BE):hi+=ssz<<1,sz=hi}return!0}()&&(sName="Jesper Olsen's module (.JO)",sVersion=fmt,bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){function s(s){for(;p<X.Sz()&&(t=X.c(s,p),p+=2,!t););}function e(s){for(;p>0&&(p-=2,!X.c(s,p)););}if(fmt="",p=0,X.c("48E7F0F0")){if(!X.c("424047FA FFF84A2B",4))return!1
if(fmt="old",!X.isVerbose())return!0
for(a0=p=12,s("43FA"),d7=p+X.U16(p,_BE)+1,s("228A"),p+=2,d2=p-8+X.U16(p-8,_BE),s("137B"),d6=a4=p+X.U16(p,_BE)-1,x=1;d6<X.Sz()&&(d6+=10,X.U16(d6,_BE))&&!X.U8(d6);)x++
e("48E7")
var r,n=X.U16(a4+2,_BE)
for(d0=x;d0--;)for(a4+=2,d3=4;d3--;)t=X.U16(a4,_BE),a4+=2,n>t&&(n=t)
p=n,n=r=X.U16(p,_BE),p+=2
do{t=X.U16(p,_BE),p+=2,t&&(t<n&&(n=t),t>r&&(r=t))}while(p<d7)
for(a3=n,synsmp=n-d2>>7,p=r;p<X.Sz()&&!([133,135].indexOf(X.U8(p))>=0);)p++
d0=0
do{for(;a3<X.Sz()&&!([133,135].indexOf(X.U8(a3))>=0);)a3++
a3++,d0++}while(a3<p)
if(p++,a3=d6,a3){for(d1=128,found=!1;d1--&&!found;)t=X.c("41FA",a3),a3+=2,t&&(found=!0)
if(found){for(a3+=X.U16(a3,_BE);a3<X.Sz()&&(X.c("FF",a3+4)||X.c("FF",a3+6));)a3+=18
p=a3}sz=p,steps=d0}}else{for(p=172;p<224&&(t=X.c("48E7",p),p+=2,!t););if(p>224)return!1
if(!X.c("F8FC",p)&&!X.c("F8F8",p))return!1
if(!X.c("08F90001 00BFE001 33FC0780 00DFF09A 47FA",p+2))return!1
if(p+=20,65536-p-X.U16(p,_BE))return!1
if(fmt="new",!X.isVerbose())return!0
for(p=0,s("48E7"),s("49F9"),p+=6,s("7600"),d0=X.U16(p-10,_BE),function(s){for(;p<X.Sz()&&!X.c(s,p);)p+=2}("10320000"),a4=p-2+X.U16(p-2,_BE),s("48E7"),p=a3=p-6,s("43FA"),p+=X.U16(p,_BE)-1,a4-=p,d3=Util.divu64(a4,18),x=1,d2=0;p<X.Sz()&&(p+=18,d2=X.U16(p,_BE),!X.U8(p,_BE))&&(d2--,!(d2<=0));x++);for(d3<x&&(x=d3),p=a3,e("45FA"),d0=p=p-2+X.U16(p-2,_BE),p+=4,synsmp=smp=d5=0,smpp=p;p<X.Sz();)if((t=X.U32(p,_BE))>d0){if(smp||(d5=t),t<=d5&&(d5=a4=t),smp++,p+=10,p>a4)break}else synsmp++,p+=10
for(E=smp+synsmp,sz=0,p=smpp;E--&&p<X.Sz();)t=X.U32(p,_BE)+X.U16(p+4,_BE),sz<t&&(sz=t),p+=10}return!0}()&&(sName="Jason C. Brooke's module (.JB,.JCB)",sVersion=fmt,bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption(("new"==fmt?"wf.smp:"+smp:"steps:"+steps)+" syn.smp:"+synsmp+" sz:"+outSz(sz)))),!bDetected&&function(){if(!X.c("000003F3 00000000 00000003 00000000 00000002 ???????? 40?????? 00000001 000003E9"))return!1
if(twofiles=!1,p=48,d1=X.U32(20,_BE)&~(1<<30),X.U32(36,_BE)!=d1)return!1
if(X.c("60000016",40)){if(!X.c("0000ABCD",44))return!1}else p=24
if(48==p&&!X.c("B07C0000",64)||24==p){if(!X.c("41F90000 00004E75",p+16))return!1
twofiles=!0}for(p=64,smpp=0;!smpp&&p<X.Sz();)t=X.fSig(p,TOEOF,"'FORM'"),!t%2?smpp=t:p=Math.max(t+1,p+1)
if(smpp<0)return!1
for(smp=0;p<X.Sz()&&X.c("'FORM' ???????? '8SVXVHDR'",p);)smp++,p+=4+X.U32(p+4,_BE)
return sz=p,!0}()&&(sName="Kris Hatlelid's module (.KH"+(twofiles?"+SONGPLAY":"")+")",bDetected=1,X.isVerbose()&&sOption("sz:"+outSz(sz))),!bDetected&&X.isHeuristicScan()&&function(){if(X.Sz()<1537)return!1
if(97!=X.U8(15))return!1
for(k=0;k<15;k++)if(X.U8(54+32*k)>64)return!1
for(trks=0,k=0;k<1024&&(k_=X.U8(k+512),255!=k_);k++)k_>trks&&(trks=k_)
if(1024==k)return!1
if(0==trks)return!1
if(1536+192*trks+192>X.Sz())return!1
for(k=0;k<=trks;k++)for(l=0;l<64;l++)if(X.U8(1536+192*k+3*l)>36)return!1
for(allsmpsz=0,k=0;k<15;k++)allsmpsz+=X.U16(52+32*k,_BE)
return sz=192*(trks+1)+allsmpsz+1536,!0}()&&(sName="Kefrens Sound Machine module (.KSM)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(2,13)),sOption("trk:"+trks+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)),sz>X.Sz()&&(sVersion="malformed!short"))),!bDetected&&function(){if(trk=X.U16(0,_BE),d2=X.U16(2,_BE),d3=X.U16(4,_BE),smp=X.U16(6,_BE),p=8,!trk||trk>4||!d2||!d3||!smp)return!1
for(mp=0,trks=[],d1=trk;d1;d1--){if(t=X.U32(p,_BE),p+=4,t>>16||!t)return!1
trks.push(t),mp<t&&(mp=t)}for(;d2;d2--){if(t=X.I32(p,_BE),p+=4,t<=0||t%2)return!1
mp<t&&(mp=t)}for(d2=X.I32(p,_BE);d3;d3--){if(t=X.I32(p,_BE),p+=4,t<=0||t%2)return!1
mp<t&&(mp=t)}if(p+=12*smp,p!=d2)return!1
for(d2=15;d2;d2--,p+=16)if(!X.c("3F3F3F3F 3F3F3F3F 3F3F3F3F 3F3F3F3F",p))return!1
return!0}()&&(sName="Paul Robotham's module (.DAT+.SSD)",bDetected=1,X.isVerbose()&&sOption("trk:"+trk+" smp:"+smp)),!bDetected&&X.isDeepScan()&&function(){for(E=0;E<6;E++)if(!(192<=X.U8(2*E+1)<=255))return!1
if(ptnsz=X.U8(12),135&ptnsz)return!1
for(ptn=-1,E=0;E<50;E++){if(j=X.U8(14+E),j>23)return!1
j>ptn&&(ptn=j)}if(ptn++,tempo=X.U8(64),tempo<3||tempo>30)return!1
if(loop=X.U8(65),loop>50)return!1
if(ord=X.U8(67),!ord||ord>50)return!1
if(hss=X.U8(68),hss<2||hss>56)return!1
for(bad=!1,smp=0,E=0;E<16;E++){if(smpst=X.U16(90+16*E+9,_LE),smplm=X.U16(90+16*E+12,_LE),smplp=X.U16(90+16*E+14,_LE),smpst>smplm||smpst<49152||smplm<49152)return!1
if((smplp<49152||smplp>smplm||smpst>smplp||smplm>49152&&smplm-smplp<6)&&(bad=!0,!X.isHeuristicScan()))return!1
smpst<smplm&&smp++}return!0}()&&(bDetected=1,sVersion="v1.x",bad&&(sVersion+="/malformed"),sName="Digital Music Maker module (.DMM)",X.isVerbose()&&sOption("tempo:"+tempo+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" loop:"+loop)),!bDetected&&function(){if(X.Sz()<2978)return!1
if(spd=X.U8(0),!isWithin(spd,1,15))return!1
for(ord=0,ptn=[],E=0;E<256;E++)if(255!=(o=X.U8(1698+E))){if(o>=128)return!1
E>ord&&(ord=E),ptn.indexOf(o)<0&&ptn.push(o)}if(ord++,ptn=ptn.length,nonz=!1,lp=X.U8(1),lp>ord)return!1
for(smp=opl=smpsz=0,E=0;E<32;E++){if(X.U8(2+13*E+12)||X.U32(418+16*E)||X.U8(930+13*E+12))return!1
var s=X.U32(418+16*E+4),e=X.U32(418+16*E+8),t=X.U32(418+16*E+12)
if(s>1048575)return!1
if(s&&t<1048575&&(t>s||e>t))return!1
if(_opl=!X.c("00000000 00000000 000000",1346+11*E),240&X.U8(1346+11*E))return!1
if(252&X.U8(1346+11*E+5))return!1
if(252&X.U8(1346+11*E+10))return!1
s&&(smp++,smpsz+=s),_opl&&opl++}for(bad=!1,ptnend=notes=0,E=0;E<128;E++){if(p=2978+X.U32(1954+4*E,_LE),O=X.U32(2466+4*E,_LE),bad||(bad=O<3||O>4096),p>16777215||X.Sz()<p+O)return!1
for(p+O>ptnend&&(ptnend=p+O),r=0;p<ptnend;){var n=X.U8(p++)
if(n<=12)p+=2,notes++
else if(n>=32&&n<=44)p++
else{if(64!=n){if(96==n)break
return!1}r+=X.U8(p++)}}if(r>64)return!1}return sz=ptnend+smpsz,smp+opl>0}()&&(sName="CDFM/Composer 670 module (.C67)",bDetected=1,bad&&(sVersion="malformed!badptn"),X.isVerbose()&&sOption("spd:"+spd+" ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" smp:"+smp+" fm:"+opl+" notes:"+notes+" sz:"+outSz(sz))),!bDetected&&function(){if(!X.c("6000.... 6000.... 6000"))return!1
if(a0=2+X.I16(2,_BE),X.c("48E77FFE E98841FA",a0))v=2
else{if(!X.c("48E740F0 4A006B0A",a0))return!1
v=3}return!0}()&&(sName='Sean "Odie" Connolly\'s module (.SCN)',sVersion="v"+v,bDetected=1),!bDetected&&function(){if(d1="48E7FCFE",a0=0,X.c(d1))return!X.c("45FA",220)&&(!!X.c("E9417000 41FA",4)&&(!!(X.c(d1,148)||X.c(d1,164)||X.c(d1,168))&&(fmt=0,base=8,!0)))
if(X.c("2F0841FA")){if(a0+=4,a0+=X.I16(a0,_BE)+28,!X.c("45FA",a0+220))return!1
if(a0+=4,!X.c("E9417000 41FA",a0))return!1
if(a0+=4,X.c(d1,a0+140)||X.c(d1,a0+156)||X.c(d1,a0+160))return fmt=0,base=a0,!0}else if(X.c(d1,28)){if(a0+=28,!X.c("45FA",a0+220))return!1
if(a0+=4,!X.c("E9417000 41FA",a0))return!1
if(a0+=4,X.c(d1,a0+140)||X.c(d1,a0+156)||X.c(d1,a0+160))return fmt=0,base=a0,!0}else{if(X.c("6000")){if(!X.c("6000.... 6000.... 6000.... 6000.... 6000.... 6000.... 6000",4))return!1
if(X.c("6000",32)&&!X.c("6000",36))return!1
if(a0=14,a0+=X.I16(a0,_BE),X.c(d1,a0)){if(!X.c("45FA",a0+268)&&!X.c("E942",a0+274))return!1
if(a0+=4,!X.c("E9417000 41FA",a0))return!1
if(a0+=4,X.c(d1,a0+140)||X.c(d1,a0+156)||X.c(d1,a0+160))return fmt=0,base=a0,!0}return a0=26+X.I16(26,_BE),X.c(d1+"43FA",a0)?(fmt=1,base=a0,!0):!1}do{if(X.c("2F0841FA",a0+28))break
a0+=2}while(a0<10)
if(10==a0)return!1
E=76
do{if(X.c(d1,a0))break
a0+=2,E--}while(E)
if(!E)return!1
if(!X.c("45FA",a0+268)&&!X.c("E942",a0+274))return!1
if(a0+=4,!X.c("E9417000 41FA",a0))return!1
if(a0+=4,X.c(d1,a0+140)||X.c(d1,a0+156)||X.c(d1,a0+160))return fmt=0,base=a0,!0}return!1}()&&(sName="Activision Pro module (.AVP)",sVersion="f."+fmt,bDetected=1,X.isVerbose()&&sOption(Hex(base),"base:")),!bDetected&&function(){if(fmt=0,X.c("0002")&&!(1&X.U8(3)))for(;(t=X.I16(4,_BE),!(1&t))&&!(1&X.I16(t))&&(d0=X.I16(48,_BE),!(d0>X.Sz()));){for(a1=2;a1<=46&&(t=X.U16(a1,_BE),!(!t||1&t||t>X.Sz()||d0<=t));a1+=2);if(a1<48)break
3840&~X.U16(t,_BE)?fmt=1:fmt=2
break}if(!fmt){if(X.I16(0,_BE)||X.I16(128,_BE)||!X.c("00000CBE",132)||!X.c("000308BE",3254)||!X.c("000309BE",3258))return!1
fmt=3}if(smpsz=smp=0,x=1,3==fmt){if(sz=X.U32(2234,_BE)+2,sz<2236||sz>X.Sz())return!1
for(t0=X.U32(0,_BE),E=4;E<128;E+=4){if(t1=X.U32(E,_BE),t=t1-t0,t<0)return!1
smpsz+=t,t&&smp++,t0=t1}if(smpsz+=128,7382==sz&&19290==smpsz)x=16
else{x=0,a1=1726
do{if(d0=X.U32(a1,_BE),a1+=4,65280==X.U16(d0,_BE))break
x++}while(a1<sz)}}else for(sz=X.U16(48,_BE),a0=X.U16(12,_BE)+2,a1=X.U16(28,_BE),x=a1-a0>>1,E=X.U16(2,_BE);E<sz-4;E+=4)M=X.U32(E,_BE),smpsz+=M,M&&smp++
return!0}()){switch(fmt){case 1:sName="Jason Page's module (.JP)"
break
case 2:sName="Jason Page's module (.JPN)"
break
case 3:sName="Jason Page's old module (.JP)"}sVersion="f."+fmt,bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" smp.sz:"+smpsz+" song sz:"+outSz(sz)))}if(!bDetected&&function(){if(a2=242,!X.c("0C40",a2)&&(a2-=6,!X.c("33C0",a2)))return!1
if(!X.c("48E7FFFE 61064CDF 7FFF4E75",a2-12))return!1
if(a2=X.fSig(a2,65535,"6000")+2,a2<2)return!1
if(t=X.I16(a2,_BE),!t||t<0||1&t)return!1
if(a2+=t,!X.c("2D58",a2))return!1
function s(s){for(;a2<X.Sz()&&!X.c(s,a2);)a2+=2}function e(s){for(;a2<X.Sz()&&(a2+=2,!X.c(s,a2-2)););}function p(s){return patchClear(),!1}a2=0
var r=[]
s("48E7FFFE"),r.push(a2>>16),r.push(65535&a2),s("33FC0001"),a2+=4,rel=X.U32(a2,_BE),e("41F9"),r.push(a2>>16),r.push(65535&a2),d1=X.I32(a2,_BE),e("B1FC"),d0=X.U32(a2,_BE),x=d0=d0-d1>>4,e("41F9"),r.push(a2>>16),r.push(65535&a2),e("B1FC"),r.push(a2>>16),r.push(65535&a2),e("303C"),s("48E7FFFE ........ 6100"),r.push(a2>>16),r.push(65535&a2),e("41F9"),r.push(a2>>16),r.push(65535&a2),d2=X.U32(a2,_BE),e("B1FC"),d3=X.U32(a2,_BE),d3=d4=d3-d2
var n=d3%24
if(d3=Util.divu64(d3,24),n){if(d4+=4,n=d4%24,d4=Util.divu64(d4,24),n)return p()
if(d3=d4,X.c("4654443C",2008))for(a3=1904,d4=2;d4>=0;d4--)a3-=4,wpU32be(a3+4,rpU32be(a3))}if(r.push(d3>>16),r.push(65535&d3),e("4BF9"),d5=rpU32be(a2)-rel,a2>X.Sz())return p()
if(!X.isDeepScan())return patchClear(),!0
r.push(d5>>16),r.push(65535&d5),r.push(0),a5=20178,r.push(a5>>16),r.push(65535&a5),a3=(r[0]<<16)+r[1]
s:for(;a3<X.Sz();)switch(rpU16be(a3)){case 13294:case 13308:a3+=2
case 12345:case 13248:case 13249:case 15417:case 16889:case 17017:case 19065:case 19449:case 19961:case 21369:case 45564:if(a3+=2,a3_=rpU32be(a3),a3_>>16==223)break
wpU32be(a3,a3_-rel),a3+=4
break
case 13305:a3+=2,a3_=rpU32be(a3),a3_>>16==223||wpU32be(a3,a3_-rel),a3+=4,a3_=rpU32be(a3),a3_>>16!=223&&(wpU32be(a3,a3_-rel),a3+=4)
break
default:if(a3+=2,a3>=d5)break s}if(d4=d3,a2=(r[10]<<16)+r[11],a2=rpU32be(a2),a2_=rpU32be(a2)-rel,wpU32be(a2,a2_),d2=a2_,d5=a2_+2*rpU32be(a2+4),a2+=24,a2_=rpU32be(a2),d3-=2,d3>128)return p(Hex(d3))
for(;d3>=0;)a2_-=rel,wpU32be(a2,a2_),d5<=a2_&&(d5=a2_+2*rpU32be(a2+4)),d2>a2_&&(d2=a2_),a2+=24,a2_=rpU32be(a2),d3--
if(r.push(a2>>16),r.push(65535&a2),a2=rpU32be((r[4]<<16)+r[5]),a3=(r[6]<<16)+r[7],a3_=rpU32be(a3),d3=Util.divu64(a3_-a2,24),r.push(d3),smp=d3+d4,d4=d3,a2_=rpU32be(a2),d4>128)return p(Hex(d4))
for(;d4>0;)a2_-=rel,wpU32be(a2,a2_),d5<=a2_&&(d5=a2_+2*rpU32be(a2+4)),d2>a2_&&(d2=a2_),a2+=24,a2_=rpU32be(a2),d4--
a2>(r[19]<<16)+r[20]&&(r[19]=a2>>16,r[20]=65535&a2),d0<<=2,a2=rpU32be((r[2]<<16)+r[3]),a2_=rpU32be(a2),d3=0
do{4294967295!=a2_&&d3<a2_-rel&&(d3=a2_-rel),a2+=4,a2_=rpU32be(a2),d0--}while(a2<X.Sz()&&d0>0)
for(a3=(r[8]<<16)+r[9];a3<X.Sz()&&(a3+=2,!X.c("0C40",a3-2)););if(d0=rpU16be(a3+22),r.push(d0),d5>d3){if(d5>X.Sz())return p()
a2=d2,a1=(r[19]<<16)+r[20]
do{rpU16be(a1)==d0&&(a1+=6,wpU32be(a1,rpU32be(a1)-rel)),a1+=2}while(a1!=a2&&a1<X.Sz())
a2=d5}else{if(d3>X.Sz())return p()
for(a2=d3;a2<X.Sz()&&(a2+=2,!([148,254,255,510,511].indexOf(rpU16be(a2-2))>=0)););a1=d5,a1_=rpU32be(a1)
do{d0==a1_>>16&&(a1+=6,a1_=rpU32be(a1)-rel,wpU32be(a1,a1_),d3<a1_&&(d3=a1_)),a1+=2,a1_=rpU32be(a1)}while(a2!=a1)
if(a2<=d3)for(a2=d3;a2<X.Sz()&&(a2+=2,!([148,254,255,510,511].indexOf(rpU16be(a2-2))>=0)););}return patchClear(),sz=a2,smpsz=d5-d2,songsz=a2-smpsz,!0}()&&(sName="Mike Davies module (.MD)",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),X.isDeepScan()&&sOption("smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz)))),!bDetected&&function(){if(a0=0,!X.c("0016",a0+4)&&(a0+=6,!X.c("0016",a0+4)))return!1
if(!X.c("0000 00000000 00000000 ....0020 ....0020",a0+6))return!1
if(d1=X.U32(a0+14,_BE),1&d1)return!1
if(!X.c("00000058",a0+d1))return!1
for(a2=a0+88,a3=0,X.c("0016",10)&&(a3+=6),a3+=X.U32(a3+14,_BE),a3+=X.U32(a3,_BE),a2=a3,x=smp=sz=d0=d3=0;a3<X.Sz();){if(a3=a2,a2+=4,!X.U32(a3,_BE)||X.U8(a3,_BE)){a3=sz,sz+=X.U32(a3+2,_BE)
break}if(a3+=X.I32(a3,_BE),a3>sz&&(sz=a3),a3>X.Sz())return!1
if(X.c("FF02",a3+6))x++
else{if(t=X.U32(a3+2,_BE),t>X.Sz())return!1
smp++,d3+=t,d0<t&&(d0=t)}}return!(a3>X.Sz()||sz>X.Sz())&&(smpsz=d3,!0)}()&&(sName="Silmarils module (.MOK)",bDetected=1,bad="",x>3&&(bad=bad.addIfNone("!subsongs>3")),smp>32&&(bad=bad.addIfNone("!smp>32")),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz)))),!bDetected&&function(){if(t=X.U32(0,_BE),t<112||1&t||!X.c("FFFF FFFFFFFF",t-6))return!1
for(sz=t,smp=0,p=4;p<100;p+=12){if(t=X.U32(p,_BE),1&t||t&&t<112||t>sz)return!1
t&&smp++}if(!smp)return!1
for(;p<112;p+=4)if(t=X.U32(p,_BE),t<112||1&t||t>sz)return!1
return!!X.c("FFFF FFFFFFFF",p+t-6)&&(smpsz=X.U32(100,_BE),p=116+smpsz,!0)}()&&(sName="GT Game Systems module (.DUX)",bDetected=1,X.isVerbose()&&(ord=1+Util.div64(X.U32(104,_BE)-smpsz,60),smpsz-=112,sOption("ord:"+ord+" smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz)))),!bDetected&&function(){if(!X.c("'buz2'0200"))return!1
if(gvol=X.F32(8),!isWithin(gvol,0,2))return!1
if(bpm=X.U32(12),!isWithin(bpm,10,200))return!1
if(startpos=X.U32(16),ord=X.U32(20)+1,startpos>=ord)return!1
if(looping=X.U8(24),looping>1)return!1
for(nV=X.U16(6),p=156,sz=-1,bad="",maxptn=maxtrk=64,maxtml=128,ptn=X.U32(p),trk=X.U32(p+4),p+=8,nV>=1&&(maxptn=X.I32(p),maxtrk=X.I32(p+4),maxtml=X.I32(p+8),p+=12),p+=16*maxptn+maxtrk*maxtml,trks=[],E=0;E<64;E++)t=X.SA(p,64).trim(),""!=t&&trks.push(t),p+=64
for(ptns=[],E=0;E<64;E++)t=X.SA(p,64).trim(),""!=t&&ptns.push(t),p+=64
if(ins=X.U32(p),p+=4,p>X.Sz())return!1
for(inss=[],totalops=0,E=0;E<ins;E++){t=X.SA(p,128).trim(),""!=t&&inss.push(t)
var s=X.U32(p+388)
totalops+=s,p+=9232+552*s}return sz=p,sz>X.Sz()&&(bad=bad.addIfNone("!short")),!0}()&&(sName="Buzzic module (.buz2)",bDetected=1,sVersion="v2."+nV.padStart(2,"0"),X.isVerbose()&&sOption("bpm:"+bpm+" trk:"+trk+" ptn:"+ptn+" ins:"+ins+" g.vol:"+Math.round(100*gvol)+"% ops:"+totalops+" sz:"+outSz(sz))),!bDetected&&function(){if(!X.c("000200"))return!1
if(!X.c("FF000F",X.U16(4,_BE)+1))return!1
for(sz=X.U16(16,_BE)+2,E=10,oldp=X.U16(8,_BE);E<32;E+=2)if(16!=E){if(p=X.U16(E,_BE),p<=oldp||p+1>X.Sz())return!1
if(!X.c("FF",p+1))return!1
oldp=p}return!0}()&&(sName="Infogrames (RobHubbard2) module (.DUM&.INS)",bDetected=1,X.isVerbose()&&sOption(outSz(sz),"sz:")),!bDetected&&function(){if(!X.c("6000"))return!1
if(d2=X.U16(2,_BE),d2<=0||d2%2)return!1
for(a1=2,a0=4,E=0;E<3;E++){if(!X.c("6000",a0))return!1
if(t=X.U16(a0+2,_BE),a0+=4,t<=0||t%2)return!1}if(a1+=d2,X.c("6000",a0)){for(E=0;E<3;E++){if(!X.c("6000",a0))return!1
if(t=X.U16(a0+2,_BE),a0+=4,t<=0||t%2)return!1}if(X.c("6000",a0))return!1}else{if(!X.c("6100",a1))return!1
a1+=4}return!!X.c("41F9",a1)&&(a1+=6,!!X.c("43F9",a1))}()&&(sName="M.Cannon & J.Dunn's Special FX module (.JD)",bDetected=1),!bDetected&&function(){if(X.Sz()<2300)return!1
if(!(X.c("00000000")||X.c("0101")||X.c("00000101")||X.c("6000")))return!1
for(s=140,a2=X.Sz()-4,a0=0;a0<X.Sz()&&!X.c("00090800",a0);)if(a0+=2,s==a0)return!1
if(!(X.c("01120900",a0+74)||X.c("02240A00",a0+148)||X.c("00090800",a0+222)||X.c("01120900",a0+296)||X.c("02240A00",a0+370)))return!1
for(a0=s+1860;a0<X.Sz()&&!X.c("0EF80E10",a0);)if(a0+=2,a0>=a2)return!1
sz=-1
for(var s=d7=p1=p2=0;s<X.Sz()&&(d0-=2,s+=2,!X.c("E740",s-2)););for(x=X.U16(s-12,_BE),p1=s-4+X.U16(s-4,_BE);s<X.Sz();){if(X.c("101A234A",s))s+=10
else if(X.c("4880D040",s))break
s+=2}for(p2=s-2+X.U16(s-2,_BE);s<X.Sz()&&!X.c("08C70007",s);)s+=2
if(a2=s,s>=X.Sz())return!1
for(;a2>0&&(a2-=2,!X.c("41FA",a2)););for(;s<X.Sz();){if(X.c("41F9",s)){a2=X.U16(s+2,_BE)
break}if(t=X.c("41FA",s),s+=2,t){a2=s+X.U16(s,_BE)
break}}for(;s<X.Sz()&&!X.c("08870002",s);)s+=2
for(a2=s+6,X.c("41F9",a2-2)?(a2=X.U16(a2,_BE),d7=a2):a2+=X.U16(a2,_BE);s<X.Sz()&&!X.c("08C70002",s);)s+=2
for(s+=10,a2=s,X.c("41F9",a2-2)?a2=X.U16(a2,_BE):a2+=X.U16(a2,_BE);s<X.Sz()&&(t=X.c("41FA",s),s+=2,!t););a2=s+X.U16(s,_BE)
var e=0
for(bad="";s<X.Sz();){if(X.c("0EF80E10",s)){e=1
break}if(X.c("7000101A",s))break
s+=2}if(!e){for(a2=s-2+X.U16(s-2,_BE);s<X.Sz();){if(X.c("0EF80E10",s)){e=1
break}if(t=X.c("41FA",s),s+=2,t)break}a2=s,s+=X.U16(s,_BE)}if(e||s>X.Sz()&&(bad=bad.addIfNone("!short"),e=2),e||(sz=s,d7||(e=1)),!e)for(;a2<X.Sz()&&(X.c("41FA",a2)&&(sz=s=a2+2+X.U16(a2+2,_BE)+14),X.c("110010",a2));)a2+=2
return 2!=e&&(d0=p2-p1,d0>0&&(d0>>=3),d0>0&&(x=d0)),!0}()&&(sName="Special FX ST module (.DODA)",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(x>1&&sOption(x,"×"),-1!=sz&&sOption(outSz(sz),"sz:"))),bDetected||(a0=d1=16+X.U16(2,_BE)+X.U16(6,_BE)+X.U16(10,_BE)+X.U16(14,_BE),a0>X.Sz()||a0%2||(a0+=X.U16(a0,_BE),a0%2||!X.c("005800B0",a0+4)))||(sName="Tronic Delta Packer module (.DP)",bDetected=1,sOption("in:TronicTracker(?)")),!bDetected&&function(){if(!X.U16(0))return!1
if(smp=X.U8(2),!smp)return!1
if(ord=X.U8(3),ord<2)return!1
if(d2=smpsz=X.U32(4,_BE),!d2||d2%2||d2>X.Sz()||d2>524288)return!1
if(d3=X.U32(8,_BE),d3>131072)return!1
for(a0=12,x=0,E=ord-1;E;E--){if(d4=X.I32(a0,_BE),d4<0||d4>131072||d4%2)return!1
X.U8(a0+4)||x++,a0+=6}if(!X.c("00000000 0000",a0))return!1
for(a0+=6,d3<<=2,a0+=d3,a2=a0+18*smp,i=0;a0<X.Sz()&&a0<a2;){if(d1=X.I32(a0+2,_BE),d1<=0||d1>d2)return!1
if(d0=X.U32(a0+12,_BE),d0>d2)return!1
if(X.U8(a0+16)>64||X.U8(a0+17))return!1
a0+=18}return!(a0>X.Sz()||d2!=d0+X.I32(a0-16,_BE))&&(sz=a0+smpsz,!0)}()&&(sName="Digital Sonix & Chrome module (.DSC)",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("ord:"+ord+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(!X.c("00000000 0000000 0000"))return!1
if((t=X.U16(164))===X.U16(168)&&t===X.U16(172)&&t===X.U16(176)&&(t=X.I16(160,_BE))>0&&!(t%2)&&X.c("00B400B6",t))fmt=1,p=166
else if((t=X.U16(516))===X.U16(520)&&t===X.U16(524)&&t===X.U16(528)&&(t=X.I16(512,_BE))>0&&!(t%2)&&X.c("02140216",t))fmt=-1,p=518
else{if(!((t=X.U16(514))===X.U16(518)&&t===X.U16(522)&&t===X.U16(526)&&(t=X.I16(516,_BE))>0)||t%2||!X.c("FFEC",t-2)&&!X.c("FFE8",t-2))return!1
fmt=0,p=516}for(mp=0,a3=0,E=0;E<4;E++)t=X.U16(p,_BE),mp<t&&(mp=t),p+=4
for(a3+=mp,mp=X.U16(a3-2,_BE);a3<X.Sz()&&(t=X.U16(a3,_BE),a3+=2,t!=mp););if(smpp=a3,!isWithin(smpp,1024,16384))return!1
for(1==fmt?a3=X.I16(170,_BE):0==fmt?a3=X.I16(516,_BE):a3=X.I16(522,_BE),ord=0;a3<X.Sz()&&(t=X.U16(a3,_BE),a3+=2,t!=mp);)ord++
if(!isWithin(ord,1,128))return!1
for(E=p=smp=smpsz=0;E<16;E++)p+=2,1!=fmt&&(p+=20),(t=X.U16(p,_BE))&&(smpsz+=t,smp++),p+=8,1!=fmt&&(p+=2)
return smpsz<<=1,!(!smp||!isWithin(smpsz,8192,131072))&&(sz=smpp+smpsz,!0)}()&&(sName="Paul Shields' module (.PS)",sVersion="f."+fmt,bDetected=1,X.isVerbose()&&sOption("ord:"+ord+" smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(sz))),!bDetected&&function(){if(!X.c("00000400"))return!1
if(!X.c("0000000000000000 0000000000000000 00000000 0000'Tempo'00",160))return!1
if([0,67,92].indexOf(X.U8(4))<0||[0,111,114].indexOf(X.U8(5))<0||[0,111,112].indexOf(X.U8(6))<0||[0,108,121].indexOf(X.U8(7))<0||[0,108,114].indexOf(X.U8(8))<0)return!1
if(!isWithin(X.U16(44),2,16)||!isWithin(X.U16(46),2,16))return!1
if(!X.U8(48)||X.U8(49)||!X.U8(50)||X.U16(51)||(mode=X.U8(53))>1)return!1
for(U=!0,E=54;E<76&&U;E+=2)X.U16(E)>4351&&(U=!1)
for(;E<144&&U;E+=2)X.U16(E)>511&&(U=!1)
if(!U)return!1
for(p=203+6*X.U16(201),voices=mode?9:11,mtln=mdur=notev=insev=volev=pitev=0,E=0;E<voices;E++){if(p+=15,dur=0,tln=X.U16(p),p+=2,tln)do{dur+=X.U16(p+2),p+=4,notev++}while(dur<tln||p>X.Sz())
tln>mtln&&(mtln=tln),dur>mdur&&(mdur=dur),p+=15,insev+=t=X.U16(p),p+=2+14*t+15,volev+=t=X.U16(p),p+=2+6*t+15,pitev+=t=X.U16(p),p+=2+6*t}return sz=p,!0}()&&(sName="AdLib Visual Composer module (.ROL)",bDetected=1,X.isVerbose()&&(c=X.SA(4,40),"\\roll\\default"!=c&&sOption(c),sOption("ch:"+voices+" rhythm:"+X.U16(44)+"/"+X.U16(46)+" bpm0:"+X.F32(197).toFixed(1)+" len:"+mdur+" notes:"+notev+" ins.ev:"+insev+" ins.ev:"+insev+" vol.ev:"+volev+" pitchev:"+pitev+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<428||!X.c("'GYMX'"))return!1
for(E=4;E<424;E++)if(isWithin(X.U8(E),1,10)||isWithin(X.U8(E),14,31))return!1
return unpsz=X.U32(424),!(unpsz<=2&&parseMDGYM(428)<=0)}()&&(sName="Sega Genesis/Mega Drive YM2612 chiptune (.GYM)",bDetected=1,unpsz<=2&&(sVersion=sVersion.append("unpacked")),X.isVerbose()&&(sOptionT(X.SC(4,32,"CP1252")),sOptionT(X.SC(36,32,"CP1252"),"for: "),sOptionT(X.SC(68,32,"CP1252"),"at: "),sOptionT(X.SC(100,32,"CP1252"),"emu: "),sOptionT(X.SC(132,32,"CP1252"),"by: "),sOptionT(X.SC(164,256,"CP1252")),unpsz>2&&sOptionT(X.U32(424),"unp.sz:"))),!bDetected&&function(){if(!X.c("6000.... 6000.... 6000")||(p=base=a6=X.I16(2,_BE)+2)<=0||p%2||(playp=X.I16(6,_BE)+6)<=0||playp%2)return!1
for(p1=p+30;p<p1&&!X.c("47FA",p-2);p+=2);if(p>=p1)return!1
var s=p
for(t=Math.min(X.Sz(),131072);p<t&&!X.c("4E75",p-2);p+=2);if(p>=X.Sz()||p>=t)return!1
if(fmt="old",X.c("177C0000",p-8)&&(fmt="new",p-=6),!X.c("00BFE001",p-6))return!1
if(p=base,x=1,d0=0,X.c("1740",p+6)||X.c("1740",p+4)){for(;p<X.Sz()&&!X.c("47FA",p-2);p+=2);p+=X.I16(p,_BE),a6=p}else s:do{if(X.c("3C00",p)){for(p=s,a3=a6=p+X.I16(p,_BE);p<X.Sz()&&!X.c("7600",p-2);p+=2);for(a3+=X.I16(p-4,_BE)+3,d0=7;d0&&(X.U16(a3,_BE)||1!=X.U8(a3+2));a3+=3,x++,d0--);d0=X.U8(a3-1)
break s}for(X.c("4A00",p+40)&&(x++,d0=X.I16(p+52,_BE));p<X.Sz()&&!X.c("47FA",p-2);p+=2);p+=X.I16(p,_BE),a6=p}while(0)
for(ord=d0,p=12;p<X.Sz()&&!X.c("1743",p-2);p+=2);for(a3=a6,pos=a6+X.I16(p,_BE),p=12;p<X.Sz()&&!X.c("5203",p-2);p+=2);if(sz=-1,patchable=X.c("177C",p+10),patchable){if(a2=base,a3+=X.I16(p+2,_BE),ord||(ord=X.U8(a3)),"new"==fmt){for(p=base+2;p<X.Sz()&&!X.c("41EB",p-2);p+=2);for(a3=a6,a6+=X.I16(p,_BE),a3+=X.I16(p+4,_BE),a6+=X.I32(a3,_BE),smpip=a6,songsz=a6+X.I16(a3-2,_BE),smp=smpsz=0;a6<X.Sz()&&(d3=X.I32(a6,_BE),a6+=4,d3>0&&(ssz=X.U16(a6,_BE)<<1)&&(smp++,d3+=ssz,smpsz<d3&&(smpsz=d3)),a6+=6,!(a6>=songsz)););}else{for(p=base+2;p<X.Sz()&&!X.c("3D70",p-2);p+=2);for(;p<X.Sz()&&!X.c("D5F0",p-2);p+=2);for(a3=a6+X.I16(p-4,_BE),a6+=X.I32(a3,_BE),t=a6,a6+=X.U16(p-18,_BE),smpip=a6,smp=smpsz=0,a3=a6+128,d1=32;d1;d1--)X.U16(a3,_BE)>1&&(smp++,ssz=X.U16(a3,_BE)<<1,d3=ssz+X.I32(a6,_BE),smpsz<d3&&(smpsz=d3)),a6+=4,a3+=2
songsz=t+X.U16(p-8,_BE)}sz=songsz+smpsz}return!0}()&&(sName="Sound Master module (.SM,.SMPRO,.SM3)",sVersion=fmt,bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),patchable&&sOption("ord:"+ord+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<1728)return!1
if((sz=X.U32(0,_BE))>2097152||sz%2)return!1
if((d2=X.U32(4,_BE))>sz||d2%2)return!1
if(d2-=704,1023&d2)return!1
if(ptn=d2>>=10,d2--,p=444,X.U8(p))return!1
if(ord=d1=X.I8(p+1),ord<0)return!1
for(p+=4,d2<<=10,d3=0;d1;p+=2,d1--){if(1023&(t=X.I16(p,_BE)))return!1
d3<t&&(d3=t)}if(d2!=d3)return!1
for(smp=0,p=14;p<448;p+=14)X.U16(p,_BE)&&smp++
return!0}()&&(sName="Tom Pakarinen's Tomy Tracker module (.SG)",bDetected=1,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&function(){if(!X.c("0003",32)&&(!X.c("0002",32)||X.U32(28,_BE)))return!1
if(X.U16(16,_BE))return!1
if((p=X.I16(18,_BE))<0||p%2)return!1
if(!X.c("FFFF0000 0400",p+62))return!1
if(title=X.readBytes(0,16),charStat(title,1).indexOf("allasc")<0)return!1
if(title=decEncoding(title,"CP437"),a2=0,a3=sz=64+X.U32(16,_BE),d2=X.U32(20,_BE),sz+=d2,a4=sz,d1=X.U32(24,_BE),sz+=d1+X.U32(28,_BE),d2-=1024,X.Sz()<sz)return!1
for(ord=d1=Util.divu64(d1,12),d1--,voc=0,d3=6;d3;d3--,a4+=2)for(p=a4,d4=ord;d4;d4--,p+=12)if(X.U16(p,_BE)){voc++
break}for(a3+=1084,smp=d3=0;d2>d3;)d4=X.U32(a3,_BE),a3+=d4,d3+=d4,smp++
if(x=1,nv=0,sv="",X.U32(28,_BE))switch(sz){case 95960:x=2
case 54544:sv="v4.0"
break
case 81906:sv="v5.0"}else switch(sz){case 126446:x=3,sv="v3.0"
break
case 136612:x=2,sv="v3.0"
break
case 154704:x=2
case 103808:sv="v3.2"}for(p=64,ptn=0;p<576;p+=2)X.U16(p,_BE)&&ptn++
return!0}()&&(sName="Holger Gehrmann's Soundcontrol module (.SCT)",sVersion=sv,bDetected=1,X.isVerbose()&&(sOptionT(title),x>1&&sOption(x,"×"),sOption("ch:"+voc+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if((sz=X.U32(0,_BE))>2097152||sz>X.Sz())return!1
for(x=16,lastfound=!1,p=19;p>=4;p--){if((t=X.U8(p))>15)return!1
!lastfound&&t&&(x=p-4,lastfound=!0)}for(m=X.U32(20,_BE),p=24;p<276;p+=4){if((t=X.U32(p,_BE))>2097152||t>sz)return!1
m>t&&(m=t)}if(276!=m)return!1
if(X.isDeepScan()){for(p=276,smp=smpsz=0;p<sz-8;){do{(U=X.fSig(p,sz-8-p,"84"))<0?p=sz:p=U+U%2}while(p<sz&&!U%2)
p<sz&&(d1=X.U8(p+1))<=31?(d1>>=2,smpp[d1]=p,d4=X.U16(p+2,_BE)<<1,smpsz+=d4-38,smp++,p+=d4):p+=2}if(!smp||smp>32)return!1}return!0}()&&(sName="Soundfactory module (.PSF)",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption((X.isDeepScan()?"smp:"+smp+" smpsz:"+Hex(smpsz)+" ":"")+"sz:"+outSz(sz)))),!bDetected&&function(){if(ord=X.U8(0),ptn=X.U8(1),ins=X.U8(2),!ptn||ptn>204||ins>31)return!1
var s=[],e=[]
for(p=3,mptn=mins=0,E=0;E<ptn;E++){if((t=X.U8(p++))>203)return!1
mptn<t&&(mptn=t),s.indexOf(t)<0&&s.push(t)}if(ins)for(E=0;E<ins;E++){if(!isWithin(t=X.U8(p++),1,31))return!1
mins<t&&(mins=t),e.indexOf(t)<0&&e.push(t)}if(rptn=s.length,rins=e.length,mptn++,rptn!=ptn||ins&&rins!=ins)return!1
for(o=0;o<ord;o++)for(E=0;E<9;E++)if(s.indexOf(X.U8(p++))<0)return!1
for(notes=0,E=0;E<64*ptn;E++,p+=3){var r=X.U8(p)>>4,n=(1&X.U8(p))<<4|X.U8(p+1)>>4
if(r>12||n&&e.indexOf(n)<0)return!1
12!=r&&notes++}return p+=11*ins,X.c("'B.J.'",p)?(p+=4,sv="v1.8"):sv="v1.3",!("v1.3"==sv&&ptn>100)&&(sz=p,!0)}()&&(sName="BeniTracker Adlib module (.PIS)",sVersion=sv,bDetected=1,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn+(ptn!=mptn?"/"+mptn:"")+" ins:"+ins+(ins!=mins?"/"+mins:"")+" notes:"+notes+" sz:"+outSz(sz))),!bDetected&&function(){for(p=0;p<16;p+=4)if(!X.c("6000",p)||(t=X.U16(p+2,_BE))>X.Sz()||t%2)return!1
if(t=X.I16(6,_BE)+6,!X.c("49FA....1940....4E75 43FA.... 49FA.... 41FA.... 45FA",t)||!X.c("'FORM'66",t+28))return!1
if(t=X.I16(10,_BE)+10,!X.c("49FA....4CFA00FF",t)||!X.c("103A.... 660C 1940.... 6100... .6000",t+10)||!X.c("2A4C DAD8 22CD 2A4C DAD8 22CD 2A4C DAD8 22CD",t+52))return!1
if(t=X.I16(14,_BE)+14,!X.c("70002A7C 00DFF0A8 3A803B40",t)||!X.c("1A801B40 00011B40 00021B40",t+26))return!1
if(initp=X.I16(2,_BE)+2,!X.c("43FA....49FA....41FA....45FA",initp)||!X.c("'FORM'66",initp+18))return!1
for(a0=0,p=initp;p<initp+16;p+=2)if(X.c("41FA",p-2)){a0=p+X.I16(p,_BE)
break}if((p=6+X.fSig(initp,4096,"E7404281"))<6)return!1
for(t=p+X.I16(p,_BE);p<X.Sz()&&!X.c("41FA",p-2);p+=2);for(;p<X.Sz()&&!X.c("D08043FA",p);p+=2);for(p+=4,p+=X.I16(p,_BE),x=p-t>>3,p=a0,smp=0;p<X.Sz();smp++){if(!X.c("'FORM'........'8SVXVHDR'",p)){X.U32(p)||(p+=4)
break}p+=8+X.U32(p+4,_BE)}return sz=p,!!smp}()&&(sName="Steve Barrett's module (.SB)",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<1024||!X.c("49FA",16))return!1
for(p=0;p<16;p+=4)if(!X.c("6000",p)||(t=X.I16(p+2,_BE))<=0||t%2)return!1
if(!X.c("48E7FFFE 4DFA.... 51EE.... 41FA",p=2+X.I16(2,_BE)))return!1
if(!X.c("48E7FFFE 4DFA.... 4A2E.... 6700.... 70033F00 49FA",p=6+X.I16(6,_BE)))return!1
if(!X.c("48E7FFFE 4DFA.... 51EE.... 6100",p=10+X.I16(10,_BE)))return!1
for(p=16;p<X.Sz()&&!X.c("40C2",p);p+=2);for(;p<X.Sz()&&!X.c("41FA",p);p+=2);for(p+=6,sz=p+X.I16(p,_BE),p+=2;p<X.Sz()&&!X.c("43E9",p-2);p+=2);if(sz+=X.I16(p,_BE)<<1,a3=sz,sz>X.Sz())return!1
for(a0=0;p<X.Sz()&&(X.c("206C0032",p)&&(a0+=8,p+=4),!X.c("08380007",p)&&!X.c("08390007",p));p+=2);for(;p<sz&&!X.c("40C1",p);p+=2);for(p+=4;p<X.Sz()&&!X.c("4CDF",p);p+=2);for(;p<sz&&86!=X.I32(p,_BE);p+=2);for(x=0;p<a3;p+=2)70==X.I16(p,_BE)&&x++
return x>>=2,!0}()&&(sName="Illusions/Microdeal Quartet module (SQT.)",sVersion="PSG synth",bDetected=1,X.isVerbose()&&(x>1&&sOption(x,"×"),sOption(outSz(sz),"sz:"))),!bDetected&&function(){if(p=modp=smp=synsmp=ord=ptn=0,x=1,sv=bad="",owner=[],X.c("'SOARV1.0STBL'")){if(x=X.I32(12,_BE),spd0=X.U8(17),ptnlen0=X.U8(19),pst0=X.U16(20,_BE),ped0=X.U16(22,_BE),lp0=X.U16(24,_BE),irqps0=X.U16(26,_BE),!isWithin(spd0,2,16)||!isWithin(irqps0,16,120)||pst0>ped0||lp0>ped0)return!1
if(p=16+12*x,!X.c("'OVTB'",p))return!1
if(ord=X.I32(p+4,_BE),ped0>ord)return!1
if(p+=24+(ord<<4),!X.c("'NTBL'",p-16))return!1
if(ntbl=X.I32(p-12,_BE),p+=ntbl<<2,!X.c("'INST'",p-8))return!1
for(ptn=Util.divu64(ntbl,16),ins=X.I32(p-4,_BE),inss=[],E=0;E<ins;E++,p+=152)X.U16(p,_BE)?synsmp++:smp++,t=X.readBytes(p+122,30,!0),t=decEncoding(t,CPAmiga).trim(),""!=t&&inss.push(t)
if(!X.c("'SD8B'",p))return!1
for(smp=a=X.I32(p+4,_BE),p+=8+38*smp,pp=p,p+=smp<<2;a--&&p<X.Sz();pp+=4)p+=X.U32(pp,_BE)
if(!X.c("'SYWT'",p))return!1
if(synsmp=X.I32(p+4,_BE),p+=8+(synsmp<<7),!X.c("'SYAR'",p))return!1
if(t=X.I32(p+4,_BE),p+=8+(t<<7),!X.c("'SYAF'",p))return!1
if(t=X.I32(p+4,_BE),p+=8+(t<<7),!X.c("'EDAT'",p))return!1
sz=p+24,sv="song"}else{if(X.c("4EFA")){if((t=X.I16(2,_BE))<=0||t%2)return!1
if(!X.c("48E7FFFE 41FA",t+2)||!X.c("201045F0 0800228A 43FA",t+14)||!X.c("20280004 45F00800 228A 43FA",t+26))return!1
if((p=X.I16(t+8,_BE))<=0||p%2)return!1
p+=t+8,modp=p,sv="+replayer"}else sv="pure"
if(p+40>X.Sz()||!X.c("00000028",p))return!1
if(spd0=X.U16(p+40,_BE),irqps0=X.U16(p+50,_BE),lp0=X.U16(p+48,_BE),!isWithin(spd0,2,16)||!isWithin(irqps0,16,120))return!1
x=(X.I32(p+4,_BE)-40)/12,(1==x||X.I16(p+60,_BE)<0)&&(x=1)
var s=[0]
for(E=0;E<8;E++){if(t=X.I32(p,_BE),p+=4,t<=0||t%2||t<s[s.length-1])return!1
s.push(t)}var e=s[2],r=s[3],n=s[4],i=s[5],a=X.I32(modp+t,_BE)
if(ord=Util.div64(r-e,16),ptn=Util.div64(n-r,64),ins=Util.div64(i-n,152),p=modp+t,p>X.Sz())return!1
for(E=0;E<ins;E++)X.U16(modp+n+152*E,_BE)?synsmp++:smp++
if(smp!=a&&(bad=bad.addIfNone("!inconsistentsmpcnt"+a)),p+=4,smp)for(pp=p,p+=a<<2;a--&&p<X.Sz();pp+=4)p+=X.U32(pp,_BE)
if(!X.c("'deadbeef'",p)){if(!X.isHeuristicScan())return!1
bad=bad.addIfNone("!badeof")}for(p+=12,a=p,lim=Math.min(p+1024,X.Sz());p<lim&&(c=255^X.U8(p++),!(255==c||isWithin(c,0,8)||isWithin(c,11,12)||isWithin(c,14,31)));)10==c&&(c=32,32==owner[owner.length-1])||owner.push(c)
32==owner[owner.length-1]&&owner.pop(),sz=p,255!=c&&p-a!=80&&(bad=bad.addIfNone("!badinfo"))}return bpm0=(15*irqps0/spd0).toFixed(1),owner=decEncoding(owner,CPAmiga).trim(),!0}()&&(sName="BrainTrace Design's Sonic Arranger module (.SA"+("pure"==sv?",.LION":"")+")",bDetected=1,sVersion=sv,""!=bad&&(sVersion=sVersion.appendS("malformed:"+bad,"/")),X.isVerbose()&&(x>1&&sOption(x,"×"),""!=owner&&sOption(addEllipsis(owner,160,128),'info:"','"'),sOption("bpm0:"+bpm0+(ord?" ord:"+ord:"")+(lp0?" lp0:"+lp0:"")+(ptn?" ptn:"+ptn:"")+(ins?" ins:"+ins:"")+(smp?" wf.smp:"+smp:"")+(synsmp?" syn.smp:"+synsmp:"")+" sz:"+outSz(sz)))),!bDetected&&X.c("'SASI'00000000000100")&&(sName="BrainTrace Design/MEDIA Verlags Sonic Arranger synth instrument",bDetected=1),!bDetected&&function(){if(X.Sz()<1700)return!1
for(p=0;p<40&&!X.c("02390001",p);p+=2);if(40==p)return!1
if(p+=8,!X.c("66..4E75",p++))return!1
if((t=X.I8(p++))<=0)return!1
if(p+=t,X.c("4A39",p))for(j=4;j--;p+=18)if(!X.c("4A39",p))return!1
if(!X.c("78001839",p))return!1
for(j=p;;){if(p=X.fSig(j,262144,"1400E302"),p<0)return!1
if(!(E%2))break
j=p+1}for(var s=X.U32(p+6,_BE);;){if(p=X.fSig(j,262144,"03580328"),p<0)return!1
if(!(E%2))break
j=p+1}for(s-=p,p=0;p<262144&&(!X.c("B23C00FF",p)&&!X.c("0C0100FF",p));p+=2);if(p>=262144)return!1
for(;p<262144&&!X.c("267C",p-2);p+=2);if(p>=262144)return!1
for(p+=4;p<262144&&!X.c("49F9",p-2);p+=2);if(p>=262144)return!1
for(smpip=X.U32(p,_BE)-s,p+=4;p<262144&&!X.c("0026267C",p-4);p+=2);if(p>=262144)return!1
for(p+=4;p<262144&&!X.c("23F4",p);p+=2);if(p>=262144)return!1
for(subsongp=X.U32(p-4,_BE)-s,p+=6,x=0,p=subsongp;p<262144&&12==X.U8(p+16)&&(t=X.U32(p,_BE),X.U32(p+4,_BE)!=t||X.U32(p+8,_BE)!=t||X.U32(p+12,_BE)!=t);p+=18)x++
for(j=X.U32(smpip,_BE)-s,E=smpip+4,ss=j-E>>2,d0=X.I32(j+4,_BE),d1=2*X.I16(j+2,_BE)+d0,smp=1;E<j;E+=4)t=X.U32(E,_BE)-s,d3=X.U32(t+4,_BE),d3&&(d4=2*X.I16(t+2,_BE)+d3,d3<d0&&(d0=d3),d4>d1&&(d1=d4),smp++)
for(songsz=d0-s,sz=d1-s,E=0;E<262144&&!X.c("4E75",E-2);E+=2);return specialmsg="",2!=(d1=X.U8(E-3))&&(specialmsg=X.SC(E,256,CPAmiga)),!0}()&&(sName="Jeroen Tel's module (.JT)",bDetected=1,X.isVerbose()&&(""!=specialmsg&&sOption(specialmsg),x>1&&sOption(x,"×"),sOption("smp:"+smp+" songsz:"+Hex(songsz)+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<=306||!X.c("'AN COOL'")||(ptn=X.U32(8,_BE))>127||(tmp0=X.U8(12))>15||X.U8(13)||(ord=X.I8(142))<=0)return!1
if("!"==X.SA(7,1))fmt=0
else{if("."!=X.SA(7,1))return!1
fmt=1}if(fmt?ptnp=306:ptnp=272,smpp=ptnp+512*ptn,smpp+212>X.Sz())return!1
if(!X.c("FFFFFFFF00000000",smpp+204)||212!=X.U32(smpp+68,_BE))return!1
for(smp=0,p=smpp+72,E=0;E<16&&p<X.Sz();E++)1!=X.U32(p,_BE)&&smp++
return sz=smpp+X.U32(smpp,_BE),!0}()&&(sName="Anders 'AN Cool' Nilsson's TCB Tracker module (.TCB)",sVersion="f."+fmt,bDetected=1,X.isVerbose()&&sOption("tempo:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&function(){if(!X.c("'if'")&&!X.c("'JN'")||X.Sz()<2033)return!1
if((smp=X.U8(110))>64||(ptn=X.U8(111))>128||(lp=X.U8(112))>=128)return!1
for(ic=0,E=2;E<109;E++)if(isWithin(X.U8(E),1,31)&&++ic>40)return!1
for(E=ord=0;E<128;E++){if((o=X.U8(113+E))>=ptn&&o<254)return!1
if(o<128&&!(t=X.U8(241+E)))return!1
if(t>15||X.U8(369+E)>=64)return!1
o<254&&ord++}if(sz=497+25*smp+1536*ptn,X.Sz()<sz)return!1
for(E=rsmp=0;E<smp;E++)if(ssz=X.U32(510+25*E),slps=X.U32(514+25*E),slpe=X.U32(518+25*E),ssz){if(rsmp++,ssz>67108864)return!1
if([1048575,15794175,4294967295].indexOf(slps)<0&&slps>ssz)return!1
if([1048575,15794175,4294967295].indexOf(slpe)<0&&(slpe>ssz||slpe<slps))return!1
sz+=ssz}return!0}()&&(sName=(X.c("'if'")?"Composer":"UNIS")+" 669 module (.669)",bDetected=1,X.isVerbose()&&(t=X.SC(2,36,"CP850").trim(),t=t.appendS(X.SC(38,36,"CP850").trim()," "),t=t.appendS(X.SC(74,36,"CP850").trim()," "),sOption(t),sOption("ord:"+ord+(lp?" loop:"+lp:"")+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<44712)return!1
if(susv=0,ins=X.U32(18944),!ins||ins>128)return!1
if(trk=X.U32(36492),!trk||trk>64)return!1
if(ptn=X.U32(36484),!ptn||ptn>128)return!1
if(gvol=X.F32(36500),gvol<0||gvol>2)return!1
if(gvol=Math.round(100*gvol)+"%",bpm=X.U8(36504),bpm<10&&susv++,start=X.U32(36508),ord=X.U32(36512),ord||susv++,ord>127||start>ord)return!1
if(ord++,floop=X.U32(36516),floop>1)return!1
for(E=0;E<ins;E++){if(p=148*E,p+147>Math.min(X.Sz(),18944))return!1
if(X.U8(p+128)>1)return!1
var s=X.I8(p+129)
if(s||susv++,s<0&&-s>trk)return!1
var e=X.I8(p+130)
if(e<0&&-e>trk)return!1
var t=X.U8(p+131)
if(t>127)return!1
var r=X.I8(p+132)
if(r<0&&-r>trk)return!1
t||susv++,r||susv++
var n=X.U8(p+133)
if(n>3)return!1
n<3&&!s&&susv++
var i=X.I8(p+134)
if(s>0&&s+i<=0)return!1;(i<-32||i>64)&&susv++
var a=X.U8(p+135),o=X.U8(p+136),d=X.U8(p+137)
if(o<a||d<o||d>127||a>127||d>127)return!1
a||o||d||susv++
var c=X.I8(p+138)
if(c<0&&-c>trk)return!1
var m=X.I8(p+140)
if(m<0&&-m>trk)return!1
var f=X.U8(p+141),l=X.U8(p+142),u=X.U8(p+143)
if(f>127||l>127||u>127)return!1
var b=X.I8(p+144)
if(b<0&&b>trk)return!1
var S=X.I8(p+145)
if(S<0&&S>trk)return!1
var U=X.U8(p+146),z=X.U8(p+147)
if(U>127||z>127||!z&&U||z&&z<=U)return!1}if(susv>3*ins)return _log("BUZFault: data too suspicious"),!1
for(E=18948;E<20100;E++)if(X.U8(E)>127)return!1
for(E=20100;E<28292;E++)if(X.U8(E)>ptn)return _log("BUZFault @"+Hex(E)+": bad ptn"),!1
return!!isAllZeroes(28292,8192)}()&&(sName="Buzzic module (.BUZ)",sVersion="v1.0",bDetected=1,sOption("trk:"+trk+" ord:"+ord+(start?" (from "+start+")":"")+" ptn:"+ptn+" ins:"+ins+" bpm:"+bpm+" gvol:"+gvol+" sz:44712")),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<45224)return!1
if(susv=0,ins=X.U32(19456),!ins||ins>128)return!1
if(trk=X.U32(37004),!trk||trk>64)return!1
if(ptn=X.U32(36996),!ptn||ptn>128)return!1
if(gvol=X.F32(37012),gvol<0|gvol>1.91)return!1
if(gvol=Math.round(100*gvol)+"%",bpm=X.U8(37016),bpm<10&&susv++,start=X.U32(37020),ord=X.U32(37024),ord||susv++,ord>127||start>ord)return!1
if(ord++,floop=X.U32(37028),floop>1)return!1
for(E=0;E<ins;E++){if(p=152*E,p+151>Math.min(X.Sz(),18944))return!1
if(X.U8(p+128)>1)return!1
var s=X.I8(p+129)
if(s||susv++,s<0&&-s>trk)return!1
var e=X.I8(p+130)
if(e<0&&-e>trk)return!1
var t=X.U8(p+131)
if(t>127)return!1
var r=X.I8(p+132)
if(r<0&&-r>trk)return!1
t||susv++,r||susv++
var n=X.U8(p+133)
if(n>3)return!1
n<3&&!s&&susv++
var i=X.I8(p+134)
if(s>0&&s+i<=0)return!1;(i<-32||i>64)&&susv++
var a=X.U8(p+135),o=X.U8(p+136),d=X.U8(p+137)
if(o<a||d<o||d>127||a>127||d>127)return!1
a||o||d||susv++
var c=X.I8(p+138)
if(c<0&&-c>trk)return!1
var m=X.I8(p+140)
if(m<0&&-m>trk)return!1
var f=X.U8(p+141),l=X.U8(p+142),u=X.U8(p+143)
if(f>127||l>127||u>127)return!1
var b=X.I8(p+144)
if(b<0&&b>trk)return!1
var S=X.I8(p+145)
if(S<0&&S>trk)return!1
var U=X.U8(p+146),z=X.U8(p+147)
if(U>127||z>127||!z&&U||z&&z<=U)return!1
if(X.I8(p+148)>118)return!1
var h=X.I8(p+149),k=X.I8(p+151)
if(h<0&&-h>trk||k<0&&-k>trk)return!1}if(susv>3*ins)return _log("BUZ1Fault: too suspicious"),!1
for(E=19460;E<20612;E++)if(X.U8(E)>127)return!1
for(E=20612;E<28804;E++)if(X.U8(E)>ptn)return _log("BUZ1Fault @"+Hex(E)),!1
return!!isAllZeroes(28804,8192)}()&&(sName="Buzzic module (.BUZ)",sVersion="v1.1",bDetected=1,sOption("trk:"+trk+" ord:"+ord+(start?" (from "+start+")":"")+" ptn:"+ptn+" ins:"+ins+" bpm:"+bpm+" gvol:"+gvol+" sz:45224")),!bDetected&&function(){function s(s,e){return _l2r("mdx",s,e),!1}if(X.Sz()<42)return!1
if(da1=X.fSig(0,Math.min(1024,X.Sz()),"0D0A1A"),da1<0)return!1
for(crypt=X.c("00'crypt'",da1-6),sus=crypt?-10:0,E=0;E<da1;E++)if(X.U8(E)<32&&[0,9,27,10,26].indexOf(X.U8(E))<0)return!1
if(title=X.SC(0,da1,"SJIS"),p=X.fSig(da1+3,Math.min(15,X.Sz()-da1),"00"),p<0)return!1
if(da1+3!=p?pdxfn=X.SC(da1+3,p,"SJIS"):pdxfn="",p++,ofs=p,bad="",comp=!1,ch=9,"LZX "==X.SA(ofs+4,4)&&(lzxsz=X.U32(ofs+18,_BE)))return comp=!0,sz=X.fSig(ofs+22,TOEOF,"'[ LZX.X ]'0D0A0000")+13,sz<13&&(bad=bad.addIfNone("!short")),!0
if(crypt?vd=-1:(vd=X.U16(ofs,_BE)+ofs,vd>X.Sz()&&(vd=-1,sus++),241!=X.U8(vd-2)&&241!=X.U8(vd-3)&&(vd=-1,sus++),p+=2),!X.c("0014",p)&&!X.c("0022",p))return!1
if(m=Math.min(1048575,X.Sz()-2),crypt)return sz=X.fSig(ofs+20,m,"'protected by cryptmdx v1.00 (c)1995 H.Yano'00")+43,!0
var e=chn=oldchn=X.U16(p,_BE)+ofs
if(!isWithin(chn,p,m))return s(chn,"!chn"+Hex(p)+"-"+Hex(m))
ch=(chn-ofs-2)/2,usedch=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],notes=vdn=mp=0,vds=[],bpm0=-1
var r=-1,n=[],i=[0,1]
if(X.isDeepScan())for(visited=[],E=0;E<m;E++)visited[E]=0
for(k=1;k<=ch;k++){p+=2,p>mp&&(mp=p),k==ch?isWithin(vd,oldchn+2,X.Sz())?chn=vd:chn=m:(chn=X.U16(p,_BE)+ofs,(!isWithin(chn,oldchn+2,m)||241!=X.U8(chn-2)&&241!=X.U8(chn-3))&&(chn=oldchn,usedch[k-1]=!1),isWithin(chn,oldchn+2,m)||(s(chn,"!p="+Hex(p)+",ch["+k+"] not between "+Hex(oldchn+2)+" and "+Hex(m)),sus+=2),241!=X.U8(chn-2)&&241!=X.U8(chn-3)&&(bad=bad.addIfNone("!badchnend@"+Hex(chn-2)+"="+Hex(X.U24(chn-3,_BE))),X.isDeepScan()||sus++)),clk=0
var o=0
if(X.isDeepScan())for(r=oldchn,stop=!1;!stop&&r!=chn&&r<m;){visited[r]=1,r>mp&&(mp=r)
var d=X.U8(r++)
if(d<128)clk+=d+1
else if(d<=223)o++,notes++,usedch[k-1]=!0,clk+=X.U8(r++)+1
else switch(d){case 255:bpm0<0&&(bpm0=X.U8(r)),r++
break
case 254:a=X.U8(r),b=X.U8(r+1),badYM2151Reg.indexOf(a)>=0?(sus++,bad=bad.addIfNone("!OPMreg@"+Hex(r-2))):8==a&&200&b?(o++,notes++,usedch[7&b]=!0):isWithin(a,96,127)&&(i[0]=!0),r+=2
break
case 253:t=X.U8(r++),vds.indexOf(t)<0&&vds.push(t)
break
case 252:case 240:case 239:case 237:case 233:r++
break
case 251:t=X.U8(r++),isWithin(t,22,127)&&(bad=bad.addIfNone("!FB@"+Hex(r-2)+"="+Hex(t)),sus++),i[0]=1
break
case 250:case 249:case 247:case 238:case 232:break
case 248:t=X.U8(r++),t||(bad=bad.addIfNone("!F8@"+Hex(r-1)),sus++)
break
case 246:X.U8(r+1)?r++:r+=2
break
case 245:246!=X.U8(r+X.I16(r,_BE)-1)&&(bad=bad.addIfNone("!F5→F6@"+Hex(r)),sus++),r+=2
break
case 244:245!=X.U8(r+X.I16(r,_BE)+1)&&(bad=bad.addIfNone("!F4→F5@"+Hex(r)),sus++),r+=2
break
case 243:case 242:r+=2
break
case 241:X.U8(r)?(n[k]=r+2+X.I16(r,_BE),isWithin(n[k],e,m)||(bad=bad.addIfNone("!loopOOB@"+Hex(r-1)),sus++),visited[n[k]]?(stop=!0,r+=2):r=n[k]):r++,vd>0&&vd<r&&(vd=r)
break
case 236:case 235:case 234:t=X.U8(r++),128!=t&&129!=t&&(r+=4)
break
case 231:1!=X.U8(r)&&(bad=bad.addIfNone("!E7@"+Hex(r-1)),sus++),r+=2
break
default:stop=!0,bad=bad.addIfNone("!unk"+Hex(d)),sus++}r>mp&&(mp=r)}if(o&&(usedch[k-1]=!0),oldchn=chn,sus>8)return s(mp,sus+" "+bad)}if(X.isDeepScan()&&"1"!=i[0]&&(bad=bad.addIfNone("!novol"),sus++),sus>8)return s(mp,sus+" "+bad)
if(vd>0&&vd<chn&&(bad=bad.addIfNone("!ins@"+Hex(vd)+"<chn@"+Hex(chn)),sus++),X.isDeepScan()){vdn=vds.length,vds.sort((function(s,e){return s-e}))
var c=[]
for(m=Math.min(X.Sz(),vd+6912),p=vd>0&&vd<chn?chn:vd>0?vd:p;vds.length&&p<m&&vds.length&&(!(192&X.U8(p+1)||240&X.U8(p+2))&&c.indexOf(t=X.U8(p))<0);p+=27)c.push(t),vds=vds.filter((function(s,e,t){return s!=X.U8(p)})),p>mp&&(mp=p)
c.sort((function(s,e){return s-e})),vds.length&&(bad+="!missingInst"+outArray(vds,16)),sz=mp}return sz=X.isDeepScan()?mp:-1,vd==X.Sz()&&(sz=vd),!0}()&&(sName="Konami's X68k Music Data eXtended module (.MDX)",bDetected=1,""!=pdxfn&&(sVersion=sVersion.appendS("+ "+pdxfn," ")),ch>9&&(sVersion+="#EX-PCM"),comp&&(sVersion=sVersion.appendS("compressed","/")),crypt&&(sVersion=sVersion.appendS("cryptmdx","/")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad+(sus?"/sus"+sus:""),"/")),X.isVerbose())){for(sOption(addEllipsis(title),'"','"'),ch=0,E=0;E<16;E++)usedch[E]&&ch++
crypt?sOption("sz:"+outSz(sz)):sOption("ch:"+ch+" bpm0:"+(bpm0<0?"default":bpm0)+(notes?" notes:"+notes:"")+(vdn?" ins:"+vdn:"")+(sz>0?" sz:"+outSz(sz):""))}if(!bDetected&&function(){var s=modp=ofsdiff=0
if(bad="",!function(){if(X.Sz()<2830)return!1
if(!X.c("4EFA....4EFA....4EFA....4EFA"))return!1
if((s=X.I16(2,_BE)+2)<=16||s%2)return!1
if(!X.c("123A.... B0016200 007E47FA 08761680 45FA0873 49FA086E D5C01892 E7887E03 7C0041FA 08D8",s)&&!X.c("42380001 123A.... B0016200 007E47FA 08B61680 45FA08B3 49FA08AE D5C01892 E7887E03 7C0041FA 0918",s))return!1
for(E=0;E<4;E++)if(X.c("123A....B001",s+2*E)){modp=s+2*E+1+X.I16(s+2*E+2,_BE)
break}if(4==E||modp>X.Sz())return!1
for(;E<60;E++)if(X.c("47FA....D7FA",s+2*E))return ofsdiff=s+2*(E+1)+X.I16(s+2*E+2,_BE),!0
return!1}())return!1
if(s=modp+1,x=X.U8(s++)+1,x>10)return!1
for(spd0=X.U8(s++),spds=[],E=0;E<10;E++)t=X.U8(s++),spds.indexOf(t)<0&&spds.push(t)
s++
var e=ofsdiff+X.U32(s,_BE),p=ofsdiff+X.U32(s+4,_BE),r=(Math.abs(e-p),[]),n=[],i=[]
for(E=0,ord=[],s+=620;E<x;E++)r[E]=[0,0,0,0],ord[E]=0
for(E=0;E<x;E++)for(j=0;j<4&&s<X.Sz();j++,s+=2)r[E][j]=X.U16(s,_BE)-8*x>>1
if(s>X.Sz())return!1
for(ordp=s,otsz=Math.min(e,p)-s>>1,E=0;E<otsz;E++,s+=2)n.push(X.I16(s,_BE))
for(trksz=Math.abs(e-p),E=tr=0;E<trksz;tr++){for(si=E;128!=X.U8(s+E++)&&E!=trksz&&s+E<X.Sz(););if(E==trksz&&128!=X.U8(s+E-1))break
i[si]=tr}for(E=0;E<x&&s<X.Sz();E++)for(j=0;j<4&&s<X.Sz();j++)for(on=!0,c=r[E][j];c-r[E][j]<255&&n[c]>=0;c++)if(void 0===i[n[c]])return!1
for(syn=smp=0,msmpp=2147483647,Msmpp=smpe=0,s=e;;){var a=X.U32(s,_BE),o=X.I16(s+4,_BE),d=X.U16(s+6,_BE)<<1,m=X.U8(s+39)
if(s+40>=X.Sz()||s+63>=msmpp)break
if(255!=m)if(a){if((a+=ofsdiff)>X.Sz())break
a<msmpp&&(msmpp=a),a>Msmpp&&a<X.Sz()&&(Msmpp=a,smpe=a+d),smp++}else{if(-779===o)break
if(-1!=o&&0!=m)return!1
syn++}s+=64}return smp?sz=smpe:sz=s,!0}()&&(sName="Fred & Julien Clermonte's Fred Editor module (.FRED,.FRD)",sVersion="final",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("tempo:"+spds.sort().join("-")+(smp?" smp:"+smp:"")+(syn?" syn:"+syn:"")+" sz:"+outSz(sz)))),!bDetected&&function(){if(!X.c("'AMF'"))return!1
var s=X.U8(3)
if(1!=s&&!isWithin(s,8,14))return!1
if(p=s<9?4:36,smp=X.U8(p),ord=X.U8(p+1),trk=X.U16(p+2),ch=s>=9?X.U8(p+4):16,!smp||!ord||!trk)return!1
if(p+=s>=9?5:4,s<12&&!isWithin(ch,1,16))return!1
if(!isWithin(ch,1,32))return!1
p+=s>=11?s>=12?32:16:s>=9?16:0,s>=13?(tmp0=X.U8(p++),tmp0<32&&(tmp0=125),spd0=X.U8(p++)):(tmp0=125,spd0=6)
var e=[]
for(p,E=0;E<ord;E++)s>=14&&(e[ord]=X.U16(p),X.U16(p),p+=2),p+=2*ch
var r=!1
if(10==s){var n=p
for(E=0;E<smp;E++)if(n+65<X.Sz()){if(X.U8(n)>1||X.U32(n+46)>smp||(ssz=X.U32(n+50))>1048576||X.U8(n+56)>64||X.U32(n+57)>ssz||X.U32(n+61)>ssz){r=!0
break}n+=65}}smps=[]
var i=0
for(rsmp=0,E=0;E<smp;E++)t=X.SC(p+1,32,"CP437").trim(),t.length&&smps.push(t),s<10?(i+=t=X.U16(p+50),t&&rsmp++,p+=59):(i+=t=X.U32(p+50),t&&rsmp++,p+=r?59:65)
for(trkc=0,E=0;E<trk;E++)t=X.U16(p),p+=2,t>trkc&&(trkc=t)
for(E=0;E<trkc;E++)t=X.U16(p),p+=3,t&&(p+=3*t+(1==s?3:0))
return sz=p+i,!0}()&&(sName="Digital Sound and Music Interface Advanced Music Format module (.AMF)",sVersion="v"+X.U8(3),bDetected=1,X.isVerbose()&&(sOptionT(X.SC(4,32,"CP437")),sOption(addEllipsis(smps.join(" "),160),'smp/msg:"','"'),sOption("ch:"+ch+" spd0:"+spd0+" tmp0:"+tmp0+" ord:"+ord+" trk:"+(trkc!=trk?trkc+"/":"")+trk+" smp:"+(rsmp==smp?"":rsmp+"/")+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(!X.c("'SAdT'")||!isWithin(nV=X.U8(4),1,9))return!1
const s=128
var e
switch(nV){case 1:e=7
break
case 2:e=6
break
case 3:e=6
break
case 4:e=14
break
case 5:0
case 6:e=142
break
case 7:e=200
break
case 8:e=152
break
case 9:e=184}for(p=5+31*(8&e?15:11),E=0,inst=[];E<29;E++)""!=(t=X.SC(p+1,X.U8(p),"CP437").trim())&&inst.push(t),p+=17
p+=3
var r=X.readBytes(p,128)
if(p+=128,1&e&&(p+=127),!isWithin(ptn=X.U16(p),1,64))return!1
if(p+=2,!isWithin(ord=X.U8(p++),1,128))return!1
for(E=rptn=0;E<ord;E++)r[E]+1>rptn&&(rptn=r[E]+1)
if(delete r,rptn>ptn||(lp=X.U8(p++))>=ord)return!1
if(bpm=X.U16(p),p+=2,4&e&&(bpm=5*bpm/2),e&s&&(p+=512),16&e&&(p+=576),32&e?(actch=X.U16(p)<<16,p+=2):actch=-1,trk=0,2&e)for(;trk<ptn&&p<X.Sz();)p+=2880,trk++
else if(64&e)for(;trk<ptn&&p<X.Sz();)p+=1728,trk++
else for(;trk<576&&p<X.Sz();)p+=192,trk++
return sz=p,!0}()&&(nV<8?sName="Surprise! AdLib Tracker module (.SAT)":sName="Surprise! AdLib Tracker 2 module (.SA2)",sVersion="v"+nV,bDetected=1,X.isVerbose()&&(sOptionT(addEllipsis(inst.join(" "),160),'ins/msg:"','"'),sOption("bpm:"+bpm+(actch>=0?"ch:"+actch:"")+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+(rptn!=ptn?rptn+"/":"")+ptn+(trk!=ptn?" trk:"+trk:"")+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<512)return!1
var s=tp=mdatsz=smplsz=-1,e=0,r=196608
if(title=album=by="",flag5=-1,tfmxst=!1,X.c("'TFMX-MOD'")){if(s=e=20,sz=X.U32(12,_LE),smplsz=sz-X.U32(8,_LE),mdatsz=X.U32(8,_LE)-8,!mdatsz||!isWithin(sz,530,X.Sz()))return!1
for(;sz<X.Sz();){t=X.U8(sz)
var n=X.U16(sz+1,_LE)
if(sz+=3,!t&&!n)break
switch(t){case 1:by=X.SC(sz,n,"CP1252")
break
case 2:album=X.SC(sz,n,"CP1252")
break
case 5:flag5=X.U8(sz)
break
case 6:title=X.SC(sz,n,"CP1252")}if(!t){sz+=17
break}sz+=n}}if(X.c("'TFHD'")){if(s=X.U32(4,_BE),tp=X.U8(8),v=X.U8(9),mdatsz=X.U32(10,_BE),smplsz=X.U32(14,_BE),sz=s+mdatsz+smplsz,s<18||!mdatsz||!isWithin(sz,530,X.Sz()))return!1
if(128&tp||!(127&tp))e=p=s
else switch(127&tp){case 1:tp="1.5"
break
case 2:tp="pro"
break
case 3:tp="7v"
break
default:return!1}}else if(X.c("'TFMX '",e)&&!X.c("'SONG'",e+5))tp="1.5"
else{if(!(X.c("'TFMX-SONG'",e)||X.c("'TFMX_SONG'",e)||X.c("'tfmxsong'",e)))return!1
var i=0,a=!1,o=X.readBytes(e+256,31),d=X.U32(e+464,_BE)
for(d||(d=2048),E=0;E<31;E++){var c=!0,m=o[E]
if(511==m)break
for(;c&&p<X.Sz();)if(p=e+d+16*m,t=X.U16(p,_BE),cmd=X.U16(p+2,_BE),p+=4,61438!=t)c=!1
else switch(cmd){case 1:i?i<0?(m=X.U16(p,_BE),i=X.I16(p+2,_BE)-1,p+=4):(i--,m=X.U16(p,_BE),p+=2):(i=-1,m++)
break
case 2:case 4:m++
break
case 3:a=!0,m++
break
default:c=a=!1}if(a)break}if(function(s){var e,t=X.U32(s+468,_BE)
t?(e=X.U32(s+472,_BE),e=X.U32(s+e,_BE)):(e=X.U32(s+1536,_BE),t=X.U32(s+2044,_BE))
var p,r=X.readBytes(s+e,t-e)
for(p=0;p<r.length;p+=4)if(isWithin(r[p],64,127))return!0
return!1}())return!1
tfmxst=!0,tp=a?"7v":"pro"}for(E=0,p=e+16,cmt="";E<6;E++,p+=40)cmt=cmt.appendS(decAnsi(p,40,CPAmiga).trim(),"  ")
cmt=cmt.trim(),_l2r("tfmxcmt",e+16,decAnsi(p,240,CPAmiga).trim())
var f=[],l=[],u=[]
for(E=0;E<32;E++)f.push(X.I16(p,_BE)),p+=2
for(E=0;E<32;E++)l.push(X.I16(p,_BE)),p+=2
for(E=0;E<32;E++)u.push(X.I16(p,_BE)),p+=2
p+=16
var b=X.I32(p,_BE),S=X.I32(p+4,_BE),U=X.I32(p+8,_BE)
if(S?S-=512:S=512,U?U-=512:U=1024,b?b-=512:b=1536,p+=48,p>X.Sz())return!1
var z=p
for(r=Math.min(r+z,X.Sz()),S+=z,U+=z,b+=z,len=s>0?mdatsz:Math.min(r,X.Sz())-p,ins=mip=0,p=U,ino=X.I32(p,_BE);ins<256&&p+4<=X.Sz()&&(t=X.I32(p,_BE)-512+z,!(3&t||!isWithin(t,b,r)||t&!X.c("F0000000",t-4)&&!X.c("07000000",t-4)||ins&&Math.abs(t-ino)>8192));ins++,p+=4)mip<t&&(mip=t),ins&&(ino=t)
ptn=Math.min(U-S>>2,128)
var h=X.U32(S,_BE)-512+z
if(pt=ptn,trkst=h-b>>4,trkst<0&&(trkst=0),s<0)switch(Math.max(U,S,mip)){case U:sz=U+4*ins
break
case mip:for(p=mip;p<r&&!X.c("07000000",p);p+=4);sz=p,sz<r&&(sz+=4)
break
case S:for(_l2r("tfmx",z,"p:"+Hex(p)+" ptnp:"+Hex(S)+" insp:"+Hex(U)+" trkp:"+Hex(b)+" trkst["+Hex(S)+"="+Hex(h)+"]:"+Hex(trkst)+" len:"+Hex(len)+"/"+Hex(r)),p=S+4,po=X.I32(S,_BE),pt=1;pt<256&&(t=X.I32(p,_BE)-512+z,!(3&t||!isWithin(t,b,r)||!X.c("F0000000",t-4)&&!X.c("07000000",t-4)||Math.abs(t-po)>8192));p+=4,pt++)po=t
sz=p}x=-1
var k=2
for(ord=[0],E=0;E<32&&k>0&&(x++,f[E]||k--,511!=f[E]&&511!=l[E])&&(f[E]<=trkst&&(ord[x]=l[E]-f[E]+1),!(f[E]>=trkst))&&(f[E]!=l[E]||f[E]||f[E+1]);E++);return x||(x=1),!0}()){switch(sName="Chris Hülsbeck's The Final Musicsystem eXtended module (TFX.,.TFM,MDAT.+SMPL.,MDST.+SMPL.)",bDetected=1,tp){case"1.5":sVersion="v1.5"
break
case"pro":sVersion="Professional"
break
case"7v":sVersion="7 voices"}tfmxst&&(sVersion="ST "+sVersion),pt<ptn&&(sVersion+="/malformed!badptn"),X.isVerbose()&&(sOptionT(title),x>1&&sOption(x,"×"),sOption(album,"in: "),sOptionT(by,"by: "),flag5>=0&&sOption(flag5,"flag5:"),"(Empty)"==cmt&&(cmt=""),sOption(addEllipsis(cmt,160),'msg:"','"'),sOption("ord:"+ord.join("+")+" ptn:"+ptn+(ptn!=pt?"/"+pt:"")+" ins:"+(ins>128?"128/":"")+ins+" sz:"+outSz(sz)))}if(!bDetected&&function(){if(!(X.c("'P22A'")||X.c("'P30A'")||X.c("'P40A'")||X.c("'P40B'")||X.c("'P41A'")))return!1
if(ptn=X.U8(4),smp=X.U8(6),volofs="41A"==X.SA(1,3)?32:34,ptn>127||!smp||smp>31)return!1
for(E=0;E<smp;E++){if(!isWithin(X.U16(volofs+16*E,_BE),1,64))return!1
if(32==volofs&&X.U16(volofs+2+16*E,_BE)%74)return!1}for(E=smpsz=0;E<smp;E++){if(ssz=X.U16(24+16*E,_BE)<<1,!ssz||ssz>65534||X.U16(30+16*E,_BE)<<1>ssz+2)return!1
smpsz+=ssz}if(smpsz<=4)return!1
X.SA(1,1)<"4"?ord=(X.U8(5)>>1)-1:ord=X.U8(5),p=16+16*smp
var s=X.U32(8,_BE),e=X.U32(12,_BE),t=X.U32(16,_BE),r=0
if(p!=e&&(s-=r=e-p,e-=r,t-=r),!isWithin(s,p,X.Sz())||!isWithin(e,p,X.Sz())||!isWithin(t,p,X.Sz()))return!1
for(E=p=0;E<smp;E++){if(32==volofs&&X.U16(volofs+2+16*E,_BE)>1110)continue;(is=X.U32(20+16*E,_BE))>p&&(p=is-r,ssz=X.U16(24+16*E,_BE))}return sz=4+t+p+(ssz<<1),!0}()&&(sName="Jarno 'Guru' Paananen's The Player module (."+X.SA(0,2)+"X,."+X.SA(0,4)+")",sVersion="v"+X.SA(1,1)+"."+X.SA(2,2),bDetected=1,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&function(){if(X.Sz()<7)return!1
if(z=sig=X.c("'P50A'")||X.c("'P60A'")||X.c("'P61A'")?4:0,smpp=X.U16(z,_BE)+z,ptn=X.U8(z+2),!ptn||ptn>127)return!1
if(smp=X.U8(z+3),32&smp)return!1
if(pksmp=64&smp,dtsmp=128&smp,smp&=63,!smp||7+6*smp>X.Sz())return!1
if(pksmp&&(z+=4),smpp<z+4+6*smp+8*ptn||smpp>X.Sz())return!1
smpsz=notes=0
var s=vols=0
for(E=0,p=z+4;E<smp;E++,p+=6){if(isWithin(ssz=X.U16(p,_BE),32768,65503)||!ssz)return!1
if(ssz>65503&&65535-ssz>smp)return!1
var e=128&X.U8(p+2)
if((127&X.U8(p+2))>15||X.U8(p+3)>64)return!1
if(vols|=X.U8(p+3),isWithin(X.U16(p+4,_BE),ssz,65534))return!1
ssz<65280&&(smpsz+=ssz<<(e?0:1),s+=ssz<<1)}if(!vols||pksmp&&X.U32(z,_BE)!=s)return!1
for(E=0;E<4*ptn;E++)if(X.U16(z+4+6*smp,_BE)+4+z+6*smp+8*ptn>smpp)return!1
if(E=mptn=0,function(){for(;255!=(t=X.U8(z+4+6*smp+8*ptn+E))&&E<128;E++){if(t>ptn-1)return!1
t>mptn&&(mptn=t)}return!0}())v=6
else{if(!function(){for(;255!=(t=X.U8(z+4+6*smp+8*ptn+E))&&E<128;E++){if(t%2||t>2*ptn)return!1
t>mptn&&(mptn=t)}return mptn>>=1,!0}())return!1
v=5}if(!E||128==E)return!1
function r(){for(E=ord+z+5+6*smp+8*ptn;E<smpp;E++)if(128&(t=X.U8(E)))E+=3
else{if(t>73||(t<<4&16|X.U8(E+1)>>4)>smp)return!1
t>=2&&notes++,E+=2}return notes>0}if(ord=E,mptn++,6==v)if(r())sv="6.0"
else{if(!function(){for(E=ord+z+5+6*smp+8*ptn;E<smpp;E++)if(127!=(t=X.U8(E))){if(255==t)switch(192&X.U8(E+1)){case 0:E++
continue
case 64:E+=2
continue
case 192:if(E<X.U16(E+2,_BE)-1)return!1
E+=3
continue}switch(240&t){case 240:if((31&X.U8(E+1))>smp)return!1
E+=2
continue
case 112:if((31&X.U8(E+1))>smp)return!1
E+=1
continue
case 224:E+=2
continue
case 96:E+=1
continue}if(128&~t){if((t<<4&16|X.U8(E+1)>>4)>smp)return!1
E+=2}else{if((t<<4&16|X.U8(E+1)>>4)>smp)return!1
E+=3}}return!0}())return!1
sv="6.1"}else r()&&(sv="5.0")
return!0}()&&(sName="Jarno 'Guru' Paananen's The Player module (.P"+sv[0]+"X,.P"+sv[0]+sv[2]+"A)",sVersion="v"+sv+"A",bDetected=1,dtsmp&&(sVersion=sVersion.appendS("deltasmp","/")),pksmp&&(sVersion=sVersion.appendS("packedsmp","/")),X.isVerbose()&&sOption("ord:"+ord+" ptn:"+(mptn!=ptn?mptn+"/":"")+ptn+" smp:"+smp+(notes>0?" notes:"+notes:"")+" sz:"+outSz(smpp+smpsz))),!bDetected&&function(){if(X.Sz()<6800)return!1
var s=X.I32(46,_BE)
if(!isWithin(s,2,67108864)||s%2)return!1
if(X.I32(0,_BE)-s!=64)return!1
for(p=4,E=0,d4=64;E<4;E++,p+=4)if(d4+=1024,X.I32(p,_BE)-s!=d4)return!1
for(E=0;E<3;E++,p+=4)if(d4+=256,X.I32(p,_BE)-s!=d4)return!1
for(smp=X.U8(35),sz=smp-1,smpsz=-1,p=68;p<4160;p+=4)(t=X.U32(p-4,_BE)-s)>sz&&(sz=t)
if(sz+=64,(sz-6800)%3)return!1
if(11792==sz?x=5:10112==sz?x=3:x=1,ptn=Util.divu64(Util.divu64(sz-6800,3),X.U8(41)+1),bad="",ptn>1024&&(bad=bad.addIfNone("!badptn")),smp>31)bad=bad.addIfNone("!badsmp")
else for(E=0,p=5360;E<smp;E++,p+=48)smpsz+=X.U16(p,_BE)
return d1=256+X.U8(33)-X.U8(34)+1,d1*=2+X.U8(44),d2=d1,d1*=X.U16(42,_BE),d3=Util.divu64(14318==sz?715904:709376,X.U8(41)+1),d1=Util.divu64(d1,d3),dur=secondsToTimeStr(d1),!0}()&&(sName="Thomas Hermann's module (.THM+.SMP)",bDetected=1,bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(x>1&&sOption(x,"×"),sOption("len."+dur+" ptn:"+ptn+" smp:"+smp+" smpsz:"+smpsz+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<26243||!isWithin(X.U32(0),3456,3457))return!1
if(!(ptn=X.U32(4))||!(x=X.U32(8))||!(ins=X.U32(12)))return!1
if(!isAllZeroes(16,36))return!1
for(mbpm=400,Mbpm=ch=smp=0,ord=[],titles=[],i=0,p=52;i<x&&p<X.Sz();i++,p+=16564){for(E=p+64;E<p+80;E++)if(X.U8(E)>1)return!1
if(!isWithin(bpm=X.U32(p+80),10,300))return!1
if(mbpm>bpm&&(mbpm=bpm),Mbpm<bpm&&(Mbpm=bpm),!isWithin(X.U8(p+84),0,3))return!1
if((startpos=X.U32(p+88))>(endpos=X.U32(p+96)))return!1
if((looppos=X.U32(p+104))>endpos)return!1
if(!isWithin(t=X.U16(p+146),1,16))return!1
if(ch<t&&(ch=t),!isWithin(delay=X.U16(p+148),2e3,6e4))return!1
if(!isWithin(amp=X.U16(p+166),20,999))return!1
if(X.isDeepScan())for(o=p+180;o<p+16564;o+=4)if(X.U16(o)>=ptn||!X.U16(o+2)||-121&X.U16(o+2))return!1
t=X.SC(p+114,32,"CP1250"),"Empty"!==t&&""!==t.trim()&&titles.push(t.trim()),ord.push(endpos)}for(p+=64*ptn*5,E=0;E<ptn&&p<X.Sz();E++)p+=4+X.U32(p)
for(E=0;E<ins&&p<X.Sz();E++,p+=8712){if([1234,1235].indexOf(X.U16(p))<0)return!1
if(X.U16(p+34)>16||!isWithin(X.U16(p+36),1,256))return!1
if(X.U16(p+38)>255||X.U16(p+40)>16||X.U16(p+42)>32)return!1
if(X.U16(p+46)>15||X.U16(p+48)>16||X.U16(p+50)>64)return!1
X.U32(p+512)&&smp++,(t=X.U32(p+516))&&(p+=t)}return!(p>X.Sz())&&(p+=256,!0)}()&&(sName="Reinier 'Rhino' van Vliet's Jaytrax/Syntrax module (.JXS)",sVersion="v."+X.U32(0),bDetected=1,X.isVerbose()&&(titles.length>1?sOption(addEllipsis(titles.join("/"),192),"×"+x+" subsongs:"):(titles.length&&sOption(titles[0]),x>1&&sOption(x,"×")),x>1?ord=ord.join("+"):ord=(startpos?startpos+"~":"")+(looppos>startpos?"("+looppos+"-)":"")+endpos,sOption("ch:"+ch+" bpm:"+mbpm+(mbpm!=Mbpm?"-"+Mbpm:"")+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(p)))),!bDetected&&function(){if(33!=X.U8(0)||128!=X.U8(9))return!1
if(!(ord=X.U16(1))||!(ins=X.U16(3))||!(smp=X.U16(5))||smp>ins||!(ptn=X.U16(7)))return!1
if(!isWithin(mvol=X.U8(10),1,32)||!isWithin(spd=X.U8(11),1,32)||!isWithin(tmp=X.U8(12),32,160))return!1
if(charStat(X.readBytes(13,26),1).indexOf("allxsc")<0)return!1
for(p=39;p<103;p++)if(X.U8(p)>64)return!1
for(p=167;p<167+ord;p++)if(255!=X.U8(p)&&X.U8(p)>=ptn)return!1
if(255!=X.U8(p-1))return!1
var s
for(rins=0,rsmp=0,bad="",E=0;E<ins&&p<X.Sz();E++){if(["I","i"].indexOf(s=X.SA(p++,1))<0)return!1
if("I"===s){if(X.U8(p+2)>128)return!1
for(p+=X.I8(p+5)>=0?244:6,j=3;j;j--)if(X.U8(p++)){if(X.U8(p+1)>X.U8(p+2)||X.U8(p+3)>X.U8(p+4))return!1
p+=5+3*X.U8(p)}rins++}}for(E=smpsz=0;E<smp&&p<X.Sz();E++){if(s=X.SA(p++,1),["S","s"].indexOf(s)<0)return!1
if("S"==s){if(X.U8(p)>64||X.U8(p+2)>64)return!1
X.U8(p+1)
var e=X.I32(p+3),t=X.U32(p+7),r=X.U32(p+11),n=X.U32(p+14),i=X.U32(p+19),a=X.readBytes(p+32,13)
if(charStat(a,1).indexOf("allxsc")<0)return!1
switch(a=decEncoding(a,CP437)){case"909OH.WAV":e=3424
break
case"909SD.WAV":e=3413
break
case"CRASH.WAV":e=16098}if(t>e||r>e||n>e||i>e||t>r||n>i)return!1
smpsz+=e,p+=45,rsmp++}}for(E=0;E<ptn&&p<X.Sz();E++){if(s=X.SA(p++,1),["P","p"].indexOf(s)<0)return!1
if("P"==s){var o=X.U16(p),d=X.U16(p+2)
if(!o||!d)return!1
p+=4+o}}for(j=X.U32(p),p+=4,E=0;E<j&&p<X.Sz()&&!(charStat(X.readBytes(p,8),1).indexOf("allxsc")<0);E++,p+=268);return j=X.U8(p++),!0}()&&(sName="Sahara Surfers' iXalance module (.IXS)",sVersion="unpacked",bDetected=1,bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SA(13,26,"CP1250")),sOption("ord:"+ord+" ptn:"+ptn+" ins:"+(rins!=ins?rins+"/":"")+ins+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" smpsz:"+smpsz+"s sz:"+outSz(p)))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<1852)return!1
if(smpp=X.U32(1080,_BE),smpp<=1084)return!1
if(d1h=(smpp-1084)%768,d1h)return!1
if(ptn=d2=Util.div64(smpp-1084,768),ord=X.U8(950),ord>127)return!1
for(mptn=0,E=0;E<=ord;E++){if(t=X.U8(952+E),t>127)return!1
mptn<t&&(mptn=t)}if(ptn!=mptn+1)return!1
for(smp=smpsz=0,smps=[],bad="",smpns=[],E=0;E<31;E++)X.isVerbose()&&(U=X.SC(20+30*E,22,"CP437").trim()).length&&!/ST-[0-9A-F]+:/i.test(U)&&smpns.push(U),t=X.U16(20+30*E+22,_BE),t&&(smp++,smpsz+=t<<1,smpns.push(E))
if(msmp=smpns[smpns.length-1],songsz=X.U32(1080,_BE),sz=songsz+smpsz,sz<X.Sz()&&(bad=bad.addIfNone("!short")),a1=952,d1=ord,x=a0=notes=0,X.isVerbose()){do{a0=1084+768*X.U8(a1),a3=a0+768,a1++
do{var s=X.readBytes(a0,2)
s[0],s[1]
if(63&s[0]&&notes++,!1&s[1]){x++
break}a0+=3}while(a0<a3&&a0<X.Sz())
d1--}while(d1)
x||(x=1)}else x=1
return 28732===songsz&&12898===smpsz&&X.c("'beast-busters1.st'")&&(x=11),!0}()&&(sName="Images Music System module (.IMS)",bDetected=1,sVersion="v1.0",""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOption(X.SC(0,20,"CP437")),x>1&&sOption(x,"×"),sOption(addEllipsis(smpns.join(","),256,160),'smp/msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<555)return!1
function s(s){for(var e=0,t=0;t<s.length;t++)s[t]&&s[t]<32&&[-1,10,13,14].indexOf(s[t])<0&&e++
return e}function e(s){const e=[0,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113]
return e.indexOf(s)>=0||e.indexOf(s-1)>=0||e.indexOf(s+1)>=0}var t=0,p=!0,r=0
for(t=s(X.readBytes(0,20)),bad="",allsmpsz=allvols=smp=r=0,snames=[],k=0;k<15;k++){var n=X.readBytes(20+30*k,22,!0),i=decEncoding(n,CPAmiga).trim()
if(/ST-[0-9A-F]+:/i.test(i)?t-=4:snames.push(i),t+=s(n),k,k,i.trim(),charStat(n,1),t>10)return k,!1
if(X.U8(20+30*k)&&!/^st-[0-9a-f]\d:/i.test(i)&&(p=!1),(M=2*X.U16(42+30*k,_BE))>73728)return k,k,Hex(M),!1
if(X.U8(44+30*k)>15&&(bad=bad.addIfNone("!finetune"),t+=16),(T=X.U8(45+30*k))>64)return!1
sls=X.U16(46+30*k,_BE),sll=X.U16(48+30*k,_BE),(M>9998||sls>4999)&&(r=Math.max(r,5)),M&&smp++,allsmpsz+=M,allvols+=T,sll>M+2&&(k,k,sll,bad=bad.addIfNone("!sLpLen>sSz")),M&&sls>=M&&(k,k,sls,bad=bad.addIfNone("!sLpStart>=sSz")),sls&&!sll&&(k,k,sls,bad=bad.addIfNone("!sLpStart0LpSz")),sls&&!M&&(k,k,sls,bad=bad.addIfNone("!sLpStart0SSz"))}if(allsmpsz<8||!allvols)return!1
if(ord=X.U8(470),ord>128)return!1
if(restartp=X.U8(471),restartp>220)return!1
for(restartp&&!/jjk55/.test(X.SA(0,6))||(restartp=120),bpm0=125,120!=restartp&&(bpm0=(88672375/(6100*(240-restartp))).toFixed(2),r=r>1?Math.max(r,p?4:5):Math.max(r,p?1:2)),ptn=offptn=badptn=ord_=0,usedptns=[],usedsmps=[],o=0;o<128;o++){if((d=X.U8(472+o))>63)return o,!1
ptn<=d&&(ptn=d+1,o<ord&&(offptn=ptn,usedptns.indexOf(d)<0&&usedptns.push(d))),d>=badptn&&(badptn=ptn+1),d&&ord_++}if(ord_++,songszoffptn=600+1024*offptn,songszoffptn>X.Sz())return songszoffptn,!1
for(t=tnDxx=notes=0,E=0;E<ptn;E++){for(emptycmd=nDxx=badnote=ptnic=ptnotes=0,row=0;row<64;row++)for(chn=0;chn<4;chn++){var a=600+(E<<10)+(row<<4)+(chn<<2),d=X.readBytes(a,4)
X.isDeepScan()&&(emptycmd||d[0]||d[1]||d[2]||d[3]?emptycmd=0:(emptycmd++,emptycmd>32&&(r=6)))
var c=240&d[0]|(240&d[2])>>4,m=((15&d[0])<<8)+d[1],f=15&d[2]
if(usedptns.indexOf(E)>=0&&(c>15?ptnic++:usedsmps.indexOf(c)<0&&usedsmps.push(c)),(X.isDeepScan()||notes<100)&&!e(m)?(ptnic+=2,badnote++):m&&ptnotes++,X.isDeepScan())switch(f){case 1:case 2:d[3]>31&&1==r?r=p?1:0:1==f&&d[3]>0&&d[3]<3?r=Math.max(r,2):1==f&&(55==d[3]||71==d[3])&&r<=2&&(r=p?1:0)
break
case 11:r=6
break
case 12:case 13:case 14:if(r=Math.max(r,2),13==f){if(emptycmd=1,!d[3]&&!row)break
nDxx++}break
case 15:r<3&&(r=3)}}if(ptn>=offptn&&ptnic>64?ptn=offptn:(t+=ptnic,notes+=ptnotes,badnote&&(bad=bad.addIfNone("!badnotes"))),t>Math.max(512,128*ptn))return!1
nDxx&&nDxx<3&&(r=6),tnDxx+=nDxx}if(tnDxx>ptn+32&&6==r&&(r=5),X.isDeepScan())switch(r){case 0:tracker="Karsten Obarski's Ultimate ST 1.0~21"
break
case 1:tracker="Karsten Obarski's Ultimate ST 1.8~2.0"
break
case 2:tracker="The Exterminator's ST 2.0 / D.O.C.'s ST II"
break
case 3:tracker="Il Scuro/Defjam's ST III / Alpha Flight ST IV / D.O.C.'s' ST IV / VI"
break
case 4:tracker="D.O.C.'s' ST IX"
break
case 5:tracker="Tip/The New Masters' Master ST 1.0"
break
case 6:tracker="D.O.C.'s ST 2.0~2"
break
default:tracker="???"}sz=600+1024*ptn+allsmpsz
var l=Math.abs(sz-X.Sz()),u=Math.abs(ord-ord_),b=ord||1e-4,S=0
return t>20&&S++,isWithin(smp,3,15)||S++,l>2048&&S++,sz>X.Sz()&&S++,restartp||S++,(!ord||!ord_||badptn>ptn+2)&&S++,u/b>.8&&S++,ptn||S++,(notes<2||badnotes>30)&&S++,allvols<smp&&S++,isWithin(bpm0,20,300)||S++,!(S>=4)&&(t&&(bad=bad.addIfNone("!baddata="+t)),sz>X.Sz()&&(bad=bad.addIfNone("!short")),S&&(bad=bad.addIfNone("!sus+"+S)),!0)}()&&(sName="Karsten Obarski's SoundTracker module (.STK,.MOD)",bDetected=1,""!=bad&&(sVersion="malformed"+bad),X.isVerbose()&&(sOptionT(X.SA(0,20)),X.isDeepScan()&&sOption(tracker,"in:"),sOption(snames.join(" "),'smps/msg:"','"'),sOption("bpm0:"+bpm0+" ord:"+ord+(ord_!=ord?"/"+ord_:"")+" ptn:"+(offptn!=ptn?offptn+"/":"")+ptn+" smp:"+smp+(X.isDeepScan()?" notes:"+notes:"")+" sz:"+outSz(sz)))),!bDetected&&function(){if(spd=X.U8(0),!isWithin(spd,1,15))return!1
if(ord=X.U8(1),!ord||ord>=128)return!1
if(ptn=X.U8(2),!ptn)return!1
if(smp=X.U8(3),smp>32)return!1
if(opl=X.U8(4),lp=X.U8(5),lp>ord)return!1
if(smpp=X.U32(6),smpp>X.Sz())return!1
for(p=10,E=0;E<ord;E++)if(X.U8(p++)>=ptn)return!1
for(ptnpt=p,p+=4*ptn,E=smpsz=0;E<smp;E++,p+=16){if(X.U32(p))return!1
var s=X.U32(p+4),e=X.U32(p+8),t=X.U32(p+12)
if(!s||s>1048575)return!1
if(smpsz+=s,t<1048575&&(t>s||e>t))return!1}for(E=0;E<opl;E++,p+=11){if(240&X.U8(p))return!1
if(252&X.U8(p+5))return!1
if(252&X.U8(p+10))return!1}for(E=notes=0,ptnp=p,bad=!1;E<ptn;E++){if(p=ptnp+X.U32(ptnpt+4*E),p>smpp-3)return!1
if(E>=ptn-1?ptnend=smpp:ptnend=ptnp+X.U32(ptnpt+4*E+4),!isWithin(ptnend-p,3,4096))return!1
for(r=0;p<ptnend;){var n=X.U8(p++)
if(n<=12)p+=2,notes++
else if(n>=32&&n<=44)p++
else{if(64!=n){if(96==n)break
return!1}r+=X.U8(p++)}}if(r>64)return!1}return sz=smpsz+smpp,opl+smp>0}()&&(sName="CDFM/Composer 670 module (.670)",sVersion="compact",bDetected=1,bad&&(sVersion="malformed!badptn"),X.isVerbose()&&sOption("spd:"+spd+" ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" smp:"+smp+" fm:"+opl+" notes:"+notes+" sz:"+outSz(sz))),!bDetected&&function(){if(X.Sz()<136)return!1
if((mode=X.U8(0))>2)return!1
if(X.U8(1)>31&&208!=X.U8(1))return!1
if(X.U8(2)<66||X.U8(2)>67)return!1
if((tempo=X.U8(3))<3||tempo>31||135&(ptnsz=X.U8(4)))return!1
for(E=5;E<14;E++)if(X.U8(E)>4)return!1
if((regbd=X.U8(14))>2)return!1
if(!(ins=X.U16(15))||ins>63)return!1
for(p=17;p<17+46*ins;p+=46){if(X.U8(p+4)>3&&225!=X.U8(p+4)||X.U8(p+9)>4)return!1
if(X.U8(p+10)>127||192&X.U8(p+12))return!1
if(!isWithin(X.I8(p+21),-48,48)||!isWithin(X.I8(p+23),-48,48))return!1
if(!isWithin(X.I8(p+27),-48,48)||!isWithin(X.I8(p+32),-48,48))return!1
if(X.U8(p+36)>48||X.U8(p+37)>1||!isWithin(X.I8(p+39),-4,0))return!1
if(isInside(X.U8(p+43),48,232)||X.U16(p+44))return!1}if(ord=X.U16(p),!ord||ord>96)return!1
for(p+=2,mp=-1,ptnp=p+9*ord*3+2,E=0;E<ord;E++)for(j=0;j<9;j++){if(pt=X.U16(p),pt%2||pt+ptnp>X.Sz()||pt>16384)return!1
mp<pt&&(mp=pt),p+=3}return digisnd=X.U16(p),p+=2,sz=ptnp+digisnd,!(X.Sz()<sz)&&(ptn=Util.divu64(digisnd,2),!0)}()&&(sName="Loudness Sound System Ad Lib module (.LDS)",bDetected=1,X.isVerbose()&&sOption("ch:9 mode:"+mode+" spd:"+X.U16(1)+" tempo:"+tempo+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" sz:"+outSz(sz))),!bDetected&&function(){for(E=0;E<4;E++)if(!isWithin(X.U8(E),0,87))return!1
for(;E<11;E++)if(X.U8(E))return!1
for(;E<16;E++)if(X.U8(E)<251)return!1
for(;E<32;E++)if([240,4,6,8,12].indexOf(X.U8(E))<0)return!1
for(c=0;E<37;E++){if(X.U8(E)>5)return!1
X.U8(E)||c++}if(c>3)return!1
for(;E<42;E++)if(X.U8(E))return!1
for(;E<48;E++)if(X.U8(E)>1)return!1
for(E=64;E<80;E++)if(!isWithin(X.U8(E),32,63))return!1
return!!X.c("32323232 323232",68)}()&&(sName="Ken Silverman's Adlib module (.KSM)",bDetected=1,X.isVerbose()&&sOption("notes:"+(notes=X.U16(80))+" sz:"+outSz(82+4*notes))),!bDetected&&function(){if(X.Sz()<464||32!=X.U8(35))return!1
if((bin=parseAtariBinary())[0]<470)return!1
if(255!=X.U8(bin[1][0][1]+5))return outArray(bin,16),!1
if(!isWithin(spd0=X.U8(36),1,16)||!isWithin(ticks=X.U8(37),1,4))return spd0,ticks,!1
for(ins=t0=0,p0=65536,p=38;p<102;p++)if(X.U8(p)||X.U8(p+64)){if([0,9].indexOf(15&X.U8(p))<0)return!1
if(t=(X.U8(p+64)<<8)+X.U8(p)+6-X.U16(2),t<0||t<=t0)return t,!1
if(t0=t,t>0){if(!isWithin(t,416,bin[1][0][1]+6))return t,!1
ins++,p0>t&&(p0=t)}}if(!ins)return p0,!1
if([0,9].indexOf(15&X.U8(166))<0)return p0,!1
for(ptn=t0=0,p=166;p<294;p++){if(t=(X.U8(p+128)<<8)+X.U8(p)-X.U16(2)+6,p0>t&&(p0=t),t<0||t<=t0)return t,!1
if(t0=t,t&&!isWithin(t,416,bin[1][0][1]+6))return t,!1
t&&255!=X.U8(t)&&ptn++}for(ord=p0-422>>4,p=423,pt=-1,ic=0;p<p0;p+=2)X.c("FF",p)||X.c("7F",p)||(X.U8(p)>127?ic++:X.U8(p)>=pt&&(pt=X.U8(p)+1))
return!0}()&&(sName="Marcin 'Jaskier' Lewandowski's Theta Music Composer (.TMC,.TM4,.TM8)",sVersion="v1.x",bDetected=1,ic&&(sVersion=sVersion.appendS("malformed!"+ic+"ptns","/")),X.isVerbose()&&(sOption(decAnsi(6,30,CPATASCII,Chars0to1FATASCII_PL)),sOption("spd0:"+spd0+" ticks:"+ticks+" ord:"+ord+" ptn:"+(pt!=ptn?pt+"/":"")+ptn+" ins:"+ins+" sz:"+outSz(bin[0])))),!bDetected&&function(){if(!X.c("AE")||X.Sz()<121)return!1
p=1,sz=unpsz=-1
var s=end=Q=0,e=Array(65536),r=[-1,-2,-3,-4]
function n(s){return r[Q++]=X.U8(s),Q>3&&(Q=0),r[0]===r[1]===r[2]===r[3]?(end=1,-1):X.U8(s)}function i(s){return delete e,!1}for(;!end&&s<(X.isDeepScan()?65536:256)&&p<Math.min(X.isDeepScan()?65535:256,X.Sz());)if(t=n(p++),174==t){if(c=n(p++),c<0)return i()
if(!c){end=!0
break}if(1===c){e[s++]=174
continue}if(b=n(p++),b<0)return i()
for(;c;c--)e[s++]=b}else e[s++]=t
if((tempo=e[8129])<16)return i()
if(e[8064]||e[8080])return i()
if(s%256)for(;s%256&&32===e[s-1];)s--
if(s%256||X.isDeepScan()&&s<8192||s>65535||p>65535)return i((Hex(s),Hex(p)))
if((modsz=e[8131]+16<<8)!=s)return i((Hex(modsz),Hex(s)))
var a=[4,12]
for(smp=0,E=8065;E<8080;E++)e[E]>=16&&smp++,e[E]>a[0]&&(a[0]=e[E],a[1]=e[E+16])
if((lastsmpend=(a[0]+16<<8)+(a[1]<<8))!=s)return i((Hex(lastsmpend),Hex(s)))
for(notes=ic=0,E=0;E<Math.min(7936,s);E++)e[E]&&240!=e[E]&&(notes++,(240&e[E])==e[E]&&ic++)
if(X.isDeepScan())for(E=8192;E<s;E++)if(e[E]>63)return i(Hex(E))
for(unpsz=s,sz=p,ord=ptn=0,E=7936;E<8064&&e[E];E++)ord++,(pt=e[E]-223)>ptn&&(ptn=pt)
if(ic>ptn<<2)return i(ic)
for(E=8096;E<8128;E++)e[E]&&e[E]<26&&(e[E]+=96)
return ss=decEncoding(e.slice(8096,8112),CPAmiga),composer=decEncoding(e.slice(8112,8128),CPAmiga),delete e,!0}()&&(sName="Polly Tracker module (.MOD)",bDetected=1,X.isVerbose()&&X.isDeepScan()&&(sOptionT(ss),sOptionT(composer,"by:"),sOption("tempo:"+Hex(tempo)+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" notes:"+notes+" unpsz:"+unpsz+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.Sz()<421||!isWithin(unpsz=X.U16(0),782,2849)||!X.c("00000007",2))return!1
var s,e,t=0,p=Math.min(X.Sz(),unpsz),r=new BitReader(4),n=!1,i=0,a=9,o=258,d=[],c=defdictsz=4096,m=[],f=258
for(E=0;E<c-256;E++)m.push({rt:0,cw:0})
var l=[]
for(E=0;E<unpsz;E++)l.push(0)
function u(s){for(var e=s;e>255;)d.push(m[e-256].rt),e=m[e-256].cw
d.push(255&e)}for(;!n&&r.offset<=p&&t<=unpsz;){if(a<9||a>12)return!1
switch(e=r.read(a)){case 256:if(o=258,c=512,f=258,(a=9)<9||a>12)return!1
if(e=r.read(a),t>=unpsz)return!1
l[t++]=255&e
break
case 257:n=!0
break
default:if(u(e<o?e:i),s=255&d[d.length-1],e<o)for(;d.length;){if(t>=unpsz)return!1
l[t++]=255&d.pop()}else{for(;d.length;){if(t>=unpsz)return!1
l[t++]=s,d.pop()}if(e!=o)return!1}f<c&&(m[f-256]={rt:s,cw:i},f++),++o>=c&&a<12&&(a++,c<<=1)}i=e}return!!n&&(sz=r.offset,!(131!=l[0]||l[1]||8&l[2]||32&l[3]||128&l[5]||l[6]>1))}()&&(sName="Ultima 6 Adlib module (.M)",sOption("unpsz:"+unpsz+" sz:"+outSz(sz)),bDetected=1),!bDetected&&function(){if(!isWithin(X.U16(0,_BE),4,16))return!1
if(!isWithin(X.U16(2,_BE),8,32))return!1
if(!isWithin(X.U16(4,_BE),4,48))return!1
if(!isWithin(X.U8(6),1,4)||!X.c("0400000000",7))return!1
if(!X.c("'WT'",12)&&X.U32(12,_BE))return!1
if(!isWithin(X.U8(23),3,119))return!1
if((t=X.U32(24,_BE))>76||3&t)return!1
sz=16
var s=Math.min(X.Sz(),65535)
for(x=0,p=28;p<Math.min(X.Sz()-1,1024);p+=12)if(!isWithin(X.U16(p,_BE),70,108))return!1
for(;sz<s&&X.c("0056",sz);){for(x++,E=0;E<4;E++)for(sz+=2;sz<s&&!X.c("0046",sz);sz+=2);sz+=12
break}return spd0=X.U16(14,_BE),!x||sz<=s}()&&(sName="Illusions/Microdeal Quartet module (QTS.+SMP., .4V+.SET)",sVersion="samples",bDetected=1,X.isVerbose()&&sOption((spd0?"spd0:"+spd0+" ":"")+"sz:"+outSz(sz))),function(){if(X.Sz()<17408)return!1
if(124!=X.U8(256)&&124!=X.U8(287))return!1
if(charStat(X.readBytes(256,32),1).indexOf("allasc")<0)return!1
if(255!=X.U8(516))return!1
if(tempo=X.U8(528),!isWithin(tempo,2,10))return!1
if(ord=X.U8(530)+1,!isWithin(ord,1,101))return!1
if(loop=X.U8(529),loop>=ord)return!1
if(charStat(X.readBytes(768,128),1).indexOf("allasc")<0)return!1
for(sz=16384,E=0;E<8;E++){if(X.U8(192+4*E))return!1
if(!isWithin(X.U8(192+4*E+1),128,192))return!1
if(!isWithin(bnk=X.U8(192+4*E+2),88,95))return!1
if(!isWithin(sec=X.U8(192+4*E+3),1,128))return!1
X.U16(192+4*E)
var s=sec<<8
bnk&=7,sz+=s}if(sz>X.Sz())return!1
for(sz+=1024,title=X.SC(257,30,"CP1251").trim(),E=smp=0;E<16;E++)if(X.U8(288+8*E+4)>1)return!1
for(E=ptn=0;E<100;E++){if((t=X.U8(416+E))>31)return!1
ptn<t&&(ptn=t)}return ptn++,!0}()&&(sName="SQ Digital Tracker module (.SQD,.M)",bDetected=1,X.isVerbose()&&(sOptionT(title),sOption("tempo:"+tempo+" ord:"+ord+(loop?" loop:"+loop:"")+" ptn:"+ptn+" sz:"+outSz(sz)))),!bDetected&&function(){if(X.U8(0)||!X.c("00000200",12))return!1
for(p=16,ptn=0;p<4112&&-1!=X.I32(p);p+=2){if(X.U8(p))return!1
X.U8(p+1)>ptn&&(ptn=X.U8(p+1))}for(ptn++,ord=p-16>>3,d2=p,p=4112+48*ptn;p<Math.min(X.Sz(),196608)&&!X.U32(p,_BE);)p+=4
if(!X.c("'FORM'........'8SVXVHDR'",p+640))return!1
for(smptp=p,smp=0,smps="",E=32,sz=0;E--;p+=4)if(!X.U8(p)){var s=smptp+X.I32(p,_BE),e=X.I32(p+128,_BE)
if(s<640||!X.c("'FORM'........'8SVXVHDR'",s))return!1
smp++,s+e>sz&&(sz=s+e)}return!0}()&&(sName="Michael Winterberg's Speedy A1 System module (.SAS)",bDetected=1,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz))),!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<720||X.Sz()>65535)return!1
for(p=0,nV=4,ofs=500,E=0;E<250;E++)if(w=X.U16(p,_LE),p+=2,500<=w&&w<65535){nV=3,ofs=120
break}p=ofs
var s=!0
if(nV<4)for(nprog=150,E=0;E<nprog;E++){if(w=X.U16(p,_LE),p+=2,w){if(s=!1,65535!=w&&w+ofs>X.Sz())return!1
if(w<600)return!1
if(w<1e3&&(nV=1,600!=X.U16(120,_LE)))return!1}if(nV>1){if(X.Sz()<1120)return!1
for(nprog=250,E=150;E<nprog;E++)if(w=X.U16(p,_LE),p+=2,w){if(s=!1,65535!=w&&(w+ofs>X.Sz()||ofs<nprog))return!1
if(w<1e3)return!1}}}else{if(X.Sz()<2500)return!1
for(nprog=500,E=0;E<nprog;E++)if(w=X.U16(p,_LE),p+=2,w){if(s=!1,65535!=w&&(w+ofs>X.Sz()||ofs<nprog))return!1
if(w<2e3)return!1}}return!s}())switch(sType="~audio",sName="Westwood ADL module (.ADL)",bDetected=1,nV){case 1:sVersion="v1"
break
case 3:sVersion="v2.x"
break
case 4:sVersion="v3"}if(!bDetected&&X.isDeepScan()&&function(){if(X.Sz()<6)return!1
if(postp=X.U16(0),orntp=X.U16(2),smptp=X.U16(4),ptnp=6,smp=postp-smptp,smp<0||3&smp)return!1
if(smp>8192)return!1
if(smp>>=1,b=orntp-16,b<0)return!1
const s=X.Sz()-1
for(;;){var e=smptp+2-b
if(e>X.Sz()+6)return!1
if(isWithin(e,8,s)&&isWithin(p1=X.U16(e)-b,8,s)&&isWithin(t=X.U16(e-4)-b,6,s)&&p1-t==32&&isWithin(pb=X.U16(ptnp+2)-b,22,s)&&isWithin(pa=X.U16(ptnp)-b,21,s)&&!X.U8(pa-1)){for(;pa<s&&255!==X.U8(pa);)for(;pa<s&&(bt=X.U8(pa++),!(bt<=95||128==bt||129==bt))&&(isWithin(bt,130,142)&&pa++,!(pa>s)););if(pa+1==pb)break}if(b--,b<0)return!1}if(postp-=b,smptp-=b,orntp-=b,!isWithin(postp,16,s)||1&smptp)return!1
if(sz=X.U16(postp-2)-b+96,!isWithin(sz,postp+1,X.Sz()+1))return!1
if(orn=smptp-orntp,1&orn)return!1
if(orn>>=1,255!=X.U8(X.U16(smptp+2)-b-32*orn-1))return!1
if(ptn_=orntp-ptnp,ptn_%6)return!1
for(ptn_/=6,ord=ptn=0,E=postp+1;X.U8(E);E++)ord++,X.U8(E)>ptn&&(ptn=X.U8(E))
return!0}()&&(sName="Flash Tracker module (.FLS)",bDetected=1,X.isVerbose()&&(sOption(Hex(b),"@"),sOption("ord:"+ord+" ptn:"+ptn+(ptn_!=ptn?"/"+ptn_:"")+" smp:"+smp+" orn:"+orn+" sz:"+outSz(sz)))),X.isHeuristicScan()){if(extIs("imf")||extIs("wlf")?(extIs("imf")?freq="560Hz (or 280Hz if Duke Nukem II)":freq="700Hz",_setResult("~audio","id/Apogee Music Format chiptune (.IMF)","","freq: "+freq)):extIs("svar")&&X.c("'PK'")&&_setResult("~audio","SVArTracker module (.SVAR)","",""),X.c("8400")?(240==X.U8(2)?sversion="adv.":sversion="",_setResult("~audio","Sierra Adlib chiptune (.SCI)",sversion,"")):X.c("1C52")?_setResult("~audio","Sound Interface System module (.LEM)","",""):X.c("'NED'")?_setResult("~audio","Nerd Tracker ][ module (.NED)","",""):X.c("'MODU'")?_setResult("~audio","NovoTrade Packer module (.NTP)","",X.isVerbose()?X.SA(4,16):""):(X.c("'Ice!'")||X.c("'ICE!'"))&&(dsize=X.U32(8,_BE),_setResult("~audio","Atari ST module (.SND,.SNDH)","compressed",X.isVerbose()?"orig.sz:"+dsize+" sz:"+outSz(X.U32(4,_BE)):"")),hdr=X.SA(0,2),!(["AY","YM","ay","ym"].indexOf(hdr)<0||X.U8(2)>6)&&(hasyear=["AY","YM"].indexOf(hdr)<0,yr=0,!(hasyear&&(yr=X.U16(10,_LE),yr&&(yr<1980||yr>2050)))&&(unpsz=X.U32(hasyear?12:10,_LE),!(unpsz<2||unpsz>10485760)&&(chipfrq=X.U32(5,_LE),!(chipfrq<8e5||chipfrq>4e6)&&(intfrq=X.U8(9),1))))){switch(X.U8(2)?sversion="2ch":sversion="1ch",hdr){case"AY":case"ay":sversion+=" AY-3-8910/12"
break
case"YM":case"ym":sversion+=" YM2149"
break
default:sversion+=" unk.chip"}X.isVerbose()&&(p=hasyear?16:14,t=X.SC(p,Math.min(256,X.Sz()-p),"CP1251"),sOptionT(t),p+=t.length+1,a=X.SC(p,Math.min(256,X.Sz()-p),"CP1251"),sOptionT(a,"by:"),p+=a.length+1,hasyear&&(yr&&sOption(yr,"'"),pr=X.SC(p,Math.min(256,X.Sz()-p),"CP1251"),p+=pr.length+1,sOptionT(pr,"for:"),tn=X.SA(p,Math.min(256,X.Sz()-p)),sOptionT(tn,"in:"),p+=tn.length+1,c=X.SA(p,Math.min(256,X.Sz()-p)),sOptionT(c)),sOption((7&X.U8(2)).toString(2).padStart(3,"0"),"mode:"),sOption(chipfrq,"chip freq:","Hz"),sOption(intfrq,"int.freq:","kHz"),t=Util.div64(unpsz,14*intfrq),sOption("time:"+secondsToTimeStr(t)),loop=X.U16(3,_LE),loop&&sOption(loop,"loop:")),_setResult("~audio","Vortex Project chiptune (.VTX)",sversion,sOptions),sOptions=""}if(function(){if(X.Sz()<768||X.Sz()>16793599)return!1
sz=en=0,nonzeroaddr=-1
var s=4294967295,e=[]
for(sus=0,bad="",E=0;8*E<(4294967295==s?768:Math.min(s,X.Sz()));E++){var t=X.U32(8*E,_BE),p=X.U32(8*E+4,_BE)
if(t){if(t<8*E||p>1048575)return!1
nonzeroaddr<0&&(nonzeroaddr=E),s>t&&t>=768&&(s=t),e.push([t,p]),en++,t+p>sz&&(sz=t+p)}}return!(!en||findGaps(e,2).length>4)&&!((e=e.sort((function(s,e){return s[0]!=e[0]?s[0]-e[0]:s[1]-e[1]})))[0][0]%8||!isWithin(e[0][0],768,16384))}()&&(sversion="",sz>X.Sz()&&!X.isVerbose()&&(bad+="!short"),bad.length&&(sversion=sversion.appendS("malformed"+bad+(sus?"sus"+sus:""),"/")),_setResult("~audio","Konami's MXDRV PCM resource (.PDX)",sversion,X.isVerbose()?"entries:"+en+" sz:"+outSz(sz):"")),X.Sz()<12||X.U32(0,_LE)||(numnotes=X.U32(4,_LE),!numnotes||numnotes>8192||(numtracks=X.U32(8,_LE),!numtracks||numtracks>256||(sz=12+4*numtracks+11*numnotes,sz!=X.Sz()&&sz!=X.Sz()+numnotes)))||(sz>X.Sz()?sversion="no panning effects":sversion="",_setResult("~audio","Ken Silverman's Digital Music module (.KDM)",sversion,X.isVerbose()?"trk:"+numtracks+" notes:"+numnotes:"")),function(){if(X.Sz()<111104)return!1
if(lp=X.U8(0),lp>63)return!1
for(ptn=0,E=1;E<100;E++){if(pt=X.U8(E),pt>31)return!1
pt>ptn&&(ptn=pt)}if(ptn++,tmp=X.U8(100),ord=X.U8(101),!ord||ord>100)return!1
if(lp>ord)return!1
for(title=X.readBytes(102,28),E=0;E<28;E++)if(title[E]<32||title[E]>127)return!1
for(title=decEncoding(title,CPSpeccy),compiled=!isAllZeroes(200,56),allsmp=smp4bit=0,smps=[],p=256;p<512;p+=16){X.U16(p),X.U16(p+2),X.U8(p+4),X.U8(p+5),X.U16(p+6)
for(E=8;E<16;E++)if(X.I8(p+E)<32)return!1
t=decAnsi(p+8,8,CPSpeccy,!1).trim(),""!=t&&smps.push(t)}return!0}()&&(D="Underground Systems Digital Studio module (.DST)",sversion=compiled?"compiled":"",X.isVerbose()?(sOptionT(title),sOptionT(smps.join(" "),'smp/msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+(lp?" loop:"+lp:"")+" page0:"+X.U8(512)+" sz:"+outSz(compiled?115200:111104)),bs=sOptions,sOptions=""):bs="",_setResult("~audio",D,sversion,bs)),function(){if(X.Sz()<112640)return!1
if((lp=X.U8(0))>63)return!1
if((tmp=X.U8(1))<3||tmp>15)return!1
if((ord=X.U8(2))>64)return!1
for(title=X.readBytes(3,30),E=0;E<30;E++)if(title[E]<32||title[E]>127)return!1
for(title=decEncoding(title,CPSpeccy),ptn=0,p=34;p<134;p++){if((pt=X.U8(p))>31)return!1
pt>ptn&&(ptn=pt)}for(ptn++;p<166;p++){var s=X.U8(p)
if(s<4||s>64)return!1}var e=[81,83,84,86,87]
for(E=0;p<186;E++,p+=4){if(X.U8(p)>124)return!1
if(X.U8(p+1)!=e[E])return!1
if(X.U8(p+2)&&X.U8(p+2)<132)return!1
if(X.U8(p+3)>16)return!1}var r=0
for(p=188;p<203;p++)X.U8(p)&&r++
if(r>3)return!1
var n=X.readBytes(203,53,!0)
if(charStat(n,!0).indexOf("allasc")<=0)return!1
if(X.U8(255))return!1
for(smps=[],p=256;p<512;p+=16){if(e.indexOf(X.U8(p+4))<0)return!1
if(X.U8(p+5)>16)return!1
if(X.U8(p+6)>124)return!1
for(t=X.readBytes(p+8,8),E=0;E<8;E++)if(t[E]<32||t[E]>127)return!1
t=decEncoding(title,CPSpeccy).trim(),""!=t&&smps.push(t)}}()&&(D="Red Limited's Extreme Tracker module (.ET1)",X.isVerbose()?(sOptionT(title),sOptionT(smps.join(" "),'smp/msg:"','"'),sOption("tmp0:"+tmp+" ord:"+ord+" ptn:"+ptn+(lp?" loop:"+lp:"")+" sz:"+outSz(112640)),bs=sOptions,sOptions=""):bs="",_setResult("~audio",D,sversion,bs)),function(){if(!X.c("4EFA....4EFA....4EFA"))return!1
var s=X.U16(2,_BE)
return!(s>X.Sz()-10)&&X.c("4BFA.... 08AD 0000",s+2)}()&&_setResult("~audio","Maniacs of Noise module (.MON)","",""),function(){if(X.Sz()<128)return!1
for(oldp=smp=0,E=0;E<128;E+=8){if(p=X.U16(E,_BE),p>X.Sz())return!1
if(p){if(p<oldp)return!1
oldp=p,smp++}if(!X.c("0010 01000000",E+2)&&!X.c("0000 00000000",E+2))return!1}return!(smp<8)}()&&_setResult("~audio","Jochen 'Mad Max' Hippel's Atari ST sample set (SMP.set)","",X.isVerbose()?"smp:"+smp+" sz:"+outSz(oldp):""),!bDetected&&X.isDeepScan()&&function(){if(notes=chs=0,X.Sz()<480)return!1
if(timediv=X.U32(0,_LE),!timediv||[96,128,480].indexOf(timediv)<0)return!1
if(maxtime=X.U32(4),!maxtime)return!1
if(gdnum=X.U32(8),!gdnum)return!1
p=12+10*gdnum
var s=pbs=ccs=0
for(ch=0;ch<16;ch++){if(notenum=X.U32(p),p+=4,notes+=notenum,notenum>1e6)return!1
if(notenum){if(chs++,p+=5*notenum,p>X.Sz())return!1
for(pcnum=X.U32(p),s+=pcnum,p+=4+4*pcnum,pbnum=X.U32(p),pbs+=pbnum,p+=4+5*pbnum,cn=0;cn<7;cn++)ccnum=X.U32(p),ccs+=ccnum,p+=4+4*ccnum}if(p>X.Sz())return!1}if(!notes||ccs>50*notes||pbs>3*notes||s>3*notes||maxtime<notes)return!1
if(size=X.U32(p),size>16384)return!1
if(p+=4+size,p>X.Sz())return!1
if(size=X.U32(p),size>1048576)return!1
if(p+=4+size,p>X.Sz())return!1
if(spsize=X.U32(p),p+=4,spsize<8192){for(E=p+4,U=4*X.U32(p),t=Math.min(X.Sz,p+4+U);E<t;E+=4)if(!isWithin(X.U32(E),U,p-4+spsize))return!1
p+=spsize}return sz=p,!0}()&&(sName="farbrausch V2 Synthesizer module (.V2M)",bDetected=1,X.isVerbose()&&(sOptions="ch:"+chs+" notes:"+notes+" timediv:"+timediv+" maxtime:"+maxtime+(spsize?" syn.speech":"")+" sz:"+outSz(sz))),!X.c("01000000",6)||X.Sz()<1500||X.Sz()>9e3||X.calculateEntropy(12,1200)<7.8||_setResult("~audio","TwinTeam's Twin Trackplayer module (.DMO)","",X.isVerbose()?"unp.sz:"+X.U16(12):""),function(){for(bs="",smp=ptn=smpsz=0,E=0;E<32;E++){if(charStat(t=X.readBytes(32*E,16),1).indexOf("allxsc")<0)return!1
var s=t.indexOf(0)
if(s){if(s<0)return!1
for(j=15;j>s&&!t[j];)j--
if(j>s)return!1
var e=X.U32(32*E+20,_BE)
e&&(smpsz+=e,smp++)}}if(tmp0=X.U8(1152),ord=X.U8(1153),!smpsz||!tmp0||tmp0>15||!ord||ord>128)return!1
for(E=0;E<ord;E++)(t=X.U8(1154+E)+1)>ptn&&(ptn=t)
if(ptn>32)return!1
for(;E<128;E++)if(X.U8(1154+E))return!1
return sz=1282+2048*ptn+smpsz,!(X.Sz()<sz)&&(bs="tmp0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(sz),!0)}()&&_setResult("~audio","SHINING 8's Voices_8/8CHNL Soundtracker module","",X.isVerbose()?bs:""),function(){if(X.Sz()<2739||X.Sz()>59188)return!1
for(ptn=ord=0,p=1536;p<1587&&255!=(t=X.U8(p));p++)if(128&t&&t<=176){if(t&=63,t+=1536,t>1586||255==X.U8(t)||t==p)return!1}else ptn<t&&(ptn=t),ord++
if(!ord)return!1
if(ptn++,1587==p||ptn>50)return!1
for(p=1587,sz=p+1152*ptn,E=0;E<576*ptn;E++){if(n=X.U8(p++),m=X.U8(p++),isWithin(m,7,15)&&128!=n)return!1
if(isWithin(m,112,159))return!1}return!0}()){var bs=""
X.isVerbose()&&(x>1&&(bs="×"+x),bs=bs.appendS("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(sz),", ")),_setResult("~audio","Hannes Seifert's HSC Adlib Composer/ECR HSC-Tracker module (.HSC)","",bs)}X.Sz()<4||parseMDGYM()<0||_setResult("~audio","Sega Genesis/Mega Drive YM2612 chiptune (.GYM)","headerless",""),function(){if(X.Sz()<Math.max(X.U16(30),48))return!1
var s
for(ch=0,E=oldp=0;E<16;E++){if(!isWithin(s=X.U16(2*E),Math.max(48,oldp),X.Sz()))return!1
if(E&&128!=X.U8(s-1))return!1
128!=X.U8(s)&&ch++,oldp=s}return!0}()&&_setResult("~audio","K.Ohshima's FMX chiptune (.FMX)","",X.isVerbose?"ch:"+ch:"")}return result()}