function detect(){if(X.c("'A2R1'FF0A0D0A ................'DATA'")||X.c("'A2R'..FF0A0D0A 'INFO'")&&isWithin(X.U8(3),50,51)){for(sName="Apple II Applesauce disk archival image (.A2R)",sVersion="v"+X.SA(3,1),(v1=X.c("'1'",3))?(bDetected=!0,w=16):w=8,meta=I="";w<X.Sz();){var e=X.SA(w,4),a=X.U32(w+4,v1?_BE:_LE)
switch(w+=8,e){case"INFO":if(v1)meta=X.SC(w,a,"UTF8").replace(/\x0A/g,",").replace(/\x09/g,":")
else{switch(iV=X.U8(w),bDetected=!0,X.U8(w+33)){case 1:dim='5¼" SS 40trk 0.25 step'
break
case 2:dim='3½" DS 80trk Apple CLV'
break
case 3:dim='5¼" DS 40trk'
break
case 4:dim='5¼" DS 80trk'
break
case 5:dim='3½" DS 80trk'
break
case 6:dim='8" DS'
break
case 7:dim='3" DS 80trk'
break
case 8:dim='3" DS 40trk'
break
default:dim="?"}sOption("disk:"+dim),1==X.U8(w+34)&&sOption("write-protected"),iV>=2&&((r=X.U8(w+42))&&sOption(r,"min.RAM:","k"),r="",(g=X.U16(w+40))||(r="?"),1&g&&(r=r.append("][")),2&g&&(r=r.append("][ Plus")),4&g&&(r=r.append("//e")),8&g&&(r=r.append("//c")),16&g&&(r=r.append("//e Enhanced")),32&g&&(r=r.append("IIgs")),64&g&&(r=r.append("//c Plus")),128&g&&(r=r.append("///")),256&g&&(r=r.append("/// Plus")),sOption(r,"for Apple "))}break
case"DATA":case"STRM":case"RWCP":case"SLVD":break
case"META":meta=X.SC(w,a,"UTF8").replace(/\x0A/g,",").replace(/\x09/g,":")}w+=a}w>X.Sz()&&(I=I.addIfNone("!short")),""!=I&&(sVersion=sVersion.appendS("/malformed"+I,"/")),X.isVerbose()&&(sOptionT(addEllipsis(meta),'info:"','"'),sOption(outSz(w),"sz:"))}else if(X.c("'AT8X'")&&isWithin(t0p=X.U32(28),36,64)&&X.c("0000",t0p+4)&&isWithin(t0sz=X.U32(t0p),(t0hdsz=X.U32(t0p+20))+X.U32(t0p+t0hdsz),4096)&&isWithin(t0sec=X.U16(t0p+10),1,40)&&X.U32(t0p+t0hdsz)==8+8*t0sec){if(sName="Atari VAPI/ATX disk image (.ATX)",sVersion="v"+X.U16(4),bDetected=!0,X.isVerbose()){for(p=0,w=t0p,sec=0;p<40&&w<X.Sz();p++,w+=X.U32(w))sec+=X.U16(w+10)
sOption("trk:"+p+" sec.total:"+sec+" sz:"+outSz(w))}}else if(X.c("'<BALLY format=1>'")&&X.c("'</BALLY>'",(S=X.U16(17,_LE))-8))sName="Bally Arcade/Astrocade BASIC tape (.BIN)",bDetected=!0,X.isVerbose()&&sOption(outSz(S),"sz:")
else if(X.c("0E0000800E..FFFE........FFFFFFFF020000000200..FFFFFFFFFE")&&[31,47].indexOf(X.U8(5))>=0&&[31,127].indexOf(X.U8(353))>=0)sName="Casio Loopy (big-endian) cartridge (.BIN)",bDetected=!0
else if(X.c("4C....4C....01'CBM::::::::'")&&X.c("FF",13118)&&X.c("FF",14720))sName="Commodore Plus/4 cartridge (.BIN)",bDetected=!0
else if(X.c("000003",8)&&X.c("'DMC '",256)&&X.c("'                                GM 00000000-00'",352))sName="AtGames/中娛/愛勝 Firecore digital media cartridge (.BIN)",bDetected=!0
else if(X.c("F50400")&&X.c("04",2048)&&X.c("8383",2056)&&4096==F.Sz())sName="Entex Adventure Vision cartridge (.BIN)",bDetected=!0
else if(!X.c("55..40..40....00")&&!X.c("5512521252B0")||X.U8(1)!=X.U8(3)||8192!=X.Sz()&&16384!=X.Sz())if(X.c("BBA56EB3E9C5A7A4CCB3D7B2CFA8CEA5CCAAA3A46FB1EFB9BBA56EB3E9C569B6E6A6F4A5F3A6CFA456A675A47BB5'r(vereese gnniee)rB'A1CFA4D5B2B6C442A1CFA473BDB6C4CEA9F3A7EFA7BBA56EB3E9C5ECAD6CA97BB5A1A65DB370AD57A4EFB96EB3E9C5BAAAEAC277A950BBD1B8A3B0EAC277A9'rTdamera kybU inet diMrceoeltcorinscC ro.pa dnF nuethcE tnreatniemtnC ro.pA llr gith seresvrde .iLecsn esip reimttde'002E",8192)||X.c("1E00E32AE401E501 E601E7011B48E801 E901EAC401300EEB 01B426ECEED26401 EF26F00108604E30 F201F301F4010128"))sName="Funtech Super Acan cartridge (.BIN)",bDetected=!0
else if(!(X.c("AA04FFFF68FF")||X.c("AA4E840D196900")||X.c("AA544E85706A90")||X.c("AA54E9A7640202")||X.c("AAC0BA69004DCC")||X.c("AA694169146914"))||!isWithin(X.Sz(),8192,32768)||4095&X.Sz())if(X.c("'ZPJ'")&&X.c("0003....0003",24)&&"allnum"==charStat(X.SA(3,3))&&charStat(X.SA(6,13),!0).indexOf(!1)){if(sName="Konami Picno image (.BIN)",bDetected=!0,sOption(charStat(X.SA(3,3))),X.isVerbose()){for(var r=X.SA(3,13);r.length&&"+"==r[r.length-1];)r=r.slice(0,r.length-1)
sOption(r)}}else if(X.c("'Copyright LeapFrog     '00..01010000000080",256))sName="Leapfrog Leapster Learning Game System image (.BIN)",bDetected=!0,X.fSig(1,4096,"'Lil ducked.  The jet zipped past her head.  Dust flew, Lil sneezed, and Leap turned red.  Then Lil got up, about to yell.  Leap gasped, \"Look, Lil!  Your tooth!  It fell!\"'")?sVersion="Approved Content":sVersion="unapproved content"
else if(7&X.Sz()||!((r=X.fSig(0,4096,"1FA6DEBACC137D74"))>=0)||7&r){if(X.c("00000000'Root-CPCA00000108-CP00000110'00000000000000000000000000000000000000000000000000000000000000000000000000",10324))sName="iQue (N64 for China) CMD (.CMD)",bDetected=!0
else if(X.c("803712400000000F80....00000014")&&X.c("AD0000",4112)&&X.c("FF",4126))sName="iQue (N64 for China) Z64 image (.Z64)",bDetected=!0
else if(X.c("'C64 CARTRIDGE   '")&&(w=X.U32(16,_BE))>=64&&X.c("'CHIP'",w)){for(bDetected=!0,sName="Commodore 64 cartridge (.CRT)",sVersion="v"+X.U8(20)+"."+X.U8(21).padStart(2,"0"),I="";w<X.Sz()&&X.c("'CHIP'",w);){a=X.U32(w+4,_BE)
var t=X.U16(14,_BE)
if(t>a-16&&(I=I.addIfNone("!badchipsz")),w+a>X.Sz()){if(w+16+t<=X.Sz()){w+=t+16,I=I.addIfNone("!badchunk")
continue}!X.isVerbose()&&w+a>X.Sz()&&(I=I.addIfNone("!short"))}w+=a}if(""!=I&&(sVersion=sVersion.appendS("malformed"+I,"/")),X.isVerbose()){switch(sOption(X.SC(32,32,"Shift_JIS")),X.U16(22,_BE)){case 0:hw="normal cartridge"
break
case 1:hw="Action Replay"
break
case 2:hw="KCS Power Cartridge"
break
case 3:hw="Final Cartridge III"
break
case 4:hw="Simons Basic"
break
case 5:hw="Ocean type 1"
break
case 6:hw="Expert Cartridge"
break
case 7:hw="Fun Play, Power Play"
break
case 8:hw="Super Games"
break
case 9:hw="Atomic Power"
break
case 10:hw="Epyx Fastload"
break
case 11:hw="Westermann Learning"
break
case 12:hw="Rex Utility"
break
case 13:hw="Final Cartridge I"
break
case 14:hw="Magic Formel"
break
case 15:hw="C64 Game System/System 3"
break
case 16:hw="WarpSpeed"
break
case 17:hw="Dinamic"
break
case 18:hw="Zaxxon, Super Zaxxon (SEGA)"
break
case 19:hw="Magic Desk/Domark/HES Australia"
break
case 20:hw="Super Snapshot 5"
break
case 21:hw="Comal-80"
break
case 22:hw="Structured Basic"
break
case 23:hw="Ross"
break
case 24:hw="Dela EP64"
break
case 25:hw="Dela EP7x8"
break
case 26:hw="Dela EP256"
break
case 27:hw="Rex EP256"
break
case 28:hw="Mikro Assembler"
break
case 29:hw="reserved"
break
case 30:hw="Action Replay 4"
break
case 31:hw="StarDOS"
break
case 32:hw="EasyFlash"
break
default:hw="?"}sOption("hw.type: "+hw+" /EXROM:"+(X.U8(24)?"inactive":"active")+" /GAME:"+(X.U8(25)?"inactive":"active")+" sz:"+outSz(w))}}}else sName="Microsoft MSX tape image (.CAS)",bDetected=!0
else sName="Hartung Game Master cartridge (.BIN)",bDetected=!0
else sName="Epoch ゲームポケコン/Game Pocket Computer cartridge (.BIN)",bDetected=!0
if(!bDetected&&function(){if(X.Sz()<204800||!X.c("0100",82)||!isWithin(R=X.U8(0),1,63))return!1
if(W=X.SC(1,R,"CP1252"),charStat(W,!0).indexOf("allxsc")<0)return!1
if(R!=X.U8(1144)||W!=X.SC(1145,X.U8(1144),"CP1252"))return!1
var e=X.U32(64,_BE),a=X.U32(68,_BE)
if(!isWithin(e,204800,2097152)||a&&12*e/512!=a)return!1
if(!a&&X.U32(76,_BE))return!1
switch(S=84+e+X.U32(68,_BE),discszt=Util.divu64(e,1024)+"k",X.U8(80)){case 0:discszt+=" GCR CLV ssdd"
break
case 1:discszt+=" GCR CLV dsdd"
break
case 2:discszt+=" MFM CAV dsdd"
break
case 3:discszt+=" MFM CAV dshd"
break
default:discszt+=" unk.type"}return!0}()&&(sName="Apple DiskCopy 4.2 disk image (.DC42)",sVersion=discszt,bDetected=!0,X.isVerbose()&&(sOption(W),sOption(outSz(S),"sz:"))),!bDetected)if(X.c("'ACT Apricot disk image'1A04")&&isAllZeroes(24,88)){sName="Jonathan Marsters's ACT/Apricot PC ApriDisk image (.DSK)",bDetected=!0
var n=sec=0,o=!1,k=by=""
for(w=128;w<X.Sz();){e=X.U32(w)
var d=X.U16(w+6)
a=X.U32(w+8)
switch(e){case 3810328576:break
case 3810328577:(r=X.U8(w+13))>sec&&(sec=r),(r=X.U16(w+14)+1)>n&&(n=r)
break
case 3810328578:k=X.SA(w+d,a)
break
case 3810328579:by=X.SA(w+d,a)
break
default:o=!0}if(o)break
if(w+=d+a,3810328578==e)break}X.isVerbose()?(sOption(k),sOption(by,"by: "),sOption("cyl:"+n+" sec:"+sec+" sz:"+outSz(w))):w>X.Sz()&&(sVersion="malformed!short")}else(X.c("'EXTENDED CPC DSK File'0D0A'Disk-Info'0D0A")||X.c("'MV - CPCEMU Disk-File'0D0A'Disk-Info'0D0A")||X.c("'MV - CPC'"))&&isWithin(p=X.U8(48),20,84)&&isWithin(sd=X.U8(49),1,2)&&X.c("'Track-Info'0D0A000000",256)&&(sName="Amstrad CPC disk image (.DSK)",bDetected=!0,X.c("'E'")?(trksz=0,sVersion="extended"):trksz=X.U16(50)+1,X.isVerbose()&&(sOption(X.SA(34,14)),sOption("trk:"+p+(trksz?" trksz:"+trksz:"")+" sides:"+sd)))
if(!bDetected&&function(){if(!X.c("'EALIB'"))return!1
T=X.U16(5),w=7
for(var e=0;e<T&&w<X.Sz();e++){w+=13
var a=X.U8(w++),s=X.U32(w)
if(w+=4,a>4||!isWithin(s,w,X.Sz()))return!1}return!0}()&&(sName="Electronic Arts Library resource pack",bDetected=!0,X.isVerbose()&&sOption(T,"files:")),bDetected||X.c("'FCSX'")&&X.U32(4)>X.U32(8)&&X.U32(8)<=X.Sz()&&(sName="FCSX zlib format (.FCS)",bDetected=!0,X.isVerbose()&&(sOptions="Zlib @10h, unp.sz:"+X.U32(4)+" sz:"+outSz(X.U32(8)))),function(){if(!X.c("00000000"))return!1
var e=X.U32(4),a=X.U32(8),s=X.U32(12),r=X.U32(16),i=X.U32(20),t=X.U32(24),c=X.U32(28)
return!([16,48,144].indexOf(e)<0||r*i*t*c!=s||(S=a+s)>X.Sz()||a<32)&&(!(16==e&&!isWithin(s,524288,745472)||48==e&&!isWithin(s,1441792,3145728)||144==e&&!isWithin(s,1179648,1310720))&&(info="disc:"+(16==e?"640/720k":48==e?"1.44M":144==e?"1.2M":"?")+" ("+(s/1024).toFixed(1)+"k)",info=info.append("hd:"+t+" cyl:"+c+" sec:"+i+" sz:"+outSz(S)),!0))}()&&(sName="EPSON's PC-98 disk image (.FDI)",bDetected=!0,X.isVerbose()&&sOption(info)),!bDetected)if(X.c("EB0A9090'IPL1'0000001EA08405B48ECD1BA8",4096)&&X.c("E9D102'                                                                                NEC 'CADFB0BFC5D9BADDCBDFADB0C08CC592E8836683428358834E8B4E93AE8381836A8385815B8376838D834F8389838020CADEB0BCDEAEDD' 2.'....' Copyright (C) NEC Corporation 1985,'",5120))sName="NEC PS-98 hard disk image (.HDI)",bDetected=!0
else if((X.c("EB1C904E")||X.c("EB2790B1")||X.c("EB279028")||X.c("EB3C9027")||X.c("EB3C904E"))&&X.c("000401010002C000D004FE0200080002000000",11)||X.c("EB..90")&&1261568==X.Sz())sName="NEC PC-98 disk image (.HDM)",bDetected=!0
else if(X.c("'HXCPICFE'")&&isWithin(sides=X.U8(10),1,2)&&isWithin(baud=1e3*X.U16(12),15e4,3e6)&&(O=X.U8(17))<=1){if(sName="HxC PIC/HFE disk image (.HFE)",sVersion="rev."+X.U8(8),bDetected=!0,X.isVerbose()){const e=["ISO IBM MFM","Amiga MFM","ISO IBM FM","emulated FM","unk."],a=["IBM PC DD","IBM PC HD","Atari ST DD","Atari ST HD","Amiga DD","Amiga HD","Amstrad CPC DD","generic Shugart DD","IBM PC ED","MSX2 DD","Commodore 64 DD","emulated Shugart"]
var p=X.U8(9),l=X.U8(16),S=(r=X.U8(11),512),f=0
for(w=512,trkenc=r>3?e[4]:3&e[r],l=l<=11?a[l]:"unk.",i=0;i<p&&w<X.Sz();i++,w+=4)f+=r=X.U16(w+2)
r=511&r?512+(4294966784&r):r,S=512*X.U16(w-4)+r,sOption("trk:"+p+(2==sides?" DS":" SS")),sOption(trkenc,"trkenc:"),sOption(l,"floppy mode:"),sOption(O?"write-protected":""),sOption(baud+" baud = "+(baud/8192).toFixed(1)+"k/s"),sOption("datasz:"+f+" sz:"+outSz(S))}}else if(X.c("'CHKH'........00000000")&&X.c("'CHKH'........01000000",X.U32(4))&&X.Sz()>12)sName="HxC Stream Loader disk track (.hxcstream)",bDetected=!0
else if(X.c("'CAPS'0000000C1CD573BA'INFO'00000060")&&X.c("'IMGE'",108)){switch(sName="SPS's KryoFlux Interchangeable Preservation Format disk image (.IPF)",bDetected=!0,X.U32(72,_BE)){case 0:sVersion="no-platform"
break
case 1:sVersion="Amiga"
break
case 2:sVersion="Atari ST"
break
case 3:sVersion="PC"
break
case 4:sVersion="Amstrad CPC"
break
case 5:sVersion="ZX Spectrum"
break
case 6:sVersion="SAM Coupe"
break
case 7:sVersion="Acorn Archimedes"
break
case 8:sVersion="C64"
break
case 9:sVersion="Atari 8-bit"
break
default:sVersion="unk."}if(sVersion+=1==X.U32(24,_BE)?" floppy":" unk.media",X.isVerbose()){for(w=108,density="",densities=[];w<X.Sz()&&(e=X.SA(w,4),/[A-Z]{4}/.test(e)&&X.c("0000",w+4));){if(a=X.U32(w+4,_BE),"IMGE"===e){switch(X.U32(w+20)){case 3:density="Copylock Amiga"
break
case 4:density="Copylock Amiga new"
break
case 5:density="Copylock ST"
break
case 6:density="Speedlock Amiga"
break
case 7:density="Speedlock Amiga old"
break
case 8:density="Adam Brierley Amiga"
break
case 9:density="Adam Brierley & density key Amiga"}densities.indexOf(density)<0&&densities.push(density)}else"DATA"===e&&(w+=X.U32(w+12,_BE))
w+=a}sOption(X.U32(40,_BE),"rev."),sOption("tracks:"+X.U32(48,_BE)+"-"+X.U32(52,_BE)+" sides:"+(1+X.U32(60,_BE))),sOption(1==X.U32(28,_BE)?"CAPS":2==X.U32(28,_BE)?"SPS":"unk.","encoder:"," rev."+X.U32(32,_BE)),sOption(Hex(X.U32(36,_BE),8),"cat.ID:"),sOption(densities.join(" + "),"copy protection:"),sOption("sz:"+outSz(w))}}else!(X.c("'JFDI'")&&isWithin(tt=X.U32(24),304,X.Sz())&&isWithin(st=X.U32(28),tt,X.Sz())&&isWithin(dt=X.U32(32),st,X.Sz())&&X.c("FFFFFFFF",st-4)&&X.c("FFFFFFFF",dt-8))||(dtt=X.U32(36))&&!isWithin(dtt,dt,X.Sz())||(dst=X.U32(40))&&!isWithin(dst,dt,X.Sz())||(ddt=X.U32(44))&&!isWithin(ddt,dt,X.Sz())?(X.c("'SEGA 32X '",256)||X.c("'SEGA GENESIS'",256))&&X.c("'(C)'",272)&&(sName="Sega MD/Genesis/32X (.MD,.32X)",bDetected=!0):(sName="Acorn Archimedes ADFFS JFD disk image (.JFD)",bDetected=!0,nV=Util.divu64(nv=X.U32(4,_LE),100),nv%=100,sVersion="v"+nV+"."+nv,iv=X.U8(20),iv,X.isVerbose()&&(sOption("tt:"+Hex(tt)+" st:"+Hex(st)+" dt:"+Hex(dt)),sOption(addEllipsis(decAnsi(48,256,CPRISCOS).trim(),192,160)),(ds=X.U16(14))>1&&(sOptions+=" ("+X.U16(12)+"/"+ds+")"),sOption("trk:"+Util.divu64(st-tt,4)+" sec:"+Util.divu64(dt-st-4*tt,8)),X.U32(4)>=204&&(1&(g=X.U32(304))&&sOption("write-protected"),4&g&&sOption("Protect CMOS req."),8&g&&sOption("Protect Modules req."),32&g&&sOption("Shift+Break to load"),sOption("for:"),256&g&&sOption("ARM3"),512&g&&sOption("ARM250"),1024&g&&sOption("ARM610/710"),2048&g&&sOption("ARM7500"),4096&g&&sOption("StrongArm"),8192&g&&sOption("ARMv5/v6/v7"),65536&g&&sOption("RiscOS 2"),g&1<<17&&sOption("RiscOS 3.1"),g&1<<18&&sOption("RiscOS 3.5"),g&1<<19&&sOption("RiscOS 3.7"),g&1<<20&&sOption("RiscOS 3.8/4.x"),g&1<<21&&sOption("RiscOS 5.x"),g&1<<22&&sOption("RiscOS 6.x"),X.U8(308)&&sOption("fps:"+X.U8(308)/2),X.U32(312)&&sOption("Obey file sz:"+X.U32(312)),sOption("datasz:"+X.U32(8)),ddt&&sOption("delta data"))))
if(!bDetected&&function(){if([204800,409600,819200].indexOf(X.Sz())<0)return!1
var e=y=erased=subdir=0,a=X.Sz()>409600,t=(Math.min(X.Sz(),819200),X.U8(255))
if(t>35)return!1
var c=[0,"ZX Spectrum"],n=[0,"SAM Coupé"],o=[0,"DISCiPLE/+D"],k=[0,"HDD"],b=X.c("'BOOT'",256)
b&&(n[0]+=20)
var d=[]
for(i=0;i<195;i++)d.push(0)
soption="",fnames=[],label="",sus=0,extIs("mgt")||sus++,819200!=X.Sz()&&sus++
const p=["erased","ZXBASIC","ZXnum.array","ZXstr.array","ZXcode","ZX48ksnap","ZXMD","ZXscr","special","ZX128ksnap","Opentype","ZXexec","UNI-DOSdir","UNI-DOScreate","14?","15?","SAMBASIC","SAMnum.array","SAMstr.array","SAMcode","SAMscr","MasterDOSdir","SAMDriverapp","SAMDriverbootstrap","EDOSNOMEN","EDOSsys","EDOSovl","27?","HDOSHdos","HDOSHdir","HDOSHdisk","HDOSHfree/Htmp"]
for(19!=(63&X.U8(0))&&charStat(X.readBytes(210,10),1).indexOf("allasc")>=0&&(n[0]+=10,label=X.SA(210,10).trim()),e=_sec=_side=_trk=0,end=!1;_trk<4+t&&e<X.Sz();){for(s=0;s<2;s++)if(b&&1==y)y++
else if(X.U8(e+1)){end&&sus++,y++
var l=X.readBytes(e+2,9)
if(charStat(l,1).indexOf("allasc")<0)return!1
var S=63&X.U8(e)
if(S>31)return!1
if(S?isWithin(S,1,11)?c[0]++:isWithin(S,12,13)?o[0]++:isWithin(S,16,23)?n[0]++:k[0]++:erased++,!X.U16(e+11,_BE))return!1
var f=X.U8(e+13),u=f>>7
if(f&=127,!isWithin(f,0,79))return!1
var m=X.U8(e+14)
if(!isWithin(m,1,10))return!1
for(a||(a=u),y||(0==S&&sus++,128&X.U8(e)&&sus++),i=0;i<195;i++){if(r=X.U8(e+15+i),d[i]&r)return!1
d[i]|=r}firstNotOf(e+220,11,[32,255])<0&&(n[0]+=10),firstNotOf(e+232,4,[255])<0&&(n[0]+=4),255==X.U8(e+250)&&n[0]++,255==X.U8(e+251)&&n[0]++,fnames.push(X.SA(e+1,10).trim()+":"+p[S]),21==S&&(subdir++,r=512*(m+10*(u+2*f))+1,X.U8(r)&&fnames.push("/"+X.SA(r,10)+"...")),s||(e+=256)}else end=!0
_sec++,_sec>9&&(_sec=0,_side++,1==_side&&(_side=0,_trk++)),e=512*(_sec+10*(_side+2*_trk))}return!(sus>5||!y)&&(sv=function(){if(!arguments.length)return""
var e,a=arguments[0]
for(e=1;e<arguments.length;e++)arguments[e][0]>a[0]&&(a=arguments[e])
return a}(c,n,o,k)[1]+"/"+(a?"DS":"SS"),!0)}()&&(sName="Miles Gordon Technology floppy image (.MGT)",sVersion=sv,bDetected=1,X.isVerbose()&&(sOption((subdir?"≈":"")+(y-erased-subdir)+(erased?"+"+erased+" erased":"")+(subdir?"+"+subdir+"subdirs":""),"files:"),y&&sOption("("+addEllipsis(fnames.join("; "))+")"),sus&&sOption("possibly malformed (level "+sus+")"))),!bDetected)if(X.c("'NES'1A")&&X.Sz()>15){if(sName="NES ROM image (.nes)",bDetected=!0,malformed=!1,szprg=16384*X.U8(4),szchr=8192*X.U8(5),flg9=X.U8(9),flg6=X.U8(6),fstorage=(2&flg6)>0,trainer=128*(4&flg6),f4scrvram=(8&flg6)>0,flg7=X.U8(7),mapper=((240&flg6)>>4)+(240&flg7),fvsunisystem=(1&flg7)>0,fplaychoice10=(2&flg7)>0,fv20_=8==(12&flg7),fv20=!1,szprgmsb=16384*((15&flg9)<<8),szchrmsb=8192*((240&flg9)<<4),ex=region=tv="",S=16+trainer+szprg+szprgmsb+szchr+szchrmsb,fv20_&&(fv20=S<X.Sz()),fv20){switch(szprg+=szprgmsb,szchr+=szchrmsb,flg8=X.U8(8),flg11=X.U8(11),flg12=X.U8(12),flg13=X.U8(13),flg14=X.U8(14),flg15=X.U8(15),sVersion="NES v2.0",mapper+=(15&flg8)<<8,submapper=(240&flg8)>>4,2&flg7){case 0:sVersion+=" #NES/Famicom/Dendy"
break
case 1:switch(sVersion+=" #Nintendo Vs. System (",15&flg13){case 0:sVersion+="RP2C03B)"
break
case 1:sVersion+="RP2C03G)"
break
case 2:sVersion+="RP2C04-0001)"
break
case 3:sVersion+="RP2C04-0002)"
break
case 4:sVersion+="RP2C04-0003)"
break
case 5:sVersion+="RP2C04-0004)"
break
case 6:sVersion+="RC2C03B)"
break
case 7:sVersion+="RC2C03C)"
break
case 8:sVersion+="RC2C05-01)"
break
case 9:sVersion+="RC2C05-02)"
break
case 10:sVersion+="RC2C05-03)"
break
case 11:sVersion+="RC2C05-04)"
break
case 12:sVersion+="RC2C05-05)"
break
default:sVersion+="unk.PPU)"}break
case 2:sVersion+=" #Nintendo Playchoice 10"
break
default:switch(15&flg13){case 0:sVersion+=" #NES/Famicom/Dendy"
break
case 1:sVersion+=" #Nintendo Vs. System"
break
case 2:sVersion+=" #Nintendo Playchoice 10"
break
case 3:sVersion+=" #Famiclone+DecimalMode"
break
case 4:sVersion+=" #NES/Famicom+EPSM/plug-through"
break
case 5:sVersion+=" #V.R. VT01 red/cyan"
break
case 6:sVersion+=" #V.R. Technology VT02"
break
case 7:sVersion+=" #V.R. Technology VT03"
break
case 8:sVersion+=" #V.R. Technology VT09"
break
case 9:sVersion+=" #V.R. Technology VT32"
break
case 10:sVersion+=" #V.R. Technology VT369"
break
case 11:sVersion+=" #UMC UM6578"
break
case 12:sVersion+=" #Famicom Network System"
break
default:sVersion+=" #(reserved)"}}switch(3&flg12){case 0:region="NA/JP/SK/TW: NTSC NES"
break
case 1:region="WE/AU: Licenced PAL NES"
break
case 2:region="Multiple"
break
default:region="EU/RU/ZH/IN/AF: Dendy"}switch(63&flg15){case 0:break
case 1:ex="Std. Sontrollers"
break
case 2:ex="NES Four Score/Satellite + 2 Std. Controllers"
break
case 3:ex="Famicom 4P Adapter"
break
case 4:ex="Vs. System (1P via $4016)"
break
case 5:ex="Vs. System (1P via $4017)"
break
case 6:ex="(obsolete MAME behaviour)"
break
case 7:ex="Vs. Zapper"
break
case 8:ex="Zapper ($4017)"
break
case 9:ex="2 Zappers"
break
case 10:ex="Bandai Hyper Shot Lightgun"
break
case 11:ex="Power Pad Side A"
break
case 12:ex="Power Pad Side B"
break
case 13:ex="Family Trainer Side A"
break
case 14:ex="Family Trainer Side B"
break
case 15:ex="Arkanoid Vaus Controller (NES)"
break
case 16:ex="Arkanoid Vaus Controller (Famicom)"
break
case 17:ex="2 Vaus Controllers + Famicom Data Recorder"
break
case 18:ex="Konami Hyper Shot Controller"
break
case 19:ex="Coconuts Pachinko Controller"
break
case 20:ex="Exciting Boxing Punching Bag (Blowup Doll)"
break
case 21:ex="Jissen Mahjong Controller"
break
case 22:ex="Party Tap"
break
case 23:ex="Oeka Kids Tablet"
break
case 24:ex="Sunsoft Barcode Battler"
break
case 25:ex="Miracle Piano Keyboard"
break
case 26:ex="Pokkun Moguraa (Whack-a-Mole Mat & Mallet)"
break
case 27:ex="Top Rider (Inflatable Bicycle)"
break
case 28:ex="Double-Fisted"
break
case 29:ex="Famicom 3D System"
break
case 30:ex="Doremikko Keyboard"
break
case 31:ex="R.O.B. Gyro Set"
break
case 32:ex='Famicom Data Recorder ("silent" keyboard)'
break
case 33:ex="ASCII Turbo File"
break
case 34:ex="IGS Storage Battle Box"
break
case 35:ex="Family BASIC Keyboard + Famicom Data Recorder"
break
case 36:ex="Dongda PEC-586 Keyboard"
break
case 37:ex="Bit Corp. Bit-79 Keyboard"
break
case 38:ex="Subor Keyboard"
break
case 39:ex="Subor Keyboard + Mouse (3x8-bit)"
break
case 40:ex="Subor Keyboard + Mouse (24-bit)"
break
case 41:ex="SNES Mouse ($4017.d0)"
break
case 42:ex="Multicart"
break
case 43:ex="2 SNES Controllers"
break
case 44:ex="RacerMate Bicycle"
break
case 45:ex="U-Force"
break
case 46:ex="R.O.B. Stack-Up"
break
case 47:ex="City Patrolman Lightgun"
break
case 48:ex="Sharp C1 Cassette Interface"
break
case 49:ex="Std. Controller w/swapped ←→/↑↓/BA"
break
case 50:ex="Excalibor Sudoku Pad"
break
case 51:ex="ABL Pinball"
break
case 52:ex="Golden Nugget Casino extra buttons"
break
default:ex="(unknown)"}S=16+trainer+szprg+szprgmsb+szchr+szchrmsb}else{switch(12&flg7||!X.c("0000 0000",12)?4==(12&flg7)?sVersion="archaic iNES":sVersion="iNES v0.7 or archaic":sVersion="iNES",szprgram=8192*X.U8(8),szprgram||(szprgram=8192),flg10=X.U8(10),3&flg10){case 0:tv="NTSC"
break
case 2:tv="PAL"
break
default:tv="NTSC/PAL"}X.c("0000 0000",X.Sz()-4)?(fprgram=(16&flg10)>0,fbusconflicts=(32&flg10)>0):(fprgram=!1,fbusconflicts=!1),region="n/a"}X.isVerbose()&&(sOption(tv,"tv: "),sOption(region,"region: "),sOption(mapper,"mapper: "),sOption(ex,"expansion: "),fplaychoice10&&sOption("PlayChoice-10"),trainer&&sOption("trainer"),fstorage&&sOption("battery-backed RAM"),sOption(outSz(S),"sz:"))}else if(X.c("'MNIB-1541-RAW'..000002..04..06..08..0A"))bDetected=!0,sVersion="v"+X.U8(13),sName="Markus Brenner's MNIB/Peter Rittwage's C64PP NIBTools disk image (.NIB)"
else if(X.c("01'CD001'01''",339968))T=X.c("'NERO'",X.Sz()-8)?1:X.c("'NER5'",X.Sz()-12)?2:0,sName=(T?"Nero AG's ":"")+"optical disc image (.NRG)",T&&(sVersion="Nero AG/v"+T),X.isVerbose()&&(sOptions=X.SA(340008,32).trim()),bDetected=!0
else if(X.c("0D04..00'host_date='")&&X.fSig(0,128,"'KryoFlux DiskSystem'"))sName="SPS's KryoFlux DiskSystem disk sector (.RAW)",bDetected=!0
else if(X.c("'CAPS'0000000C1CD573BA'DATA'")&&X.c("'PACK'",X.U32(16,_BE)+20)&&(sName="SPS's KryoFlux CT Raw disk image (.RAW)",bDetected=!0,X.isVerbose())){for(w=12,p=unpsz=0;w<X.Sz()&&(e=X.SA(w,4),/[A-Z]{4}/.test(e)&&X.c("0000",w+4));){switch(a=X.U32(w+4,_BE),e){case"DATA":a+=X.U32(w+12,_BE)
break
case"PACK":unpsz+=a,a=X.U32(w+12,_BE)+24
break
case"TRCK":p++}w+=a}sOption("trk:"+p+" sz:"+outSz(w))}if(!bDetected&&function(){if(!X.c("'SINCLAIR'")||!isWithin(T=X.U8(8),1,128)||X.Sz()<9+14*T)return!1
for(y=[],w=9,i=c=0,S=9+14*T,sec=0,I="";i<T&&S<X.Sz();i++,w+=14){var e=decAnsi(w,8,CPSpeccy)
if(e.length<8)return!1
""===(e=e.trim())[0]&&(e[0]="*")
var a=decAnsi(w+8,1,CPSpeccy)
if(!a.length)return!1
y.push(e+".$"+a),r=X.U8(w+13),sec+=r,S+=r<<8}if(S>X.Sz()||S>655364)return!1
if(X.Sz()>=S+4){for(i=0;i<S;c+=X.U8(i++));S+=4,c!=X.U32(i)&&(I="!badcrc")}else I="!nocrc"
return y=y.join(";"),!0}()&&(sName="ZX Spectrum floppy disk image (.SCL)",bDetected=!0,I.length&&(sVersion="malformed"+I),X.isVerbose()&&(sOption(addEllipsis(y,160)),sOption("sec:"+sec+" sz:"+outSz(S)))),!bDetected&&function(){if(!X.c("'SCP'")||X.U8(6)>165||X.U8(7)>165||X.U8(10)>2)return!1
var e,a=mtdsz=0,s=X.U8(5),r=X.U8(9)
for(S=688,r?r>>=3:r=2,e=16;e<688;e+=4){var i=X.U32(e)
if(i){if(!X.c("'TRK'",i))return!1
var t=0
for(q=i+4;t<s;t++){var c=X.U32(q+4)*r,n=X.U32(q+8)+i
n>a&&(a=n,mtdsz=c),q+=12}}}if(a){if(a>X.Sz())return!1
S=a+mtdsz}return!0}()){sName="SuperCard Pro disk image (.SCP)",bDetected=!0
var u=X.U8(3)
u=u?"v"+(u>>4)+" rev."+(15&u):"v.?"
var m,h,A=X.U8(4),U=(X.U8(5),X.U8(6)),C=X.U8(7),g=X.U8(8),D=1&g?4&g?"360":"300":"300/360",E=8&g?"normalised":"preservation",O=16&g?"read/write":"read-only",z=32&g,B=X.U8(10)?1==X.U8(10)?"bottom":"top":"double"
if(z&&(u="app v"+(X.U8(S+40)>>4)+"."+(15&X.U8(S+40))+"h/w v"+(X.U8(S+41)>>4)+"."+(15&X.U8(S+41)),X.c("'FPCS'",S+44)||(u+="/malformed!noendtag"),S+=48),sVersion=u,X.isVerbose()){switch(15&A){case 0:h="CBM"
break
case 1:h="Amiga"
break
case 2:h="Apple ]["
break
case 3:h="Atari ST"
break
case 4:h="Atari 800"
break
case 5:h="Mac 800"
break
case 6:h="360k/720k"
break
case 7:h="1.44M"
break
default:h="unk."}switch(A>>4){case 0:m="Commodore"
break
case 1:m="Atari"
break
case 2:m="Apple"
break
case 3:m="PC"
break
case 4:m="Tandy"
break
case 5:m="Texas Inst."
break
case 6:m="Roland"
break
case 8:m="(other)"
break
default:m="unk."}sOption("type "+h+" by "+m),sOption("trk:"+U+"-"+C+" side:"+B),sOption(O),sOption(E,"quality:"),sOption(D,""," rpm"),sOption(outSz(S),"sz:")}}if(!bDetected)if(X.c("EC..A50000")&&X.c("EC00",256)&&X.c("55AA55AA55AA55AAFFFFFFFFFFFFFFFF0000",272)&&X.c("FFFFFFFFFFFFFFFF FFFFFFFFFFFFFFFF",1024)&&X.c("4199015564F0FFFF 201B0C824118EA61 F00107F60301EE1B 0C834118EA617001 07760301EE15140500",17968))sName="GamePark GP32 SmartMedia card (.SMC)",bDetected=!0
else if(X.c("'RSY'000300")){if(sName="Jorge 'Ijor' Cwik's Pasti disk image (.STX)",bDetected=!0,sVersion="v3"+(2==X.U8(11)?" new":0==X.U8(11)?" old":""),X.isVerbose()){for(sOption(X.U8(10),"trk.total:"),i=0,w=16;i<X.U8(10)&&w<X.Sz();i++,w+=X.U32(w));sOption(outSz(w),"sz:")}}else if(X.c("'ZXST'")&&charStat(X.readBytes(16+X.U32(12),4),1).indexOf("allxsc")>=0&&X.fSig(8,512,"'Z80R'")>0&&X.fSig(32,512,"'SPCR'")>0&&isWithin(V=X.U8(4),1,1)&&(u=X.U8(5))<=5&&(hw=X.U8(6))<=16&&(g=X.U8(7))<=1){switch(sName="Spectaculator zx-state file (.SZX)",sVersion="v"+V+"."+u,bDetected=!0,hw){case 0:hw="ZX Spectrum 16k"
break
case 1:hw="ZX Spectrum 48k/+"
break
case 2:hw="ZX Spectrum 128k"
break
case 3:hw="ZX Spectrum +2"
break
case 4:hw="ZX Spectrum +2A/B"
break
case 5:hw="ZX Spectrum +3"
break
case 6:hw="ZX Spectrum +3e"
break
case 7:hw="Pentagon 128"
break
case 8:hw="Timex Sinclair TC-2048"
break
case 9:hw="Timex Sinclair TC-2068"
break
case 10:hw="Scorpion ZS-256"
break
case 11:hw="ZX Spectrum SE"
break
case 12:hw="Timex Sinclair TS-2068"
break
case 13:hw="Pentagon 512"
break
case 14:hw="Pentagon 1024"
break
case 15:hw="ZX Spectrum 48k (NTSC)"
break
case 16:hw="ZX Spectrum 128Ke"
break
default:hw="(unk.)"}if(sOption(hw,"h/w:"),X.isVerbose()){for(var w=8;w<X.Sz();){e=X.SA(w,4)
if(!(a=X.U32(w+4))||a+w>X.Sz()||charStat(X.readBytes(w,4),1).indexOf("allxsc")<0||e.length<2||e.toUpperCase()!=e)break
if(w+=8,"CRTR"===e)sOption(X.SA(w,32),"in:")
w+=a}S=w,sOption(outSz(S),"sz:")}}else if(/^C64S?\s*tape.*file/.test(X.SA(0,32))){if(sName="C64 cassette tape (.T64)",bDetected=!0,sVersion="v"+X.U8(32)+"."+X.U8(33).padStart(2,"0"),X.isVerbose()){var y=[],v=X.U16(34,_LE),M=X.U16(36,_LE)
for(i=0;i<v;i++)i<M&&(y[i]=X.SA(80+32*i,32).trim())
for(sOption(M," entries:"),i=0;i<y.length;i++)sOptions=sOptions.appendS(y[i]," ")}}else if(X.c("'XM7 TAPE IMAGE 0'"))sName="Fujitsu FM-7 emulator XM7 tape (.T77)",bDetected=!0
else if(X.c("'C64-TAPE-RAW'")&&X.U8(12)<2){bDetected=!0,sName="C64 cassette tape (.TAP)",sVersion="v"+X.U8(12)
S=X.U32(16)+20
X.isVerbose()?sOptions="sz:"+outSz(S):S>X.Sz()&&(sVersion+="/malformed!short")}else if(X.c("'ZXTape!'1A")){sVersion="v"+X.U8(8)+"."+X.U8(9).padStart(2,"0"),bDetected=!0
var P=end=!1,N=0,I=W=publisher=auth=year=lang=apptype=price=protload=org=k=hw=sel=fnames=""
const e=["B","N","S","C"]
for(w=10;!end&&w<X.Sz();)switch(X.U8(w++)){case 16:X.U8(w+4)||(charStat(r=X.readBytes(w+6,10),1).indexOf("allasc")<0&&(I=I.addIfNone("!nonASCIIfn")),r=decEncoding(r,CPSpeccy).trim(),A=X.U8(w+5),!r&&A<3&&(I=I.addIfNone("!emptyfn")),fnames=fnames.appendS(r+"."+e[A],",")),w+=4+X.U16(w+2)
break
case 17:w+=18+X.U24(w+15)
break
case 18:w+=4
break
case 19:w+=1+2*X.U8(w)
break
case 20:!X.U8(w+4)>8?(end=!0,I=I.addIfNone("!badnbitsin14")):w+=10+X.U24(w+7)
break
case 21:isWithin(X.U8(w+4),1,8)?w+=8+X.U24(w+5):(end=!0,I=I.addIfNone("!badnbitsin15"))
break
case 24:isWithin(X.U8(w+9),1,2)?w+=4+X.U32(w):(end=!0,I=I.addIfNone("!badcomptypein18"))
break
case 25:case 42:w+=4+X.U32(w)
break
case 32:case 35:case 36:w+=2
break
case 33:w+=1+X.U8(w)
break
case 34:case 37:case 39:break
case 38:w+=2+2*X.U16(w)
break
case 40:var x=w+2+X.U16(w),T=X.U8(w+2)
for(w+=3,i=0;i<T;i++){var R=X.U8(w+2)
w+=3,sel=sel.appendS(decAnsi(w,R,CPSpeccy,1,Chars0to1FSpeccy),"/"),w+=R}w=x
break
case 43:X.U8(w+4)>1?(end=!0,I=I.addIfNone("!badsignalin2B")):w+=4+X.U32(w)
break
case 48:k=k.append("-"+decAnsi(w+1,X.U8(w),CPSpeccy,1,Chars0to1FSpeccy).trim()+"-"),w+=1+X.U8(w)
break
case 49:w+=2+X.U8(w+1)
break
case 50:x=w+2+X.U16(w),T=X.U8(w+2)
for(w+=3,i=0;i<T;i++){A=X.U8(w++)
switch(r=X.SC(w+1,Math.min(X.U8(w),x-w),"CP1252").trim(),A){case 0:W=W.append(r)
break
case 1:publisher=publisher.append(r)
break
case 2:auth=auth.append(r)
break
case 3:year=year.append(r)
break
case 4:lang=lang.append(r)
break
case 5:apptype=apptype.append(r)
break
case 6:price=price.append(r)
break
case 7:protload=protload.append(r)
break
case 8:org=org.append(r)
break
case 255:k=k.appendS(r," / ")
break
default:k=k.append(r,"\ninfo#"+A.toString(16)+":")}w+=1+X.U8(w)}w=x
break
case 51:var Z=X.U8(w++)
for(i=0;i<Z;i++){var L=X.U8(w++),_=X.U8(w++)
switch(L){case 0:switch(L="[PC]",_){case 0:_="ZX Spectrum 16k"
break
case 1:_="ZX Spectrum 48k/+"
break
case 2:_="ZX Spectrum 48k ISSUE 1"
break
case 3:_="ZX Spectrum 128k +(Sinclair)"
break
case 4:_="ZX Spectrum 128k +2 (grey case)"
break
case 5:_="ZX Spectrum 128k +2A/+3"
break
case 6:_="Timex Sinclair TC-2048"
break
case 7:_="Timex Sinclair TS-2068"
break
case 8:_="Pentagon 128"
break
case 9:_="SAM Coupe"
break
case 10:_="Didaktik M"
break
case 11:_="Didaktik Gama"
break
case 12:_="ZX-80"
break
case 13:_="ZX-81"
break
case 14:_="ZX Spectrum 128k Spanish version"
break
case 15:_="ZX Spectrum Arabic version"
break
case 16:_="Microdigital TK 90-X"
break
case 17:_="MicrodigitalTK 95"
break
case 18:_="Byte"
break
case 19:_="Elwro 800-3"
break
case 20:_="ZS Scorpion 256"
break
case 21:_="Amstrad CPC 464"
break
case 22:_="Amstrad CPC 664"
break
case 23:_="Amstrad CPC 6128"
break
case 24:_="Amstrad CPC 464+"
break
case 25:_="Amstrad CPC 6128+"
break
case 26:_="Jupiter ACE"
break
case 27:_="Enterprise"
break
case 30:_="Inves Spectrum+"
break
case 31:_="Profi"
break
case 32:_="GrandRomMax"
break
case 33:_="Kay 1024"
break
case 34:_="Ice Felix HC 91"
break
case 35:_="Ice Felix HC 2000"
break
case 36:_="Amaterske RADIO Mistrum"
break
case 37:_="Quorum 128"
break
case 38:_="MicroART ATM"
break
case 39:_="MicroART ATM Turbo 2"
break
case 40:_="Chrome"
break
case 41:_="ZX Badaloc"
break
case 42:_="TS-1500"
break
case 43:_="Lambda"
break
case 44:_="TK-65"
break
case 45:_="ZX-97"
break
default:_="(unk.)"}break
case 1:switch(L="[ext.storage]",_){case 0:_="ZX Microdrive"
break
case 1:_="Opus Discovery"
break
case 2:_="MGT DISCiPLE"
break
case 3:_="MGT +D"
break
case 4:_="Rotronics Wafadrive"
break
case 5:_="TR-DOS (BetaDisk)"
break
case 6:_="Byte Drive"
break
case 7:_="Watsford"
break
case 8:_="FIZ"
break
case 9:_="Radofin"
break
case 10:_="Didaktik disk drives"
break
case 11:_="BS-DOS (MB-02)"
break
case 12:_="ZX Spectrum +3 disk drive"
break
case 13:_="JLO (Oliger) disk interface"
break
case 14:_="Timex FDD3000"
break
case 15:_="Zebra disk drive"
break
case 16:_="Ramex Millenia"
break
case 17:_="Larken"
break
case 18:_="Kempston disk interface"
break
case 19:_="Sandy"
break
case 20:_="ZX Spectrum +3e hard disk"
break
case 21:_="ZXATASP"
break
case 22:_="DivIDE"
break
case 23:_="ZXCF"
break
default:_="(unk.)"}break
case 2:switch(L="[memory addon]",_){case 0:_="Sam Ram"
break
case 1:_="Multiface ONE"
break
case 2:_="Multiface 128k"
break
case 3:_="Multiface +3"
break
case 4:_="MultiPrint"
break
case 5:_="MB-02 ROM/RAM exp."
break
case 6:_="SoftROM"
break
case 7:_="1k"
break
case 8:_="16k"
break
case 9:_="48k"
break
case 10:_="memory in 8-16k used"
break
default:_="(unk.)"}break
case 3:switch(L="[sound device]",_){case 0:_="classic 128k ZX-compatible AY hw"
break
case 1:_="Fuller Box AY hw"
break
case 2:_="Currah microSpeech"
break
case 3:_="SpecDrum"
break
case 4:_="AY ACB (L:A+C R:B+C) stereo/Melodik"
break
case 5:_="AY ABC (L:A+B R:B+C) stereo/Melodik"
break
case 6:_="RAM Music Machine"
break
case 7:_="Covox"
break
case 8:_="General Sound"
break
case 9:_="Intec Electronic Digital Interface B8001"
break
case 10:_="Zon-X AY"
break
case 11:_="QuickSilva AY"
break
case 12:_="Jupiter ACE"
break
default:_="(unk.)"}break
case 4:switch(L="[joystick]",_){case 0:_="Kempston"
break
case 1:_="Cursor/Protek/AGF"
break
case 2:_="Sinclair 2 Left (12345)"
break
case 3:_="Sinclair 1 Right (67890)"
break
case 4:_="Fuller"
break
default:_="(unk.)"}break
case 5:switch(L="[mouse]",_){case 0:_="AMX mouse"
break
case 1:_="Kempston mouse"
break
default:_="(unk.)"}break
case 6:switch(L="[controller]",_){case 0:_="Trickstick"
break
case 1:_="ZX Light Gun"
break
case 2:_="Zebra Graphics Tablet"
break
case 3:_="Defender Light Gun"
break
default:_="(unk.)"}break
case 7:switch(L="[serial port]",_){case 0:_="ZX Interface I"
break
case 1:_="ZX Spectrum 128k"
break
default:_="(unk.)"}break
case 8:switch(L="[parallel port]",_){case 0:_="Kempston S"
break
case 1:_="Kempston E"
break
case 2:_="ZX Spectrum +3"
break
case 3:_="Tasman"
break
case 4:_="DK'Tronics"
break
case 5:_="Hilderbay"
break
case 6:_="INES Printerface"
break
case 7:_="Z LPrint Interface 3"
break
case 8:_="MultiPrint"
break
case 9:_="Opus Discovery"
break
case 10:_="Standard 8255 chip with ports 31+63+95"
break
default:_="(unk.)"}break
case 9:switch(L="[printer]",_){case 0:_="ZX Printer/Alphacom 32 & compat."
break
case 1:_="Generic printer"
break
case 2:_="EPSON compat."
break
default:_="(unk.)"}break
case 10:switch(L="[modem]",_){case 0:_="Prism VTX 5000"
break
case 1:_="T/S 2050/Westridge 2050"
break
default:_="(unk.)"}break
case 11:switch(L="[digitizer]",_){case 0:_="RD Digital Tracer"
break
case 1:_="DK'Tronics Light Pen"
break
case 2:_="British MicroGraph Pad"
break
case 3:_="Romantic Robot Videoface"
break
default:_="(unk.)"}break
case 12:L="[network adapter]",_=0==_?"ZX Interface I":"(unk.)"
break
case 13:L="[keyboard]",_=0==_?"Keypad for ZX Spectrum 128k":"(unk.)"
break
case 14:switch(L="[AD/DA converter]",_){case 0:_="Harley Systems ADC 8.2"
break
case 1:_="Blackboard Electronics"
break
default:_="(unk.)"}break
case 15:switch(L="[EEPROM programmer]",_){case 0:_="Orme Electronics"
break
case 1:_="Blackboard Electronics"
break
default:_="(unk.)"}break
case 16:switch(L="[GPU]",_){case 0:_="WRX Hi-Res"
break
case 1:_="G007"
break
case 2:_="Memotech"
break
case 3:_="Lambda Colour"
break
default:_="(unk.)"}}switch(X.U8(w++)){case 0:hw=hw.append("runs on "+L+" "+_)
break
case 1:hw=hw.append("uses "+L+" "+_)
break
case 2:hw=hw.append("runs w/o specifics of "+L+" "+_)
break
case 3:hw=hw.append("won't run on "+L+" "+_)}}break
case 53:w+=20+X.U32(w+16)
break
case 90:X.c("'XTape!'1A",w)?(N++,w+=9):(end=!0,w--)
break
case 22:case 23:w+=X.U32(w)
break
case 52:w+=8
break
case 64:sOption("snapshot"),w+=4+X.U24(w+1)
break
case 75:P=!0,w+=4+X.U32(w)
break
default:end=!0,w--}sName=P?"ZX Spectrum/MSX tape (.TSX)":"ZX Spectrum tape (.TZX)",I.length&&(sVersion=sVersion.appendS("malformed"+I,"/")),X.isVerbose()&&(sOptionT(W),N>1&&sOption(N,"x"),sOptionT(auth,"by:"),sOptionT(year,"'"),sOptionT(publisher,"(c) "),sOptionT(lang,"in:"),sOptionT(apptype,"apptype:"),sOptionT(price,"price:"),sOptionT(org,"origin:"),sOptionT(protload,"prot/ldr:"),sOption(hw),sOptionT(addEllipsis(k,160)),sOptionT(addEllipsis(fnames,160),"files:"),sOptionT(sel,"choices:"),sOption(outSz(w),"sz:"))}else if(X.c("'UEF File!'00")&&X.U8(11)<=2){sName="Acorn PC Unified Emulator Format data (.UEF)",bDetected=!0,sVersion="v"+X.U8(11)+"."+X.U8(10)
var W=info=man=gear=kb=A=""
o=!1
for(w=12;w<X.Sz();){e=X.U16(w),a=X.U32(w+2)
if([0,1,2,3,4,255].indexOf(e>>8)<0)break
switch(w+=6,e){case 0:info=info.appendS(X.SA(w,a),"/")
break
case 1:man=man.appendS(X.SA(w,a)," ")
break
case 5:switch(gear="Acorn ",X.U8(w)>>4){case 0:gear+="BBC Model A"
break
case 1:gear+="Electron"
break
case 2:gear+="BBC Model B"
break
case 3:gear+="BBC Master"
break
case 4:gear+="Atom"}switch(15&X.U8(w)){case 0:kb="any"
break
case 1:kb="target PC"
break
case 2:kb="host PC"}break
case 9:W=X.SA(w,a)
break
case 257:case 258:case 259:case 260:case 272:case 273:case 274:case 275:case 276:case 277:case 278:case 279:case 288:case 305:A=A.addIfNone("#tape")
break
case 304:switch(X.U8(w)){case 0:r="unit"
break
case 1:r="tape"
break
case 2:r="disc"
break
case 3:r="vtape"
break
case 4:r="cartridge"}X.U8(w+1)>1&&(r+=" ×"+X.U8(w+1)),X.U8(w+2)>1&&(r+=1==X.U8(w)||3==X.U8(w)?" ch:":2==X.U8(w)?" "+X.U8(w+2)+" audiotracks":"..?"),info+=" #"+r
break
case 512:case 513:case 514:A=A.addIfNone("#disc")
break
case 768:switch(A=A.addIfNone("#ROM"),r="content:",X.U8(w)){case 0:r+="generic"
break
case 1:r+="OS"
break
case 2:r+="BASIC"
break
case 3:r+="language"
break
case 4:r+="utility"
break
case 5:r+="filing system"
break
case 6:r+="h/w driver"
break
case 7:r+="game"
break
default:r+="unk"}info+=" #"+r
break
case 769:A=A.addIfNone("#ROM")
break
case 1024:case 1025:case 1026:case 1027:case 1040:case 1041:case 1042:case 1056:A=A.addIfNone("#snapshot")
break
case 65280:info+="#emu:"+X.SA(w,a)
break
case 256:break
default:e>65280?A=A.addIfNone("#customdata"):o=!0}if(o){w-=6
break}w+=a}sVersion+=A,X.isVerbose()&&(sOption(W),sOptionT(info,"info:"),sOptionT(man,"manual:"),sOptionT(gear,"gear:"),sOptionT(kb,"layout:"),sOption(outSz(w),"sz:"))}else if(X.c("'UNIF'???????? 0000 0000 0000 0000 0000 0000 0000")&&X.Sz()>32){if(sName="UNIF NES cartridge (.UNF)",sVersion="v"+X.U32(4,_LE),bDetected=!0,X.isVerbose()){for(w=8,r="",mapr="",tv="",ex="",fstorage=lastchunk=!1;w<X.Sz()&&!lastchunk;){e=X.SA(w,4),a=X.U32(w+4)
switch(w+=8,e){case"MAPR":mapr=X.SA(w,a)
break
case"NAME":r=X.SA(w,a)
break
case"TCVI":switch(X.U8(w)){case 0:tv="NTSC"
break
case 1:tv="PAL"
break
case 2:tv="NTSC/PAL"}break
case"CTRL":var G=[],K=X.U8(w)
1&K&&G.push("Std. Controller"),2&K&&G.push("Zapper"),4&K&&G.push("R.O.B."),8&K&&G.push("Arkanoid Controller"),16&K&&G.push("Power Pad"),32&K&&G.push("Four Score"),K&&(ex="#"+G.join("+"))
break
case"BATR":fstorage=!0
break
case"MIRR":lastchunk=!0}w+=a}sOptionT(r),sOption(tv),sOption(ex,"expansion: "),fstorage&&sOption("battery-backed RAM"),lastchunk?sOption(outSz(w),"sz:"):sVersion+="/malformed!short"}}else if(X.c("'g GCE 198'..80"))sName="GCE Vectrex cartridge (.VEC)",bDetected=!0,X.isVerbose()&&(w=X.fSig(17,32,"80"))>0&&sOption(X.SA(17,w-17))
else if(X.c("'VICE Snapshot File'1A")){for(sName="C64 VICE emulator snapshot (.VSF)",bDetected=1,sVersion="v"+X.U8(19)+"."+X.U8(20).padStart(2,"0"),w=37,I="";w<X.Sz();){e=X.SA(w,16),a=X.U32(w+18,_BE)
if(!/([A-Z0-9-]{3,}|Acia1)/.test(e)||!isAllZeroes(w+e.length,16-e.length)){I=I.addIfNone("badchunk")
break}w+=a}X.isVerbose()?sOptions=X.SA(21,15)+" sz:"+outSz(S):w>X.Sz()&&(I=I.addIfNone("!short")),""!=I&&(sVersion=sVersion.appendS("/malformed"+I,"/"))}if(!bDetected&&function(){if(!X.c("'IWAD'")&&!X.c("'PWAD'"))return!1
var e=0,a=_LE
if(lumpn=X.I32(4,a),lumpn<0||lumpn>X.I32(4,_BE)){if(lumpn=X.I32(4,_BE),!(lumpn>0))return!1
e++,a=_BE}var s=0,r=X.I32(8,a),i=r
if(!isWithin(r,12,X.Sz()))return!1
e++
for(var t=[],c=Math.min(lumpn,64);s<c;s++,i+=16){if(i+16>X.Sz())return!1
var n=X.I32(i,a),o=X.I32(i+4,a)
if(n<0||o<0||!isWithin(n,12,X.Sz()))return!1
X.c("'ENDOFWAD'",i+8)&&e++,t.push([n,o,X.readBytes(i+8,8)])}for(t=t.sort((function(e,a){return e[0]-a[0]})),s=0;s<c;s++){var k=(128&t[s][2][0])>0
if(t[s][2][0]=127&t[s][2][0],charStat(t[s][2],!0).indexOf("allxsc")<0)return!1
if(!k&&s<c-2&&t[s][0]+t[s][1]>t[s+1][0])return!1}return u=e>=2?"Atari Jaguar":"PC",!0}()&&(sName="iD Software's Where's All the Data resource pack (.WAD)",bDetected=!0,sVersion=X.c("'I'")?"initial":"patch",sVersion+="#"+u),!bDetected&&X.c("'WOZ'..FF0A0D0A ........ 'INFO'")&&isWithin(X.U8(3),49,50)){for(sName="Apple II Applesauce disk image (.WOZ)",sVersion="v"+X.SA(3,1),w=12,meta=I="";w<X.Sz();){e=X.SA(w,4),a=X.U32(w+4)
switch(w+=8,e){case"INFO":iV=X.U8(w),bDetected=!0,dim=1==X.U8(w+1)?'5¼"':2==X.U8(w+1)?'3½"':"?",iV>=2?ds=1==X.U8(w+37)?" SS":2==X.U8(w+37)?" DS":" ?":ds="",sOption("disk:"+dim+ds),1==X.U8(w+2)&&sOption("write-protected"),iV>=2&&((r=X.U8(w+42))&&sOption(r,"min.RAM:","k"),r="",(g=X.U16(w+40))||(r="?"),1&g&&(r=r.append("][")),2&g&&(r=r.append("][ Plus")),4&g&&(r=r.append("//e")),8&g&&(r=r.append("//c")),16&g&&(r=r.append("//e Enhanced")),32&g&&(r=r.append("IIgs")),64&g&&(r=r.append("//c Plus")),128&g&&(r=r.append("///")),256&g&&(r=r.append("/// Plus")),sOption(r,"for Apple "))
break
case"TMAP":case"TRKS":case"FLUX":case"WRIT":break
case"META":meta=X.SC(w,a,"UTF8").replace(/\x0A/g,",").replace(/\x09/g,":")}w+=a}w>X.Sz()&&(I=I.addIfNone("!short")),""!=I&&(sVersion=sVersion.appendS("/malformed"+I,"/")),X.isVerbose()&&(sOptionT(addEllipsis(meta),'info:"','"'),sOption(outSz(w),"sz:"))}if(!bDetected&&function(){if(!extIs("z80")&&!extIs("slt"))return!1
if(X.Sz()<1380)return!1
nv=0,co=!0,joystick=hw=""
const e=X.U8(12)
255==e&&(e=1)
var a=X.U16(6),s=128&X.U8(37),r=30
if(a)switch(nv=1,hw="ZX Spectrum 48k",co=(32&e)>0,X.U8(29)>>6&&3){case 0:joystick="cursor"
break
case 1:joystick="Kempston"
break
case 2:joystick="SinclairI2-L"
break
case 3:joystick="SinclairI2-R"}else{switch(xblk=X.U16(30)){case 23:nv=2
break
case 54:case 55:nv=3
break
default:return!1}switch(r+=xblk+2,nv){case 2:switch(X.U8(29)>>6&&3){case 0:joystick="cursor"
break
case 1:joystick="Kempston"
break
case 2:joystick="SinclairI2-L"
break
case 3:joystick="SinclairI2-R"}break
case 3:switch(X.U8(29)>>6&&3){case 0:joystick="cursor"
break
case 1:joystick="Kempston"
break
case 3:joystick="SinclairI2-R"
break
case 2:X.c("030F0308 03040302 0301",64)?joystick="Sinclair2-L":joystick="custom"}break
default:return!1}var t=X.U8(34),n=X.U8(83)
if(t<7)switch(nv){case 2:switch(t){case 0:hw="ZX Spectrum "+(s?"16k":"48k")
break
case 1:hw="ZX Spectrum "+(s?"16":"48")+"k & Interface1"
break
case 2:hw="ZX Spectrum "+(s?"16":"48")+"k & SamRam"
break
case 3:hw="ZX Spectrum "+(s?"+2":"128k")
break
case 4:hw="ZX Spectrum "+(s?"+2":"128k")+" & Interface1"
break
default:return!1}break
case 3:const e=["MGT EPSON DISCiPLE","MGT HP DISCiPLE","MGT +D"]
switch(n=[0,1,16].indexOf(n),t){case 0:hw="ZX Spectrum "+(s?"16k":"48k")
break
case 1:hw="ZX Spectrum "+(s?"16":"48")+"k & Interface1"
break
case 2:hw="ZX Spectrum "+(s?"16":"48")+"k & SamRam"
break
case 3:if(n<0)return!1
hw="ZX Spectrum "+(s?"16":"48")+"k & "+e[n]+" MGT"
break
case 4:hw="ZX Spectrum "+(s?"+2":"128k")
break
case 5:hw="ZX Spectrum "+(s?"+2":"128k")+" & Interface1"
break
case 6:if(n<0)return!1
hw="ZX Spectrum "+(s?"+2":"128k")+" & "+e[n]+" MGT"
break
default:return!1}break
default:return!1}else switch(t){case 7:case 8:hw="ZX Spectrum "+(s?"+2A":"+3")
break
case 9:hw="Pentagon 128+"
break
case 10:hw="Scorpion ZS-256"
break
case 11:hw="Didaktik-Kompakt"
break
case 12:hw="ZX Spectrum +2"
break
case 13:hw="ZX Spectrum +2A"
break
case 14:hw="Timex Sinclair TC-2048"
break
case 15:hw="Timex Sinclair TC-2068"
case 128:hw="Timex Sinclair TS-2068"
break
default:return!1}68&X.U8(37)?hw+=" + Fuller Box":4&X.U8(37)&&(hw+=" + Melodik")}if(pgs=[],co){const e=1==nv?49152:16384
for(w=r,i=unpsz=0;w<X.Sz()&&i<64&&!X.c("000000'SLT'",w);i++){var o=1==nv?65536:X.U16(w),k=1==nv?3:X.U8(w+2)
if(pgs.indexOf(k)>=0){if(i<3)return!1
break}if(pgs.push(k),nv>1&&(w+=3),i>0)q=w+o
else for(bsz=b=c=0,q=w;q<w+o&&bsz<e&&q<X.Sz();){if(X.c("EDED",q)){if(q+=2,c=X.U8(q++),b=X.U8(q++),c<5&&237!=b)return!1
bsz+=c}else q++,bsz++
if(1==nv&&X.c("00EDED00",q)){q+=4
break}}if(bsz!=e||T>1&&q!=w+o)return!1
if(w=q,unpsz+=bsz,1==nv||k>10||pgs.length>10)break}if(w>X.Sz()||nv>1&&!i)return!1
S=w}else S=w=r+49152
if(slt=X.c("000000'SLT'",w))e:for(sltsz=0,sltlv=[],w+=6;w<X.Sz();w+=8)switch(X.U16(w)){case 0:S+=14+sltsz,sltinfo="SLT levels:"+sltlv.join(",")
break e
case 1:sltlv.push(X.U16(w+2)),sltsz+=8+X.U32(w+4)
break
default:sltsz+=8+X.U32(w+4),_l2r("z80",w,"Unknown block! Please send this file to the author of rom.1.sg")}else sltinfo=""
return!0}()&&(sName=slt?"ZX Spectrum state snapshot + levels (.SLT)":"ZX Spectrum state snapshot (.Z80)",bDetected=!0,sVersion="v"+nv,3==nv&&55==X.U16(30)&&(sVersion+="x"),co&&(sVersion+="/compressed"),X.isVerbose()&&(sOption(hw,"on:"),sOption(joystick,"joystick:"),co&&sOption("pages:"+pgs.join("+")+" unp.sz:"+Util.divu64(unpsz,1024)+"k"),slt&&sOption(sltinfo),sOption(outSz(S),"sz:"))),!bDetected&&X.isHeuristicScan()){(function(){if(X.Sz()<17||X.Sz()<X.U16(0)+2)return!1
w=blk=sus=0,fnames=I=""
const e=["B","N","S","C"]
for(;w<X.Sz();){if(!(a=X.U16(w)))return!1
if(w+=2,X.Sz()<w+a)break
var s=0,t=X.U8(w)
if([0,255].indexOf(t)<0)break
if(w<49152&&blk<5){for(i=w;i<w+a-1;i++)s^=X.U8(i)
if(s!=X.U8(i))return!1}if(0==t){if(charStat(r=X.readBytes(w+2,10),1).indexOf("allasc")<0&&(sus++,I=I.addIfNone("!nonASCII:"+decEncoding(r,CPSpeccy))),!(r=decEncoding(r,CPSpeccy).trim())){if(X.U8(w+1)<3)return!1
sus++,I=I.addIfNone("!emptyname")}fnames=fnames.appendS(r+"."+e[X.U8(w+1)],",")}else fnames=fnames.appendS(a-3,":")
if(sus>2)return!1
blk++,w+=a}return!fnames.length&&blk&&(sus++,I=I.addIfNone("!nonameblk0")),blk<2&&I.indexOf("!nonASCII")&&sus++,!(sus>2||!blk||!fnames.length||w<17)||(delete I,!1)})()&&(sName="ZX Spectrum tape (.TAP)",bDetected=!0,I.length&&(sVersion="malformed#"+sus+I),X.isVerbose()&&(sOptionT(addEllipsis(fnames,160),"blocks:"+blk+" (",")"),sOption(outSz(w),"sz:"))),extIs("rom")&&(X.c("4142")||X.c("4142",16384)||X.c("41421040",245760)||X.c("0002204810A8D08055E0A8B088800280",32752))&&[8192,16384,32768,49152,65536,131072,262144,393216,524288,1048576].indexOf(X.Sz())>=0&&_setResult("ROM","Microsoft MSX/MSX 2 cartridge (.ROM)","",""),extIs("sna")&&49179==X.Sz()&&_setResult("ROM","ZX Spectrum 48k state snapshot file (.SNA)","","")}return result()}init("ROM","")
